// xg - http://alteredqualia.com/xg
function getHttpRequest(e,t,a){var r={load:function(e){t(i,e)},progress:function(e){a(i,e)}},i=new XMLHttpRequest;addListeners(i,r),i.open("GET",e,!0),i.send(null)}function getJsonRequest(e,t){getHttpRequest(e,function(e){t(JSON.parse(e.responseText))},function(){})}function addListeners(e,t){for(var a in t)e.addEventListener(a,t[a])}var XG=XG||{VERSION:"0"};THREE.elementIndexUintAvailable=!1,THREE.CullFaceNone=0,THREE.CullFaceBack=1,THREE.CullFaceFront=2,THREE.CullFaceFrontBack=3,THREE.FrontFaceDirectionCW=0,THREE.FrontFaceDirectionCCW=1,THREE.BasicShadowMap=0,THREE.PCFShadowMap=1,THREE.PCFSoftShadowMap=2,THREE.FrontSide=0,THREE.BackSide=1,THREE.DoubleSide=2,THREE.NoBlending=0,THREE.NormalBlending=1,THREE.AdditiveBlending=2,THREE.SubtractiveBlending=3,THREE.MultiplyBlending=4,THREE.CustomBlending=5,THREE.AddEquation=32774,THREE.SubtractEquation=32778,THREE.ReverseSubtractEquation=32779,THREE.ZeroFactor=0,THREE.OneFactor=1,THREE.SrcColorFactor=768,THREE.OneMinusSrcColorFactor=769,THREE.SrcAlphaFactor=770,THREE.OneMinusSrcAlphaFactor=771,THREE.DstAlphaFactor=772,THREE.OneMinusDstAlphaFactor=773,THREE.DstColorFactor=774,THREE.OneMinusDstColorFactor=775,THREE.SrcAlphaSaturateFactor=776,THREE.MultiplyOperation=0,THREE.MixOperation=1,THREE.AddOperation=2,THREE.RepeatWrapping=10497,THREE.ClampToEdgeWrapping=33071,THREE.MirroredRepeatWrapping=33648,THREE.NearestFilter=9728,THREE.LinearFilter=9729,THREE.NearestMipMapNearestFilter=9984,THREE.LinearMipMapNearestFilter=9985,THREE.NearestMipMapLinearFilter=9986,THREE.LinearMipMapLinearFilter=9987,THREE.ByteType=5120,THREE.UnsignedByteType=5121,THREE.ShortType=5122,THREE.UnsignedShortType=5123,THREE.IntType=5124,THREE.UnsignedIntType=5125,THREE.FloatType=5126,THREE.HalfFloatType=36193,THREE.UnsignedShort4444Type=32819,THREE.UnsignedShort5551Type=32820,THREE.UnsignedShort565Type=33635,THREE.DepthComponentFormat=6402,THREE.AlphaFormat=6406,THREE.RGBFormat=6407,THREE.RGBAFormat=6408,THREE.LuminanceFormat=6409,THREE.LuminanceAlphaFormat=6410,THREE.RGB_S3TC_DXT1_Format=33776,THREE.RGBA_S3TC_DXT1_Format=33777,THREE.RGBA_S3TC_DXT3_Format=33778,THREE.RGBA_S3TC_DXT5_Format=33779,THREE.NoOperator=0,THREE.SimpleOperator=1,THREE.LinearOperator=2,THREE.ReinhardOperator=3,THREE.FilmicOperator=4,THREE.UnchartedOperator=5,THREE.LumaReinhardOperator=6,THREE.WhitePreservingReinhardOperator=7,THREE.SimpleBRDF=0,THREE.BlinnPhongBRDF=1,THREE.GGXBRDF=2,THREE.xyzOrder=0,THREE.yxzOrder=1,THREE.zxyOrder=2,THREE.zyxOrder=3,THREE.yzxOrder=4,THREE.xzyOrder=5,THREE.paramTypedArrayToXG=function(e){var t;return e instanceof Float32Array?t=THREE.FloatType:e instanceof Uint32Array?t=THREE.UnsignedIntType:e instanceof Uint16Array?t=THREE.UnsignedShortType:e instanceof Uint8Array?t=THREE.UnsignedByteType:e instanceof Int32Array?t=THREE.IntType:e instanceof Int16Array?t=THREE.ShortType:e instanceof Int8Array&&(t=THREE.ByteType),t},THREE.paramXGToTypedArray=function(e){var t;return e===THREE.FloatType?t=Float32Array:e===THREE.UnsignedIntType?t=Uint32Array:e===THREE.UnsignedShortType?t=Uint16Array:e===THREE.UnsignedByteType?t=Uint8Array:e===THREE.IntType?t=Int32Array:e===THREE.ShortType?t=Int16Array:e===THREE.ByteType&&(t=Int8Array),t},THREE.Projector=function(){var e=new THREE.Matrix4;this.projectVector=function(t,a){return a.matrixWorldInverse.getInverse(a.matrixWorld),e.multiply(a.projectionMatrix,a.matrixWorldInverse),e.multiplyVector3(t),t},this.unprojectVector=function(t,a){return a.projectionMatrixInverse.getInverse(a.projectionMatrix),e.multiply(a.matrixWorld,a.projectionMatrixInverse),e.multiplyVector3(t),t}},THREE.Color=function(e){return void 0!==e&&this.set(e),this},THREE.Color.prototype={constructor:THREE.Color,r:1,g:1,b:1,copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e){return this.r=e.r*e.r,this.g=e.g*e.g,this.b=e.b*e.b,this},copyLinearToGamma:function(e){return this.r=Math.sqrt(e.r),this.g=Math.sqrt(e.g),this.b=Math.sqrt(e.b),this},copyTonemapped:function(e,t,a){function r(e){return(e*(i*e+n*o)+s*l)/(e*(i*e+o)+s*h)-l/h}var i=.15,o=.5,n=.1,s=.2,l=.02,h=.3,d=11.2,u=1/2.2;switch(this.r=e.r*a,this.g=e.g*a,this.b=e.b*a,t){case THREE.SimpleOperator:this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b);break;case THREE.LinearOperator:this.r=Math.pow(this.r,u),this.g=Math.pow(this.g,u),this.b=Math.pow(this.b,u);break;case THREE.ReinhardOperator:this.r=this.r/(1+this.r),this.g=this.g/(1+this.g),this.b=this.b/(1+this.b),this.r=Math.pow(this.r,u),this.g=Math.pow(this.g,u),this.b=Math.pow(this.b,u);break;case THREE.FilmicOperator:var c=Math.max(0,this.r-.004),f=Math.max(0,this.g-.004),p=Math.max(0,this.b-.004);this.r=c*(6.2*c+.5)/(c*(6.2*c+1.7)+.06),this.g=f*(6.2*f+.5)/(f*(6.2*f+1.7)+.06),this.b=p*(6.2*p+.5)/(p*(6.2*p+1.7)+.06);break;case THREE.UnchartedOperator:var m=2,v=r(m*this.r),g=r(m*this.g),S=r(m*this.b),x=1/r(d);this.r=v*x,this.g=g*x,this.b=S*x,this.r=Math.pow(this.r,u),this.g=Math.pow(this.g,u),this.b=Math.pow(this.b,u)}return this},convertGammaToLinear:function(){var e=this.r,t=this.g,a=this.b;return this.r=e*e,this.g=t*t,this.b=a*a,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},set:function(e){switch(typeof e){case"number":this.setHex(e);break;case"string":this.setStyle(e)}},setRGB:function(e,t,a){return this.r=e,this.g=t,this.b=a,this},setHSV:function(e,t,a){var r,i,o,n,s;return 0===a?this.r=this.g=this.b=0:(r=Math.floor(6*e),i=6*e-r,o=a*(1-t),n=a*(1-t*i),s=a*(1-t*(1-i)),0===r?(this.r=a,this.g=s,this.b=o):1===r?(this.r=n,this.g=a,this.b=o):2===r?(this.r=o,this.g=a,this.b=s):3===r?(this.r=o,this.g=n,this.b=a):4===r?(this.r=s,this.g=o,this.b=a):5===r&&(this.r=a,this.g=o,this.b=n)),this},adjustHSV:function(e,t,a){var r=THREE.__hsv;this.getHSV(r),r.h=THREE.Math.clamp(r.h+e,0,1),r.s=THREE.Math.clamp(r.s+t,0,1),r.v=THREE.Math.clamp(r.v+a,0,1),this.setHSV(r.h,r.s,r.v)},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},setStyle:function(e){if(/^rgb\((\d+),(\d+),(\d+)\)$/i.test(e)){var t=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(e);return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,this}if(/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.test(e)){var t=/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.exec(e);return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,this}if(/^\#([0-9a-f]{6})$/i.test(e)){var t=/^\#([0-9a-f]{6})$/i.exec(e);return this.setHex(parseInt(t[1],16)),this}if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(e)){var t=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(e);return this.setHex(parseInt(t[1]+t[1]+t[2]+t[2]+t[3]+t[3],16)),this}return/^(\w+)$/i.test(e)?(this.setHex(THREE.ColorKeywords[e]),this):void 0},getHSV:function(e){var t,a,r=this.r,i=this.g,o=this.b,n=Math.max(Math.max(r,i),o),s=Math.min(Math.min(r,i),o),l=n;if(s===n)t=0,a=0;else{var h=n-s;a=h/n,t=r===n?(i-o)/h:i===n?2+(o-r)/h:4+(r-i)/h,t/=6,0>t&&(t+=1),t>1&&(t-=1)}return void 0===e&&(e={h:0,s:0,v:0}),e.h=t,e.s=a,e.v=l,e},copyIntoArray:function(e,t){void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b},lerpSelf:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},clone:function(){return(new THREE.Color).setRGB(this.r,this.g,this.b)}},THREE.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},THREE.__hsv={h:0,s:0,v:0},THREE.Math={clamp:function(e,t,a){return t>e?t:e>a?a:e},clampBottom:function(e,t){return t>e?t:e},mapLinear:function(e,t,a,r,i){return r+(e-t)*(i-r)/(a-t)},randomFloat16:function(){return(65280*Math.random()+255*Math.random())/65535},randomInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randomFloat:function(e,t){return e+Math.random()*(t-e)},randomFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return 0>e?-1:e>0?1:0},degToRad:function(e){return e*THREE.Math.__d2r},radToDeg:function(e){return e*THREE.Math.__r2d},isPowerOfTwo:function(e){return 0!==e&&0===(e&e-1)}},THREE.Math.__d2r=Math.PI/180,THREE.Math.__r2d=180/Math.PI,THREE.Quaternion=function(e,t,a,r){this.data=new Float32Array(4),this.data[0]=void 0!==e?e:0,this.data[1]=void 0!==t?t:0,this.data[2]=void 0!==a?a:0,this.data[3]=void 0!==r?r:1},THREE.Quaternion.prototype={constructor:THREE.Quaternion,set:function(e,t,a,r){var i=this.data;return i[0]=e,i[1]=t,i[2]=a,i[3]=r,this},setX:function(e){return this.data[0]=e,this},setY:function(e){return this.data[1]=e,this},setZ:function(e){return this.data[2]=e,this},setW:function(e){return this.data[3]=e,this},set x(e){this.data[0]=e},set y(e){this.data[1]=e},set z(e){this.data[2]=e},set w(e){this.data[3]=e},get x(){return this.data[0]},get y(){return this.data[1]},get z(){return this.data[2]},get w(){return this.data[3]},copy:function(e){return this.data.set(e.data),this},copyIntoArray:function(e,t){void 0===t&&(t=0),e.set(this.data,t)},setFromEuler:function(e,t){var a=this.data,r=e.data,i=Math.cos(r[0]/2),o=Math.cos(r[1]/2),n=Math.cos(r[2]/2),s=Math.sin(r[0]/2),l=Math.sin(r[1]/2),h=Math.sin(r[2]/2);return 0===t||void 0===t?(a[0]=s*o*n+i*l*h,a[1]=i*l*n-s*o*h,a[2]=i*o*h+s*l*n,a[3]=i*o*n-s*l*h):1===t?(a[0]=s*o*n+i*l*h,a[1]=i*l*n-s*o*h,a[2]=i*o*h-s*l*n,a[3]=i*o*n+s*l*h):2===t?(a[0]=s*o*n-i*l*h,a[1]=i*l*n+s*o*h,a[2]=i*o*h+s*l*n,a[3]=i*o*n-s*l*h):3===t?(a[0]=s*o*n-i*l*h,a[1]=i*l*n+s*o*h,a[2]=i*o*h-s*l*n,a[3]=i*o*n+s*l*h):4===t?(a[0]=s*o*n+i*l*h,a[1]=i*l*n+s*o*h,a[2]=i*o*h-s*l*n,a[3]=i*o*n-s*l*h):5===t&&(a[0]=s*o*n-i*l*h,a[1]=i*l*n-s*o*h,a[2]=i*o*h+s*l*n,a[3]=i*o*n+s*l*h),this},setFromAxisAngle:function(e,t){var a=this.data,r=e.data,i=t/2,o=Math.sin(i);return a[0]=r[0]*o,a[1]=r[1]*o,a[2]=r[2]*o,a[3]=Math.cos(i),this},setFromRotationMatrix:function(e){var t,a=this.data,r=e.elements,i=r[0],o=r[4],n=r[8],s=r[1],l=r[5],h=r[9],d=r[2],u=r[6],c=r[10],f=i+l+c;return f>0?(t=.5/Math.sqrt(f+1),a[0]=(u-h)*t,a[1]=(n-d)*t,a[2]=(s-o)*t,a[3]=.25/t):i>l&&i>c?(t=2*Math.sqrt(1+i-l-c),a[0]=.25*t,a[1]=(o+s)/t,a[2]=(n+d)/t,a[3]=(u-h)/t):l>c?(t=2*Math.sqrt(1+l-i-c),a[0]=(o+s)/t,a[1]=.25*t,a[2]=(h+u)/t,a[3]=(n-d)/t):(t=2*Math.sqrt(1+c-i-l),a[0]=(n+d)/t,a[1]=(h+u)/t,a[2]=.25*t,a[3]=(s-o)/t),this},inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){var e=this.data;return e[0]*=-1,e[1]*=-1,e[2]*=-1,this},lengthSq:function(){var e=this.data;return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]},length:function(){var e=this.data;return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3])},normalize:function(){var e=this.data,t=this.length();return 0===t?(e[0]=0,e[1]=0,e[2]=0,e[3]=1):(t=1/t,e[0]=e[0]*t,e[1]=e[1]*t,e[2]=e[2]*t,e[3]=e[3]*t),this},multiply:function(e,t){return this.copy(e),this.multiplySelf(t)},multiplySelf:function(e){var t=this.data,a=e.data,r=t[0],i=t[1],o=t[2],n=t[3],s=a[0],l=a[1],h=a[2],d=a[3];return t[0]=r*d+n*s+i*h-o*l,t[1]=i*d+n*l+o*s-r*h,t[2]=o*d+n*h+r*l-i*s,t[3]=n*d-r*s-i*l-o*h,this},multiplyVector3:function(e,t){t||(t=e);var a=this.data,r=e.data,i=t.data,o=r[0],n=r[1],s=r[2],l=a[0],h=a[1],d=a[2],u=a[3],c=u*o+h*s-d*n,f=u*n+d*o-l*s,p=u*s+l*n-h*o,m=-l*o-h*n-d*s;return i[0]=c*u+m*-l+f*-d-p*-h,i[1]=f*u+m*-h+p*-l-c*-d,i[2]=p*u+m*-d+c*-h-f*-l,t},slerpSelf:function(e,t){var a=this.data,r=e.data,i=a[0],o=a[1],n=a[2],s=a[3],l=r[0],h=r[1],d=r[2],u=r[3],c=s*u+i*l+o*h+n*d;if(0>c?(a[0]=-l,a[1]=-h,a[2]=-d,a[3]=-u,c=-c):this.copy(e),c>=1)return a[0]=i,a[1]=o,a[2]=n,a[3]=s,this;var f=Math.acos(c),p=Math.sqrt(1-c*c);if(Math.abs(p)<.001)return a[0]=.5*(i+a[0]),a[1]=.5*(o+a[1]),a[2]=.5*(n+a[2]),a[3]=.5*(s+a[3]),this;var m=Math.sin((1-t)*f)/p,v=Math.sin(t*f)/p;return a[0]=i*m+a[0]*v,a[1]=o*m+a[1]*v,a[2]=n*m+a[2]*v,a[3]=s*m+a[3]*v,this},equals:function(e){var t=this.data,a=e.data;return a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2]&&a[3]===t[3]},clone:function(){return(new THREE.Quaternion).copy(this)}},THREE.Quaternion.slerp=function(e,t,a,r){return a.copy(e).slerpSelf(t,r)},THREE.Vector2=function(e,t){this.data=new Float32Array(2),this.data[0]=void 0!==e?e:0,this.data[1]=void 0!==t?t:0},THREE.Vector2.prototype={constructor:THREE.Vector2,set:function(e,t){var a=this.data;return a[0]=e,a[1]=t,this},setX:function(e){return this.data[0]=e,this},setY:function(e){return this.data[1]=e,this},set x(e){this.data[0]=e},set y(e){this.data[1]=e},get x(){return this.data[0]},get y(){return this.data[1]},copy:function(e){return this.data.set(e.data),this},copyIntoArray:function(e,t){void 0===t&&(t=0),e.set(this.data,t)},addScalar:function(e){var t=this.data;return t[0]+=e,t[1]+=e,this},add:function(e,t){var a=this.data,r=e.data,i=t.data;return a[0]=r[0]+i[0],a[1]=r[1]+i[1],this},addSelf:function(e){var t=this.data,a=e.data;return t[0]+=a[0],t[1]+=a[1],this},sub:function(e,t){var a=this.data,r=e.data,i=t.data;return a[0]=r[0]-i[0],a[1]=r[1]-i[1],this},subSelf:function(e){var t=this.data,a=e.data;return t[0]-=a[0],t[1]-=a[1],this},multiplyScalar:function(e){var t=this.data;return t[0]*=e,t[1]*=e,this},divideScalar:function(e){var t=this.data;return 0!==e?(t[0]/=e,t[1]/=e):(t[0]=0,t[1]=0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){var t=this.data,a=e.data;return t[0]*a[0]+t[1]*a[1]},lengthSq:function(){var e=this.data;return e[0]*e[0]+e[1]*e[1]},length:function(){var e=this.data;return Math.sqrt(e[0]*e[0]+e[1]*e[1])},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.data,a=e.data,r=t[0]-a[0],i=t[1]-a[1];return r*r+i*i},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerpSelf:function(e,t){var a=this.data,r=e.data;return a[0]+=(r[0]-a[0])*t,a[1]+=(r[1]-a[1])*t,this},equals:function(e){var t=this.data,a=e.data;return a[0]===t[0]&&a[1]===t[1]},clone:function(){return(new THREE.Vector2).copy(this)}},THREE.Vector3=function(e,t,a){this.data=new Float32Array(3),this.data[0]=void 0!==e?e:0,this.data[1]=void 0!==t?t:0,this.data[2]=void 0!==a?a:0},THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(e,t,a){var r=this.data;return r[0]=e,r[1]=t,r[2]=a,this},setX:function(e){return this.data[0]=e,this},setY:function(e){return this.data[1]=e,this},setZ:function(e){return this.data[2]=e,this},set x(e){this.data[0]=e},set y(e){this.data[1]=e},set z(e){this.data[2]=e},get x(){return this.data[0]},get y(){return this.data[1]},get z(){return this.data[2]},copy:function(e){return this.data.set(e.data),this},copyIntoArray:function(e,t){void 0===t&&(t=0),e.set(this.data,t)},add:function(e,t){var a=this.data,r=e.data,i=t.data;return a[0]=r[0]+i[0],a[1]=r[1]+i[1],a[2]=r[2]+i[2],this},addSelf:function(e){var t=this.data,a=e.data;return t[0]+=a[0],t[1]+=a[1],t[2]+=a[2],this},addScalar:function(e){var t=this.data;return t[0]+=e,t[1]+=e,t[2]+=e,this},sub:function(e,t){var a=this.data,r=e.data,i=t.data;return a[0]=r[0]-i[0],a[1]=r[1]-i[1],a[2]=r[2]-i[2],this},subSelf:function(e){var t=this.data,a=e.data;return t[0]-=a[0],t[1]-=a[1],t[2]-=a[2],this},multiply:function(e,t){var a=this.data,r=e.data,i=t.data;return a[0]=r[0]*i[0],a[1]=r[1]*i[1],a[2]=r[2]*i[2],this},multiplySelf:function(e){var t=this.data,a=e.data;return t[0]*=a[0],t[1]*=a[1],t[2]*=a[2],this},multiplyScalar:function(e){var t=this.data;return t[0]*=e,t[1]*=e,t[2]*=e,this},divideSelf:function(e){var t=this.data,a=e.data;return t[0]/=a[0],t[1]/=a[1],t[2]/=a[2],this},divideScalar:function(e){var t=this.data;return 0!==e?(t[0]/=e,t[1]/=e,t[2]/=e):(t[0]=0,t[1]=0,t[2]=0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){var t=this.data,a=e.data;return t[0]*a[0]+t[1]*a[1]+t[2]*a[2]},lengthSq:function(){var e=this.data;return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},length:function(){var e=this.data;return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},lengthManhattan:function(){var e=this.data;return Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2])},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},cross:function(e,t){var a=this.data,r=e.data,i=t.data;return a[0]=r[1]*i[2]-r[2]*i[1],a[1]=r[2]*i[0]-r[0]*i[2],a[2]=r[0]*i[1]-r[1]*i[0],this},crossSelf:function(e){var t=this.data,a=e.data,r=t[0],i=t[1],o=t[2];return t[0]=i*a[2]-o*a[1],t[1]=o*a[0]-r*a[2],t[2]=r*a[1]-i*a[0],this},minSelf:function(e){var t=this.data,a=e.data;return t[0]=Math.min(t[0],a[0]),t[1]=Math.min(t[1],a[1]),t[2]=Math.min(t[2],a[2]),this},maxSelf:function(e){var t=this.data,a=e.data;return t[0]=Math.max(t[0],a[0]),t[1]=Math.max(t[1],a[1]),t[2]=Math.max(t[2],a[2]),this},angleTo:function(e){return Math.acos(this.dot(e)/this.length()/e.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.data,a=e.data,r=t[0]-a[0],i=t[1]-a[1],o=t[2]-a[2];return r*r+i*i+o*o},getPositionFromMatrix:function(e){var t=this.data;return t[0]=e.elements[12],t[1]=e.elements[13],t[2]=e.elements[14],this},setEulerFromRotationMatrix:function(e,t){"use asm";var a=this.data,r=THREE.Math.clamp,i=e.elements,o=i[0],n=i[4],s=i[8],l=i[1],h=i[5],d=i[9],u=i[2],c=i[6],f=i[10];return t===0||t===void 0?(a[1]=Math.asin(r(s,-1,1)),Math.abs(s)<.99999?(a[0]=Math.atan2(-d,f),a[2]=Math.atan2(-n,o)):(a[0]=Math.atan2(c,h),a[2]=0)):t===1?(a[0]=Math.asin(-r(d,-1,1)),Math.abs(d)<.99999?(a[1]=Math.atan2(s,f),a[2]=Math.atan2(l,h)):(a[1]=Math.atan2(-u,o),a[2]=0)):t===2?(a[0]=Math.asin(r(c,-1,1)),Math.abs(c)<.99999?(a[1]=Math.atan2(-u,f),a[2]=Math.atan2(-n,h)):(a[1]=0,a[2]=Math.atan2(l,o))):t===3?(a[1]=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(a[0]=Math.atan2(c,f),a[2]=Math.atan2(l,o)):(a[0]=0,a[2]=Math.atan2(-n,h))):t===4?(a[2]=Math.asin(r(l,-1,1)),Math.abs(l)<.99999?(a[0]=Math.atan2(-d,h),a[1]=Math.atan2(-u,o)):(a[0]=0,a[1]=Math.atan2(s,f))):t===5&&(a[2]=Math.asin(-r(n,-1,1)),Math.abs(n)<.99999?(a[0]=Math.atan2(c,h),a[1]=Math.atan2(s,o)):(a[0]=Math.atan2(-d,f),a[1]=0)),this},setEulerFromQuaternion:function(e,t){var a=THREE.Math.clamp,r=this.data,i=e.data[0],o=e.data[1],n=e.data[2],s=e.data[3],l=i*i,h=o*o,d=n*n,u=s*s;return 0===t||void 0===t?(r[0]=Math.atan2(2*(i*s-o*n),u-l-h+d),r[1]=Math.asin(a(2*(i*n+o*s),-1,1)),r[2]=Math.atan2(2*(n*s-i*o),u+l-h-d)):1===t?(r[0]=Math.asin(a(2*(i*s-o*n),-1,1)),r[1]=Math.atan2(2*(i*n+o*s),u-l-h+d),r[2]=Math.atan2(2*(i*o+n*s),u-l+h-d)):2===t?(r[0]=Math.asin(a(2*(i*s+o*n),-1,1)),r[1]=Math.atan2(2*(o*s-n*i),u-l-h+d),r[2]=Math.atan2(2*(n*s-i*o),u-l+h-d)):3===t?(r[0]=Math.atan2(2*(i*s+n*o),u-l-h+d),r[1]=Math.asin(a(2*(o*s-i*n),-1,1)),r[2]=Math.atan2(2*(i*o+n*s),u+l-h-d)):4===t?(r[0]=Math.atan2(2*(i*s-n*o),u-l+h-d),r[1]=Math.atan2(2*(o*s-i*n),u+l-h-d),r[2]=Math.asin(a(2*(i*o+n*s),-1,1))):5===t&&(r[0]=Math.atan2(2*(i*s+o*n),u-l+h-d),r[1]=Math.atan2(2*(i*n+o*s),u+l-h-d),r[2]=Math.asin(a(2*(n*s-i*o),-1,1))),this},getScaleFromMatrix:function(e){var t=this.data,a=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),r=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),i=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return t[0]=a,t[1]=r,t[2]=i,this},projectOnVector:function(e){var t=THREE.Vector3.__v1;t.copy(e),t.normalize();var a=this.dot(t);return this.copy(t),this.multiplyScalar(a),this},reflect:function(e){var t=THREE.Vector3.__v2;return t.copy(this),t.projectOnVector(e),t.multiplyScalar(2),this.sub(t,this),this},equals:function(e){var t=this.data,a=e.data;return a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2]},clone:function(){return(new THREE.Vector3).copy(this)}},THREE.Vector3.xAxis=new THREE.Vector3(1,0,0),THREE.Vector3.yAxis=new THREE.Vector3(0,1,0),THREE.Vector3.zAxis=new THREE.Vector3(0,0,1),THREE.Vector3.__v1=new THREE.Vector3,THREE.Vector3.__v2=new THREE.Vector3,THREE.Vector4=function(e,t,a,r){this.data=new Float32Array(4),this.data[0]=void 0!==e?e:0,this.data[1]=void 0!==t?t:0,this.data[2]=void 0!==a?a:0,this.data[3]=void 0!==r?r:1},THREE.Vector4.prototype={constructor:THREE.Vector4,set:function(e,t,a,r){var i=this.data;return i[0]=e,i[1]=t,i[2]=a,i[3]=r,this},setRGBA:function(e,t){var a=this.data;return a[0]=e.r,a[1]=e.g,a[2]=e.b,a[3]=t,this},setRGBAGamma:function(e,t){var a=this.data,r=e.r,i=e.g,o=e.b;return a[0]=r*r,a[1]=i*i,a[2]=o*o,a[3]=t,this},setX:function(e){return this.data[0]=e,this},setY:function(e){return this.data[1]=e,this},setZ:function(e){return this.data[2]=e,this},setW:function(e){return this.data[3]=e,this},set x(e){this.data[0]=e},set y(e){this.data[1]=e},set z(e){this.data[2]=e},set w(e){this.data[3]=e},get x(){return this.data[0]},get y(){return this.data[1]},get z(){return this.data[2]},get w(){return this.data[3]},copy:function(e){return this.data.set(e.data),this},copyIntoArray:function(e,t){void 0===t&&(t=0),e.set(this.data,t)},addScalar:function(e){var t=this.data;return t[0]+=e,t[1]+=e,t[2]+=e,t[3]+=e,this},add:function(e,t){var a=this.data,r=e.data,i=t.data;return a[0]=r[0]+i[0],a[1]=r[1]+i[1],a[2]=r[2]+i[2],a[3]=r[3]+i[3],this},addSelf:function(e){var t=this.data,a=e.data;return t[0]+=a[0],t[1]+=a[1],t[2]+=a[2],t[3]+=a[3],this},sub:function(e,t){var a=this.data,r=e.data,i=t.data;return a[0]=r[0]-i[0],a[1]=r[1]-i[1],a[2]=r[2]-i[2],a[3]=r[3]-i[3],this},subSelf:function(e){var t=this.data,a=e.data;return t[0]-=a[0],t[1]-=a[1],t[2]-=a[2],t[3]-=a[3],this},multiplyScalar:function(e){var t=this.data;return t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,this},divideScalar:function(e){var t=this.data;return 0!==e?(t[0]/=e,t[1]/=e,t[2]/=e,t[3]/=e):(t[0]=0,t[1]=0,t[2]=0,t[3]=0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){var t=this.data,a=e.data;return t[0]*a[0]+t[1]*a[1]+t[2]*a[2]+t[3]*a[3]},lengthSq:function(){var e=this.data;return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]},length:function(){var e=this.data;return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3])},lengthManhattan:function(){var e=this.data;return Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2])+Math.abs(e[3])},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerpSelf:function(e,t){var a=this.data,r=e.data;return a[0]+=(r[0]-a[0])*t,a[1]+=(r[1]-a[1])*t,a[2]+=(r[2]-a[2])*t,a[3]+=(r[3]-a[3])*t,this},equals:function(e){var t=this.data,a=e.data;return a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2]&&a[3]===t[3]},clone:function(){return(new THREE.Vector4).copy(this)},setAxisAngleFromQuaternion:function(e){var t=e.data[0],a=e.data[1],r=e.data[2],i=e.data[3];this.data[3]=2*Math.acos(i);var o=Math.sqrt(1-i*i);return 1e-4>o?(this.data[0]=1,this.data[1]=0,this.data[2]=0):(this.data[0]=t/o,this.data[1]=a/o,this.data[2]=r/o),this},setAxisAngleFromRotationMatrix:function(e){var t,a,r,i,o=.01,n=.1,s=e.elements,l=s[0],h=s[4],d=s[8],u=s[1],c=s[5],f=s[9],p=s[2],m=s[6],v=s[10];if(Math.abs(h-u)<o&&Math.abs(d-p)<o&&Math.abs(f-m)<o){if(Math.abs(h+u)<n&&Math.abs(d+p)<n&&Math.abs(f+m)<n&&Math.abs(l+c+v-3)<n)return this.set(1,0,0,0),this;t=Math.PI;var g=(l+1)/2,S=(c+1)/2,x=(v+1)/2,y=(h+u)/4,G=(d+p)/4,M=(f+m)/4;return g>S&&g>x?o>g?(a=0,r=.707106781,i=.707106781):(a=Math.sqrt(g),r=y/a,i=G/a):S>x?o>S?(a=.707106781,r=0,i=.707106781):(r=Math.sqrt(S),a=y/r,i=M/r):o>x?(a=.707106781,r=.707106781,i=0):(i=Math.sqrt(x),a=G/i,r=M/i),this.set(a,r,i,t),this}var w=Math.sqrt((m-f)*(m-f)+(d-p)*(d-p)+(u-h)*(u-h));return Math.abs(w)<.001&&(w=1),this.data[0]=(m-f)/w,this.data[1]=(d-p)/w,this.data[2]=(u-h)/w,this.data[3]=Math.acos((l+c+v-1)/2),this}},THREE.Matrix3=function(e,t,a,r,i,o,n,s,l){this.elements=new Float32Array(9),this.set(void 0!==e?e:1,t||0,a||0,r||0,void 0!==i?i:1,o||0,n||0,s||0,void 0!==l?l:1)},THREE.Matrix3.prototype={constructor:THREE.Matrix3,set:function(e,t,a,r,i,o,n,s,l){var h=this.elements;return h[0]=e,h[3]=t,h[6]=a,h[1]=r,h[4]=i,h[7]=o,h[2]=n,h[5]=s,h[8]=l,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},copy:function(e){return this.elements.set(e.elements),this},multiplyVector3:function(e){var t=this.elements,a=e.data,r=a[0],i=a[1],o=a[2];return a[0]=t[0]*r+t[3]*i+t[6]*o,a[1]=t[1]*r+t[4]*i+t[7]*o,a[2]=t[2]*r+t[5]*i+t[8]*o,e},multiplyVector3Array:function(e,t,a){var r=THREE.Matrix3.__v1,i=r.data;void 0===t&&(t=0),void 0===a&&(a=e.length);for(var o=t;a>o;o+=3)i[0]=e[o],i[1]=e[o+1],i[2]=e[o+2],this.multiplyVector3(r),e.set(i,o);return e},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},getInverse:function(e){var t=e.elements,a=this.elements;a[0]=t[10]*t[5]-t[6]*t[9],a[1]=-t[10]*t[1]+t[2]*t[9],a[2]=t[6]*t[1]-t[2]*t[5],a[3]=-t[10]*t[4]+t[6]*t[8],a[4]=t[10]*t[0]-t[2]*t[8],a[5]=-t[6]*t[0]+t[2]*t[4],a[6]=t[9]*t[4]-t[5]*t[8],a[7]=-t[9]*t[0]+t[1]*t[8],a[8]=t[5]*t[0]-t[1]*t[4];var r=t[0]*a[0]+t[1]*a[3]+t[2]*a[6];return 0===r?(console.warn("Matrix3.getInverse(): can't invert matrix, determinant is 0"),this.identity(),this):(this.multiplyScalar(1/r),this)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},getNormalMatrix:function(e){return this.getInverse(e).transpose(),this},clone:function(){return(new THREE.Matrix3).copy(this)}},THREE.Matrix3.__v1=new THREE.Vector3,THREE.Matrix4=function(e,t,a,r,i,o,n,s,l,h,d,u,c,f,p,m){this.elements=new Float32Array(16),this.set(void 0!==e?e:1,t||0,a||0,r||0,i||0,void 0!==o?o:1,n||0,s||0,l||0,h||0,void 0!==d?d:1,u||0,c||0,f||0,p||0,void 0!==m?m:1)},THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(e,t,a,r,i,o,n,s,l,h,d,u,c,f,p,m){var v=this.elements;return v[0]=e,v[4]=t,v[8]=a,v[12]=r,v[1]=i,v[5]=o,v[9]=n,v[13]=s,v[2]=l,v[6]=h,v[10]=d,v[14]=u,v[3]=c,v[7]=f,v[11]=p,v[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){return this.elements.set(e.elements),this},setRotationFromEuler:function(e,t){var a=this.elements,r=e.data,i=r[0],o=r[1],n=r[2],s=Math.cos(i),l=Math.sin(i),h=Math.cos(o),d=Math.sin(o),u=Math.cos(n),c=Math.sin(n);if(0===t||void 0===t){var f=s*u,p=s*c,m=l*u,v=l*c;a[0]=h*u,a[4]=-h*c,a[8]=d,a[1]=p+m*d,a[5]=f-v*d,a[9]=-l*h,a[2]=v-f*d,a[6]=m+p*d,a[10]=s*h}else if(1===t){var g=h*u,S=h*c,x=d*u,y=d*c;a[0]=g+y*l,a[4]=x*l-S,a[8]=s*d,a[1]=s*c,a[5]=s*u,a[9]=-l,a[2]=S*l-x,a[6]=y+g*l,a[10]=s*h}else if(2===t){var g=h*u,S=h*c,x=d*u,y=d*c;a[0]=g-y*l,a[4]=-s*c,a[8]=x+S*l,a[1]=S+x*l,a[5]=s*u,a[9]=y-g*l,a[2]=-s*d,a[6]=l,a[10]=s*h}else if(3===t){var f=s*u,p=s*c,m=l*u,v=l*c;a[0]=h*u,a[4]=m*d-p,a[8]=f*d+v,a[1]=h*c,a[5]=v*d+f,a[9]=p*d-m,a[2]=-d,a[6]=l*h,a[10]=s*h}else if(4===t){var G=s*h,M=s*d,w=l*h,X=l*d;a[0]=h*u,a[4]=X-G*c,a[8]=w*c+M,a[1]=c,a[5]=s*u,a[9]=-l*u,a[2]=-d*u,a[6]=M*c+w,a[10]=G-X*c}else if(5===t){var G=s*h,M=s*d,w=l*h,X=l*d;a[0]=h*u,a[4]=-c,a[8]=d*u,a[1]=G*c+X,a[5]=s*u,a[9]=M*c-w,a[2]=w*c-M,a[6]=l*u,a[10]=X*c+G}return this},setRotationFromQuaternion:function(e){var t=this.elements,a=e.data,r=a[0],i=a[1],o=a[2],n=a[3],s=r+r,l=i+i,h=o+o,d=r*s,u=r*l,c=r*h,f=i*l,p=i*h,m=o*h,v=n*s,g=n*l,S=n*h;return t[0]=1-(f+m),t[4]=u-S,t[8]=c+g,t[1]=u+S,t[5]=1-(d+m),t[9]=p-v,t[2]=c-g,t[6]=p+v,t[10]=1-(d+f),this},lookAt:function(e,t,a){var r=this.elements,i=THREE.Matrix4.__v1,o=THREE.Matrix4.__v2,n=THREE.Matrix4.__v3;n.sub(e,t).normalize(),0===n.length()&&(n.data[2]=1),i.cross(a,n).normalize(),0===i.length()&&(n.data[0]+=1e-4,i.cross(a,n).normalize()),o.cross(n,i);var s=i.data,l=o.data,h=n.data;return r[0]=s[0],r[4]=l[0],r[8]=h[0],r[1]=s[1],r[5]=l[1],r[9]=h[1],r[2]=s[2],r[6]=l[2],r[10]=h[2],this},addSelf:function(e){var t=this.elements,a=e.elements;return t[0]+=a[0],t[4]+=a[4],t[8]+=a[8],t[12]+=a[12],t[1]+=a[1],t[5]+=a[5],t[9]+=a[9],t[13]+=a[13],t[2]+=a[2],t[6]+=a[6],t[10]+=a[10],t[14]+=a[14],t[3]+=a[3],t[7]+=a[7],t[11]+=a[11],t[15]+=a[15],this},multiply:function(e,t){var a=e.elements,r=t.elements,i=this.elements,o=a[0],n=a[4],s=a[8],l=a[12],h=a[1],d=a[5],u=a[9],c=a[13],f=a[2],p=a[6],m=a[10],v=a[14],g=a[3],S=a[7],x=a[11],y=a[15],G=r[0],M=r[4],w=r[8],X=r[12],D=r[1],C=r[5],_=r[9],b=r[13],A=r[2],T=r[6],P=r[10],L=r[14],E=r[3],F=r[7],R=r[11],U=r[15];return i[0]=o*G+n*D+s*A+l*E,i[4]=o*M+n*C+s*T+l*F,i[8]=o*w+n*_+s*P+l*R,i[12]=o*X+n*b+s*L+l*U,i[1]=h*G+d*D+u*A+c*E,i[5]=h*M+d*C+u*T+c*F,i[9]=h*w+d*_+u*P+c*R,i[13]=h*X+d*b+u*L+c*U,i[2]=f*G+p*D+m*A+v*E,i[6]=f*M+p*C+m*T+v*F,i[10]=f*w+p*_+m*P+v*R,i[14]=f*X+p*b+m*L+v*U,i[3]=g*G+S*D+x*A+y*E,i[7]=g*M+S*C+x*T+y*F,i[11]=g*w+S*_+x*P+y*R,i[15]=g*X+S*b+x*L+y*U,this},multiplySelf:function(e){return this.multiply(this,e)},multiplyToArray:function(e,t,a){return this.multiply(e,t),a.set(this.elements),this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){var t=this.elements,a=e.data,r=a[0],i=a[1],o=a[2],n=1/(t[3]*r+t[7]*i+t[11]*o+t[15]);return a[0]=(t[0]*r+t[4]*i+t[8]*o+t[12])*n,a[1]=(t[1]*r+t[5]*i+t[9]*o+t[13])*n,a[2]=(t[2]*r+t[6]*i+t[10]*o+t[14])*n,e},multiplyVector3Array:function(e,t,a){var r=THREE.Matrix4.__v1,i=r.data;void 0===t&&(t=0),void 0===a&&(a=e.length);for(var o=t;a>o;o+=3)i[0]=e[o],i[1]=e[o+1],i[2]=e[o+2],this.multiplyVector3(r),e.set(i,o);return e},rotateAxis:function(e){var t=this.elements,a=e.data,r=a[0],i=a[1],o=a[2];return a[0]=r*t[0]+i*t[4]+o*t[8],a[1]=r*t[1]+i*t[5]+o*t[9],a[2]=r*t[2]+i*t[6]+o*t[10],e.normalize(),e},determinant:function(){var e=this.elements,t=e[0],a=e[4],r=e[8],i=e[12],o=e[1],n=e[5],s=e[9],l=e[13],h=e[2],d=e[6],u=e[10],c=e[14],f=e[3],p=e[7],m=e[11],v=e[15];
return f*(+i*s*d-r*l*d-i*n*u+a*l*u+r*n*c-a*s*c)+p*(+t*s*c-t*l*u+i*o*u-r*o*c+r*l*h-i*s*h)+m*(+t*l*d-t*n*c-i*o*d+a*o*c+i*n*h-a*l*h)+v*(-r*n*h-t*s*d+t*n*u+r*o*d-a*o*u+a*s*h)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArray:function(e){return e.set(this.elements),e},flattenToArrayOffset:function(e,t){return e.set(this.elements,t),e},getPosition:function(){var e=this.elements;return THREE.Matrix4.__v1.set(e[12],e[13],e[14])},setPosition:function(e){return this.elements.set(e.data,12),this},setPositionXYZ:function(e,t,a){var r=this.elements;return r[12]=e,r[13]=t,r[14]=a,this},getColumnX:function(){var e=this.elements;return THREE.Matrix4.__v1.set(e[0],e[1],e[2])},getColumnY:function(){var e=this.elements;return THREE.Matrix4.__v1.set(e[4],e[5],e[6])},getColumnZ:function(){var e=this.elements;return THREE.Matrix4.__v1.set(e[8],e[9],e[10])},getInverse:function(e){var t=this.elements,a=e.elements,r=a[0],i=a[4],o=a[8],n=a[12],s=a[1],l=a[5],h=a[9],d=a[13],u=a[2],c=a[6],f=a[10],p=a[14],m=a[3],v=a[7],g=a[11],S=a[15];t[0]=h*p*v-d*f*v+d*c*g-l*p*g-h*c*S+l*f*S,t[4]=n*f*v-o*p*v-n*c*g+i*p*g+o*c*S-i*f*S,t[8]=o*d*v-n*h*v+n*l*g-i*d*g-o*l*S+i*h*S,t[12]=n*h*c-o*d*c-n*l*f+i*d*f+o*l*p-i*h*p,t[1]=d*f*m-h*p*m-d*u*g+s*p*g+h*u*S-s*f*S,t[5]=o*p*m-n*f*m+n*u*g-r*p*g-o*u*S+r*f*S,t[9]=n*h*m-o*d*m-n*s*g+r*d*g+o*s*S-r*h*S,t[13]=o*d*u-n*h*u+n*s*f-r*d*f-o*s*p+r*h*p,t[2]=l*p*m-d*c*m+d*u*v-s*p*v-l*u*S+s*c*S,t[6]=n*c*m-i*p*m-n*u*v+r*p*v+i*u*S-r*c*S,t[10]=i*d*m-n*l*m+n*s*v-r*d*v-i*s*S+r*l*S,t[14]=n*l*u-i*d*u-n*s*c+r*d*c+i*s*p-r*l*p,t[3]=h*c*m-l*f*m-h*u*v+s*f*v+l*u*g-s*c*g,t[7]=i*f*m-o*c*m+o*u*v-r*f*v-i*u*g+r*c*g,t[11]=o*l*m-i*h*m-o*s*v+r*h*v+i*s*g-r*l*g,t[15]=i*h*u-o*l*u+o*s*c-r*h*c-i*s*f+r*l*f;var x=a[0]*t[0]+a[1]*t[4]+a[2]*t[8]+a[3]*t[12];if(0===x){var y="Matrix4.getInverse(): can't invert matrix, determinant is 0";return console.warn(y),this.identity(),this}return this.multiplyScalar(1/x),this},compose:function(e,t,a){var r=this.elements;r[3]=0,r[7]=0,r[11]=0,r[15]=1,this.setRotationFromQuaternion(t);var i=a.data,o=i[0],n=i[1],s=i[2];return r[0]*=o,r[1]*=o,r[2]*=o,r[4]*=n,r[5]*=n,r[6]*=n,r[8]*=s,r[9]*=s,r[10]*=s,r.set(e.data,12),this},decompose:function(e,t,a){var r=this.elements,i=THREE.Matrix4.__v1,o=THREE.Matrix4.__v2,n=THREE.Matrix4.__v3;i.set(r[0],r[1],r[2]),o.set(r[4],r[5],r[6]),n.set(r[8],r[9],r[10]),e=e instanceof THREE.Vector3?e:new THREE.Vector3,t=t instanceof THREE.Quaternion?t:new THREE.Quaternion,a=a instanceof THREE.Vector3?a:new THREE.Vector3;var s=a.data,l=e.data;s[0]=i.length(),s[1]=o.length(),s[2]=n.length(),l[0]=r[12],l[1]=r[13],l[2]=r[14];var h=THREE.Matrix4.__m1;return h.copy(this),h.elements[0]/=s[0],h.elements[1]/=s[0],h.elements[2]/=s[0],h.elements[4]/=s[1],h.elements[5]/=s[1],h.elements[6]/=s[1],h.elements[8]/=s[2],h.elements[9]/=s[2],h.elements[10]/=s[2],t.setFromRotationMatrix(h),[e,t,a]},extractPosition:function(e){var t=this.elements,a=e.elements;return t[12]=a[12],t[13]=a[13],t[14]=a[14],this},extractRotation:function(e){var t=this.elements,a=e.elements,r=THREE.Matrix4.__v1,i=1/r.set(a[0],a[1],a[2]).length(),o=1/r.set(a[4],a[5],a[6]).length(),n=1/r.set(a[8],a[9],a[10]).length();return t[0]=a[0]*i,t[1]=a[1]*i,t[2]=a[2]*i,t[4]=a[4]*o,t[5]=a[5]*o,t[6]=a[6]*o,t[8]=a[8]*n,t[9]=a[9]*n,t[10]=a[10]*n,this},translate:function(e){var t=this.elements,a=e.data,r=a[0],i=a[1],o=a[2];return t[12]=t[0]*r+t[4]*i+t[8]*o+t[12],t[13]=t[1]*r+t[5]*i+t[9]*o+t[13],t[14]=t[2]*r+t[6]*i+t[10]*o+t[14],t[15]=t[3]*r+t[7]*i+t[11]*o+t[15],this},rotateX:function(e){var t=this.elements,a=t[4],r=t[5],i=t[6],o=t[7],n=t[8],s=t[9],l=t[10],h=t[11],d=Math.cos(e),u=Math.sin(e);return t[4]=d*a+u*n,t[5]=d*r+u*s,t[6]=d*i+u*l,t[7]=d*o+u*h,t[8]=d*n-u*a,t[9]=d*s-u*r,t[10]=d*l-u*i,t[11]=d*h-u*o,this},rotateY:function(e){var t=this.elements,a=t[0],r=t[1],i=t[2],o=t[3],n=t[8],s=t[9],l=t[10],h=t[11],d=Math.cos(e),u=Math.sin(e);return t[0]=d*a-u*n,t[1]=d*r-u*s,t[2]=d*i-u*l,t[3]=d*o-u*h,t[8]=d*n+u*a,t[9]=d*s+u*r,t[10]=d*l+u*i,t[11]=d*h+u*o,this},rotateZ:function(e){var t=this.elements,a=t[0],r=t[1],i=t[2],o=t[3],n=t[4],s=t[5],l=t[6],h=t[7],d=Math.cos(e),u=Math.sin(e);return t[0]=d*a+u*n,t[1]=d*r+u*s,t[2]=d*i+u*l,t[3]=d*o+u*h,t[4]=d*n-u*a,t[5]=d*s-u*r,t[6]=d*l-u*i,t[7]=d*h-u*o,this},rotateByAxis:function(e,t){var a=this.elements,r=e.data,i=r[0],o=r[1],n=r[2];if(1===i&&0===o&&0===n)return this.rotateX(t);if(0===i&&1===o&&0===n)return this.rotateY(t);if(0===i&&0===o&&1===n)return this.rotateZ(t);var s=Math.sqrt(i*i+o*o+n*n);i/=s,o/=s,n/=s;var l=i*i,h=o*o,d=n*n,u=Math.cos(t),c=Math.sin(t),f=1-u,p=i*o*f,m=i*n*f,v=o*n*f,g=i*c,S=o*c,x=n*c,y=l+(1-l)*u,G=p+x,M=m-S,w=p-x,X=h+(1-h)*u,D=v+g,C=m+S,_=v-g,b=d+(1-d)*u,A=a[0],T=a[1],P=a[2],L=a[3],E=a[4],F=a[5],R=a[6],U=a[7],N=a[8],I=a[9],B=a[10],O=a[11];return a[0]=y*A+G*E+M*N,a[1]=y*T+G*F+M*I,a[2]=y*P+G*R+M*B,a[3]=y*L+G*U+M*O,a[4]=w*A+X*E+D*N,a[5]=w*T+X*F+D*I,a[6]=w*P+X*R+D*B,a[7]=w*L+X*U+D*O,a[8]=C*A+_*E+b*N,a[9]=C*T+_*F+b*I,a[10]=C*P+_*R+b*B,a[11]=C*L+_*U+b*O,this},scale:function(e){var t=this.elements,a=e.data,r=a[0],i=a[1],o=a[2];return t[0]*=r,t[4]*=i,t[8]*=o,t[1]*=r,t[5]*=i,t[9]*=o,t[2]*=r,t[6]*=i,t[10]*=o,t[3]*=r,t[7]*=i,t[11]*=o,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],a=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(a,r)))},makeTranslation:function(e){return this.set(1,0,0,e.data[0],0,1,0,e.data[1],0,0,1,e.data[2],0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),a=Math.sin(e);return this.set(1,0,0,0,0,t,-a,0,0,a,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),a=Math.sin(e);return this.set(t,0,a,0,0,1,0,0,-a,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),a=Math.sin(e);return this.set(t,-a,0,0,a,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var a=e.data,r=Math.cos(t),i=Math.sin(t),o=1-r,n=a[0],s=a[1],l=a[2],h=o*n,d=o*s;return this.set(h*n+r,h*s-i*l,h*l+i*s,0,h*s+i*l,d*s+r,d*l-i*n,0,h*l-i*s,d*l+i*n,o*l*l+r,0,0,0,0,1),this},makeScale:function(e){var t=e.data;return this.set(t[0],0,0,0,0,t[1],0,0,0,0,t[2],0,0,0,0,1),this},makeFrustum:function(e,t,a,r,i,o){var n=this.elements,s=2*i/(t-e),l=2*i/(r-a),h=(t+e)/(t-e),d=(r+a)/(r-a),u=-(o+i)/(o-i),c=-2*o*i/(o-i);return n[0]=s,n[4]=0,n[8]=h,n[12]=0,n[1]=0,n[5]=l,n[9]=d,n[13]=0,n[2]=0,n[6]=0,n[10]=u,n[14]=c,n[3]=0,n[7]=0,n[11]=-1,n[15]=0,this},makePerspective:function(e,t,a,r){var i=a*Math.tan(THREE.Math.degToRad(.5*e)),o=-i,n=o*t,s=i*t;return this.makeFrustum(n,s,o,i,a,r)},makeOrthographic:function(e,t,a,r,i,o){var n=this.elements,s=t-e,l=a-r,h=o-i,d=(t+e)/s,u=(a+r)/l,c=(o+i)/h;return n[0]=2/s,n[4]=0,n[8]=0,n[12]=-d,n[1]=0,n[5]=2/l,n[9]=0,n[13]=-u,n[2]=0,n[6]=0,n[10]=-2/h,n[14]=-c,n[3]=0,n[7]=0,n[11]=0,n[15]=1,this},clone:function(){return(new THREE.Matrix4).copy(this)}},THREE.Matrix4.__v1=new THREE.Vector3,THREE.Matrix4.__v2=new THREE.Vector3,THREE.Matrix4.__v3=new THREE.Vector3,THREE.Matrix4.__m1=new THREE.Matrix4,THREE.Matrix4.__m2=new THREE.Matrix4,THREE.Frustum=function(){this.planes=[new THREE.Plane,new THREE.Plane,new THREE.Plane,new THREE.Plane,new THREE.Plane,new THREE.Plane]},THREE.Frustum.prototype.setFromMatrix=function(e){var t=this.planes,a=e.elements,r=a[0],i=a[1],o=a[2],n=a[3],s=a[4],l=a[5],h=a[6],d=a[7],u=a[8],c=a[9],f=a[10],p=a[11],m=a[12],v=a[13],g=a[14],S=a[15];t[0].setComponents(n-r,d-s,p-u,S-m),t[1].setComponents(n+r,d+s,p+u,S+m),t[2].setComponents(n+i,d+l,p+c,S+v),t[3].setComponents(n-i,d-l,p-c,S-v),t[4].setComponents(n-o,d-h,p-f,S-g),t[5].setComponents(n+o,d+h,p+f,S+g);for(var x=0;6>x;x++)t[x].normalize()},THREE.Frustum.prototype.contains=function(e,t){for(var a=this.planes,r=e.matrixWorld,i=r.getPosition(),o=-t.boundingSphere.radius*r.getMaxScaleOnAxis(),n=0,s=0;6>s;s++)if(n=a[s].distanceToPoint(i),o>=n)return!1;return!0},THREE.Plane=function(e,t){this.normal=void 0!==e?e.clone():THREE.Vector3.xAxis.clone(),this.constant=void 0!==t?t:0},THREE.Plane.prototype={constructor:THREE.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,a,r){return this.normal.set(e,t,a),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},coplanarPoint:function(e){var t=e||new THREE.Vector3;return t.copy(this.normal),t.multiplyScalar(-this.constant),t},applyMatrix4:function(e,t){var a=THREE.Plane.__v1,r=THREE.Plane.__v2;t=t||THREE.Plane.__m1.getNormalMatrix(e);var i=a.copy(this.normal);t.multiplyVector3(i);var o=this.coplanarPoint(r);return e.multiplyVector3(o),this.setFromNormalAndCoplanarPoint(i,o),this},clone:function(){return(new THREE.Plane).copy(this)}},THREE.Plane.__v1=new THREE.Vector3,THREE.Plane.__v2=new THREE.Vector3,THREE.Plane.__m1=new THREE.Matrix3,THREE.Box3=function(e,t){this.min=void 0!==e?e.clone():new THREE.Vector3(1/0,1/0,1/0),this.max=void 0!==t?t.clone():new THREE.Vector3(-1/0,-1/0,-1/0)},THREE.Box3.prototype={constructor:THREE.Box3,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},add:function(e){this.min.minSelf(e.min),this.max.maxSelf(e.max)},clone:function(){return(new THREE.Box3).copy(this)}},THREE.Sphere=function(e,t){this.center=void 0===e?new THREE.Vector3:e.clone(),this.radius=void 0===t?0:t},THREE.Sphere.prototype={constructor:THREE.Sphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},clone:function(){return(new THREE.Sphere).copy(this)}},THREE.Clock=function(e){this.autoStart=void 0!==e?e:!0,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1},THREE.Clock.prototype.start=function(){this.startTime=Date.now(),this.oldTime=this.startTime,this.running=!0},THREE.Clock.prototype.stop=function(){this.getElapsedTime(),this.running=!1},THREE.Clock.prototype.getElapsedTime=function(){return this.getDelta(),this.elapsedTime},THREE.Clock.prototype.getDelta=function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=Date.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e},THREE.Animation=function(e,t){this.id=THREE.AnimationIdCount++,this.root=e,this.data=t,this.hierarchy=[],this.boneIndexMap={};for(var a=0;a<e.bones.length;a++){var r=e.bones[a];this.hierarchy.push(r),this.boneIndexMap[r.name]=a}this.initData(t),this.currentTime=0,this.timeScale=1,this.weight=1,this.direction=1,this.directionBackwards=!1,this.isPlaying=!1,this.isPaused=!0,this.loop=!0},THREE.Animation.prototype.play=function(e,t){if(this.isPlaying===!1){this.isPlaying=!0,this.loop=void 0!==e?e:!0,this.currentTime=void 0!==t?t:0;var a,r,i=this.hierarchy.length;for(a=0;i>a;a++){r=this.hierarchy[a],r.useQuaternion=!0,r.matrixAutoUpdate=!0,void 0===r.animationCache&&(r.animationCache={});var o;void 0===r.animationCache[this.id]?(r.animationCache[this.id]={},o=r.animationCache[this.id],o.prevKey={pos:0,rot:0,scl:0},o.nextKey={pos:0,rot:0,scl:0},o.originalMatrix=r instanceof THREE.Bone?r.skinMatrix:r.matrix,o.oldMatrix=new THREE.Matrix4):o=r.animationCache[this.id];var n=o.prevKey,s=o.nextKey;n.pos=this.data.hierarchy[a].keys[0],n.rot=this.data.hierarchy[a].keys[0],n.scl=this.data.hierarchy[a].keys[0],this.directionBackwards?(s.pos=this.getPrevKeyWith("pos",a,-1),s.rot=this.getPrevKeyWith("rot",a,-1),s.scl=this.getPrevKeyWith("scl",a,-1)):(s.pos=this.getNextKeyWith("pos",a,1),s.rot=this.getNextKeyWith("rot",a,1),s.scl=this.getNextKeyWith("scl",a,1))}this.update(0)}this.isPaused=!1},THREE.Animation.prototype.setWeight=function(e){this.weight=e},THREE.Animation.prototype.setDirectionForward=function(){this.direction=1,this.directionBackwards=!1},THREE.Animation.prototype.setDirectionBackward=function(){this.direction=-1,this.directionBackwards=!0},THREE.Animation.prototype.pause=function(){this.isPaused=!this.isPaused},THREE.Animation.prototype.stop=function(){this.isPlaying=!1,this.isPaused=!1},THREE.Animation.prototype.update=function(e){if(this.isPlaying!==!1){var t,a,r,i,o,n,s,l,h,d,u,c,f=["pos","rot","scl"],p=this.currentTime+e*this.timeScale*this.direction,m=p%this.data.length;this.directionBackwards&&0>m&&(m+=this.data.length);var v=m;this.currentTime=m;for(var g=0,S=this.hierarchy.length;S>g;g++){l=this.hierarchy[g],h=l.animationCache[this.id],l.matrixAutoUpdate=!1,l.firstAnimationFlag||h.oldMatrix.copy(l.matrix);for(var x=0;3>x;x++){if(t=f[x],n=h.prevKey[t],s=h.nextKey[t],this.directionBackwards){if(s.time>p){if(v>p){if(!this.loop)return void this.stop();var y=this.data.hierarchy[g].keys;for(n=this.data.hierarchy[g].keys[y.length-1],s=this.getPrevKeyWith(t,g,-1);s.time>v;)n=s,s=this.getPrevKeyWith(t,g,s.index-1)}else do n=s,s=this.getPrevKeyWith(t,g,s.index-1);while(s.time>v);h.prevKey[t]=n,h.nextKey[t]=s}a=(n.time-v)/(n.time-s.time)}else{if(s.time<=p){if(p>v){if(!this.loop)return void this.stop();for(n=this.data.hierarchy[g].keys[0],s=this.getNextKeyWith(t,g,1);s.time<v;)n=s,s=this.getNextKeyWith(t,g,s.index+1)}else do n=s,s=this.getNextKeyWith(t,g,s.index+1);while(s.time<v);h.prevKey[t]=n,h.nextKey[t]=s}a=(v-n.time)/(s.time-n.time)}i=n[t],o=s[t],(0>a||a>1)&&(console.log("THREE.Animation.update: Warning! Scale out of bounds:"+a+" on bone "+g),a=0>a?0:1),"pos"===t?(r=l.position,d=i[0]+(o[0]-i[0])*a,u=i[1]+(o[1]-i[1])*a,c=i[2]+(o[2]-i[2])*a,r.set(d,u,c)):"rot"===t?THREE.Quaternion.slerp(i,o,l.quaternion,a):"scl"===t&&(r=l.scale,d=i[0]+(o[0]-i[0])*a,u=i[1]+(o[1]-i[1])*a,c=i[2]+(o[2]-i[2])*a,r.set(d,u,c))}l.updateMatrix(),l.matrix.multiplyScalar(this.weight),l.firstAnimationFlag||l.matrix.addSelf(h.oldMatrix),l.firstAnimationFlag=!1}}},THREE.Animation.prototype.getNextKeyWith=function(e,t,a){var r=this.data.hierarchy[t].keys;for(a%=r.length;a<r.length;a++)if(void 0!==r[a][e])return r[a];return this.data.hierarchy[t].keys[0]},THREE.Animation.prototype.getPrevKeyWith=function(e,t,a){var r=this.data.hierarchy[t].keys;for(a=a>=0?a:a+r.length;a>=0;a--)if(void 0!==r[a][e])return r[a];return this.data.hierarchy[t].keys[r.length-1]},THREE.Animation.prototype.initData=function(e){if(e.initialized!==!0){for(var t=e.hierarchy,a=0;a<t.length;a++){for(var r=t[a],i=0;i<r.keys.length;i++)if(r.keys[i].time<0&&(r.keys[i].time=0),void 0!==r.keys[i].rot&&!(r.keys[i].rot instanceof THREE.Quaternion)){var o=r.keys[i].rot;r.keys[i].rot=new THREE.Quaternion(o[0],o[1],o[2],o[3])}for(var i=1;i<r.keys.length;i++)r.keys[i].time===r.keys[i-1].time&&(r.keys.splice(i,1),i--);for(var i=0;i<r.keys.length;i++)r.keys[i].index=i}e.initialized=!0}},THREE.Animation.prototype.findRoot=function(){for(var e,t=this.data.hierarchy,a=0,r=t.length;r>a;a++){var i=t[a];if(-1===i.parent){e=i;break}}return e},THREE.Animation.prototype.offsetPositionKeysForBone=function(e,t){for(var a=this.boneIndexMap[e],r=this.data.hierarchy[a].keys,i=0,o=r.length;o>i;i++){var n=r[i],s=n.pos;void 0!==s&&(s[0]+=t.x,s[1]+=t.y,s[2]+=t.z)}},THREE.Animation.prototype.offsetRotationKeysForBone=function(e,t){for(var a=this.boneIndexMap[e],r=this.data.hierarchy[a].keys,i=0,o=r.length;o>i;i++){var n=r[i],s=n.rot;void 0!==s&&s.multiplySelf(t)}},THREE.Animation.prototype.setKeysComponentValue=function(e,t,a,r){for(var i=0,o=e.keys.length;o>i;i++){var n=e.keys[i];n[t]&&(n[t][a]=r)}},THREE.Animation.prototype.copyKeysToBoneRange=function(e,t,a){for(var r=this.data.hierarchy,i=e.data.hierarchy,o=t;a>o;o++)for(var n=i[o],s=r[o],l=0,h=n.keys.length;h>l;l++){var d=n.keys[l];s.keys[l]=d}},THREE.AnimationIdCount=0,THREE.Geometry=function(){this.id=THREE.GeometryIdCount++,this.attributes={},this.attributesList=[],this.virtualAttributes={},this.virtualAttributesList=[],this.numPrimitives=0,this.numVertices=0,this.dynamic=!1,this.offsets=[],this.boundingBox=null,this.boundingSphere=null,this.morphTargets=[],this.morphColors=[]},THREE.Geometry.prototype={constructor:THREE.Geometry,addIndex:function(e,t,a){var r=new t(this.numPrimitives*a);this.addAttributeArray(e,r,a)},addAttribute:function(e,t,a){var r=new t(this.numVertices*a);this.addAttributeArray(e,r,a)},addVirtualAttribute:function(e){var t={name:e,mapped:null};this.virtualAttributes[e]=t,this.virtualAttributesList.push(t)},addUnattachedAttribute:function(e,t,a){var r=new t(this.numVertices*a),i={name:e,itemSize:a,numItems:r.length,array:r,buffer:null,type:THREE.paramTypedArrayToXG(r),typeSize:r.BYTES_PER_ELEMENT,needsUpdate:!0,attached:!1};this.attributes[e]=i,this.attributesList.push(i)},addAttributeArray:function(e,t,a){var r={name:e,itemSize:a,numItems:t.length,array:t,buffer:null,type:THREE.paramTypedArrayToXG(t),typeSize:t.BYTES_PER_ELEMENT,needsUpdate:!0,attached:!0};this.attributes[e]=r,this.attributesList.push(r)},setAttributeValue:function(e,t,a,r){var i=this.attributes[e];if(i){if(void 0===a&&(a=0),void 0===r&&(r=i.array.length),t instanceof THREE.Color||t instanceof THREE.Vector2||t instanceof THREE.Vector3||t instanceof THREE.Vector4||t instanceof THREE.Quaternion)for(var o=a;r>o;o+=i.itemSize)t.copyIntoArray(i.array,o);i.needsUpdate=!0}},applyMatrix:function(e){var t,a;if(this.attributes.position&&(t=this.attributes.position.array),this.attributes.normal&&(a=this.attributes.normal.array),void 0!==t&&(e.multiplyVector3Array(t),this.attributes.position.needsUpdate=!0),void 0!==a){var r=new THREE.Matrix3;r.getInverse(e).transpose(),r.multiplyVector3Array(a),this.normalizeAttribute("normal"),this.attributes.normal.needsUpdate=!0}},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);var e=this.attributes.position.array;if(e){var t,a,r,i=this.boundingBox,o=i.min.data,n=i.max.data;e.length>=3&&(o[0]=n[0]=e[0],o[1]=n[1]=e[1],o[2]=n[2]=e[2]);for(var s=3,l=e.length;l>s;s+=3)t=e[s],a=e[s+1],r=e[s+2],t<o[0]?o[0]=t:t>n[0]&&(n[0]=t),a<o[1]?o[1]=a:a>n[1]&&(n[1]=a),r<o[2]?o[2]=r:r>n[2]&&(n[2]=r)}(void 0===e||0===e.length)&&(this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0))},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere);var e=this.attributes.position.array;if(e){for(var t,a,r,i,o=0,n=0,s=e.length;s>n;n+=3)a=e[n],r=e[n+1],i=e[n+2],t=a*a+r*r+i*i,t>o&&(o=t);this.boundingSphere.radius=Math.sqrt(o)}},computeVertexNormals:function(){this.computeNormals("position","normal")},computeNormals:function(e,t){if(this.attributes[e]){var a,r,i,o,n=this.attributes[e].array.length;if(void 0===this.attributes[t])this.addAttributeArray(t,new Float32Array(n),3);else for(a=0,r=this.attributes[t].array.length;r>a;a++)this.attributes[t].array[a]=0;var s,l,h,d,u,c,f=this.attributes[e].array,p=this.attributes[t].array,m=new THREE.Vector3,v=new THREE.Vector3,g=new THREE.Vector3,S=new THREE.Vector3,x=new THREE.Vector3,y=S.data;if(this.attributes.index){var G=this.attributes.index.array,M=this.offsets;for(i=0,o=M.length;o>i;++i){var w=M[i].start,X=M[i].count,D=M[i].index;for(a=w,r=w+X;r>a;a+=3)s=D+G[a],l=D+G[a+1],h=D+G[a+2],d=f[3*s],u=f[3*s+1],c=f[3*s+2],m.set(d,u,c),d=f[3*l],u=f[3*l+1],c=f[3*l+2],v.set(d,u,c),d=f[3*h],u=f[3*h+1],c=f[3*h+2],g.set(d,u,c),S.sub(g,v),x.sub(m,v),S.crossSelf(x),p[3*s]+=y[0],p[3*s+1]+=y[1],p[3*s+2]+=y[2],p[3*l]+=y[0],p[3*l+1]+=y[1],p[3*l+2]+=y[2],p[3*h]+=y[0],p[3*h+1]+=y[1],p[3*h+2]+=y[2]}}else for(a=0,r=f.length;r>a;a+=9)d=f[a],u=f[a+1],c=f[a+2],m.set(d,u,c),d=f[a+3],u=f[a+4],c=f[a+5],v.set(d,u,c),d=f[a+6],u=f[a+7],c=f[a+8],g.set(d,u,c),S.sub(g,v),x.sub(m,v),S.crossSelf(x),p[a]=y[0],p[a+1]=y[1],p[a+2]=y[2],p[a+3]=y[0],p[a+4]=y[1],p[a+5]=y[2],p[a+6]=y[0],p[a+7]=y[1],p[a+8]=y[2];this.normalizeAttribute(t),this.attributes[t].needsUpdate=!0}},normalizeAttribute:function(e,t,a){var r=this.attributes[e];if(r){var i=r.array;void 0===t&&(t=0),void 0===a&&(a=i.length);for(var o,n,s,l,h=t;a>h;h+=3)o=i[h],n=i[h+1],s=i[h+2],l=1/Math.sqrt(o*o+n*n+s*s),i[h]*=l,i[h+1]*=l,i[h+2]*=l}},scaleAttribute:function(e,t,a,r,i,o){var n=this.attributes[e];if(n){var s=n.array,l=n.itemSize;void 0===i&&(i=0),void 0===o&&(o=s.length);for(var h=i;o>h;h+=l)s[h]*=t,l>1&&void 0!==a&&(s[h+1]*=a),l>2&&void 0!==r&&(s[h+2]*=r)}},computeMorphNormals:function(){for(var e=0,t=this.morphTargets.length;t>e;e++){var a="mp_"+e,r="mn_"+e;this.computeNormals(a,r)}},computeTangents:function(){function e(e,t,a){u=r[3*e],c=r[3*e+1],f=r[3*e+2],p=r[3*t],m=r[3*t+1],v=r[3*t+2],g=r[3*a],S=r[3*a+1],x=r[3*a+2],y=o[2*e],G=o[2*e+1],M=o[2*t],w=o[2*t+1],X=o[2*a],D=o[2*a+1],C=p-u,_=g-u,b=m-c,A=S-c,T=v-f,P=x-f,L=M-y,E=X-y,F=w-G,R=D-G,U=1/(L*R-E*F),H.set((R*C-F*_)*U,(R*b-F*A)*U,(R*T-F*P)*U),W.set((L*_-E*C)*U,(L*A-E*b)*U,(L*P-E*T)*U),l[e].addSelf(H),l[t].addSelf(H),l[a].addSelf(H),h[e].addSelf(W),h[t].addSelf(W),h[a].addSelf(W)}function t(e){rt[0]=i[3*e],rt[1]=i[3*e+1],rt[2]=i[3*e+2],at.copy(tt),Q=l[e],$.copy(Q),$.subSelf(tt.multiplyScalar(tt.dot(Q))).normalize(),et.cross(at,Q),J=et.dot(h[e]),Y=0>J?-1:1,s[4*e]=it[0],s[4*e+1]=it[1],s[4*e+2]=it[2],s[4*e+3]=Y}if(void 0===this.attributes.index||void 0===this.attributes.position||void 0===this.attributes.normal||void 0===this.attributes.uv)return void console.warn("Missing required attributes (index, position, normal or uv) in Geometry.computeTangents()");var a=this.attributes.index.array,r=this.attributes.position.array,i=this.attributes.normal.array,o=this.attributes.uv.array,n=r.length/3;void 0===this.attributes.tangent&&this.addAttributeArray("tangent",new Float32Array(4*n),4);for(var s=this.attributes.tangent.array,l=[],h=[],d=0;n>d;d++)l[d]=new THREE.Vector3,h[d]=new THREE.Vector3;var u,c,f,p,m,v,g,S,x,y,G,M,w,X,D,C,_,b,A,T,P,L,E,F,R,U,N,I,B,O,k,V,z,H=new THREE.Vector3,W=new THREE.Vector3,j=this.offsets;for(B=0,O=j.length;O>B;++B){var q=j[B].start,Z=j[B].count,K=j[B].index;for(N=q,I=q+Z;I>N;N+=3)k=K+a[N],V=K+a[N+1],z=K+a[N+2],e(k,V,z)}var Y,Q,J,$=new THREE.Vector3,et=new THREE.Vector3,tt=new THREE.Vector3,at=new THREE.Vector3,rt=tt.data,it=$.data;for(B=0,O=j.length;O>B;++B){var q=j[B].start,Z=j[B].count,K=j[B].index;for(N=q,I=q+Z;I>N;N+=3)k=K+a[N],V=K+a[N+1],z=K+a[N+2],t(k),t(V),t(z)}this.attributes.tangent.needsUpdate=!0},mergeBatch:function(e,t){e.length!==t.length&&console.warn("THREE.Geometry.mergeBatch: geometries and transforms arrays don't have the same sizes");var a=Math.min(e.length,t.length),r=e.slice(0),i=t.slice(0);0!==this.attributesList.length&&(r.unshift(this),i.unshift(new THREE.Matrix4));for(var o={},n=0,s=0,l=0;a>l;l++){for(var h=r[l],d=0,u=h.attributesList.length;u>d;d++){var c=h.attributesList[d],f=c.name,p=c.type,m=c.array,v=c.itemSize;void 0===o[f]&&(o[f]={size:0,type:p,array:null,offset:0,itemSize:v}),o[f].size+=m.length}n+=h.numVertices,s+=h.numPrimitives}for(var f in o){var c=o[f],g=THREE.paramXGToTypedArray(c.type);"index"===f&&n>65535&&(THREE.elementIndexUintAvailable?g=Uint32Array:console.warn("THREE.Geometry.mergeBatch: too many vertices for new merged indexed geometry")),c.array=new g(c.size)}for(var S=0,l=0;a>l;l++){for(var h=r[l],x=i[l],d=0,u=h.attributesList.length;u>d;d++){var c=h.attributesList[d],f=c.name,p=c.type,m=c.array,y=o[f],G=y.array,M=y.offset;if("index"===f&&y.type===THREE.UnsignedIntType&&p===THREE.UnsignedShortType)for(var w=0,X=m.length;X>w;w++)G[M+w]=m[w];else G.set(m,M);var D=M,C=M+m.length;if("position"===f&&x.multiplyVector3Array(G,D,C),"normal"===f){var _=new THREE.Matrix3;_.getInverse(x).transpose(),_.multiplyVector3Array(D,C),this.normalizeAttribute("normal",D,C)}if("index"===f)for(var w=D;C>w;w++)G[w]+=S;y.offset+=m.length}S+=h.attributes.position.array.length/3}if(0===this.attributesList.length){for(var f in o){var c=o[f];this.addAttributeArray(f,c.array,c.itemSize)}this.offsets[0]={start:0,index:0,count:3*s}}else{for(var d=0,u=this.attributesList.length;u>d;d++){var b=this.attributesList[d],f=b.name,c=o[f];b.array=c.array,b.numItems=c.array.length,b.needsUpdate=!0}this.offsets[0].count=3*s}this.numVertices=n,this.numPrimitives=s},merge:function(e,t){if(this.numVertices+=e.numVertices,this.numPrimitives+=e.numPrimitives,0===this.attributesList.length){this.attributes={};for(var a=0,r=e.attributesList.length;r>a;a++){var i=e.attributesList[a],o=i.name,n=i.array,s=i.itemSize,l=i.type,h=THREE.paramXGToTypedArray(i.type),d=new h(n);this.addAttributeArray(o,d,s)}this.offsets=[];var u=e.offsets;for(a=0,r=u.length;r>a;a++){var c=u[a].start,f=u[a].index,p=u[a].count;this.offsets[a]={start:c,index:f,count:p}}return void this.applyMatrix(t)}var m=this.attributes.position.array.length/3,v=e.attributes.position.array.length/3,g=Uint16Array;m+v>65535&&this.attributes.index&&(THREE.elementIndexUintAvailable?g=Uint32Array:console.warn("THREE.Geometry.merge: too many vertices for new merged indexed geometry"));for(var S=this.attributes.position?m:0,x=0,a=0,r=this.attributesList.length;r>a;a++){var y=this.attributesList[a],o=y.name,n=y.array,l=y.type,s=y.itemSize,G=e.attributes[o],M=G.array;if(void 0!==G)if(G.itemSize===s&&G.type===l||"index"===o&&G.itemSize===s){var w=n.length,X=n.length+M.length,h=THREE.paramXGToTypedArray(l);if("index"===o&&h!==g){for(var D=new g(X),C=0;w>C;C++)D[C]=n[C];for(C=w;X>C;C++)D[C]=M[C-w];y.type=THREE.paramTypedArrayToXG(D),y.typeSize=D.BYTES_PER_ELEMENT}else{var D=new h(X);D.set(n,0),D.set(M,w)}if("index"===o){x=M.length/3;for(var C=w;X>C;C++)D[C]+=S}if(t&&("position"===o&&t.multiplyVector3Array(D,w),"normal"===o)){var _=new THREE.Matrix3;_.getInverse(t).transpose(),_.multiplyVector3Array(D,w),this.normalizeAttribute("normal",w)}y.array=D,y.numItems=X,y.needsUpdate=!0}else console.warn("THREE.Geometry.merge: incompatible attribute ["+o+"]");else console.warn("THREE.Geometry.merge: missing attribute ["+o+"]")}this.offsets.length>0&&(this.offsets[0].count+=3*x)}},THREE.GeometryIdCount=0,THREE.PlaneGeometry=function(e,t){THREE.Geometry.call(this),this.width=e,this.height=t,this.numPrimitives=2,this.numVertices=4,this.addIndex("index",Uint16Array,3),this.addAttribute("position",Float32Array,3),this.addAttribute("normal",Float32Array,3),this.addAttribute("uv",Float32Array,2);var a=this.attributes.index.array,r=this.attributes.position.array,i=this.attributes.normal.array,o=this.attributes.uv.array,n=.5*this.width,s=.5*this.height;r[0]=-n,r[1]=-s,r[2]=0,r[3]=n,r[4]=-s,r[5]=0,r[6]=n,r[7]=s,r[8]=0,r[9]=-n,r[10]=s,r[11]=0,i[0]=0,i[1]=0,i[2]=1,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=1,i[9]=0,i[10]=0,i[11]=1,o[0]=0,o[1]=0,o[2]=1,o[3]=0,o[4]=1,o[5]=1,o[6]=0,o[7]=1,a[0]=0,a[1]=1,a[2]=3,a[3]=1,a[4]=2,a[5]=3,this.offsets.push({start:0,index:0,count:a.length})},THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.HeightfieldGeometry=function(e,t,a,r,i){THREE.Geometry.call(this),this.width=e,this.length=t,this.widthSegments=a||1,this.lengthSegments=r||1,this.numPrimitives=this.widthSegments*this.lengthSegments*2,this.numVertices=(this.widthSegments+1)*(this.lengthSegments+1);var o=Uint16Array;this.numVertices>65536&&(THREE.elementIndexUintAvailable?o=Uint32Array:console.warn("THREE.HeightfieldGeometry: too many vertices for 16 bit indices")),this.addIndex("index",o,3),this.addAttribute("position",Float32Array,3),this.addAttribute("normal",Float32Array,3),this.addAttribute("uv",Float32Array,2);for(var n=this.attributes.index.array,s=this.attributes.position.array,l=(this.attributes.normal.array,this.attributes.uv.array),h=.5*this.width,d=.5*this.length,u=this.width/this.widthSegments,c=this.length/this.lengthSegments,f=0,p=0,m=0,v=0;v<this.lengthSegments+1;v++)for(var g=0;g<this.widthSegments+1;g++){var S=g*u-h,x=v*c-d,y=0;void 0!==i&&(y=i[m],m+=1),s[f]=S,s[f+1]=y,s[f+2]=x,f+=3;var G=g/this.widthSegments,M=v/this.lengthSegments;l[p]=G,l[p+1]=M,p+=2}for(var w=0,X=this.widthSegments+1,v=0;v<this.lengthSegments;v++)for(var g=0;g<this.widthSegments;g++){var D=g+X*v,C=g+X*(v+1),_=g+1+X*(v+1),b=g+1+X*v;n[w]=D,n[w+1]=C,n[w+2]=b,n[w+3]=C,n[w+4]=_,n[w+5]=b,w+=6}this.offsets.push({start:0,index:0,count:n.length}),this.computeVertexNormals()},THREE.HeightfieldGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.BoxGeometry=function(e,t,a){THREE.Geometry.call(this),this.width=e,this.height=t,this.depth=a,this.numPrimitives=12,this.numVertices=24,this.addIndex("index",Uint16Array,3),this.addAttribute("position",Float32Array,3),this.addAttribute("normal",Float32Array,3),this.addAttribute("uv",Float32Array,2);var r=this.attributes.index.array,i=this.attributes.position.array,o=this.attributes.normal.array,n=this.attributes.uv.array,s=this.width/2,l=this.height/2,h=this.depth/2,d=0,u=0,c=0,f=0,p=function(e,t,a,s,l,h,p,m,v,g,S,x,y,G,M){i[d]=s,i[d+1]=l,i[d+2]=h,i[d+3]=p,i[d+4]=m,i[d+5]=v,i[d+6]=g,i[d+7]=S,i[d+8]=x,i[d+9]=y,i[d+10]=G,i[d+11]=M,o[d]=e,o[d+1]=t,o[d+2]=a,o[d+3]=e,o[d+4]=t,o[d+5]=a,o[d+6]=e,o[d+7]=t,o[d+8]=a,o[d+9]=e,o[d+10]=t,o[d+11]=a,n[u]=0,n[u+1]=0,n[u+2]=1,n[u+3]=0,n[u+4]=1,n[u+5]=1,n[u+6]=0,n[u+7]=1,r[c]=f,r[c+1]=f+1,r[c+2]=f+3,r[c+3]=f+1,r[c+4]=f+2,r[c+5]=f+3,d+=12,u+=8,c+=6,f+=4};p(1,0,0,s,-l,h,s,-l,-h,s,l,-h,s,l,h),p(-1,0,0,-s,-l,-h,-s,-l,h,-s,l,h,-s,l,-h),p(0,1,0,-s,l,h,s,l,h,s,l,-h,-s,l,-h),p(0,-1,0,s,-l,h,-s,-l,h,-s,-l,-h,s,-l,-h),p(0,0,1,-s,-l,h,s,-l,h,s,l,h,-s,l,h),p(0,0,-1,s,-l,-h,-s,-l,-h,-s,l,-h,s,l,-h),this.offsets.push({start:0,index:0,count:r.length})},THREE.BoxGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.SphereGeometry=function(e,t,a,r,i,o,n){THREE.Geometry.call(this),this.radius=e||50,this.widthSegments=Math.max(3,Math.floor(t)||8),this.heightSegments=Math.max(2,Math.floor(a)||6),r=void 0!==r?r:0,i=void 0!==i?i:2*Math.PI,o=void 0!==o?o:0,n=void 0!==n?n:Math.PI,this.numPrimitives=this.heightSegments*this.widthSegments*2,this.numVertices=(this.heightSegments+1)*(this.widthSegments+1),this.addIndex("index",Uint16Array,3),this.addAttribute("position",Float32Array,3),this.addAttribute("normal",Float32Array,3),this.addAttribute("uv",Float32Array,2);var s,l,h=this.attributes.index.array,d=this.attributes.position.array,u=this.attributes.normal.array,c=this.attributes.uv.array,f=0,p=0,m=new THREE.Vector3;for(l=0;l<=this.heightSegments;l++)for(s=0;s<=this.widthSegments;s++){var v=s/this.widthSegments,g=l/this.heightSegments,S=-this.radius*Math.cos(r+v*i)*Math.sin(o+g*n),x=this.radius*Math.cos(o+g*n),y=this.radius*Math.sin(r+v*i)*Math.sin(o+g*n);d[f]=S,d[f+1]=x,d[f+2]=y,m.set(S,x,y).normalize(),u[f]=m.data[0],u[f+1]=m.data[1],u[f+2]=m.data[2],f+=3,c[p]=v,c[p+1]=1-g,p+=2}for(f=0,l=0;l<this.heightSegments;l++)for(s=0;s<this.widthSegments;s++){var G=l*(this.widthSegments+1)+(s+1),M=l*(this.widthSegments+1)+s,w=(l+1)*(this.widthSegments+1)+s,X=(l+1)*(this.widthSegments+1)+(s+1);h[f]=G,h[f+1]=M,h[f+2]=X,h[f+3]=M,h[f+4]=w,h[f+5]=X,f+=6}this.offsets.push({start:0,index:0,count:h.length}),this.boundingSphere=new THREE.Sphere(new THREE.Vector3,e)},THREE.SphereGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.CylinderGeometry=function(e,t,a,r,i,o){THREE.Geometry.call(this),e=void 0!==e?e:20,t=void 0!==t?t:20,a=void 0!==a?a:100;var n=a/2,s=r||8,l=i||1,h=e>0&&!o,d=t>0&&!o;this.numPrimitives=l*s*2+s*(1*h+1*d),this.numVertices=(l+1)*(s+1)+(2*s+1)*(1*h+1*d),this.addIndex("index",Uint16Array,3),this.addAttribute("position",Float32Array,3),this.addAttribute("normal",Float32Array,3),this.addAttribute("uv",Float32Array,2);var u,c,f=this.attributes.index.array,p=this.attributes.position.array,m=this.attributes.normal.array,v=this.attributes.uv.array,g=0,S=0,x=0;for(c=0;l>=c;c++){var y=c/l,G=y*(t-e)+e;for(u=0;s>=u;u++){var M=u/s,w=G*Math.sin(M*Math.PI*2),X=-y*a+n,D=G*Math.cos(M*Math.PI*2);p[g]=w,p[g+1]=X,p[g+2]=D,g+=3,v[x]=M,v[x+1]=1-y,x+=2}}var C,_,b,A,T,P,L,E,F=(t-e)/a,R=new THREE.Vector3,U=new THREE.Vector3;for(S=0,u=0;s>u;u++)for(0!==e?(L=u,E=u+1):(L=s+1+u,E=s+1+(u+1)),L*=3,E*=3,C=p[L],_=p[L+1],b=p[L+2],A=p[E],T=p[E+1],P=p[E+2],R.set(C,_,b),U.set(A,T,P),R.setY(Math.sqrt(R.data[0]*R.data[0]+R.data[2]*R.data[2])*F).normalize(),U.setY(Math.sqrt(U.data[0]*U.data[0]+U.data[2]*U.data[2])*F).normalize(),c=0;l>c;c++){var N=c*(s+1)+u,I=(c+1)*(s+1)+u,B=(c+1)*(s+1)+(u+1),O=c*(s+1)+(u+1);f[S]=N,f[S+1]=I,f[S+2]=O,f[S+3]=I,f[S+4]=B,f[S+5]=O,S+=6,m[3*N]=R.data[0],m[3*N+1]=R.data[1],m[3*N+2]=R.data[2],m[3*I]=R.data[0],m[3*I+1]=R.data[1],m[3*I+2]=R.data[2],m[3*B]=U.data[0],m[3*B+1]=U.data[1],m[3*B+2]=U.data[2],m[3*O]=U.data[0],m[3*O+1]=U.data[1],m[3*O+2]=U.data[2]
}if(!o&&e>0){var B=g/3;for(p[g]=0,p[g+1]=n,p[g+2]=0,m[g]=0,m[g+1]=1,m[g+2]=0,g+=3,v[x]=.5,v[x+1]=.5,x+=2,u=0;s>u;u++){var N=g/3,I=N+1;C=3*u,A=3*(u+1),p[g]=p[C],p[g+1]=p[C+1],p[g+2]=p[C+2],p[g+3]=p[A],p[g+4]=p[A+1],p[g+5]=p[A+2],m[g]=0,m[g+1]=1,m[g+2]=0,m[g+3]=0,m[g+4]=1,m[g+5]=0,g+=6,f[S]=N,f[S+1]=I,f[S+2]=B,S+=3;var k=u/s,V=(u+1)/s;v[x]=k,v[x+1]=1,v[x+2]=V,v[x+3]=1,x+=4}}if(!o&&t>0){var B=g/3;for(p[g]=0,p[g+1]=-n,p[g+2]=0,m[g]=0,m[g+1]=-1,m[g+2]=0,g+=3,v[x]=.5,v[x+1]=.5,x+=2,u=0;s>u;u++){var N=g/3,I=N+1;C=3*(u+1+c*(s+1)),A=3*(u+c*(s+1)),p[g]=p[C],p[g+1]=p[C+1],p[g+2]=p[C+2],p[g+3]=p[A],p[g+4]=p[A+1],p[g+5]=p[A+2],m[g]=0,m[g+1]=-1,m[g+2]=0,m[g+3]=0,m[g+4]=-1,m[g+5]=0,g+=6,f[S]=N,f[S+1]=I,f[S+2]=B,S+=3;var k=u/s,V=(u+1)/s;v[x]=k,v[x+1]=0,v[x+2]=V,v[x+3]=0,x+=4}}this.offsets.push({start:0,index:0,count:f.length})},THREE.CylinderGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.CapsuleGeometry=function(e,t,a){THREE.Geometry.call(this);var r=new THREE.CylinderGeometry(e,e,t,a,1,!0),i=new THREE.SphereGeometry(e,a,.5*a,0,2*Math.PI,0,.5*Math.PI),o=new THREE.Vector3(0,.5*t,0),n=new THREE.Vector3(0,.5*-t,0),s=new THREE.Matrix4;s.makeTranslation(o);var l=new THREE.Matrix4;l.makeRotationX(Math.PI);var h=new THREE.Matrix4;h.makeTranslation(n),h.multiplySelf(l),r.merge(i,s),r.merge(i,h),r.computeBoundingSphere(),this.attributes=r.attributes,this.attributesList=r.attributesList,this.virtualAttributes=r.virtualAttributes,this.virtualAttributesList=r.virtualAttributesList,this.numPrimitives=r.numPrimitives,this.numVertices=r.numVertices,this.offsets=r.offsets,this.boundingBox=r.boundingBox,this.boundingSphere=r.boundingSphere},THREE.CapsuleGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.RandomGeometry=function(e){THREE.Geometry.call(this),void 0===e&&(e={}),this.shape=void 0!==e.shape?e.shape:"sphere",this.customCallback=void 0!==e.callback?e.callback:function(){},this.radius=void 0!==e.radius?e.radius:1,this.width=void 0!==e.width?e.width:1,this.height=void 0!==e.height?e.height:1,this.depth=void 0!==e.depth?e.depth:1,this.useSeed=void 0!==e.useSeed?e.useSeed:!1,this.seed=void 0!==e.seed?e.seed:Math.random(),this.numPrimitives=0,this.numVertices=void 0!==e.vertices?e.vertices:1e3,this.addAttribute("position",Float32Array,3),this.refresh(this.seed)},THREE.RandomGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.RandomGeometry.prototype.refresh=function(e){this.seed=e;var t=this.attributes.position.array,a=this.radius,r=this.width,i=this.height,o=this.depth;if(this.useSeed){Math.seedrandom(this.seed);var n=Math.srandom}else var n=Math.random;var s,l=function(e){var t=2*n()-1,r=n()*Math.PI*2,i=Math.sqrt(1-t*t);e.x=a*i*Math.cos(r),e.y=a*i*Math.sin(r),e.z=a*t},h=function(e){for(var t=0,r=.5,i=c;i;r*=.5,i>>=1)1&i&&(t+=r);t=2*t-1;var o=(c+.5)/f,n=2*o*Math.PI,s=Math.sqrt(1-t*t);e.x=a*s*Math.cos(n),e.y=a*s*Math.sin(n),e.z=a*t,c+=1},d=function(e){var t=(n()-.5)*a,r=(n()-.5)*a,i=(n()-.5)*a,o=n()*a,s=1/Math.sqrt(t*t+r*r+i*i);e.x=o*t*s,e.y=o*r*s,e.z=o*i*s},u=function(e){e.x=(n()-.5)*r,e.y=(n()-.5)*i,e.z=(n()-.5)*o};"sphereSurface"===this.shape?s=l:"sphereHammersley"===this.shape?s=h:"sphere"===this.shape?s=d:"box"===this.shape?s=u:"custom"===this.shape&&(s=this.customCallback);for(var c=0,f=this.numVertices,p=0,m={x:0,y:0,z:0},v=0,g=this.numVertices;g>v;v++)s(m),t[p]=m.x,t[p+1]=m.y,t[p+2]=m.z,p+=3;this.attributes.position.needsUpdate=!0},THREE.GeometryUtils={center:function(e){for(var t=new THREE.Box3,a=0,r=e.length;r>a;a++){var i=e[a];i.computeBoundingBox(),t.add(i.boundingBox)}var o=t.min.clone();o.addSelf(t.max),o.multiplyScalar(-.5);var n=new THREE.Matrix4;n.makeTranslation(o);for(var a=0,r=e.length;r>a;a++){var i=e[a];i.applyMatrix(n)}},generateTerrainHeights:function(e,t,a,r){if(void 0!==r){Math.seedrandom(r);var i=Math.srandom}else var i=Math.random;for(var o=function(t,a,r){var i=a*s+t;e[i]=r},n=function(t,a){var r=a*s+t;return e[r]},s=t+1,l=t;l>=2;l/=2){var h=l/2;a/=2;for(var d=0;t>d;d+=l)for(var u=0;t>u;u+=l){var c=n(d,u)+n(d+l,u)+n(d,u+l)+n(d+l,u+l);c/=4,c+=2*a*i()-a,o(d+h,u+h,c)}for(var d=0;t>d;d+=h)for(var u=(d+h)%l;t>u;u+=l){var c=n((d-h+s)%s,u)+n((d+h)%s,u)+n(d,(u+h)%s)+n(d,(u-h+s)%s);c/=4,c+=2*a*i()-a,o(d,u,c),0===d&&o(t,u,c),0===u&&o(d,t,c)}}},getTerrainHeightsRange:function(e){for(var t=1/0,a=-1/0,r=0,i=e.length;i>r;r++){var o=e[r];t>o&&(t=o),o>a&&(a=o)}return{min:t,max:a}},offsetTerrainHeights:function(e,t){for(var a=0,r=e.length;r>a;a++)e[a]+=t},centerTerrainHeights:function(e){var t=THREE.GeometryUtils.getTerrainHeightsRange(e),a=(t.min+t.max)*-.5;THREE.GeometryUtils.offsetTerrainHeights(e,a)},floorTerrainHeights:function(e){var t=THREE.GeometryUtils.getTerrainHeightsRange(e),a=-t.min;THREE.GeometryUtils.offsetTerrainHeights(e,a)},blendTerrainHeights:function(e,t,a,r){for(var i=0,o=e.length;o>i;i++){var n=e[i],s=t[i],l=Math.floor(i/a),h=i%a,d=r(h,l);e[i]=d*n+(1-d)*s}},addParticleAttributes:function(e){e.addAttribute("velocitySpinStart",Float32Array,4),e.addAttribute("accelerationSpinSpeed",Float32Array,4),e.addAttribute("startSizeEndSizeStartTimeLifeTime",Float32Array,4)},setParticleAttributes:function(e,t){var a=e.attributes.velocitySpinStart.array,r=e.attributes.accelerationSpinSpeed.array,i=e.attributes.startSizeEndSizeStartTimeLifeTime.array,o={x:0,y:0,z:0},n={x:0,y:0,z:0},s={start:0,speed:0},l={start:0,end:0},h={start:0,life:0},d={velocity:o,acceleration:n,spin:s,size:l,time:h};(a.length!==r.length||a.length!==i.length||i.length!==r.length)&&console.error("THREE.GeometryUtils.setParticleAttributes: attributes lengths mismatch");for(var u=0,c=a.length;c>u;u+=4)t(d),a[u]=o.x,a[u+1]=o.y,a[u+2]=o.z,a[u+3]=s.start,r[u]=n.x,r[u+1]=n.y,r[u+2]=n.z,r[u+3]=s.speed,i[u]=l.start,i[u+1]=l.end,i[u+2]=h.start,i[u+3]=h.life}},THREE.Node=function(){this.id=THREE.NodeIdCount++,this.name="",this.properties={},this.parent=void 0,this.children=[],this.transformChildren=!0,this.position=new THREE.Vector3,this.rotation=new THREE.Vector3,this.scale=new THREE.Vector3(1,1,1),this.up=new THREE.Vector3(0,1,0),this.eulerOrder=THREE.Node.defaultEulerOrder,this.renderDepth=null,this.rotationAutoUpdate=!0,this.matrix=new THREE.Matrix4,this.matrixWorld=new THREE.Matrix4,this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!0,this.quaternion=new THREE.Quaternion,this.useQuaternion=!1,this.visible=!0,this.enabled=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0},THREE.Node.prototype={constructor:THREE.Node,applyMatrix:function(e){this.matrix.multiply(e,this.matrix),this.scale.getScaleFromMatrix(this.matrix);var t=(new THREE.Matrix4).extractRotation(this.matrix);this.rotation.setEulerFromRotationMatrix(t,this.eulerOrder),this.position.getPositionFromMatrix(this.matrix)},translate:function(e,t){this.matrix.rotateAxis(t),this.position.addSelf(t.multiplyScalar(e))},translateX:function(e){this.translate(e,THREE.Vector3.xAxis.clone())},translateY:function(e){this.translate(e,THREE.Vector3.yAxis.clone())},translateZ:function(e){this.translate(e,THREE.Vector3.zAxis.clone())},localToWorld:function(e){return this.matrixWorld.multiplyVector3(e)},worldToLocal:function(e){return THREE.Node.__m1.getInverse(this.matrixWorld).multiplyVector3(e)},lookAt:function(e){this.matrix.lookAt(e,this.position,this.up),this.rotationAutoUpdate&&(this.useQuaternion===!1?this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder):this.quaternion.copy(this.matrix.decompose()[1]))},add:function(e){if(e===this)return void console.warn("THREE.Node.add: A node can't be added as a child of itself.");if(e instanceof THREE.Node){void 0!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e);for(var t=this;void 0!==t.parent;)t=t.parent;void 0!==t&&t instanceof THREE.Scene&&t.__addNode(e)}},remove:function(e){var t=this.children.indexOf(e);if(-1!==t){e.parent=void 0,this.children.splice(t,1);for(var a=this;void 0!==a.parent;)a=a.parent;void 0!==a&&a instanceof THREE.Scene&&a.__removeNode(e)}},traverse:function(e){e(this);for(var t=this.children,a=0,r=t.length;r>a;a++)t[a].traverse(e)},getChildByName:function(e,t){for(var a=0,r=this.children.length;r>a;a++){var i=this.children[a];if(i.name===e)return i;if(t===!0&&(i=i.getChildByName(e,t),void 0!==i))return i}return void 0},getDescendants:function(e){void 0===e&&(e=[]),Array.prototype.push.apply(e,this.children);for(var t=0,a=this.children.length;a>t;t++)this.children[t].getDescendants(e);return e},updateMatrix:function(){this.useQuaternion===!1&&this.quaternion.setFromEuler(this.rotation,this.eulerOrder),this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate===!0&&this.updateMatrix(),(this.matrixWorldNeedsUpdate===!0||e===!0)&&(this.parent&&this.parent.transformChildren?this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=this.children,a=0,r=t.length;r>a;a++)t[a].updateMatrixWorld(e)},clone:function(e){void 0===e&&(e=new THREE.Node),e.name=this.name,e.up.copy(this.up),e.position.copy(this.position),e.rotation instanceof THREE.Vector3&&e.rotation.copy(this.rotation),e.eulerOrder=this.eulerOrder,e.scale.copy(this.scale),e.renderDepth=this.renderDepth,e.rotationAutoUpdate=this.rotationAutoUpdate,e.matrix.copy(this.matrix),e.matrixWorld.copy(this.matrixWorld),e.matrixAutoUpdate=this.matrixAutoUpdate,e.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,e.quaternion.copy(this.quaternion),e.useQuaternion=this.useQuaternion,e.visible=this.visible,e.castShadow=this.castShadow,e.receiveShadow=this.receiveShadow,e.frustumCulled=this.frustumCulled;for(var t=0;t<this.children.length;t++){var a=this.children[t];e.add(a.clone())}return e}},THREE.Node.__m1=new THREE.Matrix4,THREE.Node.defaultEulerOrder=THREE.xyzOrder,THREE.NodeIdCount=0,THREE.Bone=function(e){THREE.Node.call(this),this.skin=e,this.skinMatrix=new THREE.Matrix4},THREE.Bone.prototype=Object.create(THREE.Node.prototype),THREE.Bone.prototype.update=function(e,t){this.matrixAutoUpdate&&(t|=this.updateMatrix()),(t||this.matrixWorldNeedsUpdate)&&(e?this.skinMatrix.multiply(e,this.matrix):this.skinMatrix.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(var a=0,r=this.children.length;r>a;a++)this.children[a].update(this.skinMatrix,t)},THREE.Scene=function(){THREE.Node.call(this),this.fog=null,this.heightFog=null,this.matrixAutoUpdate=!1,this.transformChildren=!1,this.__objects=[],this.__lights=[],this.__objectsAdded=[],this.__objectsRemoved=[]},THREE.Scene.prototype=Object.create(THREE.Node.prototype),THREE.Scene.prototype.__addNode=function(e){if(e instanceof THREE.Light)-1===this.__lights.indexOf(e)&&this.__lights.push(e),e.target&&void 0===e.target.parent&&this.add(e.target);else if(!(e instanceof THREE.Camera||e instanceof THREE.Bone)&&-1===this.__objects.indexOf(e)){this.__objects.push(e),this.__objectsAdded.push(e);var t=this.__objectsRemoved.indexOf(e);-1!==t&&this.__objectsRemoved.splice(t,1)}for(var a=0;a<e.children.length;a++)this.__addNode(e.children[a])},THREE.Scene.prototype.__removeNode=function(e){if(e instanceof THREE.Light){var t=this.__lights.indexOf(e);-1!==t&&this.__lights.splice(t,1)}else if(!(e instanceof THREE.Camera)){var t=this.__objects.indexOf(e);if(-1!==t){this.__objects.splice(t,1),this.__objectsRemoved.push(e);var a=this.__objectsAdded.indexOf(e);-1!==a&&this.__objectsAdded.splice(a,1)}}for(var r=0;r<e.children.length;r++)this.__removeNode(e.children[r])},THREE.Gyroscope=function(){THREE.Node.call(this)},THREE.Gyroscope.prototype=Object.create(THREE.Node.prototype),THREE.Gyroscope.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent?(this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix),this.matrixWorld.decompose(this.translationWorld,this.rotationWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.rotationObject,this.scaleObject),this.matrixWorld.compose(this.translationWorld,this.rotationObject,this.scaleWorld)):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=0,a=this.children.length;a>t;t++)this.children[t].updateMatrixWorld(e)},THREE.Gyroscope.prototype.translationWorld=new THREE.Vector3,THREE.Gyroscope.prototype.translationObject=new THREE.Vector3,THREE.Gyroscope.prototype.rotationWorld=new THREE.Quaternion,THREE.Gyroscope.prototype.rotationObject=new THREE.Quaternion,THREE.Gyroscope.prototype.scaleWorld=new THREE.Vector3,THREE.Gyroscope.prototype.scaleObject=new THREE.Vector3,THREE.Mesh=function(e,t){THREE.Node.call(this),this.geometries=e instanceof Array?e:e instanceof THREE.Geometry?[e]:[],this.materials=t instanceof Array?t:t instanceof THREE.Material?[t]:[];for(var a=0,r=this.geometries.length;r>a;a++){var i=this.geometries[a];null===i.boundingSphere&&i.computeBoundingSphere()}},THREE.Mesh.prototype=Object.create(THREE.Node.prototype),THREE.Mesh.prototype.clone=function(e){return void 0===e&&(e=new THREE.Mesh(this.geometries,this.materials)),THREE.Node.prototype.clone.call(this,e),e},THREE.MorphMesh=function(e,t){THREE.Mesh.call(this,e,t),this.animationsMap={},this.animationsList=[];var a=this.geometries[0],r=a.morphTargets.length,i="__default",o=0,n=r-1,s=r/1;this.createAnimation(i,o,n,s),this.setAnimationWeight(i,1),this.morphTargetInfluences=new Float32Array(a.morphTargets.length)},THREE.MorphMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.MorphMesh.prototype.createAnimation=function(e,t,a,r){var i={startFrame:t,endFrame:a,length:a-t+1,fps:r,duration:(a-t)/r,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[e]=i,this.animationsList.push(i)},THREE.MorphMesh.prototype.autoCreateAnimations=function(e){for(var t,a=/([a-z]+)(\d+)/,r={},i=this.geometries[0],o=0,n=i.morphTargets.length;n>o;o++){var s=i.morphTargets[o],l=s.name.match(a);if(l&&l.length>1){{var h=l[1];l[2]}r[h]||(r[h]={start:1/0,end:-1/0});var d=r[h];o<d.start&&(d.start=o),o>d.end&&(d.end=o),t||(t=h)}}for(var h in r){var d=r[h];this.createAnimation(h,d.start,d.end,e)}this.firstAnimation=t},THREE.MorphMesh.prototype.setAnimationDirectionForward=function(e){var t=this.animationsMap[e];t&&(t.direction=1,t.directionBackwards=!1)},THREE.MorphMesh.prototype.setAnimationDirectionBackward=function(e){var t=this.animationsMap[e];t&&(t.direction=-1,t.directionBackwards=!0)},THREE.MorphMesh.prototype.setAnimationFPS=function(e,t){var a=this.animationsMap[e];a&&(a.fps=t,a.duration=(a.end-a.start)/a.fps)},THREE.MorphMesh.prototype.setAnimationDuration=function(e,t){var a=this.animationsMap[e];a&&(a.duration=t,a.fps=(a.end-a.start)/a.duration)},THREE.MorphMesh.prototype.setAnimationWeight=function(e,t){var a=this.animationsMap[e];a&&(a.weight=t)},THREE.MorphMesh.prototype.setAnimationTime=function(e,t){var a=this.animationsMap[e];a&&(a.time=t)},THREE.MorphMesh.prototype.getAnimationTime=function(e){var t=0,a=this.animationsMap[e];return a&&(t=a.time),t},THREE.MorphMesh.prototype.getAnimationDuration=function(e){var t=-1,a=this.animationsMap[e];return a&&(t=a.duration),t},THREE.MorphMesh.prototype.playAnimation=function(e){var t=this.animationsMap[e];t?(t.time=0,t.active=!0):console.warn("animation["+e+"] undefined")},THREE.MorphMesh.prototype.stopAnimation=function(e){var t=this.animationsMap[e];t&&(t.active=!1)},THREE.MorphMesh.prototype.update=function(e){for(var t=0,a=this.animationsList.length;a>t;t++){var r=this.animationsList[t];if(r.active){var i=r.duration/r.length;r.time+=r.direction*e,r.mirroredLoop?(r.time>r.duration||r.time<0)&&(r.direction*=-1,r.time>r.duration&&(r.time=r.duration,r.directionBackwards=!0),r.time<0&&(r.time=0,r.directionBackwards=!1)):(r.time=r.time%r.duration,r.time<0&&(r.time+=r.duration));var o=r.startFrame+THREE.Math.clamp(Math.floor(r.time/i),0,r.length-1),n=r.weight;o!==r.currentFrame&&(this.morphTargetInfluences[r.lastFrame]=0,this.morphTargetInfluences[r.currentFrame]=1*n,this.morphTargetInfluences[o]=0,r.lastFrame=r.currentFrame,r.currentFrame=o);var s=r.time%i/i;r.directionBackwards&&(s=1-s),this.morphTargetInfluences[r.currentFrame]=s*n,this.morphTargetInfluences[r.lastFrame]=(1-s)*n}}},THREE.MD2Character=function(){function e(e,t){for(var r=[],i=0;i<t.length;i++)r[i]=THREE.ImageUtils.loadTexture(e+t[i],a),r[i].name=t[i];return r}function t(e,t){var a=(THREE.ImageUtils.generateDataTexture(1,1,new THREE.Color(16777215)),new THREE.PhongMaterial({color:16777215,specular:1118481,shininess:50,map:t,morphTargets:!0,morphNormals:!0,metal:!0}));a.wrapAround=!0;for(var r=[],o=0,n=e.length;n>o;o++)r[o]=a;var s=new THREE.MorphMesh(e,r);return s.rotation.setY(-Math.PI/2),s.autoCreateAnimations(i.animationFPS),s}function a(){i.loadCounter-=1,0===i.loadCounter&&i.onLoadComplete()}function r(e){return 1===e?1:-Math.pow(2,-10*e)+1}var i=this;this.scale=1,this.animationFPS=6,this.transitionFrames=15,this.maxSpeed=275,this.maxReverseSpeed=-275,this.frontAcceleration=600,this.backAcceleration=600,this.frontDecceleration=600,this.angularSpeed=2.5,this.root=new THREE.Node,this.meshBody=null,this.meshWeapon=null,this.controls=null,this.skinsBody=[],this.skinsWeapon=[],this.weapons=[],this.currentSkin=void 0,this.onLoadComplete=function(){},this.meshes=[],this.animations={},this.loadCounter=0,this.speed=0,this.bodyOrientation=0,this.walkSpeed=this.maxSpeed,this.crouchSpeed=.5*this.maxSpeed,this.activeAnimation=null,this.oldAnimation=null,this.enableShadows=function(e){for(var t=0;t<this.meshes.length;t++)this.meshes[t].castShadow=e,this.meshes[t].receiveShadow=e},this.setVisible=function(e){for(var t=0;t<this.meshes.length;t++)this.meshes[t].visible=e,this.meshes[t].visible=e},this.shareParts=function(e){this.animations=e.animations,this.walkSpeed=e.walkSpeed,this.crouchSpeed=e.crouchSpeed,this.skinsBody=e.skinsBody,this.skinsWeapon=e.skinsWeapon;var a=t(e.meshBody.geometries,this.skinsBody[0]);a.scale.set(this.scale,this.scale,this.scale),this.root.position.data[1]=e.root.position.data[1],this.root.add(a),this.meshBody=a,this.meshes.push(a);for(var r=0;r<e.weapons.length;r++){var i=t(e.weapons[r].geometries,this.skinsWeapon[r]);i.scale.set(this.scale,this.scale,this.scale),i.visible=!1,i.name=e.weapons[r].name,this.root.add(i),this.weapons[r]=i,this.meshWeapon=i,this.meshes.push(i)}},this.loadParts=function(r){this.animations=r.animations,this.walkSpeed=r.walkSpeed,this.crouchSpeed=r.crouchSpeed,this.loadCounter=2*r.weapons.length+r.skins.length+1;for(var o=[],n=0;n<r.weapons.length;n++)o[n]=r.weapons[n][1];this.skinsBody=e(r.baseUrl+"skins/",r.skins),this.skinsWeapon=e(r.baseUrl+"skins/",o);var s=new THREE.JSONLoader;s.load(r.baseUrl+r.body,function(e){for(var r=0,o=e.length;o>r;r++){var n=e[r];n.computeBoundingBox()}i.root.position.data[1]=-i.scale*n.boundingBox.min.data[1];var s=t(n,i.skinsBody[0]);s.scale.multiplyScalar(i.scale),i.root.add(s),i.meshBody=s,i.meshes.push(s),a()});for(var l=function(e,r){return function(o){var n=t(o,i.skinsWeapon[e]);n.scale.set(i.scale,i.scale,i.scale),n.visible=!1,n.name=r,i.root.add(n),i.weapons[e]=n,i.meshWeapon=n,i.meshes.push(n),a()}},n=0;n<r.weapons.length;n++)s.load(r.baseUrl+r.weapons[n][0],l(n,r.weapons[n][0]))},this.setPlaybackRate=function(e){this.meshBody&&(this.meshBody.duration=this.meshBody.baseDuration/e),this.meshWeapon&&(this.meshWeapon.duration=this.meshWeapon.baseDuration/e)},this.setSkin=function(e){if(this.meshBody){for(var t=0,a=this.meshBody.materials.length;a>t;t++){var r=this.meshBody.materials[t];r.map=this.skinsBody[e]}this.currentSkin=e}},this.setWeapon=function(e){for(var t=0;t<this.weapons.length;t++)this.weapons[t].visible=!1;var a=this.weapons[e];a&&(a.visible=!0,this.meshWeapon=a,this.activeAnimation&&(a.playAnimation(this.activeAnimation),this.meshWeapon.setAnimationTime(this.activeAnimation,this.meshBody.getAnimationTime(this.activeAnimation))))},this.setAnimation=function(e){e!==this.activeAnimation&&e&&(this.meshBody&&(this.meshBody.setAnimationWeight(e,0),this.meshBody.playAnimation(e),this.oldAnimation=this.activeAnimation,this.activeAnimation=e,this.blendCounter=this.transitionFrames),this.meshWeapon&&(this.meshWeapon.setAnimationWeight(e,0),this.meshWeapon.playAnimation(e)))},this.update=function(e){this.controls&&this.updateMovementModel(e),this.animations&&(this.updateBehaviors(e),this.updateAnimations(e))},this.updateAnimations=function(e){var t=1;this.blendCounter>0&&(t=(this.transitionFrames-this.blendCounter)/this.transitionFrames,this.blendCounter-=1),this.meshBody&&(this.meshBody.update(e),this.meshBody.setAnimationWeight(this.activeAnimation,t),this.meshBody.setAnimationWeight(this.oldAnimation,1-t)),this.meshWeapon&&(this.meshWeapon.update(e),this.meshWeapon.setAnimationWeight(this.activeAnimation,t),this.meshWeapon.setAnimationWeight(this.oldAnimation,1-t))},this.updateBehaviors=function(){var e,t,a=this.controls,r=this.animations;a.crouch?(e=r.crouchMove,t=r.crouchIdle):(e=r.move,t=r.idle),a.jump&&(e=r.jump,t=r.jump),a.attack&&(a.crouch?(e=r.crouchAttack,t=r.crouchAttack):(e=r.attack,t=r.attack)),(a.moveForward||a.moveBackward||a.moveLeft||a.moveRight)&&this.activeAnimation!==e&&this.setAnimation(e),Math.abs(this.speed)<.2*this.maxSpeed&&!(a.moveLeft||a.moveRight||a.moveForward||a.moveBackward)&&this.activeAnimation!==t&&this.setAnimation(t),a.moveForward&&(this.meshBody&&(this.meshBody.setAnimationDirectionForward(this.activeAnimation),this.meshBody.setAnimationDirectionForward(this.oldAnimation)),this.meshWeapon&&(this.meshWeapon.setAnimationDirectionForward(this.activeAnimation),this.meshWeapon.setAnimationDirectionForward(this.oldAnimation))),a.moveBackward&&(this.meshBody&&(this.meshBody.setAnimationDirectionBackward(this.activeAnimation),this.meshBody.setAnimationDirectionBackward(this.oldAnimation)),this.meshWeapon&&(this.meshWeapon.setAnimationDirectionBackward(this.activeAnimation),this.meshWeapon.setAnimationDirectionBackward(this.oldAnimation)))},this.updateMovementModel=function(e){var t=this.controls;this.maxSpeed=t.crouch?this.crouchSpeed:this.walkSpeed,this.maxReverseSpeed=-this.maxSpeed,t.moveForward&&(this.speed=THREE.Math.clamp(this.speed+e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),t.moveBackward&&(this.speed=THREE.Math.clamp(this.speed-e*this.backAcceleration,this.maxReverseSpeed,this.maxSpeed));var a=1;if(t.moveLeft&&(this.bodyOrientation+=e*this.angularSpeed,this.speed=THREE.Math.clamp(this.speed+a*e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),t.moveRight&&(this.bodyOrientation-=e*this.angularSpeed,this.speed=THREE.Math.clamp(this.speed+a*e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),!t.moveForward&&!t.moveBackward)if(this.speed>0){var i=r(this.speed/this.maxSpeed);this.speed=THREE.Math.clamp(this.speed-i*e*this.frontDecceleration,0,this.maxSpeed)}else{var i=r(this.speed/this.maxReverseSpeed);this.speed=THREE.Math.clamp(this.speed+i*e*this.backAcceleration,this.maxReverseSpeed,0)}var o=this.speed*e;this.root.position.data[0]+=Math.sin(this.bodyOrientation)*o,this.root.position.data[2]+=Math.cos(this.bodyOrientation)*o,this.root.rotation.data[1]=this.bodyOrientation}},THREE.SkinnedCharacter=function(e){function t(e){return 1===e?1:-Math.pow(2,-10*e)+1}this.config=e,this.transitionFrames=15,this.controls=null,this.root=new THREE.Node,this.meshes=[],this.animations={},this.speed=0,this.bodyOrientation=0,this.activeAnimation=null,this.oldAnimation=null,this.animations=e.animations,this.walkSpeed=void 0!==e.walkSpeed?e.walkSpeed:275,this.crouchSpeed=void 0!==e.crouchSpeed?e.crouchSpeed:137.5,this.angularSpeed=void 0!==e.angularSpeed?e.angularSpeed:2.5,this.frontAcceleration=void 0!==e.frontAcceleration?e.frontAcceleration:600,this.frontDecceleration=void 0!==e.frontDecceleration?e.frontDecceleration:600,this.backAcceleration=void 0!==e.backAcceleration?e.backAcceleration:600,this.maxSpeed=this.walkSpeed,this.maxReverseSpeed=-this.maxSpeed,this.addMesh=function(e){this.root.add(e),this.meshes.push(e)},this.enableShadows=function(e){for(var t=0;t<this.meshes.length;t++){var a=this.meshes[t];a.castShadow=e,a.receiveShadow=e}},this.setVisible=function(e){for(var t=0;t<this.meshes.length;t++){var a=this.meshes[t];a.visible=e,a.visible=e}},this.setAnimation=function(e){if(e!==this.activeAnimation&&e)for(var t=0,a=this.meshes.length;a>t;t++){var r=this.meshes[t];r.setAnimationWeight(e,0),r.playAnimation(e),this.oldAnimation=this.activeAnimation,this.activeAnimation=e,this.blendCounter=this.transitionFrames}},this.update=function(e){this.controls&&this.updateMovementModel(e),this.animations&&(this.updateBehaviors(e),this.updateAnimations(e))},this.updateAnimations=function(e){var t=1;this.blendCounter>0&&(t=(this.transitionFrames-this.blendCounter)/this.transitionFrames,this.blendCounter-=1);for(var a=0,r=this.meshes.length;r>a;a++){var i=this.meshes[a];i.setAnimationWeight(this.activeAnimation,t),i.setAnimationWeight(this.oldAnimation,1-t),i.update(e)}},this.updateBehaviors=function(){var e,t,a=this.controls,r=this.animations;if(a.crouch?(e=r.crouchMove,t=r.crouchIdle):(e=r.move,t=r.idle),a.jump&&(e=r.jump,t=r.jump),a.attack&&(a.crouch?(e=r.crouchAttack,t=r.crouchAttack):(e=r.attack,t=r.attack)),(a.moveForward||a.moveBackward||a.moveLeft||a.moveRight)&&this.activeAnimation!==e&&this.setAnimation(e),Math.abs(this.speed)<.2*this.maxSpeed&&!(a.moveLeft||a.moveRight||a.moveForward||a.moveBackward)&&this.activeAnimation!==t&&this.setAnimation(t),a.moveForward)for(var i=0,o=this.meshes.length;o>i;i++){var n=this.meshes[i];n.setAnimationDirectionForward(this.activeAnimation),n.setAnimationDirectionForward(this.oldAnimation)}if(a.moveBackward)for(var i=0,o=this.meshes.length;o>i;i++){var n=this.meshes[i];n.setAnimationDirectionBackward(this.activeAnimation),n.setAnimationDirectionBackward(this.oldAnimation)}},this.updateMovementModel=function(e){var a=this.controls;this.maxSpeed=a.crouch?this.crouchSpeed:this.walkSpeed,this.maxReverseSpeed=-this.maxSpeed,a.moveForward&&(this.speed=THREE.Math.clamp(this.speed+e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),a.moveBackward&&(this.speed=THREE.Math.clamp(this.speed-e*this.backAcceleration,this.maxReverseSpeed,this.maxSpeed));var r=1;if(a.moveLeft&&(this.bodyOrientation+=e*this.angularSpeed,this.speed=THREE.Math.clamp(this.speed+r*e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),a.moveRight&&(this.bodyOrientation-=e*this.angularSpeed,this.speed=THREE.Math.clamp(this.speed+r*e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),!a.moveForward&&!a.moveBackward)if(this.speed>0){var i=t(this.speed/this.maxSpeed);this.speed=THREE.Math.clamp(this.speed-i*e*this.frontDecceleration,0,this.maxSpeed)}else{var i=t(this.speed/this.maxReverseSpeed);this.speed=THREE.Math.clamp(this.speed+i*e*this.backAcceleration,this.maxReverseSpeed,0)}var o=this.speed*e;this.root.position.data[0]+=Math.sin(this.bodyOrientation)*o,this.root.position.data[2]+=Math.cos(this.bodyOrientation)*o,this.root.rotation.data[1]=this.bodyOrientation}},THREE.SkinnedMesh=function(e,t,a){THREE.Mesh.call(this,e,t),this.useVertexTexture=void 0!==a?a:!0,this.animations={},this.animationsList=[],this.identityMatrix=new THREE.Matrix4,this.bones=[],this.boneMatrices=[];var r=this.geometries[0];if(r){var i=r.bones,o=r.animations;if(i){var n,s,l,h,d,u;for(n=0;n<i.length;n++)l=i[n],h=l.pos,d=l.rotq,u=l.scl,s=this.addBone(),s.name=l.name,s.position.set(h[0],h[1],h[2]),s.quaternion.set(d[0],d[1],d[2],d[3]),s.useQuaternion=!0,void 0!==u?s.scale.set(u[0],u[1],u[2]):s.scale.set(1,1,1);for(n=0;n<this.bones.length;n++)l=i[n],s=this.bones[n],-1===l.parent?this.add(s):this.bones[l.parent].add(s);var c=this.bones.length;if(this.useVertexTexture){var f;f=c>256?64:c>64?32:c>16?16:8,this.boneTextureWidth=f,this.boneTextureHeight=f,this.boneMatrices=new Float32Array(this.boneTextureWidth*this.boneTextureHeight*4),this.boneTexture=new THREE.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,THREE.RGBAFormat,THREE.FloatType),this.boneTexture.minFilter=THREE.NearestFilter,this.boneTexture.magFilter=THREE.NearestFilter,this.boneTexture.generateMipmaps=!1,this.boneTexture.flipY=!1}else this.boneMatrices=new Float32Array(16*c);this.pose()}if(o)for(var p=0,m=o.length;m>p;p++){var v=o[p],g=new THREE.Animation(this,v);this.animations[v.name]=g,this.animationsList.push(g)}}},THREE.SkinnedMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.SkinnedMesh.prototype.playAnimation=function(e){void 0!==this.animations[e]&&this.animations[e].play()},THREE.SkinnedMesh.prototype.setAnimationWeight=function(e,t){void 0!==this.animations[e]&&this.animations[e].setWeight(t)},THREE.SkinnedMesh.prototype.setAnimationDirectionForward=function(e){void 0!==this.animations[e]&&this.animations[e].setDirectionForward()},THREE.SkinnedMesh.prototype.setAnimationDirectionBackward=function(e){void 0!==this.animations[e]&&this.animations[e].setDirectionBackward()},THREE.SkinnedMesh.prototype.update=function(e){for(var t=this.bones,a=0,r=t.length;r>a;a++){var i=t[a];i.firstAnimationFlag=!0}for(var a=0,r=this.animationsList.length;r>a;a++){var o=this.animationsList[a];o.update(e)}},THREE.SkinnedMesh.prototype.addBone=function(e){return void 0===e&&(e=new THREE.Bone(this)),this.bones.push(e),e},THREE.SkinnedMesh.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent?this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=0,a=this.children.length;a>t;t++){var r=this.children[t];r instanceof THREE.Bone?r.update(this.identityMatrix,!1):r.updateMatrixWorld(!0)}if(void 0==this.boneInverses){this.boneInverses=[];for(var i=0,o=this.bones.length;o>i;i++){var n=new THREE.Matrix4;n.getInverse(this.bones[i].skinMatrix),this.boneInverses.push(n)}}for(var i=0,o=this.bones.length;o>i;i++)THREE.SkinnedMesh.offsetMatrix.multiply(this.bones[i].skinMatrix,this.boneInverses[i]),THREE.SkinnedMesh.offsetMatrix.flattenToArrayOffset(this.boneMatrices,16*i);this.useVertexTexture&&(this.boneTexture.needsUpdate=!0)},THREE.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(!0);for(var e,t,a,r,i,o=0,n=this.geometries.length;n>o;o++)for(var s=this.geometries[o],l=s.attributes.skinWeight.array,h=0,d=l.length;d>h;h+=4)e=l[h],t=l[h+1],a=l[h+2],r=l[h+3],i=1/(Math.abs(e)+Math.abs(t)+Math.abs(a)+Math.abs(r)),1/0!==i?(l[h]*=i,l[h+1]*=i,l[h+2]*=i,l[h+3]*=i):l[h]=1},THREE.SkinnedMesh.prototype.clone=function(e){return void 0===e&&(e=new THREE.SkinnedMesh(this.geometries,this.materials,this.useVertexTexture)),THREE.Mesh.prototype.clone.call(this,e),e},THREE.SkinnedMesh.offsetMatrix=new THREE.Matrix4,THREE.TriangleStrip=function(e,t){THREE.Mesh.call(this,e,t)},THREE.TriangleStrip.prototype=Object.create(THREE.Mesh.prototype),THREE.TriangleStrip.prototype.clone=function(e){return void 0===e&&(e=new THREE.TriangleStrip(this.geometries,this.materials)),THREE.Mesh.prototype.clone.call(this,e),e},THREE.Particles=function(e,t){THREE.Node.call(this),this.geometries=e instanceof Array?e:e instanceof THREE.Geometry?[e]:[],this.materials=t instanceof Array?t:t instanceof THREE.Material?[t]:[];for(var a=0,r=this.geometries.length;r>a;a++){var i=this.geometries[a];null===i.boundingSphere&&i.computeBoundingSphere()}this.sortParticles=!1,this.frustumCulled=!1},THREE.Particles.prototype=Object.create(THREE.Node.prototype),THREE.Particles.prototype.clone=function(e){return void 0===e&&(e=new THREE.Particles(this.geometries,this.materials)),e.sortParticles=this.sortParticles,e.frustumCulled=this.frustumCulled,THREE.Node.prototype.clone.call(this,e),e},THREE.ImmediateRenderObject=function(){THREE.Node.call(this),this.boundingSphere=new THREE.Sphere,this.render=function(){}},THREE.ImmediateRenderObject.prototype=Object.create(THREE.Node.prototype),THREE.MarchingCubes=function(e,t,a,r){THREE.ImmediateRenderObject.call(this),this.materials=[t],this.boundingSphere.radius=1,this.enableUvs=void 0!==a?a:!1,this.enableColors=void 0!==r?r:!1,this.init=function(e){this.resolution=e,this.isolation=80,this.size=e,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(3*this.size3),this.vlist=new Float32Array(36),this.nlist=new Float32Array(36),this.firstDraw=!0,this.maxCount=4096,this.count=0,this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=new Float32Array(3*this.maxCount),this.normalArray=new Float32Array(3*this.maxCount),this.enableUvs&&(this.uvArray=new Float32Array(2*this.maxCount)),this.enableColors&&(this.colorArray=new Float32Array(3*this.maxCount))
},this.lerp=function(e,t,a){return e+(t-e)*a},this.VIntX=function(e,t,a,r,i,o,n,s,l,h){var d=(i-l)/(h-l),u=this.normal_cache;t[r]=o+d*this.delta,t[r+1]=n,t[r+2]=s,a[r]=this.lerp(u[e],u[e+3],d),a[r+1]=this.lerp(u[e+1],u[e+4],d),a[r+2]=this.lerp(u[e+2],u[e+5],d)},this.VIntY=function(e,t,a,r,i,o,n,s,l,h){var d=(i-l)/(h-l),u=this.normal_cache;t[r]=o,t[r+1]=n+d*this.delta,t[r+2]=s;var c=e+3*this.yd;a[r]=this.lerp(u[e],u[c],d),a[r+1]=this.lerp(u[e+1],u[c+1],d),a[r+2]=this.lerp(u[e+2],u[c+2],d)},this.VIntZ=function(e,t,a,r,i,o,n,s,l,h){var d=(i-l)/(h-l),u=this.normal_cache;t[r]=o,t[r+1]=n,t[r+2]=s+d*this.delta;var c=e+3*this.zd;a[r]=this.lerp(u[e],u[c],d),a[r+1]=this.lerp(u[e+1],u[c+1],d),a[r+2]=this.lerp(u[e+2],u[c+2],d)},this.compNorm=function(e){var t=3*e;0===this.normal_cache[t]&&(this.normal_cache[t]=this.field[e-1]-this.field[e+1],this.normal_cache[t+1]=this.field[e-this.yd]-this.field[e+this.yd],this.normal_cache[t+2]=this.field[e-this.zd]-this.field[e+this.zd])},this.polygonize=function(e,t,a,r,i,o){var n=r+1,s=r+this.yd,l=r+this.zd,h=n+this.yd,d=n+this.zd,u=r+this.yd+this.zd,c=n+this.yd+this.zd,f=0,p=this.field[r],m=this.field[n],v=this.field[s],g=this.field[h],S=this.field[l],x=this.field[d],y=this.field[u],G=this.field[c];i>p&&(f|=1),i>m&&(f|=2),i>v&&(f|=8),i>g&&(f|=4),i>S&&(f|=16),i>x&&(f|=32),i>y&&(f|=128),i>G&&(f|=64);var M=THREE.edgeTable[f];if(0===M)return 0;var w=this.delta,X=e+w,D=t+w,C=a+w;1&M&&(this.compNorm(r),this.compNorm(n),this.VIntX(3*r,this.vlist,this.nlist,0,i,e,t,a,p,m)),2&M&&(this.compNorm(n),this.compNorm(h),this.VIntY(3*n,this.vlist,this.nlist,3,i,X,t,a,m,g)),4&M&&(this.compNorm(s),this.compNorm(h),this.VIntX(3*s,this.vlist,this.nlist,6,i,e,D,a,v,g)),8&M&&(this.compNorm(r),this.compNorm(s),this.VIntY(3*r,this.vlist,this.nlist,9,i,e,t,a,p,v)),16&M&&(this.compNorm(l),this.compNorm(d),this.VIntX(3*l,this.vlist,this.nlist,12,i,e,t,C,S,x)),32&M&&(this.compNorm(d),this.compNorm(c),this.VIntY(3*d,this.vlist,this.nlist,15,i,X,t,C,x,G)),64&M&&(this.compNorm(u),this.compNorm(c),this.VIntX(3*u,this.vlist,this.nlist,18,i,e,D,C,y,G)),128&M&&(this.compNorm(l),this.compNorm(u),this.VIntY(3*l,this.vlist,this.nlist,21,i,e,t,C,S,y)),256&M&&(this.compNorm(r),this.compNorm(l),this.VIntZ(3*r,this.vlist,this.nlist,24,i,e,t,a,p,S)),512&M&&(this.compNorm(n),this.compNorm(d),this.VIntZ(3*n,this.vlist,this.nlist,27,i,X,t,a,m,x)),1024&M&&(this.compNorm(h),this.compNorm(c),this.VIntZ(3*h,this.vlist,this.nlist,30,i,X,D,a,g,G)),2048&M&&(this.compNorm(s),this.compNorm(u),this.VIntZ(3*s,this.vlist,this.nlist,33,i,e,D,a,v,y)),f<<=4;for(var _,b,A,T=0,P=0;-1!=THREE.triTable[f+P];)_=f+P,b=_+1,A=_+2,this.posnormtriv(this.vlist,this.nlist,3*THREE.triTable[_],3*THREE.triTable[b],3*THREE.triTable[A],o),P+=3,T++;return T},this.posnormtriv=function(e,t,a,r,i,o){var n=3*this.count;if(this.positionArray[n]=e[a],this.positionArray[n+1]=e[a+1],this.positionArray[n+2]=e[a+2],this.positionArray[n+3]=e[r],this.positionArray[n+4]=e[r+1],this.positionArray[n+5]=e[r+2],this.positionArray[n+6]=e[i],this.positionArray[n+7]=e[i+1],this.positionArray[n+8]=e[i+2],this.normalArray[n]=t[a],this.normalArray[n+1]=t[a+1],this.normalArray[n+2]=t[a+2],this.normalArray[n+3]=t[r],this.normalArray[n+4]=t[r+1],this.normalArray[n+5]=t[r+2],this.normalArray[n+6]=t[i],this.normalArray[n+7]=t[i+1],this.normalArray[n+8]=t[i+2],this.enableUvs){var s=2*this.count;this.uvArray[s]=e[a],this.uvArray[s+1]=e[a+2],this.uvArray[s+2]=e[r],this.uvArray[s+3]=e[r+2],this.uvArray[s+4]=e[i],this.uvArray[s+5]=e[i+2]}this.enableColors&&(this.colorArray[n]=e[a],this.colorArray[n+1]=e[a+1],this.colorArray[n+2]=e[a+2],this.colorArray[n+3]=e[r],this.colorArray[n+4]=e[r+1],this.colorArray[n+5]=e[r+2],this.colorArray[n+6]=e[i],this.colorArray[n+7]=e[i+1],this.colorArray[n+8]=e[i+2]),this.count+=3,this.count>=this.maxCount-3&&(this.hasPositions=!0,this.hasNormals=!0,this.enableUvs&&(this.hasUvs=!0),this.enableColors&&(this.hasColors=!0),o(this))},this.begin=function(){this.count=0,this.hasPositions=!1,this.hasNormals=!1,this.hasUvs=!1,this.hasColors=!1},this.end=function(e){if(0!==this.count){for(var t=3*this.count;t<this.positionArray.length;t++)this.positionArray[t]=0;this.hasPositions=!0,this.hasNormals=!0,this.enableUvs&&(this.hasUvs=!0),this.enableColors&&(this.hasColors=!0),e(this)}},this.addBall=function(e,t,a,r,i){var o=this.size*Math.sqrt(r/i),n=a*this.size,s=t*this.size,l=e*this.size,h=Math.floor(n-o);1>h&&(h=1);var d=Math.floor(n+o);d>this.size-1&&(d=this.size-1);var u=Math.floor(s-o);1>u&&(u=1);var c=Math.floor(s+o);c>this.size-1&&(c=this.size-1);var f=Math.floor(l-o);1>f&&(f=1);var p=Math.floor(l+o);p>this.size-1&&(p=this.size-1);var m,v,g,S,x,y,G,M,w,X,D;for(g=h;d>g;g++)for(x=this.size2*g,M=g/this.size-a,w=M*M,v=u;c>v;v++)for(S=x+this.size*v,G=v/this.size-t,X=G*G,m=f;p>m;m++)y=m/this.size-e,D=r/(1e-6+y*y+X+w)-i,D>0&&(this.field[S+m]+=D)},this.addPlaneX=function(e,t){var a,r,i,o,n,s,l,h=this.size,d=this.yd,u=this.zd,c=this.field,f=h*Math.sqrt(e/t);for(f>h&&(f=h),a=0;f>a;a++)if(s=a/h,o=s*s,n=e/(1e-4+o)-t,n>0)for(r=0;h>r;r++)for(l=a+r*d,i=0;h>i;i++)c[u*i+l]+=n},this.addPlaneY=function(e,t){var a,r,i,o,n,s,l,h,d=this.size,u=this.yd,c=this.zd,f=this.field,p=d*Math.sqrt(e/t);for(p>d&&(p=d),r=0;p>r;r++)if(s=r/d,o=s*s,n=e/(1e-4+o)-t,n>0)for(l=r*u,a=0;d>a;a++)for(h=l+a,i=0;d>i;i++)f[c*i+h]+=n},this.addPlaneZ=function(e,t){var a,r,i,o,n,s,l,h,d=this.size,u=this.yd,c=this.zd,f=this.field,p=d*Math.sqrt(e/t);for(p>d&&(p=d),i=0;p>i;i++)if(s=i/d,o=s*s,n=e/(1e-4+o)-t,n>0)for(l=c*i,r=0;d>r;r++)for(h=l+r*u,a=0;d>a;a++)f[h+a]+=n},this.reset=function(){var e;for(e=0;e<this.size3;e++)this.normal_cache[3*e]=0,this.field[e]=0},this.render=function(e){this.begin();var t,a,r,i,o,n,s,l,h,d=this.size-2;for(i=1;d>i;i++)for(h=this.size2*i,s=(i-this.halfsize)/this.halfsize,r=1;d>r;r++)for(l=h+this.size*r,n=(r-this.halfsize)/this.halfsize,a=1;d>a;a++)o=(a-this.halfsize)/this.halfsize,t=l+a,this.polygonize(o,n,s,t,this.isolation,e);this.end(e)},this.init(e)},THREE.MarchingCubes.prototype=Object.create(THREE.ImmediateRenderObject.prototype),THREE.edgeTable=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),THREE.triTable=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),THREE.Camera=function(){THREE.Node.call(this),this.matrixWorldInverse=new THREE.Matrix4,this.projectionMatrix=new THREE.Matrix4,this.projectionMatrixInverse=new THREE.Matrix4},THREE.Camera.prototype=Object.create(THREE.Node.prototype),THREE.Camera.prototype.lookAt=function(e){this.matrix.lookAt(this.position,e,this.up),this.rotationAutoUpdate===!0&&(this.useQuaternion===!1?this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder):this.quaternion.copy(this.matrix.decompose()[1]))},THREE.Camera.prototype.clone=function(e){return void 0===e&&(e=new THREE.Camera),THREE.Node.prototype.clone.call(this,e),e.matrixWorldInverse.copy(this.matrixWorldInverse),e.projectionMatrix.copy(this.projectionMatrix),e.projectionMatrixInverse.copy(this.projectionMatrixInverse),e},THREE.OrthographicCamera=function(e,t,a,r,i,o){THREE.Camera.call(this),this.left=e,this.right=t,this.top=a,this.bottom=r,this.near=void 0!==i?i:.1,this.far=void 0!==o?o:2e3,this.updateProjectionMatrix()},THREE.OrthographicCamera.prototype=Object.create(THREE.Camera.prototype),THREE.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)},THREE.OrthographicCamera.prototype.clone=function(e){return void 0===e&&(e=new THREE.OrthographicCamera),THREE.Camera.prototype.clone.call(this,e),e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e.near=this.near,e.far=this.far,e},THREE.PerspectiveCamera=function(e,t,a,r){THREE.Camera.call(this),this.fov=void 0!==e?e:50,this.aspect=void 0!==t?t:1,this.near=void 0!==a?a:.1,this.far=void 0!==r?r:2e3,this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype=Object.create(THREE.Camera.prototype),THREE.PerspectiveCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)},THREE.PerspectiveCamera.prototype.clone=function(e){return void 0===e&&(e=new THREE.PerspectiveCamera),THREE.Camera.prototype.clone.call(this,e),e.fov=this.fov,e.aspect=this.aspect,e.near=this.near,e.far=this.far,e},THREE.CubeCamera=function(e,t){THREE.Node.call(this);var a=90,r=1,i=new THREE.PerspectiveCamera(a,r,e,t);i.up.set(0,-1,0),i.lookAt(new THREE.Vector3(1,0,0)),this.add(i);var o=new THREE.PerspectiveCamera(a,r,e,t);o.up.set(0,-1,0),o.lookAt(new THREE.Vector3(-1,0,0)),this.add(o);var n=new THREE.PerspectiveCamera(a,r,e,t);n.up.set(0,0,1),n.lookAt(new THREE.Vector3(0,1,0)),this.add(n);var s=new THREE.PerspectiveCamera(a,r,e,t);s.up.set(0,0,-1),s.lookAt(new THREE.Vector3(0,-1,0)),this.add(s);var l=new THREE.PerspectiveCamera(a,r,e,t);l.up.set(0,-1,0),l.lookAt(new THREE.Vector3(0,0,1)),this.add(l);var h=new THREE.PerspectiveCamera(a,r,e,t);h.up.set(0,-1,0),h.lookAt(new THREE.Vector3(0,0,-1)),this.add(h),this.px=i,this.nx=o,this.py=n,this.ny=s,this.pz=l,this.nz=h},THREE.CubeCamera.prototype=Object.create(THREE.Node.prototype),THREE.Light=function(e){THREE.Node.call(this),this.color=new THREE.Color(e)},THREE.Light.prototype=Object.create(THREE.Node.prototype),THREE.AreaLight=function(e,t){THREE.Light.call(this,e),this.normal=new THREE.Vector3(0,-1,0),this.right=new THREE.Vector3(1,0,0),this.intensity=void 0!==t?t:1,this.width=1,this.height=1,this.constantAttenuation=1.5,this.linearAttenuation=.5,this.quadraticAttenuation=.1,this.texture=null,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=90,this.shadowCameraLeft=-500,this.shadowCameraRight=500,this.shadowCameraTop=500,this.shadowCameraBottom=-500,this.shadowCameraOrtho=!1,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512},THREE.AreaLight.prototype=Object.create(THREE.Light.prototype),THREE.DayLight=function(e,t,a,r,i){THREE.Light.call(this,e),this.skyColor=new THREE.Color(t),this.groundColor=new THREE.Color(a),this.position=new THREE.Vector3(0,100,0),this.hemiPosition=new THREE.Vector3(0,100,0),this.target=new THREE.Node,this.sunIntensity=void 0!==r?r:1,this.hemiIntensity=void 0!==i?i:1,this.castShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraRight=500,this.shadowCameraTop=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowCascade=!1,this.shadowCascadeOffset=new THREE.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0,0],this.shadowCascadeWidth=[512,512,512,512],this.shadowCascadeHeight=[512,512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[]},THREE.DayLight.prototype=Object.create(THREE.Light.prototype),THREE.DayLightCube=function(e,t){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,100,0),this.target=new THREE.Node,this.intensity=void 0!==t?t:1,this.textureSpecular=null,this.textureDiffuse=null,this.ambientIntensity=1,this.castShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraRight=500,this.shadowCameraTop=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowCascade=!1,this.shadowCascadeOffset=new THREE.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0,0],this.shadowCascadeWidth=[512,512,512,512],this.shadowCascadeHeight=[512,512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[]},THREE.DayLightCube.prototype=Object.create(THREE.Light.prototype),THREE.DirectionalLight=function(e,t){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,1,0),this.target=new THREE.Node,this.intensity=void 0!==t?t:1,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraRight=500,this.shadowCameraTop=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowCascade=!1,this.shadowCascadeOffset=new THREE.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0,0],this.shadowCascadeWidth=[512,512,512,512],this.shadowCascadeHeight=[512,512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[]},THREE.DirectionalLight.prototype=Object.create(THREE.Light.prototype),THREE.HemisphereLight=function(e,t,a){THREE.Light.call(this,e),this.groundColor=new THREE.Color(t),this.position=new THREE.Vector3(0,100,0),this.intensity=void 0!==a?a:1},THREE.HemisphereLight.prototype=Object.create(THREE.Light.prototype),THREE.PointLight=function(e,t,a){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,0,0),this.intensity=void 0!==t?t:1,this.distance=void 0!==a?a:0,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512},THREE.PointLight.prototype=Object.create(THREE.Light.prototype),THREE.SphereLight=function(e,t,a,r){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,0,0),this.intensity=void 0!==t?t:1,this.distance=void 0!==a?a:0,this.radius=void 0!==r?r:1,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512},THREE.SphereLight.prototype=Object.create(THREE.Light.prototype),THREE.TubeLight=function(e,t,a,r,i){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,0,0),this.intensity=void 0!==t?t:1,this.distance=void 0!==a?a:0,this.radius=void 0!==r?r:.1,this.length=void 0!==i?r:5,this.occlusionEnabled=!1,this.castShadow=!1,this.onlyShadow=!1,this.endPoint0=new THREE.Node,this.endPoint1=new THREE.Node,this.endPoint0.position.y=.5*-i,this.endPoint1.position.y=.5*i,this.add(this.endPoint0),this.add(this.endPoint1)},THREE.TubeLight.prototype=Object.create(THREE.Light.prototype),THREE.SpotLight=function(e,t,a,r,i){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,1,0),this.target=new THREE.Node,this.intensity=void 0!==t?t:1,this.distance=void 0!==a?a:0,this.angle=void 0!==r?r:Math.PI/2,this.exponent=void 0!==i?i:10,this.texture=null,this.textureCameraNear=1,this.textureCameraFar=5e3,this.textureCameraFov=50,this.textureCameraAspectScale=1,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512},THREE.SpotLight.prototype=Object.create(THREE.Light.prototype),THREE.ImageLight=function(e,t,a){THREE.Light.call(this,16777215),this.textureSpecular=e,this.textureDiffuse=t,this.textureMip=e,this.intensity=void 0!==a?a:1,this.local=!1,this.size=new THREE.Vector3(1,1,1)},THREE.ImageLight.prototype=Object.create(THREE.Light.prototype),THREE.LightProxy=function(e,t){this.light=e,this.renderer=t},THREE.LightProxy.prototype=Object.create(THREE.Mesh.prototype),THREE.LightProxy.prototype.update=function(e){var t=this.materials[0].uniforms;t.matProj&&(t.matProj.value=e.projectionMatrix),t.matProjInverse&&(t.matProjInverse.value=e.projectionMatrixInverse),t.matView&&(t.matView.value=e.matrixWorldInverse),t.matViewInverse&&(t.matViewInverse.value=e.matrixWorld),this.light&&(this.visible=this.light.visible)},THREE.LightProxy.prototype.resize=function(e,t){var a=this.materials[0],r=a.uniforms;r.viewSize&&r.viewSize.value.set(e,t)},THREE.LightProxy.prototype.setSamplers=function(e){var t=this.renderer,a=e.uniforms,r=t.getUseMultipleRenderTargets();if(r){var i=t.getCombinedTarget();a.viewSize.value.set(i.width,i.height),a.samplerDiffuseRGB&&(a.samplerDiffuseRGB.value=i.colorTexture[0]),a.samplerSpecularRGB&&(a.samplerSpecularRGB.value=i.colorTexture[1]),a.samplerWrapRGB&&(a.samplerWrapRGB.value=i.colorTexture[2]),a.samplerNormal&&(a.samplerNormal.value=i.colorTexture[3]),a.samplerDepth&&(a.samplerDepth.value=t.useDepthTexture?i.depthTexture:i.colorTexture[4])}else{var o=t.getColorTarget(),n=t.getNormalDepthTarget();a.viewSize.value.set(o.width,o.height),a.samplerColor&&(a.samplerColor.value=o),a.samplerNormalDepth&&(a.samplerNormalDepth.value=n)}var s=t.getSSAOTarget();a.samplerSSAO&&(a.samplerSSAO.value=s)},THREE.LightProxy.prototype.generateDefines=function(){var e=this.light,t=this.renderer,a={};if(t.shadowMapEnabled&&e&&e.castShadow){a.USE_SHADOWMAP=!0;var r=void 0!==e.shadowMapType?e.shadowMapType:t.shadowMapType;switch(r){case THREE.BasicShadowMap:a.SHADOWMAP_TYPE_BASIC=!0;break;case THREE.PCFShadowMap:a.SHADOWMAP_TYPE_PCF=!0;break;case THREE.PCFSoftShadowMap:a.SHADOWMAP_TYPE_PCF_SOFT=!0}a.SLOPE_DEPTH_BIAS=t.shadowMapSlopeDepthBias,a.SHADOWMAP_DEBUG=t.shadowMapDebug,a.DEPTH_TEXTURES=t.shadowMapUseDepthTextures&&t.renderer.supportsDepthTextures()}return t.ssaoEnabled&&e&&(a.USE_SSAO=!0),a.USE_MRT=t.getUseMultipleRenderTargets(),a.TEXTURE_DEPTH=t.useDepthTexture,a},THREE.LightProxy.prototype.setupDirectionalShadowmap=function(e){var t=this.light,a=this.renderer.renderer,r=t.properties,i=!a.supportsDepthOnlyRenderTarget(),o=a.supportsLuminanceFloatRenderTarget()?THREE.LuminanceFormat:THREE.RGBFormat,n={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:o,type:THREE.FloatType},s=this.renderer.shadowMapUseDepthTextures&&a.supportsDepthTextures(),l={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,useColorTexture:i,stencilBuffer:!1,format:o,useDepthTexture:!0,depthTextureType:this.renderer.shadowMapDepthTextureType},h=s?l:n;r.shadowMap=[],r.shadowMatrixDeferred=[],r.shadowMatrixForward=[],r.shadowCamera=[],r.pointsWorld=[],r.pointsFrustum=[];for(var d=0;e>d;d++){var u=new THREE.RenderTarget(t.shadowMapWidth,t.shadowMapHeight,h);u.generateMipmaps=!1,r.shadowMap[d]=u;var c=new THREE.OrthographicCamera(t.shadowCameraLeft,t.shadowCameraRight,t.shadowCameraTop,t.shadowCameraBottom,t.shadowCameraNear,t.shadowCameraFar);if(r.shadowCamera[d]=c,r.shadowMatrixDeferred[d]=new THREE.Matrix4,r.shadowMatrixForward[d]=new THREE.Matrix4,t.shadowCascade){r.pointsWorld[d]=[],r.pointsFrustum[d]=[];for(var f=r.pointsWorld[d],p=r.pointsFrustum[d],m=0;8>m;m++)f[m]=new THREE.Vector3,p[m]=new THREE.Vector3;var v=t.shadowCascadeNearZ[d],g=t.shadowCascadeFarZ[d];p[0].set(-1,-1,v),p[1].set(1,-1,v),p[2].set(-1,1,v),p[3].set(1,1,v),p[4].set(-1,-1,g),p[5].set(1,-1,g),p[6].set(-1,1,g),p[7].set(1,1,g)}r.shadowMapPars=new THREE.Vector4(t.shadowMapWidth,t.shadowMapHeight,t.shadowDarkness,t.shadowBias)}t.properties.cascadeCount=e},THREE.LightProxy.prototype.updateDirectionalShadowmap=function(e){var t=this.light,a=this.materials[0].uniforms,r=t.properties;if(t.shadowCascade&&!r.gyro){var i=new THREE.Gyroscope;i.position=t.shadowCascadeOffset,i.add(t),i.add(t.target),e.add(i),r.gyro=i}for(var o=0;o<r.cascadeCount;o++){var n=r.shadowMatrixDeferred[o],s=r.shadowMatrixForward[o],l=r.shadowCamera[o],h=r.shadowMap[o];n.multiply(l.projectionMatrix,l.matrixWorldInverse),s.multiply(THREE.LightProxy.biasMatrix,n),n.multiplySelf(e.matrixWorld),a.matShadow.value[o]=n,a.samplerShadowMap.value[o]=h.useDepthTexture?h.depthTexture:h}a.shadowDarkness.value=Math.sqrt(t.shadowDarkness),a.shadowBias.value=t.shadowBias,a.shadowMapSize.value.set(t.shadowMapWidth,t.shadowMapHeight)},THREE.LightProxy.geometryLightSphere=new THREE.SphereGeometry(1,16,8),THREE.LightProxy.geometryLightPlane=new THREE.PlaneGeometry(2,2),THREE.LightProxy.geometryLightBox=new THREE.BoxGeometry(1,1,1),THREE.LightProxy.positionVS=new THREE.Vector3,THREE.LightProxy.directionVS=new THREE.Vector3,THREE.LightProxy.rightVS=new THREE.Vector3,THREE.LightProxy.normalVS=new THREE.Vector3,THREE.LightProxy.upVS=new THREE.Vector3,THREE.LightProxy.biasMatrix=new THREE.Matrix4(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),THREE.SpotLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.spotLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines();i.SPOT_TEXTURE=!!e.texture;var o=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});this.setSamplers(o);var n=THREE.LightProxy.geometryLightPlane;THREE.Mesh.call(this,n,o);var s=e.properties;if(e.castShadow){var l=!t.renderer.supportsDepthOnlyRenderTarget(),h=t.renderer.supportsLuminanceFloatRenderTarget()?THREE.LuminanceFormat:THREE.RGBFormat,d={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:h,type:THREE.FloatType},u=t.shadowMapUseDepthTextures&&t.renderer.supportsDepthTextures(),c={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,useColorTexture:l,stencilBuffer:!1,format:h,useDepthTexture:!0,depthTextureType:t.shadowMapDepthTextureType},f=u?c:d,p=new THREE.RenderTarget(e.shadowMapWidth,e.shadowMapHeight,f);
p.wrapS=THREE.MirroredRepeatWrapping,p.wrapT=THREE.MirroredRepeatWrapping,p.generateMipmaps=!1,s.shadowMap=p;var m=e.shadowMapWidth/e.shadowMapHeight,v=new THREE.PerspectiveCamera(e.shadowCameraFov,m,e.shadowCameraNear,e.shadowCameraFar);s.shadowCamera=v,s.shadowMatrixDeferred=new THREE.Matrix4,s.shadowMatrixForward=new THREE.Matrix4,s.shadowMapPars=new THREE.Vector4(e.shadowMapWidth,e.shadowMapHeight,e.shadowDarkness,e.shadowBias)}if(e.texture){var g=e.texture.image,m=g.width/g.height,S=new THREE.PerspectiveCamera(e.textureCameraFov,m,e.textureCameraNear,e.textureCameraFar);s.textureCamera=S,s.textureMatrixDeferred=new THREE.Matrix4}},THREE.SpotLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.SpotLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=e.matrixWorldInverse,i=t.matrixWorld,o=THREE.LightProxy.positionVS,n=THREE.LightProxy.directionVS;o.copy(i.getPosition()),r.multiplyVector3(o),n.copy(i.getPosition()),n.subSelf(t.target.matrixWorld.getPosition()),n.normalize(),r.rotateAxis(n),a.lightPositionVS.value.copy(o),a.lightDirectionVS.value.copy(n),a.lightAngleCos.value=Math.cos(.5*t.angle),a.lightDistance.value=t.distance;var s=t.intensity*t.intensity;if(a.lightIntensity.value=s,a.lightColor.value.copyGammaToLinear(t.color),t.castShadow){var l=t.properties.shadowMatrixDeferred,h=t.properties.shadowMatrixForward,d=t.properties.shadowCamera,u=t.properties.shadowMap;l.multiply(d.projectionMatrix,d.matrixWorldInverse),h.multiply(THREE.LightProxy.biasMatrix,l),l.multiplySelf(e.matrixWorld),a.matShadow.value=l,a.samplerShadowMap.value=u.useDepthTexture?u.depthTexture:u,a.shadowDarkness.value=Math.sqrt(t.shadowDarkness),a.shadowBias.value=t.shadowBias,a.shadowMapSize.value.set(t.shadowMapWidth,t.shadowMapHeight)}if(t.texture){var c=t.properties.textureMatrixDeferred,f=t.properties.textureCamera,p=t.texture.image,m=p.width/p.height;f.fov=t.textureCameraFov,f.near=t.textureCameraNear,f.far=t.textureCameraFar,f.aspect=m*t.textureCameraAspectScale,f.updateProjectionMatrix(),f.position.copy(t.matrixWorld.getPosition()),t.target&&f.lookAt(t.target.matrixWorld.getPosition()),f.updateMatrixWorld(),f.matrixWorldInverse.getInverse(f.matrixWorld),c.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),c.multiplySelf(f.projectionMatrix),c.multiplySelf(f.matrixWorldInverse),c.multiplySelf(e.matrixWorld),a.matTexture.value=c,a.samplerTexture.value=t.texture}},THREE.AreaLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.areaLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines();i.AREA_TEXTURE=!!e.texture;var o=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});this.setSamplers(o);var n=THREE.LightProxy.geometryLightPlane;if(THREE.Mesh.call(this,n,o),e.castShadow){var s=e.properties,l=!t.renderer.supportsDepthOnlyRenderTarget(),h=t.renderer.supportsLuminanceFloatRenderTarget()?THREE.LuminanceFormat:THREE.RGBFormat,d={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:h,type:THREE.FloatType},u=t.shadowMapUseDepthTextures&&t.renderer.supportsDepthTextures(),c={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,useColorTexture:l,stencilBuffer:!1,format:h,useDepthTexture:!0,depthTextureType:t.shadowMapDepthTextureType},f=u?c:d,p=new THREE.RenderTarget(e.shadowMapWidth,e.shadowMapHeight,f);if(p.generateMipmaps=!1,s.shadowMap=p,e.shadowCameraOrtho)var m=new THREE.OrthographicCamera(e.shadowCameraLeft,e.shadowCameraRight,e.shadowCameraTop,e.shadowCameraBottom,e.shadowCameraNear,e.shadowCameraFar);else var v=e.shadowMapWidth/e.shadowMapHeight,m=new THREE.PerspectiveCamera(e.shadowCameraFov,v,e.shadowCameraNear,e.shadowCameraFar);s.shadowCamera=m,s.shadowMatrixDeferred=new THREE.Matrix4,s.shadowMatrixForward=new THREE.Matrix4,s.shadowMapPars=new THREE.Vector4(e.shadowMapWidth,e.shadowMapHeight,e.shadowDarkness,e.shadowBias)}},THREE.AreaLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.AreaLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=t.matrixWorld,i=e.matrixWorldInverse,o=THREE.LightProxy.positionVS,n=THREE.LightProxy.rightVS,s=THREE.LightProxy.normalVS,l=THREE.LightProxy.upVS;o.copy(r.getPosition()),i.multiplyVector3(o),a.lightPositionVS.value.copy(o),n.copy(t.right),s.copy(t.normal),r.rotateAxis(n),r.rotateAxis(s),i.rotateAxis(n),i.rotateAxis(s),l.cross(n,s),l.normalize(),a.lightRightVS.value.copy(n),a.lightNormalVS.value.copy(s),a.lightUpVS.value.copy(l),a.lightWidth.value=t.width,a.lightHeight.value=t.height,a.constantAttenuation.value=t.constantAttenuation,a.linearAttenuation.value=t.linearAttenuation,a.quadraticAttenuation.value=t.quadraticAttenuation,a.samplerTexture.value=t.texture;var h=t.intensity*t.intensity;if(a.lightIntensity.value=h,a.lightColor.value.copyGammaToLinear(t.color),t.castShadow){var d=t.properties.shadowMatrixDeferred,u=t.properties.shadowMatrixForward,c=t.properties.shadowCamera,f=t.properties.shadowMap;d.multiply(c.projectionMatrix,c.matrixWorldInverse),u.multiply(THREE.LightProxy.biasMatrix,d),d.multiplySelf(e.matrixWorld),a.matShadow.value=d,a.samplerShadowMap.value=f.useDepthTexture?f.depthTexture:f,a.shadowDarkness.value=Math.sqrt(t.shadowDarkness),a.shadowBias.value=t.shadowBias,a.shadowMapSize.value.set(t.shadowMapWidth,t.shadowMapHeight)}},THREE.DayLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.dayLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines(e),o=e.shadowCascade?e.shadowCascadeCount:1;i.SHADOWMAP_COUNT=o;var n=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});this.setSamplers(n);var s=THREE.LightProxy.geometryLightPlane;THREE.Mesh.call(this,s,n),e.castShadow&&this.setupDirectionalShadowmap(o)},THREE.DayLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.DayLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=THREE.LightProxy.directionVS;r.copy(t.matrixWorld.getPosition()),r.subSelf(t.target.matrixWorld.getPosition()),r.normalize(),e.matrixWorldInverse.rotateAxis(r),a.lightDirectionVSSun.value.copy(r),r.copy(t.hemiPosition),r.normalize(),e.matrixWorldInverse.rotateAxis(r),a.lightDirectionVSHemi.value.copy(r);var i=t.sunIntensity*t.sunIntensity,o=t.hemiIntensity*t.hemiIntensity;a.lightIntensitySun.value=i,a.lightIntensityHemi.value=o,a.lightColorSun.value.copyGammaToLinear(t.color),a.lightColorSky.value.copyGammaToLinear(t.skyColor),a.lightColorGround.value.copyGammaToLinear(t.groundColor),t.castShadow&&this.updateDirectionalShadowmap(e)},THREE.DayLightCubeProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.dayLightCube,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines(e),o=e.shadowCascade?e.shadowCascadeCount:1;i.SHADOWMAP_COUNT=o,t.specularMipFix&&(i["SPECULAR_MIP_FIX "]=!0);var n=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});this.setSamplers(n);var s=THREE.LightProxy.geometryLightPlane;THREE.Mesh.call(this,s,n),e.castShadow&&this.setupDirectionalShadowmap(o)},THREE.DayLightCubeProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.DayLightCubeProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=THREE.LightProxy.directionVS;r.copy(t.matrixWorld.getPosition()),r.subSelf(t.target.matrixWorld.getPosition()),r.normalize(),e.matrixWorldInverse.rotateAxis(r),a.lightDirectionVSSun.value.copy(r),a.samplerSpecular.value=t.textureSpecular,a.samplerDiffuse.value=t.textureDiffuse,a.maxMipSpecular.value=t.textureSpecular.mipmapCount;var i=t.intensity*t.intensity,o=t.ambientIntensity*t.ambientIntensity;a.lightIntensitySun.value=i,a.lightIntensityAmbient.value=o,a.lightColorSun.value.copyGammaToLinear(t.color),t.castShadow&&this.updateDirectionalShadowmap(e)},THREE.DirectionalLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.directionalLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines(e),o=e.shadowCascade?e.shadowCascadeCount:1;i.SHADOWMAP_COUNT=o;var n=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});this.setSamplers(n);var s=THREE.LightProxy.geometryLightPlane;THREE.Mesh.call(this,s,n),e.castShadow&&this.setupDirectionalShadowmap(o)},THREE.DirectionalLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.DirectionalLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=THREE.LightProxy.directionVS;r.copy(t.matrixWorld.getPosition()),r.subSelf(t.target.matrixWorld.getPosition()),r.normalize(),e.matrixWorldInverse.rotateAxis(r),a.lightDirectionVS.value.copy(r);var i=t.intensity*t.intensity;a.lightIntensity.value=i,a.lightColor.value.copyGammaToLinear(t.color),t.castShadow&&this.updateDirectionalShadowmap(e)},THREE.HemisphereLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.hemisphereLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines(e),o=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});this.setSamplers(o);var n=THREE.LightProxy.geometryLightPlane;THREE.Mesh.call(this,n,o)},THREE.HemisphereLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.HemisphereLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=THREE.LightProxy.directionVS;r.copy(t.matrixWorld.getPosition()),r.normalize(),e.matrixWorldInverse.rotateAxis(r),a.lightDirectionVS.value.copy(r);var i=t.intensity*t.intensity;a.lightIntensity.value=i,a.lightColorSky.value.copyGammaToLinear(t.color),a.lightColorGround.value.copyGammaToLinear(t.groundColor)},THREE.PointLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.pointLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines();i.SHADOWMAP_COUNT=6;var o,n=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0});if(e.distance>0?(o=THREE.LightProxy.geometryLightSphere,n.depthTest=!0,n.side=THREE.BackSide):(o=THREE.LightProxy.geometryLightPlane,n.depthTest=!1,n.side=THREE.FrontSide),this.setSamplers(n),THREE.Mesh.call(this,o,n),e.castShadow){var s=e.properties;s.shadowMap=[],s.shadowCamera=[],s.shadowMatrixDeferred=[],s.shadowMatrixForward=[];for(var l=!t.renderer.supportsDepthOnlyRenderTarget(),h=t.renderer.supportsLuminanceFloatRenderTarget()?THREE.LuminanceFormat:THREE.RGBFormat,d={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:h,type:THREE.FloatType},u=t.shadowMapUseDepthTextures&&t.renderer.supportsDepthTextures(),c={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,useColorTexture:l,stencilBuffer:!1,format:h,useDepthTexture:!0,depthTextureType:t.shadowMapDepthTextureType},f=u?c:d,p=[new THREE.Vector3(0,-1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,-1),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,-1,0)],m=[new THREE.Vector3(1,0,0),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,-1)],v=0;6>v;v++){var g=new THREE.RenderTarget(e.shadowMapWidth,e.shadowMapHeight,f);g.generateMipmaps=!1,s.shadowMap[v]=g;var S=e.shadowMapWidth/e.shadowMapHeight,x=new THREE.PerspectiveCamera(90,S,e.shadowCameraNear,e.shadowCameraFar);x.up.copy(p[v]),x.lookAt(m[v]),s.shadowCamera[v]=x,s.shadowMatrixDeferred[v]=new THREE.Matrix4,s.shadowMatrixForward[v]=new THREE.Matrix4}}},THREE.PointLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.PointLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=t.properties,i=t.distance;if(i>0){var o=THREE.LightProxy.positionVS;this.scale.set(1,1,1).multiplyScalar(i),a.lightDistance.value=i,o.copy(t.matrixWorld.getPosition()),e.matrixWorldInverse.multiplyVector3(o),a.lightPositionVS.value.copy(o),this.position.copy(t.matrixWorld.getPosition())}else a.lightDistance.value=1/0;var n=t.intensity*t.intensity;if(a.lightIntensity.value=n,a.lightColor.value.copyGammaToLinear(t.color),t.castShadow){for(var s=0;6>s;s++){var l=r.shadowMatrixDeferred[s],h=r.shadowMatrixForward[s],d=r.shadowCamera[s],u=r.shadowMap[s];l.multiply(d.projectionMatrix,d.matrixWorldInverse),h.multiply(THREE.LightProxy.biasMatrix,l),l.multiplySelf(e.matrixWorld),a.matShadow.value[s]=l,a.samplerShadowMap.value[s]=u.useDepthTexture?u.depthTexture:u}a.shadowDarkness.value=Math.sqrt(t.shadowDarkness),a.shadowBias.value=t.shadowBias,a.shadowMapSize.value.set(t.shadowMapWidth,t.shadowMapHeight)}},THREE.SphereLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.sphereLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines();i.SHADOWMAP_COUNT=6;var o,n=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0});if(e.distance>0?(o=THREE.LightProxy.geometryLightSphere,n.depthTest=!0,n.side=THREE.BackSide):(o=THREE.LightProxy.geometryLightPlane,n.depthTest=!1,n.side=THREE.FrontSide),this.setSamplers(n),THREE.Mesh.call(this,o,n),e.castShadow){var s=e.properties;s.shadowMap=[],s.shadowCamera=[],s.shadowMatrixDeferred=[],s.shadowMatrixForward=[];for(var l=!t.renderer.supportsDepthOnlyRenderTarget(),h=t.renderer.supportsLuminanceFloatRenderTarget()?THREE.LuminanceFormat:THREE.RGBFormat,d={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:h,type:THREE.FloatType},u=t.shadowMapUseDepthTextures&&t.renderer.supportsDepthTextures(),c={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,useColorTexture:l,stencilBuffer:!1,format:h,useDepthTexture:!0,depthTextureType:t.shadowMapDepthTextureType},f=u?c:d,p=[new THREE.Vector3(0,-1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,-1),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,-1,0)],m=[new THREE.Vector3(1,0,0),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,-1)],v=0;6>v;v++){var g=new THREE.RenderTarget(e.shadowMapWidth,e.shadowMapHeight,f);g.generateMipmaps=!1,s.shadowMap[v]=g;var S=e.shadowMapWidth/e.shadowMapHeight,x=new THREE.PerspectiveCamera(90,S,e.shadowCameraNear,e.shadowCameraFar);x.up.copy(p[v]),x.lookAt(m[v]),s.shadowCamera[v]=x,s.shadowMatrixDeferred[v]=new THREE.Matrix4,s.shadowMatrixForward[v]=new THREE.Matrix4}}},THREE.SphereLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.SphereLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=t.properties,i=t.distance;if(i>0){var o=THREE.LightProxy.positionVS;this.scale.set(1,1,1).multiplyScalar(i),a.lightDistance.value=i,o.copy(t.matrixWorld.getPosition()),e.matrixWorldInverse.multiplyVector3(o),a.lightPositionVS.value.copy(o),this.position.copy(t.matrixWorld.getPosition())}else a.lightDistance.value=1/0;a.lightRadius.value=t.radius;var n=t.intensity*t.intensity;if(a.lightIntensity.value=n,a.lightColor.value.copyGammaToLinear(t.color),t.castShadow){for(var s=0;6>s;s++){var l=r.shadowMatrixDeferred[s],h=r.shadowMatrixForward[s],d=r.shadowCamera[s],u=r.shadowMap[s];l.multiply(d.projectionMatrix,d.matrixWorldInverse),h.multiply(THREE.LightProxy.biasMatrix,l),l.multiplySelf(e.matrixWorld),a.matShadow.value[s]=l,a.samplerShadowMap.value[s]=u.useDepthTexture?u.depthTexture:u}a.shadowDarkness.value=Math.sqrt(t.shadowDarkness),a.shadowBias.value=t.shadowBias,a.shadowMapSize.value.set(t.shadowMapWidth,t.shadowMapHeight)}},THREE.TubeLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.tubeLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines();e.occlusionEnabled&&(i.OCCLUSION_ENABLED=!0);var o=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0,side:THREE.FrontSide}),n=THREE.LightProxy.geometryLightPlane;this.setSamplers(o),THREE.Mesh.call(this,n,o)},THREE.TubeLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.TubeLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms,r=THREE.LightProxy.positionVS;r.copy(t.endPoint0.matrixWorld.getPosition()),e.matrixWorldInverse.multiplyVector3(r),a.lightPosition0VS.value.copy(r),r.copy(t.endPoint1.matrixWorld.getPosition()),e.matrixWorldInverse.multiplyVector3(r),a.lightPosition1VS.value.copy(r),a.lightDistance.value=t.distance,a.lightRadius.value=t.radius;var i=t.intensity*t.intensity;a.lightIntensity.value=i,a.lightColor.value.copyGammaToLinear(t.color)},THREE.ImageLightProxy=function(e,t){THREE.LightProxy.call(this,e,t);var a=THREE.DeferredShaders.imageLight,r=THREE.UniformsUtils.clone(a.uniforms),i=this.generateDefines();e.textureSpecular instanceof THREE.RenderTargetCube&&(i.CUBE_SPECULAR_LINEAR=!0),e.textureDiffuse instanceof THREE.RenderTargetCube&&(i.CUBE_DIFFUSE_LINEAR=!0),e.local&&(i.LIGHT_LOCAL=!0),t.specularMipFix&&(i["SPECULAR_MIP_FIX "]=!0);var o=new THREE.ShaderMaterial({uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:i,blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0});this.setSamplers(o);var n;e.local?(n=THREE.LightProxy.geometryLightBox,o.depthTest=!0,o.side=THREE.BackSide):(n=THREE.LightProxy.geometryLightPlane,o.depthTest=!1,o.side=THREE.FrontSide),THREE.Mesh.call(this,n,o)},THREE.ImageLightProxy.prototype=Object.create(THREE.LightProxy.prototype),THREE.ImageLightProxy.prototype.update=function(e){THREE.LightProxy.prototype.update.call(this,e);var t=this.light,a=this.materials[0].uniforms;a.samplerSpecular.value=t.textureSpecular,a.samplerDiffuse.value=t.textureDiffuse,a.samplerMip.value=t.textureMip,a.maxMipSpecular.value=t.textureSpecular.mipmapCount;var r=t.intensity*t.intensity;if(a.lightIntensity.value=r,t.local){var i=t.size,o=t.matrixWorld.getPosition();this.position.copy(o),this.scale.copy(i),a.lightSize.value.copy(i).multiplyScalar(.5),a.lightPositionWS.value.copy(o)}},THREE.FirstPersonControls=function(e,t){var a=this;this.element=t,this.enabled=!1,this.movementSpeed=1,this.decaySpeed=1,this.lookSpeed=.1,this.amplitude=.1,this.frequency=2;var r=new THREE.Node;r.add(e);var i=new THREE.Node;i.add(r);var o=new THREE.Node;o.add(i);var n=!1,s=!1,l=!1,h=!1,d=new THREE.Vector3,u=0,c=Math.PI/2,f=function(e){var t=.001;if(a.enabled!==!1){var r=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0;o.rotation.y-=r*a.lookSpeed*t,i.rotation.x-=n*a.lookSpeed*t,i.rotation.x=THREE.Math.clamp(i.rotation.x,-c,c)}},p=function(e){switch(e.keyCode){case 38:case 87:n=!0;break;case 37:case 65:l=!0;break;case 40:case 83:s=!0;break;case 39:case 68:h=!0}},m=function(e){switch(e.keyCode){case 38:case 87:n=!1;break;case 37:case 65:l=!1;break;case 40:case 83:s=!1;break;case 39:case 68:h=!1}},v=function(){a.enabled=document.pointerLockElement===a.element||document.mozPointerLockElement===a.element||document.webkitPointerLockElement===a.element?!0:!1};document.addEventListener("mousemove",f,!1),document.addEventListener("keydown",p,!1),document.addEventListener("keyup",m,!1),document.addEventListener("click",function(){var e="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(!e)return void console.warn("Pointer lock not available");var t=a.element;t.requestPointerLock=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;var r=/Firefox/i.test(navigator.userAgent);if(r){var i=function(){(document.fullscreenElement===t||document.mozFullscreenElement===t||document.mozFullScreenElement===t)&&(document.removeEventListener("fullscreenchange",i),document.removeEventListener("mozfullscreenchange",i),t.requestPointerLock())};document.addEventListener("fullscreenchange",i,!1),document.addEventListener("mozfullscreenchange",i,!1),t.requestFullscreen=t.requestFullscreen||t.mozRequestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullscreen,t.requestFullscreen()}else t.requestPointerLock();document.addEventListener("pointerlockchange",v,!1),document.addEventListener("mozpointerlockchange",v,!1),document.addEventListener("webkitpointerlockchange",v,!1)}),this.getRoot=function(){return o},this.attachCamera=function(e){r.add(e)},this.lookAt=function(e){o.updateMatrixWorld(),o.lookAt(e),o.rotation.x=0,o.rotation.z=0,o.rotation.y*=-1},this.update=function(e){if(u+=e,a.enabled!==!1){var t=a.movementSpeed,i=a.decaySpeed;d.x+=-d.x*i*e,d.z+=-d.z*i*e;var c=Math.sqrt(d.x*d.x+d.z*d.z);r.position.y=c*a.amplitude*Math.sin(u*a.frequency),n&&(d.z-=t*e),s&&(d.z+=t*e),l&&(d.x-=t*e),h&&(d.x+=t*e),o.translateX(d.x),o.translateY(d.y),o.translateZ(d.z)}}},THREE.Loader=function(e){this.showStatus=e,this.statusDomElement=e?THREE.Loader.prototype.addStatusElement():null,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.textureMap={}},THREE.Loader.prototype={constructor:THREE.Loader,crossOrigin:"anonymous",addStatusElement:function(){var e=document.createElement("div");return e.style.position="absolute",e.style.right="0px",e.style.top="0px",e.style.fontSize="0.8em",e.style.textAlign="left",e.style.background="rgba(0,0,0,0.25)",e.style.color="#fff",e.style.width="120px",e.style.padding="0.5em 0.5em 0.5em 0.5em",e.style.zIndex=1e3,e.innerHTML="Loading ...",e},updateProgress:function(e){var t="Loaded ";t+=e.total?(100*e.loaded/e.total).toFixed(0)+"%":(e.loaded/1e3).toFixed(2)+" KB",this.statusDomElement.innerHTML=t},extractUrlBase:function(e){var t=e.split("/");return t.pop(),(t.length<1?".":t.join("/"))+"/"},initMaterials:function(e,t){for(var a=[],r=0;r<e.length;++r)a[r]=this.createMaterial(e[r],t);return a},needsTangents:function(e){for(var t=0,a=e.length;a>t;t++){var r=e[t];if(r instanceof THREE.ShaderMaterial)return!0}return!1},createMaterial:function(e,t,a){function r(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)==t}function i(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))}function o(e,t){var a=new Image;a.onload=function(){if(r(this.width)&&r(this.height))e.image=this;else{var t=i(this.width),a=i(this.height),o=document.createElement("canvas");o.width=t,o.height=a,o.getContext("2d").drawImage(this,0,0,t,a),e.image=o}e.needsUpdate=!0},a.crossOrigin=d.crossOrigin,a.src=t}function n(e,t){return"/"===e[e.length-1]?e+t:e+"/"+t}function s(e,t,a,r,i){var o=e;return t&&(o+="_R["+t[0]+"_"+t[1]+"]"),a&&(o+="_O["+a[0]+"_"+a[1]+"]"),r&&(o+="_W["+r[0]+"_"+r[1]+"]"),i&&(o+="_A["+i+"]"),o}function l(e,r,i,l,h,u,c){var f,p=n(t,i),m=s(p,l,h,u,c);if(void 0===d.textureMap[m]){var v,g=i.toLowerCase().endsWith(".dds"),S=i.toLowerCase().endsWith(".crn");if(g?a?(v=new THREE.CompressedTexture,f=v,THREE.ImageUtils.generateDummyCompressedTexture(v)):v=THREE.ImageUtils.loadCompressedTexture(p):S?a?(v=new THREE.CompressedTexture,f=v,THREE.ImageUtils.generateDummyCompressedTexture(v)):v=THREE.ImageUtils.loadCRNTexture(p):(v=new THREE.Texture,o(v,p)),v.sourceFile=i,l&&(v.repeat.set(l[0],l[1]),1!==l[0]&&(v.wrapS=THREE.RepeatWrapping),1!==l[1]&&(v.wrapT=THREE.RepeatWrapping)),h&&v.offset.set(h[0],h[1]),u){var x={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};void 0!==x[u[0]]&&(v.wrapS=x[u[0]]),void 0!==x[u[1]]&&(v.wrapT=x[u[1]])}c&&(v.anisotropy=c),d.textureMap[m]=v}return e[r]=d.textureMap[m],f}function h(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}var d=this,u="PhongMaterial",c={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null};if(e.shading){var f=e.shading.toLowerCase();"phong"===f?u="PhongMaterial":"basic"===f&&(u="EmissiveMaterial")}void 0!==e.blending&&void 0!==XG[e.blending]&&(c.blending=XG[e.blending]),(void 0!==e.transparent||e.transparency<1)&&(c.transparent=e.transparent),void 0!==e.depthTest&&(c.depthTest=e.depthTest),void 0!==e.depthWrite&&(c.depthWrite=e.depthWrite),void 0!==e.visible&&(c.visible=e.visible),void 0!==e.flipSided&&(c.side=THREE.BackSide),void 0!==e.doubleSided&&(c.side=THREE.DoubleSide),void 0!==e.vertexColors&&(c.vertexColors=e.vertexColors),void 0!==e.skinning&&(c.skinning=e.skinning),void 0!==e.wrapAround&&(c.wrapAround=e.wrapAround),void 0!==e.wrapRGB&&(c.wrapRGB=new THREE.Vector3(e.wrapRGB[0],e.wrapRGB[1],e.wrapRGB[2])),e.colorDiffuse?c.color=h(e.colorDiffuse):e.DbgColor&&(c.color=e.DbgColor),e.colorSpecular&&(c.specular=h(e.colorSpecular)),e.colorAmbient&&(c.ambient=h(e.colorAmbient)),e.transparency&&(c.opacity=e.transparency),e.specularCoef&&(c.shininess=e.specularCoef);var p,m=[];e.mapDiffuse&&t&&(p=l(c,"map",e.mapDiffuse,e.mapDiffuseRepeat,e.mapDiffuseOffset,e.mapDiffuseWrap,e.mapDiffuseAnisotropy),p&&m.push([p,e.mapDiffuse])),e.mapLight&&t&&(p=l(c,"lightMap",e.mapLight,e.mapLightRepeat,e.mapLightOffset,e.mapLightWrap,e.mapLightAnisotropy),p&&m.push([p,e.mapLight])),e.mapBump&&t&&(p=l(c,"bumpMap",e.mapBump,e.mapBumpRepeat,e.mapBumpOffset,e.mapBumpWrap,e.mapBumpAnisotropy),p&&m.push([p,e.mapBump])),e.mapNormal&&t&&(p=l(c,"normalMap",e.mapNormal,e.mapNormalRepeat,e.mapNormalOffset,e.mapNormalWrap,e.mapNormalAnisotropy),p&&m.push([p,e.mapNormal])),e.mapSpecular&&t&&(p=l(c,"specularMap",e.mapSpecular,e.mapSpecularRepeat,e.mapSpecularOffset,e.mapSpecularWrap,e.mapSpecularAnisotropy),p&&m.push([p,e.mapSpecular])),e.mapGloss&&t&&(p=l(c,"glossMap",e.mapGloss,e.mapGlossRepeat,e.mapGlossOffset,e.mapGlossWrap,e.mapGlossAnisotropy),p&&m.push([p,e.mapGloss])),e.mapNormalGloss&&t&&(p=l(c,"normalGlossMap",e.mapNormalGloss,e.mapNormalGlossRepeat,e.mapNormalGlossOffset,e.mapNormalGlossWrap,e.mapNormalGlossAnisotropy),p&&m.push([p,e.mapNormalGloss])),e.mapBumpScale&&(c.bumpScale=e.mapBumpScale),e.mapNormalScale&&(c.normalScale=new THREE.Vector2(e.mapNormalScale[0],e.mapNormalScale[1]));var v=new XG[u](c);return void 0!==e.DbgName&&(v.name=e.DbgName),v.properties={texturesToLoad:m},v}},THREE.UTF8Loader=function(){},THREE.UTF8Loader.prototype.load=function(e,t,a){this.downloadModelJson(e,a,t)},THREE.UTF8Loader.MaterialCreator=function(e,t){this.materials={},this.textureMap={};for(var a in t)this.createMaterial(a,t[a],e)},THREE.UTF8Loader.MaterialCreator.prototype.get=function(e){return this.materials[e]},THREE.UTF8Loader.MaterialCreator.prototype.createMaterial=function(e,t,a){var r=this,i=function(e){var t=a+e;if(void 0===r.textureMap[t]){var i,o=e.toLowerCase().endsWith(".dds"),n=e.toLowerCase().endsWith(".crn");i=o?THREE.ImageUtils.loadCompressedTexture(t):n?THREE.ImageUtils.loadCRNTexture(t):THREE.ImageUtils.loadTexture(t),r.textureMap[t]=i}return r.textureMap[t]},o={};for(var n in t){var s=t[n];switch(n.toLowerCase()){case"kd":o.color=(new THREE.Color).setRGB(s[0]/255,s[1]/255,s[2]/255);break;case"ka":o.ambient=(new THREE.Color).setRGB(s[0]/255,s[1]/255,s[2]/255);break;case"ks":o.specular=(new THREE.Color).setRGB(s[0]/255,s[1]/255,s[2]/255);break;case"map_kd":o.map=i(s);break;case"map_ks":o.specularMap=i(s);break;case"map_light":o.lightMap=i(s);break;case"map_normal":o.normalMap=i(s);break;case"map_bump":o.bumpMap=i(s);break;case"map_gloss":o.glossMap=i(s);break;case"ns":o.shininess=s;break;case"side":var l=s.toLowerCase();o.side="double"===l?THREE.DoubleSide:"back"===l?THREE.BackSide:THREE.FrontSide;break;case"alphatest":o.alphaTest=s;break;case"d":1>s&&(o.opacity=s,o.transparent=!0)}}!o.ambient&&o.color&&(o.ambient=o.color),this.materials[e]=new THREE.PhongMaterial(o)},THREE.UTF8Loader.GeometryCreator=function(){},THREE.UTF8Loader.GeometryCreator.prototype.create=function(e,t){var a,r,i,o,n,s,l,h,d=new THREE.Geometry,u=e.length/8,c=new Float32Array(3*u),f=new Float32Array(3*u),p=new Float32Array(2*u),m=e.length,v=8;for(r=0,i=0,a=i;m>a;a+=v)o=e[a],n=e[a+1],s=e[a+2],c[r++]=o,c[r++]=n,c[r++]=s;for(r=0,i=3,a=i;m>a;a+=v)l=e[a],h=e[a+1],p[r++]=l,p[r++]=h;for(r=0,i=5,a=i;m>a;a+=v)o=e[a],n=e[a+1],s=e[a+2],f[r++]=o,f[r++]=n,f[r++]=s;return d.addAttributeArray("index",t,1),d.addAttributeArray("position",c,3),d.addAttributeArray("normal",f,3),d.addAttributeArray("uv",p,2),d.offsets=[{start:0,count:t.length,index:0}],d.computeBoundingSphere(),d};var DEFAULT_DECODE_PARAMS={decodeOffsets:[-4095,-4095,-4095,0,0,-511,-511,-511],decodeScales:[1/8191,1/8191,1/8191,1/1023,1/1023,1/1023,1/1023,1/1023]};THREE.UTF8Loader.prototype.decompressAttribsInner_=function(e,t,a,r,i,o,n,s){for(var l=0,h=t;a>h;h++){var d=e.charCodeAt(h);l+=d>>1^-(1&d),r[i]=s*(l+n),i+=o}},THREE.UTF8Loader.prototype.decompressIndices_=function(e,t,a,r,i){for(var o=0,n=0;a>n;n++){var s=e.charCodeAt(t++);r[i++]=o-s,0===s&&o++}},THREE.UTF8Loader.prototype.decompressAABBs_=function(e,t,a,r,i){for(var o=6*a,n=t+o,s=0,l=new Float32Array(o),h=t;n>h;h+=6){var d=e.charCodeAt(h+0)+r[0],u=e.charCodeAt(h+1)+r[1],c=e.charCodeAt(h+2)+r[2],f=e.charCodeAt(h+3)+1>>1,p=e.charCodeAt(h+4)+1>>1,m=e.charCodeAt(h+5)+1>>1;l[s++]=i[0]*(d+f),l[s++]=i[1]*(u+p),l[s++]=i[2]*(c+m),l[s++]=i[0]*f,l[s++]=i[1]*p,l[s++]=i[2]*m}return l},THREE.UTF8Loader.prototype.decompressMesh=function(e,t,a,r,i,o){for(var n=a.decodeScales.length,s=a.decodeOffsets,l=a.decodeScales,h=t.attribRange[0],d=t.attribRange[1],u=h,c=new Float32Array(n*d),f=0;n>f;f++){var p=u+d,m=l[f];m&&this.decompressAttribsInner_(e,u,p,c,f,n,s[f],m),u=p}var v=3*t.indexRange[1],g=new Uint16Array(v);this.decompressIndices_(e,u,v,g,0);var S=void 0,x=t.bboxes;x&&(S=this.decompressAABBs_(e,x,t.names.length,s,l)),o(r,i,c,g,S,t)},THREE.UTF8Loader.prototype.copyAttrib=function(e,t,a,r){for(var i=0;e>i;i++)a[i]=t[e*r+i]},THREE.UTF8Loader.prototype.decodeAttrib2=function(e,t,a,r,i,o,n,s,l,h){for(var d=0;5>d;d++){var u=e.charCodeAt(i+o*d+h),c=u>>1^-(1&u);l[d]+=c,s[t*h+d]=l[d],n[t*h+d]=r[d]*(l[d]+a[d])}},THREE.UTF8Loader.prototype.accumulateNormal=function(e,t,a,r,i){var o=r[8*e],n=r[8*e+1],s=r[8*e+2],l=r[8*t],h=r[8*t+1],d=r[8*t+2],u=r[8*a],c=r[8*a+1],f=r[8*a+2];l-=o,h-=n,d-=s,u-=o,c-=n,f-=s,o=h*f-d*c,n=d*u-l*f,s=l*c-h*u,i[3*e]+=o,i[3*e+1]+=n,i[3*e+2]+=s,i[3*t]+=o,i[3*t+1]+=n,i[3*t+2]+=s,i[3*a]+=o,i[3*a+1]+=n,i[3*a+2]+=s},THREE.UTF8Loader.prototype.decompressMesh2=function(e,t,a,r,i,o){for(var n=96,s=a.decodeScales.length,l=a.decodeOffsets,h=a.decodeScales,d=t.attribRange[0],u=t.attribRange[1],c=t.codeRange[0],f=(t.codeRange[1],3*t.codeRange[2]),p=new Uint16Array(f),m=new Int32Array(3*u),v=new Uint16Array(s),g=new Uint16Array(s*u),S=new Float32Array(s*u),x=0,y=0,G=0;f>G;G+=3){var M=e.charCodeAt(c++),w=Math.min(G,n);if(w>M){var X,D,C,_=M%3,b=G-(M-_);switch(_){case 0:X=p[b+2],D=p[b+1],C=p[b+0];break;case 1:X=p[b+0],D=p[b+2],C=p[b+1];break;case 2:X=p[b+1],D=p[b+0],C=p[b+2]}p[y++]=X,p[y++]=D,M=e.charCodeAt(c++);var A=x-M;if(p[y++]=A,0===M){for(var T=0;5>T;T++){var P=e.charCodeAt(d+u*T+x),L=(P>>1^-(1&P))+g[s*X+T]+g[s*D+T]-g[s*C+T];v[T]=L,g[s*x+T]=L,S[s*x+T]=h[T]*(L+l[T])}x++}else this.copyAttrib(s,g,v,A);this.accumulateNormal(X,D,A,g,m)}else{var E=x-(M-w);p[y++]=E,M===w?this.decodeAttrib2(e,s,l,h,d,u,S,g,v,x++):this.copyAttrib(s,g,v,E),M=e.charCodeAt(c++);var F=x-M;p[y++]=F,0===M?this.decodeAttrib2(e,s,l,h,d,u,S,g,v,x++):this.copyAttrib(s,g,v,F),M=e.charCodeAt(c++);var R=x-M;if(p[y++]=R,0===M){for(var T=0;5>T;T++)v[T]=(g[s*E+T]+g[s*F+T])/2;this.decodeAttrib2(e,s,l,h,d,u,S,g,v,x++)}else this.copyAttrib(s,g,v,R);this.accumulateNormal(E,F,R,g,m)}}for(var G=0;u>G;G++){var U=m[3*G],N=m[3*G+1],I=m[3*G+2],B=511/Math.sqrt(U*U+N*N+I*I),O=e.charCodeAt(d+5*u+G),k=e.charCodeAt(d+6*u+G),V=e.charCodeAt(d+7*u+G);S[s*G+5]=B*U+(O>>1^-(1&O)),S[s*G+6]=B*N+(k>>1^-(1&k)),S[s*G+7]=B*I+(V>>1^-(1&V))}o(r,i,S,p,void 0,t)},THREE.UTF8Loader.prototype.downloadMesh=function(e,t,a,r,i){function o(e){for(;s<a.length;){var o=a[s],l=o.indexRange;if(l){var h=l[0]+3*l[1];if(e.responseText.length<h)break;n.decompressMesh(e.responseText,o,r,t,s,i)
}else{var d=o.codeRange,h=d[0]+d[1];if(e.responseText.length<h)break;n.decompressMesh2(e.responseText,o,r,t,s,i)}++s}}var n=this,s=0;getHttpRequest(e,function(e,t){(200===e.status||0===e.status)&&o(e,t)},o)},THREE.UTF8Loader.prototype.downloadMeshes=function(e,t,a,r){for(var i in t){var o=t[i];this.downloadMesh(e+i,i,o,a,r)}},THREE.UTF8Loader.prototype.createMeshCallback=function(e,t,a){var r=0,i=0,o={},n={},s=t.urls;for(var l in s)o[l]=s[l].length,n[l]=0,i++;var h=[],d=[],u=new THREE.PhongMaterial,c=new THREE.UTF8Loader.MaterialCreator(e,t.materials,this),f=new THREE.UTF8Loader.GeometryCreator,p=function(e,t,s,l,p,m){var v=f.create(s,l),g=c.get(m.material);g||(g=u),h.push(v),d.push(g),n[e]++,n[e]===o[e]&&(r++,r===i&&a(h,d))};return p},THREE.UTF8Loader.prototype.downloadModel=function(e,t,a,r){var i=this.createMeshCallback(t,a,r);this.downloadMeshes(e,a.urls,a.decodeParams,i)},THREE.UTF8Loader.prototype.downloadModelJson=function(e,t,a){getJsonRequest(e,function(r){r.decodeParams||(r.decodeParams=t&&t.decodeParams?t.decodeParams:DEFAULT_DECODE_PARAMS),r.options=t;var i=e.substr(0,e.lastIndexOf("/")+1),o=i;t&&t.geometryBase&&(i=t.geometryBase,"/"!==i.charAt(i.length-1)&&(i+="/")),t&&t.materialBase&&(o=t.materialBase,"/"!==o.charAt(o.length-1)&&(o+="/")),this.downloadModel(i,o,r,a)}.bind(this))},THREE.CTMLoader=function(e){THREE.Loader.call(this,e),this.maxWorkerCount=4,this.workerPool=[],this.workerState=[],this.workerFreeCallbacks=[],window.URL=window.URL||window.webkitURL;for(var t=new Blob([THREE.CTMLoader.workerString],{type:"application/x-javascript"}),a=window.URL.createObjectURL(t),r=0;r<this.maxWorkerCount;r++){var i=new Worker(a);i.index=r,this.workerPool[r]=i,this.workerState[r]=0}},THREE.CTMLoader.prototype=Object.create(THREE.Loader.prototype),THREE.CTMLoader.prototype.loadParts=function(e,t,a){var r=this,i=void 0!==a&&a.basePath?a.basePath:this.extractUrlBase(e),o=void 0!==a&&void 0!==a.useCrunchWorker?a.useCrunchWorker:!0,n=void 0!==a?a.callbackGeometriesLoaded:null,s=void 0!==a?a.callbackProgress:null,l=function(e,t,a,r){for(var i={},n=0,s=t.length;s>n;n++){var l=t[n],h=l[0],d=l[1],u=l[2];i[h]=[d,u]}for(var c=[],n=0,s=a.length;s>n;n++){var f=a[n];if(f.properties.texturesToLoad)for(var p=0,m=f.properties.texturesToLoad.length;m>p;p++){var v=f.properties.texturesToLoad[p],g=v[0],S=v[1],l=i[S];if(l){var x=S.toLowerCase().endsWith(".crn");if(x){var d=l[0],u=l[1];o?c.push([g,d,u]):THREE.ImageUtils.loadCRNTextureFromPack(g,e,d,u)}else{var d=l[0];THREE.ImageUtils.loadCompressedTextureFromPack(g,e,d)}}}}if(o&&c.length>0){var y=function(){r()};THREE.ImageUtils.loadMultipleCRNTexturesFromPack(c,e,y)}else r()},h=function(e,t,a,r,i){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState&&(200===o.status||0===o.status)){var e=o.response;l(e,t,a,r)}},i&&(o.onprogress=function(t){var a={url:e,loaded:t.loaded,total:t.total};i(a)}),o.open("GET",e,!0),o.responseType="arraybuffer",o.send(null)},d=function(e){function a(){c&&f&&t(u,d)}function o(t){p+=1,u.push(t),p===e.offsets.length&&(c=!0,n&&n(u,d),a())}function l(){m+=1,m===e.textures.length&&(f=!0,a())}for(var d=[],u=[],c=!1,f=!1,p=0,m=0,v=e.textures&&e.textureOffsets,g=0;g<e.materials.length;g++)d[g]=r.createMaterial(e.materials[g],i,v);var S=i+e.data,x={offsets:e.offsets,callbackProgress:s};if(r.load(S,o,x),v)for(var g=0,y=e.textures.length;y>g;g++){var G=i+e.textures[g],M=e.textureOffsets[g];h(G,M,d,l,s)}else f=!0},u=new XMLHttpRequest;u.onreadystatechange=function(){if(4===u.readyState&&(200===u.status||0===u.status)){var e=JSON.parse(u.responseText);d(e)}},u.open("GET",e,!0),u.overrideMimeType&&u.overrideMimeType("text/plain; charset=x-user-defined"),u.setRequestHeader("Content-Type","text/plain"),u.send(null)},THREE.CTMLoader.prototype.getWorker=function(e){for(var t,a=0,r=this.workerPool.length;r>a;a++){var i=this.workerState[a];if(0===i){t=this.workerPool[a],this.workerState[a]=1;break}}void 0===t?this.workerFreeCallbacks.push(e):e(t)},THREE.CTMLoader.prototype.releaseWorker=function(e){var t=this.workerFreeCallbacks.shift();t?t(e):this.workerState[e.index]=0},THREE.CTMLoader.prototype.load=function(e,t,a){var r=this,i=void 0!==a&&void 0!==a.offsets?a.offsets:[0],o=void 0!==a&&void 0!==a.callbackProgress?a.callbackProgress:null,n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status||0===n.status){var a=n.response,o=function(e){e.onmessage=function(a){for(var i=a.data.f,o=0;o<i.length;o++){var n=i[o];r.createModelBuffers(n,t)}Date.now();r.releaseWorker(e)};Date.now();e.postMessage=e.webkitPostMessage||e.postMessage,e.postMessage({data:a,offsets:i},[a])};r.getWorker(o)}else console.error("THREE.CTMLoader: Couldn't load ["+e+"] ["+n.status+"]")},o&&(n.onprogress=function(t){var a={url:e,loaded:t.loaded,total:t.total};o(a)}),n.open("GET",e,!0),n.responseType="arraybuffer",n.send(null)},THREE.CTMLoader.prototype.createModelBuffers=function(e,t){var a=function(){var t=this,a=!0;THREE.Geometry.call(this);var r,i,o=e.body.indices,n=e.body.vertices,s=e.body.normals;if(void 0!==e.body.uvMaps&&e.body.uvMaps.length>0&&(r=e.body.uvMaps[0].uv),void 0!==e.body.attrMaps&&e.body.attrMaps.length>0&&"Color"===e.body.attrMaps[0].name&&(i=e.body.attrMaps[0].attr),a){var l,h,d,u=new Uint32Array(o.length),c=new Float32Array(n.length);s&&(l=new Float32Array(s.length)),r&&(h=new Float32Array(r.length)),i&&(d=new Float32Array(i.length));for(var f,p,m,v={},g=0,S=function(e){if(void 0===v[e]){v[e]=g;var t=3*e,a=3*e+1,o=3*e+2,u=3*g,f=3*g+1,p=3*g+2;c[u]=n[t],c[f]=n[a],c[p]=n[o],s&&(l[u]=s[t],l[f]=s[a],l[p]=s[o]),r&&(h[2*g]=r[2*e],h[2*g+1]=r[2*e+1]),i&&(d[4*g]=i[4*e],d[4*g+1]=i[4*e+1],d[4*g+2]=i[4*e+2],d[4*g+3]=i[4*e+3]),g+=1}},x=0;x<o.length;x+=3)f=o[x],p=o[x+1],m=o[x+2],S(f),S(p),S(m),u[x]=v[f],u[x+1]=v[p],u[x+2]=v[m];o=u,n=c,s&&(s=l),r&&(r=h),i&&(i=d)}t.offsets=[];for(var y=o,G=0,M=n.length,w=0,X=M,x=0;x<y.length;){for(var D=0;3>D;++D){var C=y[x++];M>C&&(M=C),C>w&&(w=C)}if(w-M>65535){x-=3;for(var _=G;x>_;++_)y[_]-=X;t.offsets.push({start:G,count:x-G,index:X}),G=x,M=n.length,w=0}X=M}for(var _=G;x>_;++_)y[_]-=X;t.offsets.push({start:G,count:x-G,index:X});var b=new Uint16Array(o);t.addAttributeArray("index",b,1),t.addAttributeArray("position",n,3),void 0!==s&&t.addAttributeArray("normal",s,3),void 0!==r&&t.addAttributeArray("uv",r,2),void 0!==i&&t.addAttributeArray("color",i,4)};a.prototype=Object.create(THREE.Geometry.prototype);var r=new a;void 0===r.attributes.normal&&r.computeVertexNormals(),t(r)},THREE.CTMLoader.workerString=["var LZMA = LZMA || {};","","LZMA.OutWindow = function(){","  this._windowSize = 0;","};","","LZMA.OutWindow.prototype.create = function(windowSize){","  if ( (!this._buffer) || (this._windowSize !== windowSize) ){","    this._buffer = [];","  }","  this._windowSize = windowSize;","  this._pos = 0;","  this._streamPos = 0;","};","","LZMA.OutWindow.prototype.flush = function(){","  var size = this._pos - this._streamPos;","  if (size !== 0){","    while(size --){","      this._stream.writeByte(this._buffer[this._streamPos ++]);","    }","    if (this._pos >= this._windowSize){","      this._pos = 0;","    }","    this._streamPos = this._pos;","  }","};","","LZMA.OutWindow.prototype.releaseStream = function(){","  this.flush();","  this._stream = null;","};","","LZMA.OutWindow.prototype.setStream = function(stream){","  this.releaseStream();","  this._stream = stream;","};","","LZMA.OutWindow.prototype.init = function(solid){","  if (!solid){","    this._streamPos = 0;","    this._pos = 0;","  }","};","","LZMA.OutWindow.prototype.copyBlock = function(distance, len){","  var pos = this._pos - distance - 1;","  if (pos < 0){","    pos += this._windowSize;","  }","  while(len --){","    if (pos >= this._windowSize){","      pos = 0;","    }","    this._buffer[this._pos ++] = this._buffer[pos ++];","    if (this._pos >= this._windowSize){","      this.flush();","    }","  }","};","","LZMA.OutWindow.prototype.putByte = function(b){","  this._buffer[this._pos ++] = b;","  if (this._pos >= this._windowSize){","    this.flush();","  }","};","","LZMA.OutWindow.prototype.getByte = function(distance){","  var pos = this._pos - distance - 1;","  if (pos < 0){","    pos += this._windowSize;","  }","  return this._buffer[pos];","};","","LZMA.RangeDecoder = function(){","};","","LZMA.RangeDecoder.prototype.setStream = function(stream){","  this._stream = stream;","};","","LZMA.RangeDecoder.prototype.releaseStream = function(){","  this._stream = null;","};","","LZMA.RangeDecoder.prototype.init = function(){","  var i = 5;","","  this._code = 0;","  this._range = -1;","","  while(i --){","    this._code = (this._code << 8) | this._stream.readByte();","  }","};","","LZMA.RangeDecoder.prototype.decodeDirectBits = function(numTotalBits){","  var result = 0, i = numTotalBits, t;","","  while(i --){","    this._range >>>= 1;","    t = (this._code - this._range) >>> 31;","    this._code -= this._range & (t - 1);","    result = (result << 1) | (1 - t);","","    if ( (this._range & 0xff000000) === 0){","      this._code = (this._code << 8) | this._stream.readByte();","      this._range <<= 8;","    }","  }","","  return result;","};","","LZMA.RangeDecoder.prototype.decodeBit = function(probs, index){","  var prob = probs[index],","      newBound = (this._range >>> 11) * prob;","","  if ( (this._code ^ 0x80000000) < (newBound ^ 0x80000000) ){","    this._range = newBound;","    probs[index] += (2048 - prob) >>> 5;","    if ( (this._range & 0xff000000) === 0){","      this._code = (this._code << 8) | this._stream.readByte();","      this._range <<= 8;","    }","    return 0;","  }","","  this._range -= newBound;","  this._code -= newBound;","  probs[index] -= prob >>> 5;","  if ( (this._range & 0xff000000) === 0){","    this._code = (this._code << 8) | this._stream.readByte();","    this._range <<= 8;","  }","  return 1;","};","","LZMA.initBitModels = function(probs, len){","  while(len --){","    probs[len] = 1024;","  }","};","","LZMA.BitTreeDecoder = function(numBitLevels){","  this._models = [];","  this._numBitLevels = numBitLevels;","};","","LZMA.BitTreeDecoder.prototype.init = function(){","  LZMA.initBitModels(this._models, 1 << this._numBitLevels);","};","","LZMA.BitTreeDecoder.prototype.decode = function(rangeDecoder){","  var m = 1, i = this._numBitLevels;","","  while(i --){","    m = (m << 1) | rangeDecoder.decodeBit(this._models, m);","  }","  return m - (1 << this._numBitLevels);","};","","LZMA.BitTreeDecoder.prototype.reverseDecode = function(rangeDecoder){","  var m = 1, symbol = 0, i = 0, bit;","","  for (; i < this._numBitLevels; ++ i){","    bit = rangeDecoder.decodeBit(this._models, m);","    m = (m << 1) | bit;","    symbol |= bit << i;","  }","  return symbol;","};","","LZMA.reverseDecode2 = function(models, startIndex, rangeDecoder, numBitLevels){","  var m = 1, symbol = 0, i = 0, bit;","","  for (; i < numBitLevels; ++ i){","    bit = rangeDecoder.decodeBit(models, startIndex + m);","    m = (m << 1) | bit;","    symbol |= bit << i;","  }","  return symbol;","};","","LZMA.LenDecoder = function(){","  this._choice = [];","  this._lowCoder = [];","  this._midCoder = [];","  this._highCoder = new LZMA.BitTreeDecoder(8);","  this._numPosStates = 0;","};","","LZMA.LenDecoder.prototype.create = function(numPosStates){","  for (; this._numPosStates < numPosStates; ++ this._numPosStates){","    this._lowCoder[this._numPosStates] = new LZMA.BitTreeDecoder(3);","    this._midCoder[this._numPosStates] = new LZMA.BitTreeDecoder(3);","  }","};","","LZMA.LenDecoder.prototype.init = function(){","  var i = this._numPosStates;","  LZMA.initBitModels(this._choice, 2);","  while(i --){","    this._lowCoder[i].init();","    this._midCoder[i].init();","  }","  this._highCoder.init();","};","","LZMA.LenDecoder.prototype.decode = function(rangeDecoder, posState){","  if (rangeDecoder.decodeBit(this._choice, 0) === 0){","    return this._lowCoder[posState].decode(rangeDecoder);","  }","  if (rangeDecoder.decodeBit(this._choice, 1) === 0){","    return 8 + this._midCoder[posState].decode(rangeDecoder);","  }","  return 16 + this._highCoder.decode(rangeDecoder);","};","","LZMA.Decoder2 = function(){","  this._decoders = [];","};","","LZMA.Decoder2.prototype.init = function(){","  LZMA.initBitModels(this._decoders, 0x300);","};","","LZMA.Decoder2.prototype.decodeNormal = function(rangeDecoder){","  var symbol = 1;","","  do{","    symbol = (symbol << 1) | rangeDecoder.decodeBit(this._decoders, symbol);","  }while(symbol < 0x100);","","  return symbol & 0xff;","};","","LZMA.Decoder2.prototype.decodeWithMatchByte = function(rangeDecoder, matchByte){","  var symbol = 1, matchBit, bit;","","  do{","    matchBit = (matchByte >> 7) & 1;","    matchByte <<= 1;","    bit = rangeDecoder.decodeBit(this._decoders, ( (1 + matchBit) << 8) + symbol);","    symbol = (symbol << 1) | bit;","    if (matchBit !== bit){","      while(symbol < 0x100){","        symbol = (symbol << 1) | rangeDecoder.decodeBit(this._decoders, symbol);","      }","      break;","    }","  }while(symbol < 0x100);","","  return symbol & 0xff;","};","","LZMA.LiteralDecoder = function(){","};","","LZMA.LiteralDecoder.prototype.create = function(numPosBits, numPrevBits){","  var i;","","  if (this._coders","    && (this._numPrevBits === numPrevBits)","    && (this._numPosBits === numPosBits) ){","    return;","  }","  this._numPosBits = numPosBits;","  this._posMask = (1 << numPosBits) - 1;","  this._numPrevBits = numPrevBits;","","  this._coders = [];","","  i = 1 << (this._numPrevBits + this._numPosBits);","  while(i --){","    this._coders[i] = new LZMA.Decoder2();","  }","};","","LZMA.LiteralDecoder.prototype.init = function(){","  var i = 1 << (this._numPrevBits + this._numPosBits);","  while(i --){","    this._coders[i].init();","  }","};","","LZMA.LiteralDecoder.prototype.getDecoder = function(pos, prevByte){","  return this._coders[( (pos & this._posMask) << this._numPrevBits)","    + ( (prevByte & 0xff) >>> (8 - this._numPrevBits) )];","};","","LZMA.Decoder = function(){","  this._outWindow = new LZMA.OutWindow();","  this._rangeDecoder = new LZMA.RangeDecoder();","  this._isMatchDecoders = [];","  this._isRepDecoders = [];","  this._isRepG0Decoders = [];","  this._isRepG1Decoders = [];","  this._isRepG2Decoders = [];","  this._isRep0LongDecoders = [];","  this._posSlotDecoder = [];","  this._posDecoders = [];","  this._posAlignDecoder = new LZMA.BitTreeDecoder(4);","  this._lenDecoder = new LZMA.LenDecoder();","  this._repLenDecoder = new LZMA.LenDecoder();","  this._literalDecoder = new LZMA.LiteralDecoder();","  this._dictionarySize = -1;","  this._dictionarySizeCheck = -1;","","  this._posSlotDecoder[0] = new LZMA.BitTreeDecoder(6);","  this._posSlotDecoder[1] = new LZMA.BitTreeDecoder(6);","  this._posSlotDecoder[2] = new LZMA.BitTreeDecoder(6);","  this._posSlotDecoder[3] = new LZMA.BitTreeDecoder(6);","};","","LZMA.Decoder.prototype.setDictionarySize = function(dictionarySize){","  if (dictionarySize < 0){","    return false;","  }","  if (this._dictionarySize !== dictionarySize){","    this._dictionarySize = dictionarySize;","    this._dictionarySizeCheck = Math.max(this._dictionarySize, 1);","    this._outWindow.create( Math.max(this._dictionarySizeCheck, 4096) );","  }","  return true;","};","","LZMA.Decoder.prototype.setLcLpPb = function(lc, lp, pb){","  var numPosStates = 1 << pb;","","  if (lc > 8 || lp > 4 || pb > 4){","    return false;","  }","","  this._literalDecoder.create(lp, lc);","","  this._lenDecoder.create(numPosStates);","  this._repLenDecoder.create(numPosStates);","  this._posStateMask = numPosStates - 1;","","  return true;","};","","LZMA.Decoder.prototype.init = function(){","  var i = 4;","","  this._outWindow.init(false);","","  LZMA.initBitModels(this._isMatchDecoders, 192);","  LZMA.initBitModels(this._isRep0LongDecoders, 192);","  LZMA.initBitModels(this._isRepDecoders, 12);","  LZMA.initBitModels(this._isRepG0Decoders, 12);","  LZMA.initBitModels(this._isRepG1Decoders, 12);","  LZMA.initBitModels(this._isRepG2Decoders, 12);","  LZMA.initBitModels(this._posDecoders, 114);","","  this._literalDecoder.init();","","  while(i --){","    this._posSlotDecoder[i].init();","  }","","  this._lenDecoder.init();","  this._repLenDecoder.init();","  this._posAlignDecoder.init();","  this._rangeDecoder.init();","};","","LZMA.Decoder.prototype.decode = function(inStream, outStream, outSize){","  var state = 0, rep0 = 0, rep1 = 0, rep2 = 0, rep3 = 0, nowPos64 = 0, prevByte = 0,","      posState, decoder2, len, distance, posSlot, numDirectBits;","","  this._rangeDecoder.setStream(inStream);","  this._outWindow.setStream(outStream);","","  this.init();","","  while(outSize < 0 || nowPos64 < outSize){","    posState = nowPos64 & this._posStateMask;","","    if (this._rangeDecoder.decodeBit(this._isMatchDecoders, (state << 4) + posState) === 0){","      decoder2 = this._literalDecoder.getDecoder(nowPos64 ++, prevByte);","","      if (state >= 7){","        prevByte = decoder2.decodeWithMatchByte(this._rangeDecoder, this._outWindow.getByte(rep0) );","      }else{","        prevByte = decoder2.decodeNormal(this._rangeDecoder);","      }","      this._outWindow.putByte(prevByte);","","      state = state < 4? 0: state - (state < 10? 3: 6);","","    }else{","","      if (this._rangeDecoder.decodeBit(this._isRepDecoders, state) === 1){","        len = 0;","        if (this._rangeDecoder.decodeBit(this._isRepG0Decoders, state) === 0){","          if (this._rangeDecoder.decodeBit(this._isRep0LongDecoders, (state << 4) + posState) === 0){","            state = state < 7? 9: 11;","            len = 1;","          }","        }else{","          if (this._rangeDecoder.decodeBit(this._isRepG1Decoders, state) === 0){","            distance = rep1;","          }else{","            if (this._rangeDecoder.decodeBit(this._isRepG2Decoders, state) === 0){","              distance = rep2;","            }else{","              distance = rep3;","              rep3 = rep2;","            }","            rep2 = rep1;","          }","          rep1 = rep0;","          rep0 = distance;","        }","        if (len === 0){","          len = 2 + this._repLenDecoder.decode(this._rangeDecoder, posState);","          state = state < 7? 8: 11;","        }","      }else{","        rep3 = rep2;","        rep2 = rep1;","        rep1 = rep0;","","        len = 2 + this._lenDecoder.decode(this._rangeDecoder, posState);","        state = state < 7? 7: 10;","","        posSlot = this._posSlotDecoder[len <= 5? len - 2: 3].decode(this._rangeDecoder);","        if (posSlot >= 4){","","          numDirectBits = (posSlot >> 1) - 1;","          rep0 = (2 | (posSlot & 1) ) << numDirectBits;","","          if (posSlot < 14){","            rep0 += LZMA.reverseDecode2(this._posDecoders,","                rep0 - posSlot - 1, this._rangeDecoder, numDirectBits);","          }else{","            rep0 += this._rangeDecoder.decodeDirectBits(numDirectBits - 4) << 4;","            rep0 += this._posAlignDecoder.reverseDecode(this._rangeDecoder);","            if (rep0 < 0){","              if (rep0 === -1){","                break;","              }","              return false;","            }","          }","        }else{","          rep0 = posSlot;","        }","      }","","      if (rep0 >= nowPos64 || rep0 >= this._dictionarySizeCheck){","        return false;","      }","","      this._outWindow.copyBlock(rep0, len);","      nowPos64 += len;","      prevByte = this._outWindow.getByte(0);","    }","  }","","  this._outWindow.flush();","  this._outWindow.releaseStream();","  this._rangeDecoder.releaseStream();","","  return true;","};","","LZMA.Decoder.prototype.setDecoderProperties = function(properties){","  var value, lc, lp, pb, dictionarySize;","","  if (properties.size < 5){","    return false;","  }","","  value = properties.readByte();","  lc = value % 9;","  value = ~~(value / 9);","  lp = value % 5;","  pb = ~~(value / 5);","","  if ( !this.setLcLpPb(lc, lp, pb) ){","    return false;","  }","","  dictionarySize = properties.readByte();","  dictionarySize |= properties.readByte() << 8;","  dictionarySize |= properties.readByte() << 16;","  dictionarySize += properties.readByte() * 16777216;","","  return this.setDictionarySize(dictionarySize);","};","","LZMA.decompress = function(properties, inStream, outStream, outSize){","  var decoder = new LZMA.Decoder();","","  if ( !decoder.setDecoderProperties(properties) ){",'    throw "Incorrect stream properties";',"  }","","  if ( !decoder.decode(inStream, outStream, outSize) ){",'    throw "Error in data stream";',"  }","","  return true;","};","","LZMA.decompressFile = function(inStream, outStream){","  var decoder = new LZMA.Decoder(), outSize;","","  if ( !decoder.setDecoderProperties(inStream) ){",'    throw "Incorrect stream properties";',"  }","","  outSize = inStream.readByte();","  outSize |= inStream.readByte() << 8;","  outSize |= inStream.readByte() << 16;","  outSize += inStream.readByte() * 16777216;","","  inStream.readByte();","  inStream.readByte();","  inStream.readByte();","  inStream.readByte();","","  if ( !decoder.decode(inStream, outStream, outSize) ){",'    throw "Error in data stream";',"  }","","  return true;","};","","var CTM = CTM || {};","","CTM.CompressionMethod = {","  RAW: 0x00574152,","  MG1: 0x0031474d,","  MG2: 0x0032474d","};","","CTM.Flags = {","  NORMALS: 0x00000001","};","","CTM.File = function(stream){","  this.load(stream);","};","","CTM.File.prototype.load = function(stream){","  this.header = new CTM.FileHeader(stream);","","  this.body = new CTM.FileBody(this.header);","","  this.getReader().read(stream, this.body);","};","","CTM.File.prototype.getReader = function(){","  var reader;","","  switch(this.header.compressionMethod){","    case CTM.CompressionMethod.RAW:","      reader = new CTM.ReaderRAW();","      break;","    case CTM.CompressionMethod.MG1:","      reader = new CTM.ReaderMG1();","      break;","    case CTM.CompressionMethod.MG2:","      reader = new CTM.ReaderMG2();","      break;","  }","","  return reader;","};","","CTM.FileHeader = function(stream){",'  stream.readInt32(); //magic "OCTM"',"  this.fileFormat = stream.readInt32();","  this.compressionMethod = stream.readInt32();","  this.vertexCount = stream.readInt32();","  this.triangleCount = stream.readInt32();","  this.uvMapCount = stream.readInt32();","  this.attrMapCount = stream.readInt32();","  this.flags = stream.readInt32();","  this.comment = stream.readString();","};","","CTM.FileHeader.prototype.hasNormals = function(){","  return this.flags & CTM.Flags.NORMALS;","};","","CTM.FileBody = function(header){","  var i = header.triangleCount * 3,","      v = header.vertexCount * 3,","      n = header.hasNormals()? header.vertexCount * 3: 0,","      u = header.vertexCount * 2,","      a = header.vertexCount * 4,","      j = 0;","","  var data = new ArrayBuffer(","    (i + v + n + (u * header.uvMapCount) + (a * header.attrMapCount) ) * 4);","","  this.indices = new Uint32Array(data, 0, i);","","  this.vertices = new Float32Array(data, i * 4, v);","","  if ( header.hasNormals() ){","    this.normals = new Float32Array(data, (i + v) * 4, n);","  }","","  if (header.uvMapCount){","    this.uvMaps = [];","    for (j = 0; j < header.uvMapCount; ++ j){","      this.uvMaps[j] = {uv: new Float32Array(data,","        (i + v + n + (j * u) ) * 4, u) };","    }","  }","","  if (header.attrMapCount){","    this.attrMaps = [];","    for (j = 0; j < header.attrMapCount; ++ j){","      this.attrMaps[j] = {attr: new Float32Array(data,","        (i + v + n + (u * header.uvMapCount) + (j * a) ) * 4, a) };","    }","  }","};","","CTM.FileMG2Header = function(stream){",'  stream.readInt32(); //magic "MG2H"',"  this.vertexPrecision = stream.readFloat32();","  this.normalPrecision = stream.readFloat32();","  this.lowerBoundx = stream.readFloat32();","  this.lowerBoundy = stream.readFloat32();","  this.lowerBoundz = stream.readFloat32();","  this.higherBoundx = stream.readFloat32();","  this.higherBoundy = stream.readFloat32();","  this.higherBoundz = stream.readFloat32();","  this.divx = stream.readInt32();","  this.divy = stream.readInt32();","  this.divz = stream.readInt32();","","  this.sizex = (this.higherBoundx - this.lowerBoundx) / this.divx;","  this.sizey = (this.higherBoundy - this.lowerBoundy) / this.divy;","  this.sizez = (this.higherBoundz - this.lowerBoundz) / this.divz;","};","","CTM.ReaderRAW = function(){","};","","CTM.ReaderRAW.prototype.read = function(stream, body){","  this.readIndices(stream, body.indices);","  this.readVertices(stream, body.vertices);","","  if (body.normals){","    this.readNormals(stream, body.normals);","  }","  if (body.uvMaps){","    this.readUVMaps(stream, body.uvMaps);","  }","  if (body.attrMaps){","    this.readAttrMaps(stream, body.attrMaps);","  }","};","","CTM.ReaderRAW.prototype.readIndices = function(stream, indices){",'  stream.readInt32(); //magic "INDX"',"  stream.readArrayInt32(indices);","};","","CTM.ReaderRAW.prototype.readVertices = function(stream, vertices){",'  stream.readInt32(); //magic "VERT"',"  stream.readArrayFloat32(vertices);","};","","CTM.ReaderRAW.prototype.readNormals = function(stream, normals){",'  stream.readInt32(); //magic "NORM"',"  stream.readArrayFloat32(normals);","};","","CTM.ReaderRAW.prototype.readUVMaps = function(stream, uvMaps){","  var i = 0;","  for (; i < uvMaps.length; ++ i){",'    stream.readInt32(); //magic "TEXC"',"","    uvMaps[i].name = stream.readString();","    uvMaps[i].filename = stream.readString();","    stream.readArrayFloat32(uvMaps[i].uv);","  }","};","","CTM.ReaderRAW.prototype.readAttrMaps = function(stream, attrMaps){","  var i = 0;","  for (; i < attrMaps.length; ++ i){",'    stream.readInt32(); //magic "ATTR"',"","    attrMaps[i].name = stream.readString();","    stream.readArrayFloat32(attrMaps[i].attr);","  }","};","","CTM.ReaderMG1 = function(){","};","","CTM.ReaderMG1.prototype.read = function(stream, body){","  this.readIndices(stream, body.indices);","  this.readVertices(stream, body.vertices);","","  if (body.normals){","    this.readNormals(stream, body.normals);","  }","  if (body.uvMaps){","    this.readUVMaps(stream, body.uvMaps);","  }","  if (body.attrMaps){","    this.readAttrMaps(stream, body.attrMaps);","  }","};","","CTM.ReaderMG1.prototype.readIndices = function(stream, indices){",'  stream.readInt32(); //magic "INDX"',"  stream.readInt32(); //packed size","","  var interleaved = new CTM.InterleavedStream(indices, 3);","  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","","  CTM.restoreIndices(indices, indices.length);","};","","CTM.ReaderMG1.prototype.readVertices = function(stream, vertices){",'  stream.readInt32(); //magic "VERT"',"  stream.readInt32(); //packed size","","  var interleaved = new CTM.InterleavedStream(vertices, 1);","  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","};","","CTM.ReaderMG1.prototype.readNormals = function(stream, normals){",'  stream.readInt32(); //magic "NORM"',"  stream.readInt32(); //packed size","","  var interleaved = new CTM.InterleavedStream(normals, 3);","  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","};","","CTM.ReaderMG1.prototype.readUVMaps = function(stream, uvMaps){","  var i = 0;","  for (; i < uvMaps.length; ++ i){",'    stream.readInt32(); //magic "TEXC"',"","    uvMaps[i].name = stream.readString();","    uvMaps[i].filename = stream.readString();","","    stream.readInt32(); //packed size","","    var interleaved = new CTM.InterleavedStream(uvMaps[i].uv, 2);","    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","  }","};","","CTM.ReaderMG1.prototype.readAttrMaps = function(stream, attrMaps){","  var i = 0;","  for (; i < attrMaps.length; ++ i){",'    stream.readInt32(); //magic "ATTR"',"","    attrMaps[i].name = stream.readString();","","    stream.readInt32(); //packed size","","    var interleaved = new CTM.InterleavedStream(attrMaps[i].attr, 4);","    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","  }","};","","CTM.ReaderMG2 = function(){","};","","CTM.ReaderMG2.prototype.read = function(stream, body){","  this.MG2Header = new CTM.FileMG2Header(stream);","","  this.readVertices(stream, body.vertices);","  this.readIndices(stream, body.indices);","","  if (body.normals){","    this.readNormals(stream, body);","  }","  if (body.uvMaps){","    this.readUVMaps(stream, body.uvMaps);","  }","  if (body.attrMaps){","    this.readAttrMaps(stream, body.attrMaps);","  }","};","","CTM.ReaderMG2.prototype.readVertices = function(stream, vertices){",'  stream.readInt32(); //magic "VERT"',"  stream.readInt32(); //packed size","","  var interleaved = new CTM.InterleavedStream(vertices, 3);","  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","","  var gridIndices = this.readGridIndices(stream, vertices);","","  CTM.restoreVertices(vertices, this.MG2Header, gridIndices, this.MG2Header.vertexPrecision);","};","","CTM.ReaderMG2.prototype.readGridIndices = function(stream, vertices){",'  stream.readInt32(); //magic "GIDX"',"  stream.readInt32(); //packed size","","  var gridIndices = new Uint32Array(vertices.length / 3);","","  var interleaved = new CTM.InterleavedStream(gridIndices, 1);","  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","","  CTM.restoreGridIndices(gridIndices, gridIndices.length);","","  return gridIndices;","};","","CTM.ReaderMG2.prototype.readIndices = function(stream, indices){",'  stream.readInt32(); //magic "INDX"',"  stream.readInt32(); //packed size","","  var interleaved = new CTM.InterleavedStream(indices, 3);","  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","","  CTM.restoreIndices(indices, indices.length);","};","","CTM.ReaderMG2.prototype.readNormals = function(stream, body){",'  stream.readInt32(); //magic "NORM"',"  stream.readInt32(); //packed size","","  var interleaved = new CTM.InterleavedStream(body.normals, 3);","  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","","  var smooth = CTM.calcSmoothNormals(body.indices, body.vertices);","","  CTM.restoreNormals(body.normals, smooth, this.MG2Header.normalPrecision);","};","","CTM.ReaderMG2.prototype.readUVMaps = function(stream, uvMaps){","  var i = 0;","  for (; i < uvMaps.length; ++ i){",'    stream.readInt32(); //magic "TEXC"',"","    uvMaps[i].name = stream.readString();","    uvMaps[i].filename = stream.readString();","","    var precision = stream.readFloat32();","","    stream.readInt32(); //packed size","","    var interleaved = new CTM.InterleavedStream(uvMaps[i].uv, 2);","    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","","    CTM.restoreMap(uvMaps[i].uv, 2, precision);","  }","};","","CTM.ReaderMG2.prototype.readAttrMaps = function(stream, attrMaps){","  var i = 0;","  for (; i < attrMaps.length; ++ i){",'    stream.readInt32(); //magic "ATTR"',"","    attrMaps[i].name = stream.readString();","","    var precision = stream.readFloat32();","","    stream.readInt32(); //packed size","","    var interleaved = new CTM.InterleavedStream(attrMaps[i].attr, 4);","    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);","","    CTM.restoreMap(attrMaps[i].attr, 4, precision);","  }","};","","CTM.restoreIndices = function(indices, len){","  var i = 3;","  if (len > 0){","    indices[2] += indices[0];","    indices[1] += indices[0];","  }","  for (; i < len; i += 3){","    indices[i] += indices[i - 3];","","    if (indices[i] === indices[i - 3]){","      indices[i + 1] += indices[i - 2];","    }else{","      indices[i + 1] += indices[i];","    }","","    indices[i + 2] += indices[i];","  }","};","","CTM.restoreGridIndices = function(gridIndices, len){","  var i = 1;","  for (; i < len; ++ i){","    gridIndices[i] += gridIndices[i - 1];","  }","};","","CTM.restoreVertices = function(vertices, grid, gridIndices, precision){","  var gridIdx, delta, x, y, z,","      intVertices = new Uint32Array(vertices.buffer, vertices.byteOffset, vertices.length),","      ydiv = grid.divx, zdiv = ydiv * grid.divy,","      prevGridIdx = 0x7fffffff, prevDelta = 0,","      i = 0, j = 0, len = gridIndices.length;","","  for (; i < len; j += 3){","    x = gridIdx = gridIndices[i ++];","","    z = ~~(x / zdiv);","    x -= ~~(z * zdiv);","    y = ~~(x / ydiv);","    x -= ~~(y * ydiv);","","    delta = intVertices[j];","    if (gridIdx === prevGridIdx){","      delta += prevDelta;","    }","","    vertices[j]     = grid.lowerBoundx +","      x * grid.sizex + precision * delta;","    vertices[j + 1] = grid.lowerBoundy +","      y * grid.sizey + precision * intVertices[j + 1];","    vertices[j + 2] = grid.lowerBoundz +","      z * grid.sizez + precision * intVertices[j + 2];","","    prevGridIdx = gridIdx;","    prevDelta = delta;","  }","};","","CTM.restoreNormals = function(normals, smooth, precision){","  var ro, phi, theta, sinPhi,","      nx, ny, nz, by, bz, len,","      intNormals = new Uint32Array(normals.buffer, normals.byteOffset, normals.length),","      i = 0, k = normals.length,","      PI_DIV_2 = 3.141592653589793238462643 * 0.5;","","  for (; i < k; i += 3){","    ro = intNormals[i] * precision;","    phi = intNormals[i + 1];","","    if (phi === 0){","      normals[i]     = smooth[i]     * ro;","      normals[i + 1] = smooth[i + 1] * ro;","      normals[i + 2] = smooth[i + 2] * ro;","    }else{","","      if (phi <= 4){","        theta = (intNormals[i + 2] - 2) * PI_DIV_2;","      }else{","        theta = ( (intNormals[i + 2] * 4 / phi) - 2) * PI_DIV_2;","      }","","      phi *= precision * PI_DIV_2;","      sinPhi = ro * Math.sin(phi);","","      nx = sinPhi * Math.cos(theta);","      ny = sinPhi * Math.sin(theta);","      nz = ro * Math.cos(phi);","","      bz = smooth[i + 1];","      by = smooth[i] - smooth[i + 2];","","      len = Math.sqrt(2 * bz * bz + by * by);","      if (len > 1e-20){","        by /= len;","        bz /= len;","      }","","      normals[i]     = smooth[i]     * nz +","        (smooth[i + 1] * bz - smooth[i + 2] * by) * ny - bz * nx;","      normals[i + 1] = smooth[i + 1] * nz -","        (smooth[i + 2]      + smooth[i]   ) * bz  * ny + by * nx;","      normals[i + 2] = smooth[i + 2] * nz +","        (smooth[i]     * by + smooth[i + 1] * bz) * ny + bz * nx;","    }","  }","};","","CTM.restoreMap = function(map, count, precision){","  var delta, value,","      intMap = new Uint32Array(map.buffer, map.byteOffset, map.length),","      i = 0, j, len = map.length;","","  for (; i < count; ++ i){","    delta = 0;","","    for (j = i; j < len; j += count){","      value = intMap[j];","","      delta += value & 1? -( (value + 1) >> 1): value >> 1;","","      map[j] = delta * precision;","    }","  }","};","","CTM.calcSmoothNormals = function(indices, vertices){","  var smooth = new Float32Array(vertices.length),","      indx, indy, indz, nx, ny, nz,","      v1x, v1y, v1z, v2x, v2y, v2z, len,","      i, k;","","  for (i = 0, k = indices.length; i < k;){","    indx = indices[i ++] * 3;","    indy = indices[i ++] * 3;","    indz = indices[i ++] * 3;","","    v1x = vertices[indy]     - vertices[indx];","    v2x = vertices[indz]     - vertices[indx];","    v1y = vertices[indy + 1] - vertices[indx + 1];","    v2y = vertices[indz + 1] - vertices[indx + 1];","    v1z = vertices[indy + 2] - vertices[indx + 2];","    v2z = vertices[indz + 2] - vertices[indx + 2];","","    nx = v1y * v2z - v1z * v2y;","    ny = v1z * v2x - v1x * v2z;","    nz = v1x * v2y - v1y * v2x;","","    len = Math.sqrt(nx * nx + ny * ny + nz * nz);","    if (len > 1e-10){","      nx /= len;","      ny /= len;","      nz /= len;","    }","","    smooth[indx]     += nx;","    smooth[indx + 1] += ny;","    smooth[indx + 2] += nz;","    smooth[indy]     += nx;","    smooth[indy + 1] += ny;","    smooth[indy + 2] += nz;","    smooth[indz]     += nx;","    smooth[indz + 1] += ny;","    smooth[indz + 2] += nz;","  }","","  for (i = 0, k = smooth.length; i < k; i += 3){","    len = Math.sqrt(smooth[i] * smooth[i] +","      smooth[i + 1] * smooth[i + 1] +","      smooth[i + 2] * smooth[i + 2]);","","    if(len > 1e-10){","      smooth[i]     /= len;","      smooth[i + 1] /= len;","      smooth[i + 2] /= len;","    }","  }","","  return smooth;","};","","CTM.isLittleEndian = (function(){","  var buffer = new ArrayBuffer(2),","      bytes = new Uint8Array(buffer),","      ints = new Uint16Array(buffer);","","  bytes[0] = 1;","","  return ints[0] === 1;","}());","","CTM.InterleavedStream = function(data, count){","  this.data = new Uint8Array(data.buffer, data.byteOffset, data.byteLength);","  this.offset = CTM.isLittleEndian? 3: 0;","  this.count = count * 4;","  this.len = this.data.length;","};","","CTM.InterleavedStream.prototype.writeByte = function(value){","  this.data[this.offset] = value;","","  this.offset += this.count;","  if (this.offset >= this.len){","","    this.offset -= this.len - 4;","    if (this.offset >= this.count){","","      this.offset -= this.count + (CTM.isLittleEndian? 1: -1);","    }","  }","};","","CTM.Stream = function(data){","  this.data = data;","  this.chardata = new DataView(data);","  this.offset = 0;","};","","CTM.Stream.prototype.TWO_POW_MINUS23 = Math.pow(2, -23);","","CTM.Stream.prototype.TWO_POW_MINUS126 = Math.pow(2, -126);","","CTM.Stream.prototype.readByte = function(){","  return this.chardata.getUint8(this.offset++);","};","","CTM.Stream.prototype.readInt32 = function(){","var v = this.chardata.getInt32(this.offset, CTM.isLittleEndian);","this.offset += 4;","return v;","};","","CTM.Stream.prototype.readFloat32 = function(){","var v = this.chardata.getFloat32(this.offset, CTM.isLittleEndian);","this.offset += 4;","return v;","};","","CTM.Stream.prototype.readString = function(){","  var len = this.readInt32();","","  this.offset += len;","","	var tmp = new Uint8Array(this.data,this.offset - len, len);","	return String.fromCharCode.apply(null,tmp);","};","","CTM.Stream.prototype.readArrayInt32 = function(array){","  var i = 0, len = array.length;","","  while(i < len){","    array[i ++] = this.readInt32();","  }","","  return array;","};","","CTM.Stream.prototype.readArrayFloat32 = function(array){","  var i = 0, len = array.length;","","  while(i < len){","    array[i ++] = this.readFloat32();","  }","","  return array;","};","","self.onmessage = function( event ) {","var s = Date.now();","","	var files = [];","","	for ( var i = 0; i < event.data.offsets.length; i ++ ) {","","		var stream = new CTM.Stream( event.data.data );","		stream.offset = event.data.offsets[ i ];","","		files[ i ] = new CTM.File( stream );","","	}","","var e = Date.now();",'	self.postMessage( {"f":files,"t":e-s} );',"","}"].join("\n"),THREE.JSONLoader=function(e){THREE.Loader.call(this,e),this.withCredentials=!1
},THREE.JSONLoader.prototype=Object.create(THREE.Loader.prototype),THREE.JSONLoader.prototype.load=function(e,t,a){this.onLoadStart(),this.loadAjaxJSON(this,e,t,a)},THREE.JSONLoader.prototype.loadAjaxJSON=function(e,t,a,r){void 0===r&&(r={});var i=r.texturePath?r.texturePath:this.extractUrlBase(t),o=r.mergeMaterials,n=r.callbackProgress,s=new XMLHttpRequest,l=0;s.onreadystatechange=function(){if(s.readyState===s.DONE)if(200===s.status||0===s.status){if(s.responseText){var r=JSON.parse(s.responseText);e.createModel(r,a,i,o)}else console.warn("THREE.JSONLoader: ["+t+"] seems to be unreachable or file there is empty");e.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load ["+t+"] ["+s.status+"]");else s.readyState===s.LOADING?n&&(0===l&&(l=s.getResponseHeader("Content-Length")),n({total:l,loaded:s.responseText.length})):s.readyState===s.HEADERS_RECEIVED&&(l=s.getResponseHeader("Content-Length"))},s.open("GET",t,!0),s.withCredentials=this.withCredentials,s.send(null)},THREE.JSONLoader.prototype.generateMaterialChunks=function(e,t,a){function r(e,t){return e&1<<t}for(var i,o,n,s,l,h,d,u,c,f,p,m,v=[],g=e.faces,S=g.length,x=0;S>x;){i=g[x++],o=r(i,0),n=r(i,1),l=r(i,2),h=r(i,3),d=r(i,4),u=r(i,5),c=r(i,6),f=r(i,7),o?(p=2,m=4):(p=1,m=3),x+=m,n?(s=g[x++],a&&(s=0)):s=0,void 0===v[s]?v[s]={nTriangles:p,hasNormals:!1,hasUvs:!1,hasColors:!1,hasIndices:!1,indexOffset:0,vertexOffset:0,positionOffset:0,normalOffset:0,colorOffset:0,uvOffset:[],skinWeightOffset:0,skinIndexOffset:0,indexMap:{}}:v[s].nTriangles+=p;var y=v[s];l&&(x+=t),h&&(x+=t*m),d&&(x+=1),u&&(x+=m),c&&(x+=1),f&&(x+=m),(d||u)&&(y.hasNormals|=!0),(l||h)&&(y.hasUvs|=!0),(c||f)&&(y.hasColors|=!0)}return v},THREE.JSONLoader.prototype.generateGeometries=function(e,t,a){for(var r=[],i=0,o=e.length;o>i;i++){var n=e[i];if(void 0!==n){var s=new THREE.Geometry;s.numPrimitives=n.nTriangles,s.numVertices=3*n.nTriangles;var l=Uint16Array;if(s.numVertices>65536&&(l=THREE.elementIndexUintAvailable?Uint32Array:null),null!==l&&(s.addIndex("index",l,3),s.offsets.push({start:0,index:0,count:3*n.nTriangles}),n.hasIndices=!0),s.addAttribute("position",Float32Array,3),n.hasUvs&&s.addAttribute("uv",Float32Array,2),n.hasColors&&s.addAttribute("color",Float32Array,3),s.addAttribute("normal",Float32Array,3),n.hasUvs){n.uvOffset[0]=0;for(var h=1;a>h;h++)s.addAttribute("uv"+(h+1),Float32Array,2),n.uvOffset[h]=0}if(t.skinWeights&&s.addAttribute("skinWeight",Float32Array,4),t.skinIndices&&s.addAttribute("skinIndex",Float32Array,4),void 0===t.morphTargets&&(t.morphTargets=[]),void 0===t.morphColors&&(t.morphColors=[]),t.morphTargets.length>0){s.addVirtualAttribute("morphTarget0"),s.addVirtualAttribute("morphTarget1"),s.addVirtualAttribute("morphTarget2"),s.addVirtualAttribute("morphTarget3"),s.addVirtualAttribute("morphNormal0"),s.addVirtualAttribute("morphNormal1"),s.addVirtualAttribute("morphNormal2"),s.addVirtualAttribute("morphNormal3");for(var h=0,d=t.morphTargets.length;d>h;h++){var u=t.morphTargets[h].name;s.addUnattachedAttribute("mp_"+h,Float32Array,3),s.addUnattachedAttribute("mn_"+h,Float32Array,3),s.morphTargets[h]={name:u,index:s.attributesList.length-2}}}if(t.morphColors.length>0){for(var h=0,d=t.morphColors.length;d>h;h++){{var c=t.morphColors[h],u=c.name;c.colors}s.addUnattachedAttribute("mc_"+h,Float32Array,3),s.morphColors[h]={name:u,index:s.attributesList.length-1,faceColors:!0}}n.hasColors||(s.addVirtualAttribute("color"),s.virtualAttributes.color.mapped=s.attributesList[s.morphColors[0].index])}r[i]=s,s.bones=t.bones;var f=[];t.animations&&(f=t.animations),t.animation&&f.push(t.animation),s.animations=f}}return r},THREE.JSONLoader.prototype.fillGeometries=function(e,t,a,r,i){function o(e,t){return e&1<<t}function n(e,t,a,r,i){e[t]=a[3*r]*i,e[t+1]=a[3*r+1]*i,e[t+2]=a[3*r+2]*i}function s(e,t,a,r){e[t]=a[3*r],e[t+1]=a[3*r+1],e[t+2]=a[3*r+2]}function l(e,t,a,r,i){ut=e[3*t],ct=e[3*t+1],ft=e[3*t+2],pt.set(ut,ct,ft),ut=e[3*a],ct=e[3*a+1],ft=e[3*a+2],mt.set(ut,ct,ft),ut=e[3*r],ct=e[3*r+1],ft=e[3*r+2],vt.set(ut,ct,ft),gt.sub(vt,mt),St.sub(pt,mt),gt.crossSelf(St),i[3*t]+=xt[0],i[3*t+1]+=xt[1],i[3*t+2]+=xt[2],i[3*a]+=xt[0],i[3*a+1]+=xt[1],i[3*a+2]+=xt[2],i[3*r]+=xt[0],i[3*r+1]+=xt[1],i[3*r+2]+=xt[2]}var h,d,u,c,f,p,m,v,g,S,x,y,G,M,w,X,D,C,_,b,A,T,P,L,E,F,R,U,N,I,B,O,k,V,z,H,W,j,q,Z,K,Y,Q,J,$,et,tt=void 0!==a.scale?1/a.scale:1,at=new THREE.Color,rt=a.faces,it=a.vertices,ot=a.normals,nt=a.colors,st=a.skinWeights,lt=a.skinIndices,ht=new Float32Array(a.vertices.length);if(void 0!==a.morphTargets){var dt=[];for($=0,et=a.morphTargets.length;et>$;$++)dt[$]=new Float32Array(a.vertices.length)}for(var ut,ct,ft,pt=new THREE.Vector3,mt=new THREE.Vector3,vt=new THREE.Vector3,gt=new THREE.Vector3,St=new THREE.Vector3,xt=gt.data,yt=0,Gt=0,Mt=rt.length;Mt>Gt;){f=rt[Gt++],p=o(f,0),m=o(f,1),v=o(f,2),g=o(f,3),S=o(f,4),x=o(f,5),y=o(f,6),G=o(f,7),p?(A=rt[Gt++],T=rt[Gt++],P=rt[Gt++],L=rt[Gt++],Y=4):(A=rt[Gt++],T=rt[Gt++],P=rt[Gt++],Y=3),m?(c=rt[Gt++],i&&(c=0)):c=0,F=t[c],E=e[c],F.hasIndices&&(R=E.attributes.index.array),U=E.attributes.position.array,F.hasNormals&&(N=E.attributes.normal.array),F.hasUvs&&(I=E.attributes.uv.array),F.hasColors&&(B=E.attributes.color.array),V=F.indexOffset,z=F.positionOffset,q=F.vertexOffset;var wt=F.indexMap;if(p?(F.hasIndices?(R[V]=q,R[V+1]=q+1,R[V+2]=q+3,R[V+3]=q+1,R[V+4]=q+2,R[V+5]=q+3,F.positionOffset+=12):F.positionOffset+=18,F.indexOffset+=6,F.vertexOffset+=4):(F.hasIndices&&(R[V]=q,R[V+1]=q+1,R[V+2]=q+2),F.indexOffset+=3,F.vertexOffset+=3,F.positionOffset+=9),F.hasIndices){for(n(U,z,it,A,tt),n(U,z+3,it,T,tt),n(U,z+6,it,P,tt),wt[z]=A,wt[z+3]=T,wt[z+6]=P,l(it,A,T,P,ht),p&&(n(U,z+9,it,L,tt),wt[z+9]=L),Q=0,J=a.morphTargets.length;J>Q;Q++){var Xt=E.attributes["mp_"+Q].array,Dt=a.morphTargets[Q].vertices;n(Xt,z,Dt,A,tt),n(Xt,z+3,Dt,T,tt),n(Xt,z+6,Dt,P,tt),l(Dt,A,T,P,dt[Q]),p&&n(Xt,z+9,Dt,L,tt)}for(Q=0,J=a.morphColors.length;J>Q;Q++){var Ct=E.attributes["mc_"+Q].array,_t=a.morphColors[Q].colors;s(Ct,z,_t,yt),s(Ct,z+3,_t,yt),s(Ct,z+6,_t,yt),p&&s(Xt,z+9,_t,yt)}}else if(p){for(n(U,z,it,A,tt),n(U,z+3,it,T,tt),n(U,z+6,it,L,tt),n(U,z+9,it,T,tt),n(U,z+12,it,P,tt),n(U,z+15,it,L,tt),wt[z]=A,wt[z+3]=T,wt[z+6]=L,wt[z+9]=T,wt[z+12]=P,wt[z+15]=L,Q=0,J=a.morphTargets.length;J>Q;Q++){var Xt=E.attributes["mp_"+Q].array,Dt=a.morphTargets[Q].vertices;n(Xt,z,Dt,A,tt),n(Xt,z+3,Dt,T,tt),n(Xt,z+6,Dt,L,tt),n(Xt,z+9,Dt,T,tt),n(Xt,z+12,Dt,P,tt),n(Xt,z+15,Dt,L,tt)}for(Q=0,J=a.morphColors.length;J>Q;Q++){var Ct=E.attributes["mc_"+Q].array,_t=a.morphColors[Q].colors;s(Ct,z,_t,yt),s(Ct,z+3,_t,yt),s(Ct,z+6,_t,yt),s(Ct,z+9,_t,yt),s(Ct,z+12,_t,yt),s(Ct,z+15,_t,yt)}}else{for(n(U,z,it,A,tt),n(U,z+3,it,T,tt),n(U,z+6,it,P,tt),wt[z]=A,wt[z+3]=T,wt[z+6]=P,Q=0,J=a.morphTargets.length;J>Q;Q++){var Xt=E.attributes["mp_"+Q].array,Dt=a.morphTargets[Q].vertices;n(Xt,z,Dt,A,tt),n(Xt,z+3,Dt,T,tt),n(Xt,z+6,Dt,P,tt)}for(Q=0,J=a.morphColors.length;J>Q;Q++){var Ct=E.attributes["mc_"+Q].array,_t=a.morphColors[Q].colors;s(Ct,z,_t,yt),s(Ct,z+3,_t,yt),s(Ct,z+6,_t,yt)}}if(a.skinWeights&&(O=E.attributes.skinWeight.array,Z=F.skinWeightOffset,O[Z]=st[2*A],O[Z+1]=st[2*A+1],O[Z+2]=0,O[Z+3]=0,O[Z+4]=st[2*T],O[Z+5]=st[2*T+1],O[Z+6]=0,O[Z+7]=0,O[Z+8]=st[2*P],O[Z+9]=st[2*P+1],O[Z+10]=0,O[Z+11]=0,p?(O[Z+12]=st[2*L],O[Z+13]=st[2*L+1],O[Z+14]=0,O[Z+15]=0,F.skinWeightOffset+=16):F.skinWeightOffset+=12),a.skinIndices&&(k=E.attributes.skinIndex.array,K=F.skinIndexOffset,k[K]=lt[2*A],k[K+1]=lt[2*A+1],k[K+2]=0,k[K+3]=0,k[K+4]=lt[2*T],k[K+5]=lt[2*T+1],k[K+6]=0,k[K+7]=0,k[K+8]=lt[2*P],k[K+9]=lt[2*P+1],k[K+10]=0,k[K+11]=0,p?(k[K+12]=lt[2*L],k[K+13]=lt[2*L+1],k[K+14]=0,k[K+15]=0,F.skinIndexOffset+=16):F.skinIndexOffset+=12),v)for(Q=0;r>Q;Q++)for(M=a.uvs[Q],u=rt[Gt++],w=M[2*u],X=M[2*u+1],D=0===Q?I:E.attributes["uv"+(Q+1)].array,$=0;Y>$;$++)W=F.uvOffset[Q],D[W]=w,D[W+1]=X,F.uvOffset[Q]+=2;if(g)for(Q=0;r>Q;Q++){for(M=a.uvs[Q],D=0===Q?I:E.attributes["uv"+(Q+1)].array,$=0;Y>$;$++)W=F.uvOffset[Q],u=rt[Gt++],w=M[2*u],X=M[2*u+1],D[W]=w,D[W+1]=X,F.uvOffset[Q]+=2;if(p&&!F.hasIndices){var bt=F.uvOffset[Q]-4,At=D[bt],Tt=D[bt+1];D[bt]=w,D[bt+1]=X,D[bt+2]=D[bt-2],D[bt+3]=D[bt-1],D[bt+4]=At,D[bt+5]=Tt,D[bt+6]=w,D[bt+7]=X,F.uvOffset[Q]+=4}}if(S)for(d=3*rt[Gt++],C=ot[d++],_=ot[d++],b=ot[d],$=0;Y>$;$++)H=F.normalOffset,N[H]=C,N[H+1]=_,N[H+2]=b,F.normalOffset+=3;if(x){for(Q=0;Y>Q;Q++)H=F.normalOffset,d=3*rt[Gt++],C=ot[d++],_=ot[d++],b=ot[d],N[H]=C,N[H+1]=_,N[H+2]=b,F.normalOffset+=3;if(p&&!F.hasIndices){var bt=F.normalOffset-6,Pt=N[bt],Lt=N[bt+1],Et=N[bt+2];N[bt]=C,N[bt+1]=_,N[bt+2]=b,N[bt+3]=N[bt-3],N[bt+4]=N[bt-2],N[bt+5]=N[bt-1],N[bt+6]=Pt,N[bt+7]=Lt,N[bt+8]=Et,N[bt+9]=C,N[bt+10]=_,N[bt+11]=b,F.normalOffset+=6}}if(y)for(j=F.colorOffset,h=rt[Gt++],at.setHex(nt[h]),$=0;Y>$;$++)B[j]=at.r,B[j+1]=at.g,B[j+2]=at.b,F.colorOffset+=3;if(G){for(j=F.colorOffset,Q=0;Y>Q;Q++)h=rt[Gt++],at.setHex(nt[h]),B[j]=at.r,B[j+1]=at.g,B[j+2]=at.b,F.colorOffset+=3;if(p&&!F.hasIndices){var bt=F.colorOffset-6,Pt=B[bt],Lt=B[bt+1],Et=B[bt+2];B[bt]=C,B[bt+1]=_,B[bt+2]=b,B[bt+3]=B[bt-3],B[bt+4]=B[bt-2],B[bt+5]=B[bt-1],B[bt+6]=Pt,B[bt+7]=Lt,B[bt+8]=Et,B[bt+9]=C,B[bt+10]=_,B[bt+11]=b,F.colorOffset+=6}}yt+=1}var Ft;for(Q=0,J=ht.length;J>Q;Q+=3)C=ht[Q],_=ht[Q+1],b=ht[Q+2],Ft=1/Math.sqrt(C*C+_*_+b*b),ht[Q]*=Ft,ht[Q+1]*=Ft,ht[Q+2]*=Ft;if(void 0!==a.morphTargets)for($=0,et=a.morphTargets.length;et>$;$++){var Rt=dt[$];for(Q=0,J=Rt.length;J>Q;Q+=3)C=Rt[Q],_=Rt[Q+1],b=Rt[Q+2],Ft=1/Math.sqrt(C*C+_*_+b*b),Rt[Q]*=Ft,Rt[Q+1]*=Ft,Rt[Q+2]*=Ft}for(Q=0,J=t.length;J>Q;Q++){var Ut=t[Q];if(!Ut.hasNormals){E=e[Q],N=E.attributes.normal.array;for(Gt in Ut.indexMap){var Nt=Ut.indexMap[Gt];Gt=parseInt(Gt),N[Gt+0]=ht[3*Nt],N[Gt+1]=ht[3*Nt+1],N[Gt+2]=ht[3*Nt+2]}if(void 0!==a.morphTargets)for($=0,et=a.morphTargets.length;et>$;$++){var Rt=dt[$],It=E.attributes["mn_"+$].array;for(Gt in Ut.indexMap){var Nt=Ut.indexMap[Gt];Gt=parseInt(Gt),It[Gt+0]=Rt[3*Nt],It[Gt+1]=Rt[3*Nt+1],It[Gt+2]=Rt[3*Nt+2]}}}}},THREE.JSONLoader.prototype.createModel=function(e,t,a,r){for(var i=0,o=0;o<e.uvs.length;o++)e.uvs[o].length&&i++;var n=this.generateMaterialChunks(e,i,r),s=this.generateGeometries(n,e,i);this.fillGeometries(s,n,e,i,r);var l=this.initMaterials(e.materials,a);t(s,l)},THREE.RenderTarget=function(e,t,a){this.id=THREE.TextureIdCount++,this.width=e,this.height=t,a=a||{},this.wrapS=void 0!==a.wrapS?a.wrapS:THREE.ClampToEdgeWrapping,this.wrapT=void 0!==a.wrapT?a.wrapT:THREE.ClampToEdgeWrapping,this.magFilter=void 0!==a.magFilter?a.magFilter:THREE.LinearFilter,this.minFilter=void 0!==a.minFilter?a.minFilter:THREE.LinearMipMapLinearFilter,this.anisotropy=void 0!==a.anisotropy?a.anisotropy:1,this.offset=new THREE.Vector2(0,0),this.repeat=new THREE.Vector2(1,1),this.format=void 0!==a.format?a.format:THREE.RGBAFormat,this.type=void 0!==a.type?a.type:THREE.UnsignedByteType,this.depthBuffer=void 0!==a.depthBuffer?a.depthBuffer:!0,this.stencilBuffer=void 0!==a.stencilBuffer?a.stencilBuffer:!0,this.mipmapCount=0,this.generateMipmaps=!0,this.shareDepthFrom=null,this.useDepthTexture=void 0!==a.useDepthTexture?a.useDepthTexture:!1,this.depthTextureType=void 0!==a.depthTextureType?a.depthTextureType:THREE.UnsignedIntType,this.depthTexture=null,this.useColorTexture=void 0!==a.useColorTexture?a.useColorTexture:!0,this.needsUpdate=!0,this.onUpdate=null},THREE.RenderTarget.prototype.setSize=function(e,t){this.width=e,this.height=t,this.needsUpdate=!0},THREE.RenderTarget.prototype.clone=function(){var e=new THREE.RenderTarget(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.format=this.format,e.type=this.type,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e.mipmapCount=this.mipmapCount,e.generateMipmaps=this.generateMipmaps,e.shareDepthFrom=this.shareDepthFrom,e.useDepthTexture=this.useDepthTexture,e.depthTextureType=this.depthTextureType,e.depthTexture=this.depthTexture,e.useColorTexture=this.useColorTexture,e},THREE.RenderTargetCube=function(e,t,a){THREE.RenderTarget.call(this,e,t,a),this.activeCubeFace=0},THREE.RenderTargetCube.prototype=Object.create(THREE.RenderTarget.prototype),THREE.RenderTargetArray=function(e,t,a,r,i){i=i||{},this.width=e,this.height=t,this.colorTexture=[],this.depthTexture=null;for(var o=0;a>o;o++)this.colorTexture.push(new THREE.RenderTarget(e,t,i));r&&(this.depthTexture=new THREE.RenderTarget(e,t,{magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter})),this.depthBuffer=void 0!==i.depthBuffer?i.depthBuffer:!0,this.stencilBuffer=void 0!==i.stencilBuffer?i.stencilBuffer:!0,this.generateMipmaps=!0,this.needsUpdate=!0,this.onUpdate=null},THREE.RenderTargetArray.prototype.clone=function(){for(var e=new THREE.RenderTargetArray(this.width,this.height),t=this.colorTexture.length,a=0;t>a;a++)e.colorTexture.push(this.colorTexture[a].clone());return this.depthTexture&&(e.depthTexture=this.depthTexture.clone()),e.generateMipmaps=this.generateMipmaps,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e},THREE.RenderTargetArray.prototype.setSize=function(e,t){this.width=e,this.height=t;for(var a=this.colorTexture.length,r=0;a>r;r++)this.colorTexture[r].setSize(e,t);this.depthTexture&&this.depthTexture.setSize(e,t),this.needsUpdate=!0},THREE.ImageUtils={crossOrigin:"anonymous",loadTexture:function(e,t,a){var r=new Image,i=new THREE.Texture(r);return r.onload=function(){i.image=r,i.needsUpdate=!0,t&&t(i)},a&&(r.onerror=a),r.crossOrigin=this.crossOrigin,r.src=e,i.sourceFile=e,i},loadMultipleCRNTexturesFromPack:function(e,t,a){for(var r=!1,i=(Date.now(),[]),o=[],n=0,s=e.length;s>n;n++){var l=e[n],h=l[0],d=l[1],u=l[2];i.push([d,u]),o.push(h)}if(r);else var c=new Worker("js/crunch/CrunchWorker.js");c.onmessage=function(e){for(var t=e.data.textureData,r=0,i=t.length;i>r;r++){var n=t[r],s=o[r];s.format=n.format,s.mipmaps=n.mipmaps,s.image.width=n.width,s.image.height=n.height,s.generateMipmaps=!1,s.needsUpdate=!0}Date.now();a&&a()},c.postMessage({buffer:t,offsets:i},[t])},loadCRNTextureFromPack:function(e,t,a,r,i){var o=!0,n=THREE.ImageUtils.parseCRN(t,o,a,r);return e.format=n.format,e.mipmaps=n.mipmaps,e.image.width=n.width,e.image.height=n.height,e.generateMipmaps=!1,e.needsUpdate=!0,i&&i(e),e},loadCompressedTextureFromPack:function(e,t,a,r){var i=!0,o=THREE.ImageUtils.parseDDS(t,i,a);return e.format=o.format,e.mipmaps=o.mipmaps,e.image.width=o.width,e.image.height=o.height,e.generateMipmaps=!1,e.needsUpdate=!0,r&&r(e),e},loadCompressedTexture:function(e,t,a){var r=new THREE.CompressedTexture,i=new XMLHttpRequest;return i.onload=function(){var e=i.response,a=!0,o=0,n=THREE.ImageUtils.parseDDS(e,a,o);r.format=n.format,r.mipmaps=n.mipmaps,r.image.width=n.width,r.image.height=n.height,r.generateMipmaps=!1,r.needsUpdate=!0,t&&t(r)},i.onerror=a,i.open("GET",e,!0),i.responseType="arraybuffer",i.send(null),r},loadCRNTexture:function(e,t,a){var r=new THREE.CompressedTexture,i=new XMLHttpRequest;return i.onload=function(){var e=i.response,a=!0,o=THREE.ImageUtils.parseCRN(e,a,0);r.format=o.format,r.mipmaps=o.mipmaps,r.image.width=o.width,r.image.height=o.height,r.generateMipmaps=!1,r.needsUpdate=!0,t&&t(r)},i.onerror=a,i.open("GET",e,!0),i.responseType="arraybuffer",i.send(null),r},loadTextureCube:function(e,t,a){var r=[];r.loadCount=0;var i=new THREE.Texture;i.image=r,i.flipY=!1;for(var o=0,n=e.length;n>o;++o){var s=new Image;r[o]=s,s.onload=function(){r.loadCount+=1,6===r.loadCount&&(i.needsUpdate=!0,i.mipmapCount=0,t&&t(i))},s.onerror=a,s.crossOrigin=this.crossOrigin,s.src=e[o]}return i},loadCompressedTextureCube:function(e,t,a){var r=[];r.loadCount=0;var i=new THREE.CompressedTexture;i.image=r,i.flipY=!1,i.generateMipmaps=!1;var o=function(e,a){return function(){var o=e.response,n=!0,s=0,l=THREE.ImageUtils.parseDDS(o,n,s);a.format=l.format,a.mipmaps=l.mipmaps,a.width=l.width,a.height=l.height,r.loadCount+=1,6===r.loadCount&&(i.format=l.format,i.mipmapCount=l.mipmapCount,i.needsUpdate=!0,t&&t(i))}};if(e instanceof Array)for(var n=0,s=e.length;s>n;++n){var l={};r[n]=l;var h=new XMLHttpRequest;h.onload=o(h,l),h.onerror=a;var d=e[n];h.open("GET",d,!0),h.responseType="arraybuffer",h.send(null)}else{var d=e,h=new XMLHttpRequest;h.onload=function(){var e=h.response,a=!0,o=0,n=THREE.ImageUtils.parseDDS(e,a,o);if(n.isCubemap){for(var s=n.mipmaps.length/n.mipmapCount,l=0;s>l;l++){r[l]={mipmaps:[]};for(var d=0;d<n.mipmapCount;d++)r[l].mipmaps.push(n.mipmaps[l*n.mipmapCount+d]),r[l].format=n.format,r[l].width=n.width,r[l].height=n.height}i.format=n.format,i.mipmapCount=n.mipmapCount,i.needsUpdate=!0,t&&t(i)}},h.onerror=a,h.open("GET",d,!0),h.responseType="arraybuffer",h.send(null)}return i},loadCRNTextureCube:function(e,t,a){var r=[];r.loadCount=0;var i=new THREE.CompressedTexture;i.image=r,i.flipY=!1,i.generateMipmaps=!1;var o=function(e,a){return function(){var o=e.response,n=!0,s=0,l=THREE.ImageUtils.parseCRN(o,n,s);a.format=l.format,a.mipmaps=l.mipmaps,a.width=l.width,a.height=l.height,r.loadCount+=1,6===r.loadCount&&(i.format=l.format,i.mipmapCount=l.mipmapCount,i.needsUpdate=!0,t&&t(i))}};if(e instanceof Array)for(var n=0,s=e.length;s>n;++n){var l={};r[n]=l;var h=new XMLHttpRequest;h.onload=o(h,l),h.onerror=a;var d=e[n];h.open("GET",d,!0),h.responseType="arraybuffer",h.send(null)}else console.warn("Loading cubemap from cube CRN file not implemented!");return i},parseDDS:function(e,t,a){function r(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function i(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}void 0===a&&(a=0);var o={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},n=542327876,s=131072,l=512,h=4,d=64,u=64,c=65,f=r("DXT1"),p=r("DXT3"),m=r("DXT5"),v=31,g=0,S=1,x=2,y=3,G=4,M=7,w=20,X=21,D=28,C=new Uint32Array(e,a,v);if(C[g]!==n)return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),o;if(!C[w]&h)return console.error("ImageUtils.parseDDS(): Unsupported format, must contain a FourCC code"),o;var _=!0,b=0,A=C[X];switch(A){case f:b=8,o.format=THREE.RGB_S3TC_DXT1_Format;break;case p:b=16,o.format=THREE.RGBA_S3TC_DXT3_Format;break;case m:b=16,o.format=THREE.RGBA_S3TC_DXT5_Format;break;default:if(!(C[w]&d))return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",A,i(A)),o;if(C[20]===c)o.format=THREE.RGBAFormat,_=!1;else{if(C[20]!==u)return console.error("ImageUtils.parseDDS(): Unsupported uncompressed format"),o;o.format=THREE.RGBFormat,_=!1}}o.mipmapCount=1,C[x]&s&&t!==!1&&(o.mipmapCount=Math.max(1,C[M])),o.isCubemap=C[D]&l?!0:!1,o.width=C[G],o.height=C[y];for(var T,P,L,E=a+C[S]+4,F=o.width,R=o.height,U=o.isCubemap?6:1,N=0;U>N;N++){for(var I=0;I<o.mipmapCount;I++){var B=4;if(T=_?Math.max(4,F)/4*Math.max(4,R)/4*b:F*R*4,P=new Uint8Array(e,E,T),_)L=P;else if(o.format===THREE.RGBAFormat){L=P;for(var O=0;T>O;O+=4){var k=L[O];L[O]=L[O+2],L[O+2]=k}}else if(o.format===THREE.RGBFormat){L=new Uint8Array(F*R*3),L.length%16!==0&&(B=1);for(var V=0,O=0;T>O;O+=4){var z=P[O],H=P[O+1],W=P[O+2];L[V++]=W,L[V++]=H,L[V++]=z}}var j={data:L,width:F,height:R,unpackAlignment:B};o.mipmaps.push(j),E+=T,F=Math.max(.5*F,1),R=Math.max(.5*R,1)}F=o.width,R=o.height}return o},parseCRN:function(e,t,a,r){void 0===a&&(a=0),void 0===r&&(r=e.byteLength);var i={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},o=0,n=1,s=2,l=function(e,t,a){t.set(e,a)},h=new Uint8Array(e,a,r),d=r,u=Module._malloc(d);l(h,Module.HEAPU8,u,d);var c,f=Module._crn_get_dxt_format(u,d);switch(f){case o:c=THREE.RGB_S3TC_DXT1_Format;break;case n:c=THREE.RGBA_S3TC_DXT3_Format;break;case s:c=THREE.RGBA_S3TC_DXT5_Format;break;default:return console.error("ImageUtils.parseCRN(): Unsupported image format"),0}var p=Module._crn_get_width(u,d),m=Module._crn_get_height(u,d),v=Module._crn_get_levels(u,d);i.format=c,i.width=p,i.height=m,i.mipmapCount=v;for(var g=4,S=Module._crn_get_uncompressed_size(u,d,0),x=Module._malloc(S),y=0;v>y;++y){y&&(S=Module._crn_get_uncompressed_size(u,d,y)),Module._crn_decompress(u,d,x,S,y);var G=Module.HEAPU8.buffer.slice(x,x+S),M=new Uint8Array(G),w={data:M,width:p,height:m,unpackAlignment:g};i.mipmaps.push(w),p=Math.max(.5*p,1),m=Math.max(.5*m,1)}return Module._free(u),Module._free(x),i},getNormalMap:function(e,t){var a=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},r=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},i=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return[e[0]/t,e[1]/t,e[2]/t]};t=1|t;var o=e.width,n=e.height,s=document.createElement("canvas");s.width=o,s.height=n;var l=s.getContext("2d");l.drawImage(e,0,0);for(var h=l.getImageData(0,0,o,n).data,d=l.createImageData(o,n),u=d.data,c=0;o>c;c++)for(var f=0;n>f;f++){var p=0>f-1?0:f-1,m=f+1>n-1?n-1:f+1,v=0>c-1?0:c-1,g=c+1>o-1?o-1:c+1,S=[],x=[0,0,h[4*(f*o+c)]/255*t];S.push([-1,0,h[4*(f*o+v)]/255*t]),S.push([-1,-1,h[4*(p*o+v)]/255*t]),S.push([0,-1,h[4*(p*o+c)]/255*t]),S.push([1,-1,h[4*(p*o+g)]/255*t]),S.push([1,0,h[4*(f*o+g)]/255*t]),S.push([1,1,h[4*(m*o+g)]/255*t]),S.push([0,1,h[4*(m*o+c)]/255*t]),S.push([-1,1,h[4*(m*o+v)]/255*t]);for(var y=[],G=S.length,M=0;G>M;M++){var w=S[M],X=S[(M+1)%G];w=r(w,x),X=r(X,x),y.push(i(a(w,X)))}for(var D=[0,0,0],M=0;M<y.length;M++)D[0]+=y[M][0],D[1]+=y[M][1],D[2]+=y[M][2];D[0]/=y.length,D[1]/=y.length,D[2]/=y.length;var C=4*(f*o+c);u[C]=(D[0]+1)/2*255|0,u[C+1]=(D[1]+1)/2*255|0,u[C+2]=255*D[2]|0,u[C+3]=255}return l.putImageData(d,0,0),s},generateDataTexture:function(e,t,a){for(var r=e*t,i=new Uint8Array(3*r),o=Math.floor(255*a.r),n=Math.floor(255*a.g),s=Math.floor(255*a.b),l=0;r>l;l++)i[3*l]=o,i[3*l+1]=n,i[3*l+2]=s;var h=new THREE.DataTexture(i,e,t,THREE.RGBFormat);return h.needsUpdate=!0,h},generateNoiseTexture:function(e,t){for(var a=e*t,r=new Uint8Array(3*a),i=0;a>i;i++)r[3*i]=Math.floor(255*Math.random()),r[3*i+1]=Math.floor(255*Math.random()),r[3*i+2]=Math.floor(255*Math.random());var o=new THREE.DataTexture(r,e,t,THREE.RGBFormat);return o.needsUpdate=!0,o},generateDummyCompressedTexture:function(e){var t=[542327876,124,659463,4,4,8,0,3,1347242311,1396982829,131585,0,0,0,0,0,0,0,0,32,4,827611204,24,16711680,65280,255,0,4198408,0,0,0,0,38066,2863311530,38066,2863311530,38066,2863311530],a=new Uint32Array(t),r=!0,i=0,o=THREE.ImageUtils.parseDDS(a.buffer,r,i);e.format=o.format,e.mipmaps=o.mipmaps,e.image.width=o.width,e.image.height=o.height,e.generateMipmaps=!1,e.needsUpdate=!0},generateMipTexture:function(e,t){function a(e,t,a){for(var r=e*t,i=new Uint8Array(r),o=16*a,n=0;r>n;n++)i[n]=o;var s={width:e,height:t,data:i};return s}THREE.Math.isPowerOfTwo(e)&&THREE.Math.isPowerOfTwo(t)||console.error("THREE.ImageUtils.generateMipTexture: dimensions [",e,"x",t,"] are not power of two.");for(var r=Math.log(Math.max(e,t))/Math.LN2,i=e,o=t,n=[],s=0;r>=s;s++)n[s]=a(i,o,s),i=Math.max(Math.ceil(.5*i),1),o=Math.max(Math.ceil(.5*o),1);var l=n[0],h=new THREE.DataTexture(l.data,e,t,THREE.LuminanceFormat);return h.mipmaps=n,h.unpackAlignment=1,h.needsUpdate=!0,h}},THREE.UniformsUtils={merge:function(e){var t,a,r,i={};for(t=0;t<e.length;t++){r=this.clone(e[t]);for(a in r)i[a]=r[a]}return i},clone:function(e){var t,a,r,i={};for(t in e){i[t]={};for(a in e[t])r=e[t][a],i[t][a]=r instanceof THREE.Color||r instanceof THREE.Vector2||r instanceof THREE.Vector3||r instanceof THREE.Vector4||r instanceof THREE.Quaternion||r instanceof THREE.Matrix3||r instanceof THREE.Matrix4||r instanceof THREE.Texture?r.clone():r instanceof Array?r.slice():r}return i}},THREE.Fog=function(e,t,a){this.name="",this.color=new THREE.Color(e),this.near=void 0!==t?t:1,this.far=void 0!==a?a:1e3},THREE.Fog.prototype.clone=function(){return new THREE.Fog(this.color.getHex(),this.near,this.far)},THREE.FogExp2=function(e,t){this.name="",this.color=new THREE.Color(e),this.density=void 0!==t?t:25e-5},THREE.FogExp2.prototype.clone=function(){return new THREE.FogExp2(this.color.getHex(),this.density)},THREE.HeightFog=function(e){e=e||{},this.name="",this.height=void 0!==e.height?e.height:-15,this.visibilityDistance=void 0!==e.visibilityDistance?e.visibilityDistance:50,this.fadeSpeed=void 0!==e.fadeSpeed?e.fadeSpeed:.15,this.shallowDepthColor=void 0!==e.shallowDepthColor?e.shallowDepthColor:(new THREE.Color).setRGB(.0078,.5176,.7),this.deepDepthColor=void 0!==e.deepDepthColor?e.deepDepthColor:(new THREE.Color).setRGB(.0039,.00196,.145),this.rgbExtinctionDistance=void 0!==e.rgbExtinctionDistance?e.rgbExtinctionDistance:new THREE.Vector3(7,30,40)},THREE.HeightFog.prototype.clone=function(){var e=new THREE.HeightFog;return e.height=this.height,e.visibilityDistance=this.visibilityDistance,e.fadeSpeed=this.fadeSpeed,e.shallowDepthColor.copy(this.shallowDepthColor),e.deepDepthColor.copy(this.deepDepthColor),e.rgbExtinctionDistance.copy(this.rgbExtinctionDistance),e},THREE.LightProbe=function(e,t,a){this.bounces=0;var r=void 0!==a?a:THREE.FloatType,i={format:THREE.RGBFormat,type:r,magFilter:THREE.LinearFilter,minFilter:THREE.LinearMipMapLinearFilter,stencilBuffer:!1},o={format:THREE.RGBFormat,type:r,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter,stencilBuffer:!1};this.specularCube=new THREE.RenderTargetCube(e,e,i),this.diffuseCube=new THREE.RenderTargetCube(t,t,o);var n=THREE.IBLDiffuseProbeShader,s=THREE.UniformsUtils.clone(n.uniforms);s.tCube.value=this.diffuseCube;var l=new THREE.ShaderMaterial({vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,uniforms:s,transparent:!0}),h=THREE.IBLDiffuseConvolutionShader,d=THREE.UniformsUtils.clone(h.uniforms);d.tCube.value=this.specularCube,this.diffuseConvolutionMaterial=new THREE.ShaderMaterial({vertexShader:h.vertexShader,fragmentShader:h.fragmentShader,uniforms:d,side:THREE.BackSide,transparent:!0});var u=THREE.LightProbe.sphereGeometry;THREE.Mesh.call(this,u,l),this.renderDepth=1},THREE.LightProbe.prototype=Object.create(THREE.Mesh.prototype),THREE.LightProbe.sphereGeometry=new THREE.SphereGeometry(1,32,16),THREE.LightProbesManager=function(e,t,a){this.renderer=e,this.scene=t,this.dynamicObjects=a,this.defaultSpecularSize=128,this.defaultDiffuseSize=16,this.defaultProbeTextureType=THREE.FloatType,this.probesList=[],this.convolutionScene=new THREE.Scene,this.sceneCamera=new THREE.CubeCamera(1,1e3),this.convolutionCamera=new THREE.CubeCamera(1,1e3),this.scene.add(this.sceneCamera),this.convolutionScene.add(this.convolutionCamera);var r=new THREE.SphereGeometry(2,8,4);this.convolutionMesh=new THREE.Mesh(r,null),this.convolutionScene.add(this.convolutionMesh),this.maxBounces=1,this.maxProbesPerFrame=1},THREE.LightProbesManager.prototype.createProbe=function(e,t){void 0===e&&(e=this.defaultSpecularSize),void 0===t&&(t=this.defaultDiffuseSize);var a=new THREE.LightProbe(e,t,this.defaultProbeTextureType);return this.probesList.push(a),this.dynamicObjects.push(a),a},THREE.LightProbesManager.prototype.update=function(){var e,t,a,r=this.dynamicObjects;for(e=0,t=r.length;t>e;e++)a=r[e],a.properties.oldVisible=a.visible,a.visible=!1;var i=this.renderer,o=this.probesList,n=0;for(e=0,t=o.length;t>e;e++){var s=o[e];if(!(s.bounces>=this.maxBounces)){var l=s.specularCube,h=s.diffuseCube;if(this.sceneCamera.position.copy(s.position),this.convolutionMesh.materials[0]=s.diffuseConvolutionMaterial,i.renderCube(this.scene,this.sceneCamera,l),i.renderCube(this.convolutionScene,this.convolutionCamera,h),s.bounces+=1,n+=1,n>=this.maxProbesPerFrame)break}}for(e=0,t=r.length;t>e;e++)a=r[e],a.visible=a.properties.oldVisible},THREE.LightProbesManager.prototype.refreshProbes=function(){for(var e=this.probesList,t=0,a=e.length;a>t;t++){var r=e[t];r.bounces=0}},THREE.Material=function(){this.id=THREE.MaterialIdCount++,this.name="",this.side=THREE.FrontSide,this.opacity=1,this.transparent=!1,this.blending=THREE.NormalBlending,this.blendSrc=THREE.SrcAlphaFactor,this.blendDst=THREE.OneMinusSrcAlphaFactor,this.blendEquation=THREE.AddEquation,this.depthTest=!0,this.depthWrite=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.particle=!1,this.particleSize=1,this.visible=!0,this.enabled=!0,this.needsUpdate=!0},THREE.Material.prototype.setValues=function(e){if(void 0!==e)for(var t in e){var a=e[t];if(void 0!==a){if(t in this){var r=this[t];r instanceof THREE.Color&&a instanceof THREE.Color?r.copy(a):r instanceof THREE.Color?r.set(a):r instanceof THREE.Vector2&&a instanceof THREE.Vector2?r.copy(a):r instanceof THREE.Vector3&&a instanceof THREE.Vector3?r.copy(a):this[t]=a}}else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},THREE.Material.prototype.clone=function(e){return void 0===e&&(e=new THREE.Material),e.name=this.name,e.side=this.side,e.opacity=this.opacity,e.transparent=this.transparent,e.blending=this.blending,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.polygonOffset=this.polygonOffset,e.polygonOffsetFactor=this.polygonOffsetFactor,e.polygonOffsetUnits=this.polygonOffsetUnits,e.alphaTest=this.alphaTest,e.particle=this.particle,e.visible=this.visible,e},THREE.MaterialIdCount=0,THREE.EmissiveMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.intensity=1,this.map=null,this.lightMap=null,this.fog=!0,this.vertexColors=!1,this.skinning=!1,this.morphTargets=!1,this.particleSize=1,this.particleSizeAttenuation=!0,this.setValues(e)},THREE.EmissiveMaterial.prototype=Object.create(THREE.Material.prototype),THREE.EmissiveMaterial.prototype.clone=function(){var e=new THREE.EmissiveMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.lightMap=this.lightMap,e.fog=this.fog,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.particleSize=this.particleSize,e.particleSizeAttenuation=this.particleSizeAttenuation,e},THREE.PhongMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.specular=new THREE.Color(1118481),this.shininess=30,this.metal=!1,this.parallax=!1,this.parallaxScale=1,this.parallaxRefineSteps=3,this.wrapAround=!1,this.wrapAroundSkin=!1,this.wrapRGB=new THREE.Vector3(1,1,1),this.map=null,this.lightMap=null,this.glossMap=null,this.specularMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalGlossMap=null,this.normalScale=new THREE.Vector2(1,1),this.fog=!0,this.vertexColors=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.lights=!0,this.setValues(e)},THREE.PhongMaterial.prototype=Object.create(THREE.Material.prototype),THREE.PhongMaterial.prototype.clone=function(){var e=new THREE.PhongMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.specular.copy(this.specular),e.shininess=this.shininess,e.metal=this.metal,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.lightMap=this.lightMap,e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.normalMap=this.normalMap,e.normalGlossMap=this.normalGlossMap,e.normalScale.copy(this.normalScale),e.glossMap=this.glossMap,e.specularMap=this.specularMap,e.fog=this.fog,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},THREE.DynamicParticleMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.intensity=1,this.map=null,this.fog=!0,this.vertexColors=!1,this.particle=!0,this.particleSize=1,this.particleSizeAttenuation=!0,this.time=0,this.timeRange=1,this.timeOffset=0,this.numFrames=1,this.frameDuration=1,this.interpolateFrames=!0,this.setValues(e)},THREE.DynamicParticleMaterial.prototype=Object.create(THREE.Material.prototype),THREE.DynamicParticleMaterial.prototype.clone=function(){var e=new THREE.DynamicParticleMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.fog=this.fog,e.vertexColors=this.vertexColors,e.particleSize=this.particleSize,e.particleSizeAttenuation=this.particleSizeAttenuation,e.time=this.time,e.timeRange=this.timeRange,e.timeOffset=this.timeOffset,e.numFrames=this.numFrames,e.frameDuration=this.frameDuration,e.interpolateFrames=this.interpolateFrames,e},THREE.ShaderMaterial=function(e){THREE.Material.call(this),this.fragmentShader="void main() {}",this.vertexShader="void main() {}",this.uniforms={},this.defines={},this.attributes=null,this.fog=!1,this.lights=!1,this.vertexColors=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)},THREE.ShaderMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ShaderMaterial.prototype.clone=function(){var e=new THREE.ShaderMaterial;
return THREE.Material.prototype.clone.call(this,e),e.fragmentShader=this.fragmentShader,e.vertexShader=this.vertexShader,e.uniforms=THREE.UniformsUtils.clone(this.uniforms),e.attributes=this.attributes,e.defines=this.defines,e.fog=this.fog,e.lights=this.lights,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},THREE.Texture=function(e,t,a,r,i,o,n,s){this.id=THREE.TextureIdCount++,this.name="",this.image=e,this.mipmaps=[],this.mipmapCount=0,this.wrapS=void 0!==t?t:THREE.ClampToEdgeWrapping,this.wrapT=void 0!==a?a:THREE.ClampToEdgeWrapping,this.magFilter=void 0!==r?r:THREE.LinearFilter,this.minFilter=void 0!==i?i:THREE.LinearMipMapLinearFilter,this.anisotropy=void 0!==s?s:1,this.format=void 0!==o?o:THREE.RGBAFormat,this.type=void 0!==n?n:THREE.UnsignedByteType,this.offset=new THREE.Vector2(0,0),this.repeat=new THREE.Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.needsUpdate=!1,this.onUpdate=null},THREE.Texture.prototype={constructor:THREE.Texture,clone:function(e){return void 0===e&&(e=new THREE.Texture),e.image=this.image,e.mipmaps=this.mipmaps.slice(0),e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.format=this.format,e.type=this.type,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=this.flipY,e.unpackAlignment=this.unpackAlignment,e}},THREE.TextureIdCount=0,THREE.CompressedTexture=function(e,t,a,r,i,o,n,s,l,h){THREE.Texture.call(this,null,o,n,s,l,r,i,h),this.image={width:t,height:a},this.mipmaps=e,this.generateMipmaps=!1},THREE.CompressedTexture.prototype=Object.create(THREE.Texture.prototype),THREE.CompressedTexture.prototype.clone=function(){var e=new THREE.CompressedTexture;return THREE.Texture.prototype.clone.call(this,e),e},THREE.DataTexture=function(e,t,a,r,i,o,n,s,l,h){THREE.Texture.call(this,null,o,n,s,l,r,i,h),this.image={data:e,width:t,height:a}},THREE.DataTexture.prototype=Object.create(THREE.Texture.prototype),THREE.DataTexture.prototype.clone=function(){var e=new THREE.DataTexture;return THREE.Texture.prototype.clone.call(this,e),e},THREE.ShaderChunk={fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform vec2 fogNearFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNearFar.x, fogNearFar.y, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),height_fog_pars_fragment:["#ifdef USE_HEIGHT_FOG","uniform float fogHeight;","uniform float fogVisibilityDistance;","uniform float fogFadeSpeed;","uniform vec3 fogShallowDepthColor;","uniform vec3 fogDeepDepthColor;","uniform vec3 fogRgbExtinctionDistance;","#endif"].join("\n"),height_fog_fragment:["#ifdef USE_HEIGHT_FOG","vec3 u = vertexPositionWS.xyz - cameraPosition;","vec3 w = cameraPosition - vec3( 0.0, fogHeight, 0.0 );","vec3 n = vec3( 0.0, 1.0, 0.0 );","float D = dot( n, u );","float N = -dot( n, w );","float sI = N / D;","vec3 intersectionPosition = cameraPosition + sI * u;","float fogThickness = length( intersectionPosition - vertexPositionWS.xyz );","if ( vertexPositionWS.y > fogHeight ) {","fogThickness = 0.0;","}","float fogThickness2 = intersectionPosition.y - vertexPositionWS.y;","if ( cameraPosition.y < fogHeight ) {","}","float r1 = clamp( fogFadeSpeed * fogThickness / fogVisibilityDistance, 0.0, 1.0 );","vec3 r2 = clamp( fogThickness2 / fogRgbExtinctionDistance, 0.0, 1.0 );","gl_FragColor.xyz = mix( mix( gl_FragColor.xyz, fogShallowDepthColor * globalLightFactor, r1 ), fogDeepDepthColor * globalLightFactor, r2 );","#endif"].join("\n"),worldpos_vertex:["#if defined( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),map_pars_vertex:["#if !defined( PARTICLE ) && ( defined( USE_MAP ) || defined( USE_LIGHTMAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined ( USE_NORMALGLOSSMAP ) || defined ( USE_GLOSSMAP ) || defined( USE_SPECULARMAP ) )","varying vec2 vUv;","uniform vec4 offsetRepeat;","#endif"].join("\n"),map_pars_fragment:["#if !defined( PARTICLE ) && ( defined( USE_MAP ) || defined( USE_LIGHTMAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP ) || defined ( USE_GLOSSMAP ) || defined( USE_SPECULARMAP ) )","varying vec2 vUv;","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_vertex:["#if !defined( PARTICLE ) && ( defined( USE_MAP ) || defined( USE_LIGHTMAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP ) || defined ( USE_GLOSSMAP ) || defined( USE_SPECULARMAP ) )","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","vec2 texCoord;","#ifdef PARTICLE","texCoord = vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y );","#else","texCoord = uvCoord;","#endif","vec4 texelColor = texture2D( map, texCoord );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","gl_FragColor = gl_FragColor * texelColor;","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","float lightMapIntensity = texture2D( lightMap, uvCoord ).r;","#else","float lightMapIntensity = 1.0;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd( const in vec2 texCoord ) {","vec2 dSTdx = dFdx( texCoord );","vec2 dSTdy = dFdy( texCoord );","float Hll = bumpScale * texture2D( bumpMap, texCoord ).x;","float dBx = bumpScale * texture2D( bumpMap, texCoord + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, texCoord + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( const in vec3 surf_pos, const in vec3 surf_norm, const in vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#if defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb( const in vec3 eye_pos, const in vec3 surf_norm, const in vec3 normal_pixel, const in vec2 texCoord ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( texCoord.st );","vec2 st1 = dFdy( texCoord.st );","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = normal_pixel * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["vec3 specularMapColor;","#ifdef USE_SPECULARMAP","vec4 texelSpecular = texture2D( specularMap, uvCoord );","specularMapColor = texelSpecular.rgb;","#else","specularMapColor = vec3( 1.0 );","#endif"].join("\n"),glossmap_pars_fragment:["#ifdef USE_GLOSSMAP","uniform sampler2D glossMap;","#endif"].join("\n"),area_lights_utils:["#if MAX_AREA_LIGHTS > 0","vec3 projectOnPlane( vec3 point, vec3 planeCenter, vec3 planeNorm ) {","return point - dot( point - planeCenter, planeNorm ) * planeNorm;","}","bool sideOfPlane( vec3 point, vec3 planeCenter, vec3 planeNorm ) {","return ( dot( point - planeCenter, planeNorm ) >= 0.0 );","}","vec3 linePlaneIntersect( vec3 lp, vec3 lv, vec3 pc, vec3 pn ) {","return lp + lv * ( dot( pn, pc - lp ) / dot( pn, lv ) );","}","float calculateAttenuation( float dist, float constantAttenuation, float linearAttenuation, float quadraticAttenuation ) {","return ( 1.0 / ( constantAttenuation + linearAttenuation * dist + quadraticAttenuation * dist * dist ) );","}","#endif"].join("\n"),lights_phong_pars_fragment:["#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirectionVS[ MAX_DIR_LIGHTS ];","uniform int directionalLightPars[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirectionVS[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPositionVS[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPHERE_LIGHTS > 0","uniform vec3 sphereLightColor[ MAX_SPHERE_LIGHTS ];","uniform vec3 sphereLightPositionVS[ MAX_SPHERE_LIGHTS ];","uniform vec2 sphereLightPars[ MAX_SPHERE_LIGHTS ];","#endif","#if MAX_TUBE_LIGHTS > 0","uniform vec3 tubeLightColor[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightPosition0VS[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightPosition1VS[ MAX_TUBE_LIGHTS ];","uniform vec2 tubeLightPars[ MAX_TUBE_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPositionVS[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirectionVS[ MAX_SPOT_LIGHTS ];","uniform vec4 spotLightPars[ MAX_SPOT_LIGHTS ];","#endif","#if MAX_AREA_LIGHTS > 0","uniform vec3 areaLightColor[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightPosition[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightNormal[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightRight[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightUp[ MAX_AREA_LIGHTS ];","uniform vec4 areaLightPars[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightAttenuation[ MAX_AREA_LIGHTS ];","#ifdef AREA_TEXTURE","uniform sampler2D areaLightTexture[ MAX_AREA_LIGHTS ];","#endif","#endif","#if MAX_IMAGE_LIGHTS > 0","uniform samplerCube imageLightTextureDiffuse[ MAX_IMAGE_LIGHTS ];","uniform samplerCube imageLightTextureSpecular[ MAX_IMAGE_LIGHTS ];","uniform samplerCube imageLightTextureMip[ MAX_IMAGE_LIGHTS ];","uniform vec3 imageLightPars[ MAX_IMAGE_LIGHTS ];","uniform vec3 imageLightPositionWS[ MAX_IMAGE_LIGHTS ];","uniform vec3 imageLightSize[ MAX_IMAGE_LIGHTS ];","#endif","#if MAX_IMAGE_LIGHTS > 0 || defined( USE_HEIGHT_FOG )","uniform mat4 viewInverseMatrix;","#endif","#if MAX_IMAGE_LIGHTS > 0 || MAX_HEMI_LIGHTS > 0","vec3 EnvironmentBRDF( float gloss, float dotNV, vec3 rf0 ) {","vec4 t = vec4( 1.0 / 0.96, 0.475, ( 0.0275 - 0.25 * 0.04 ) / 0.96, 0.25 );","t *= vec4( gloss );","t += vec4( 0.0, 0.0, ( 0.015 - 0.75 * 0.04 ) / 0.96, 0.75 );","float a0 = t.x * min( t.y, exp2( -9.28 * dotNV ) ) + t.z;","float a1 = t.w;","return clamp( a0 + rf0 * ( a1 - a0 ), 0.0, 1.0 );","}","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","float SmithGeometryFactor1( vec3 L, vec3 V, vec3 N, float shininess ) {","vec3 H = L + V;","float dotVN = dot( V, N );","float dotVH = dot( V, H );","if ( ( dotVH / dotVN ) <= 0.0 ) return 0.0;","float f = acos( dotVN );","float a = sqrt( 0.5 * shininess + 1.0 ) / tan( f );","float G = 1.0;","if ( a < 1.6 )","G = ( 3.535 * a + 2.181 * a * a ) / ( 1.0 + 2.276 * a + 2.577 * a * a );","return G;","}","float SmithGeometryFactor2( float dotLN, vec3 V, vec3 N, float shininess ) {","float dotNV = max( dot( N, V ), 0.0 );","float a = 1.0 / ( sqrt( 0.7854 * shininess + 1.571 ) );","return 1.0 / ( ( dotLN * ( 1.0 - a ) + a ) * ( dotNV * ( 1.0 - a ) + a ) );","}","float KelemenGeometryFactor( float dotLH ) {","return 1.0 / ( dotLH * dotLH );","}","float GGX_SchlickGeometryFactor_V1( in float k, in float dotNX ) {","return dotNX / ( dotNX * ( 1.0 - k ) + k );","}","float GGX_SchlickGeometryFactor_V2( in float k, in float dotNX ) {","return 1.0 / ( dotNX + sqrt( k + ( 1.0 - k ) * dotNX * dotNX ) );","}","float saturate( float x ) {","return clamp( x, 0.0, 1.0 );","}","vec3 saturate( vec3 x ) {","return clamp( x, vec3( 0.0 ), vec3( 1.0 ) );","}","float GGX_Specular( in float m, in vec3 n, in vec3 h, in vec3 v, in vec3 l ) {","float nDotH = saturate( dot( n, h ) );","float nDotL = saturate( dot( n, l ) );","float nDotV = saturate( dot( n, v ) );","float nDotH2 = nDotH * nDotH;","float m2 = pow( m, 4.0 );","float d = m2 / ( pow( nDotH * nDotH * ( m2 - 1.0 ) + 1.0, 2.0 ) );","float v1i = GGX_SchlickGeometryFactor_V2( m2, nDotL );","float v1o = GGX_SchlickGeometryFactor_V2( m2, nDotV );","float vis = v1i * v1o;","return d * vis;","}","float BlinnPhong_Specular( in float shininess, in float dotLN, in float dotNormalHalf, in vec3 eyeVector, in vec3 normal ) {","float geo = SmithGeometryFactor2( dotLN, eyeVector, normal, shininess );","return geo * max( pow( dotNormalHalf, shininess ), 0.0 );","}","vec3 PSSFitFunction( in float NdotL, in float r ) {","const vec3 a0 = vec3( 0.0605, 0.2076, 0.2243 );","const vec3 a1 = vec3( 0.0903, 0.1687, 0.2436 );","const vec3 a2 = vec3( -0.0210, -0.0942, -0.1116 );","const vec3 a3 = vec3( 0.6896, 0.6762, 0.6480 );","const vec3 a4 = vec3( -0.1110, -0.5023, -0.6703 );","const vec3 a5 = vec3( 0.8177, 0.9119, 0.9209 );","vec3 t = vec3( NdotL ) * ( a0 * r + a1 ) + ( a2 * r + a3 );","vec3 fade = saturate( a4 * r + a5 );","return t * t * t * fade + saturate( NdotL ) * ( 1.0 - fade );","}","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),parallax_pars_fragment:["#if defined( USE_PARALLAX ) && defined( USE_BUMPMAP )","uniform float parallaxScale;","vec2 computeParallaxProjection( const in vec3 surf_pos, const in vec3 surf_norm, const in vec3 surf_view, const in vec2 texCoord ) {","vec2 TexDx = dFdx( texCoord );","vec2 TexDy = dFdy( texCoord );","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 vR1 = cross( vSigmaY, vN );","vec3 vR2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, vR1 );","vec3 vV = surf_view;","vec2 vProjVscr = ( 1.0 / fDet ) * vec2( dot( vR1, vV ), dot( vR2, vV ) );","vec2 vProjVtex = TexDx * vProjVscr.x + TexDy * vProjVscr.y;","return vProjVtex;","}","#endif"].join("\n"),parallax_fragment:["#if defined( USE_PARALLAX ) && defined( USE_BUMPMAP )","float height = parallaxScale * ( 2.0 * texture2D( bumpMap, vUv ).x - 1.0 );","vec2 parallaxProjection = computeParallaxProjection( -vViewPosition, normal, viewPosition, vUv );","vec2 uvOffset = parallaxProjection * height;","uvCoord += uvOffset;","#ifdef PARALLAX_REFINE_STEPS","for ( int i = 0; i < PARALLAX_REFINE_STEPS; i ++ ) {","height += parallaxScale * ( texture2D( bumpMap, uvCoord ).x - 1.0 );","uvOffset = parallaxProjection * height;","uvCoord = vUv + uvOffset;","}","#endif","#endif"].join("\n"),lights_phong_fragment:["#ifdef DOUBLE_SIDED","normal *= ( 2.0 * float( gl_FrontFacing ) - 1.0 );","#endif","#if defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","vec4 normalGlossMap = texture2D( normalMap, uvCoord );","#endif","#if defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","normal = perturbNormal2Arb( -vViewPosition, normal, normalGlossMap.xyz, uvCoord );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd( uvCoord ) );","#endif","#if defined( USE_GLOSSMAP )","vec4 glossMap = texture2D( glossMap, uvCoord );","float glossMapValue = exp2( 13.0 * glossMap.x + 1.0 );","#elif defined( USE_NORMALGLOSSMAP )","float glossMapValue = exp2( 13.0 * normalGlossMap.a + 1.0 );","#else","float glossMapValue = 1.0;","#endif","vec3 globalLightFactor = vec3( 0.0 );","vec3 vertexPosition = -vViewPosition.xyz;","vec3 eyeVector = normalize( -vertexPosition );","#if MAX_IMAGE_LIGHTS > 0 || defined( USE_HEIGHT_FOG )","vec4 vertexPositionWS = viewInverseMatrix * vec4( vertexPosition, 1.0 );","#endif","float shininess = glossMapValue * specular.a;","float specularNormalization = shininess * 0.125 + 0.25;","vec3 specularColor = specular.rgb * specularMapColor;","const float maxShininess = 8192.0;","float gloss = clamp( shininess / maxShininess, 0.0, 1.0 );","float roughness = saturate( sqrt( 8.0 / ( shininess + 7.0 ) ) );","#if defined( WRAP_AROUND ) && defined( WRAP_AROUND_SKIN )","float curvature = length( fwidth( vNormal.xyz ) ) / length( fwidth( vertexPosition.xyz ) );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec3 lightPosition = pointLightPositionVS[ i ];","vec3 lightVector = lightPosition + vViewPosition;","float attenuation = 1.0;","if ( pointLightDistance[ i ] > 0.0 ) {","float cutoff = 0.3;","float denom = length( lightVector ) / pointLightDistance[ i ] + 1.0;","attenuation = 1.0 / ( denom * denom );","attenuation = ( attenuation - cutoff ) / ( 1.0 - cutoff );","attenuation = max( attenuation, 0.0 );","attenuation *= attenuation;","}","lightVector = normalize( lightVector );","float dotLNUnclamped = dot( normal, lightVector );","float dotLN = max( dotLNUnclamped, 0.0 );","#ifdef WRAP_AROUND","#ifdef WRAP_AROUND_SKIN","vec3 pointDiffuseWeight = PSSFitFunction( dot( vNormal, lightVector ), curvature );","#else","float pointDiffuseWeightFull = dotLN;","float pointDiffuseWeightHalf = max( 0.25 * dotLNUnclamped + 0.25, 0.0 );","vec3 pointDiffuseWeight = mix( vec3( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#endif","#else","float pointDiffuseWeight = dotLN;","#endif","pointDiffuseWeight *= attenuation;","vec3 diffuseTerm = ( diffuse.rgb * pointLightColor[ i ] ) * pointDiffuseWeight;","vec3 pointHalfVector = normalize( lightVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotLH = max( dot( lightVector, pointHalfVector ), 0.0 );","vec3 fresnel = specularColor + ( 1.0 - specularColor ) * pow( 1.0 - dotLH, 5.0 );","#if defined( BRDF_BLINN_PHONG )","pointSpecular += attenuation * specularNormalization * BlinnPhong_Specular( shininess, dotLN, pointDotNormalHalf, eyeVector, normal ) * ( fresnel * dotLN ) * pointLightColor[ i ];","#elif defined( BRDF_GGX )","pointSpecular += attenuation * GGX_Specular( roughness, normal, pointHalfVector, eyeVector, lightVector ) * ( fresnel * dotLN ) * pointLightColor[ i ];","#endif","#else","float pointSpecularWeight = max( pow( pointDotNormalHalf, shininess ), 0.0 );","pointSpecular += attenuation * ( pointSpecularWeight * dotLN ) * ( specularColor * pointLightColor[ i ] );","#endif","#ifdef PHYSICALLY_BASED_SHADING","pointDiffuse  += ( 1.0 - fresnel ) * diffuseTerm;","#else","pointDiffuse  += diffuseTerm;","#endif","globalLightFactor += pointLightColor[ i ] * attenuation;","}","#endif","#if MAX_SPHERE_LIGHTS > 0","vec3 sphereDiffuse  = vec3( 0.0 );","vec3 sphereSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPHERE_LIGHTS; i ++ ) {","vec3 lightPosition = sphereLightPositionVS[ i ];","vec3 lightVectorFull = lightPosition + vViewPosition;","float attenuation = 1.0;","float maxDistance = sphereLightPars[ i ].x;","float lightRadius = sphereLightPars[ i ].y;","float lightDistance = length( lightVectorFull );","if ( maxDistance > 0.0 ) {","float cutoff = 0.3;","float denom = lightDistance / maxDistance + 1.0;","attenuation = 1.0 / ( denom * denom );","attenuation = ( attenuation - cutoff ) / ( 1.0 - cutoff );","attenuation = max( attenuation, 0.0 );","attenuation *= attenuation;","}","vec3 lightVector = normalize( lightVectorFull );","float dotLNUnclamped = dot( normal, lightVector );","float dotLN = max( dotLNUnclamped, 0.0 );","#ifdef WRAP_AROUND","#ifdef WRAP_AROUND_SKIN","vec3 sphereDiffuseWeight = PSSFitFunction( dot( vNormal, lightVector ), curvature );","#else","float sphereDiffuseWeightFull = dotLN;","float sphereDiffuseWeightHalf = max( 0.25 * dotLNUnclamped + 0.25, 0.0 );","vec3 sphereDiffuseWeight = mix( vec3( sphereDiffuseWeightFull ), vec3( sphereDiffuseWeightHalf ), wrapRGB );","#endif","#else","float sphereDiffuseWeight = dotLN;","#endif","sphereDiffuseWeight *= attenuation;","vec3 diffuseTerm = ( diffuse.rgb * sphereLightColor[ i ] ) * sphereDiffuseWeight;","vec3 reflectVS1 = reflect( eyeVector, normal );","vec3 centerToRay = lightVectorFull - dot( lightVectorFull, reflectVS1 ) * reflectVS1;","vec3 closestPoint = lightVectorFull - centerToRay * saturate( lightRadius / length( centerToRay ) );","lightVector = normalize( closestPoint );","dotLN = max( dot( lightVector, normal ), 0.0 );","float alpha = roughness * roughness;","float alphaPrime = saturate( alpha + lightRadius / ( 3.0 * lightDistance ) );","float sphereNormalization = alphaPrime * alphaPrime;","vec3 sphereHalfVector = normalize( lightVector + viewPosition );","float sphereDotNormalHalf = max( dot( normal, sphereHalfVector ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotLH = max( dot( lightVector, sphereHalfVector ), 0.0 );","vec3 fresnel = specularColor + ( 1.0 - specularColor ) * pow( 1.0 - dotLH, 5.0 );","#if defined( BRDF_BLINN_PHONG )","sphereSpecular += attenuation * specularNormalization * BlinnPhong_Specular( shininess, dotLN, sphereDotNormalHalf, eyeVector, normal ) * ( fresnel * dotLN ) * sphereLightColor[ i ];","#elif defined( BRDF_GGX )","sphereSpecular += sphereNormalization * attenuation * GGX_Specular( roughness, normal, sphereHalfVector, eyeVector, lightVector ) * ( fresnel * dotLN ) * sphereLightColor[ i ];","#endif","#else","float sphereSpecularWeight = max( pow( sphereDotNormalHalf, shininess ), 0.0 );","sphereSpecular += attenuation * ( sphereSpecularWeight * dotLN ) * ( specularColor * sphereLightColor[ i ] );","#endif","#ifdef PHYSICALLY_BASED_SHADING","sphereDiffuse  += ( 1.0 - fresnel ) * diffuseTerm;","#else","sphereDiffuse  += diffuseTerm;","#endif","globalLightFactor += sphereLightColor[ i ] * attenuation;","}","#endif","#if MAX_TUBE_LIGHTS > 0","vec3 tubeDiffuse  = vec3( 0.0 );","vec3 tubeSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_TUBE_LIGHTS; i ++ ) {","vec3 lightPosition0 = tubeLightPosition0VS[ i ];","vec3 lightPosition1 = tubeLightPosition1VS[ i ];","float attenuation = 1.0;","float maxDistance = tubeLightPars[ i ].x;","float lightRadius = tubeLightPars[ i ].y;","vec3 lightVector0 = lightPosition0 - vertexPosition;","vec3 lightVector1 = lightPosition1 - vertexPosition;","float length0 = length( lightVector0 );","float length1 = length( lightVector1 );","float a = 2.0 * saturate( dot( normal, lightVector0 ) / ( 2.0 * length0 ) + dot( normal, lightVector1 ) / ( 2.0 * length1 ) );","float b = length0 * length1 + dot( lightVector0, lightVector1 ) + 2.0;","float dotLN = a / b;","vec3 tubeDiffuseWeight = vec3( dotLN );","vec3 diffuseTerm = ( diffuse.rgb * tubeLightColor[ i ] ) * tubeDiffuseWeight;","vec3 reflectVS1 = reflect( eyeVector, normal );","vec3 lightVectorD = lightVector1 - lightVector0;","float lengthD = length( lightVectorD );","float dotRD = dot( reflectVS1, lightVectorD );","float ta = dot( reflectVS1, lightVector0 ) * dotRD - dot( lightVector0, lightVectorD );","float tb = lengthD * lengthD - dotRD * dotRD;","float t = ta / tb;","vec3 closestPoint = lightVector0 + saturate( t ) * lightVectorD;","vec3 lightVectorClosest = closestPoint;","vec3 centerToRay = lightVectorClosest - dot( lightVectorClosest, reflectVS1 ) * reflectVS1;","closestPoint = lightVectorClosest - centerToRay * saturate( lightRadius / length( centerToRay ) );","vec3 lightVector = normalize( closestPoint );","float lightDistance = length( closestPoint );","float alpha = roughness * roughness;","float alphaPrime = saturate( alpha + lightRadius / ( 3.0 * lightDistance ) );","float tubeNormalization = alphaPrime * alphaPrime;","if ( maxDistance > 0.0 ) {","float cutoff = 0.3;","float denom = lightDistance / maxDistance + 1.0;","attenuation = 1.0 / ( denom * denom );","attenuation = ( attenuation - cutoff ) / ( 1.0 - cutoff );","attenuation = max( attenuation, 0.0 );","}","vec3 sphereHalfVector = normalize( lightVector + viewPosition );","float sphereDotNormalHalf = max( dot( normal, sphereHalfVector ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotLH = max( dot( lightVector, sphereHalfVector ), 0.0 );","vec3 fresnel = specularColor + ( 1.0 - specularColor ) * pow( 1.0 - dotLH, 5.0 );","#if defined( BRDF_BLINN_PHONG )","tubeSpecular += attenuation * specularNormalization * BlinnPhong_Specular( shininess, dotLN, sphereDotNormalHalf, eyeVector, normal ) * ( fresnel * dotLN ) * tubeLightColor[ i ];","#elif defined( BRDF_GGX )","tubeSpecular += tubeNormalization * attenuation * GGX_Specular( roughness, normal, sphereHalfVector, eyeVector, lightVector ) * ( fresnel * dotLN ) * tubeLightColor[ i ];","#endif","#else","float sphereSpecularWeight = max( pow( sphereDotNormalHalf, shininess ), 0.0 );","sphereSpecular += attenuation * ( sphereSpecularWeight * dotLN ) * ( specularColor * sphereLightColor[ i ] );","#endif","#ifdef PHYSICALLY_BASED_SHADING","tubeDiffuse  += ( 1.0 - fresnel ) * diffuseTerm * attenuation;","#else","tubeDiffuse  += diffuseTerm * attenuation;","#endif","globalLightFactor += tubeLightColor[ i ] * attenuation;","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec3 lightPosition = spotLightPositionVS[ i ];","vec3 lightVector = lightPosition + vViewPosition;","float spotLightAngleCos = spotLightPars[ i ].x;","float spotLightExponent = spotLightPars[ i ].y;","float spotLightDistance = spotLightPars[ i ].z;","float attenuation = 1.0;","if ( spotLightDistance > 0.0 )","attenuation = 1.0 - min( ( length( lightVector ) / spotLightDistance ), 1.0 );","lightVector = normalize( lightVector );","float rho = dot( spotLightDirectionVS[ i ], normalize( spotLightPositionVS[ i ] + vViewPosition ) );","if ( rho > spotLightAngleCos ) {;","float theta = spotLightAngleCos + 0.0001;","float phi = spotLightAngleCos + 0.05;","const float falloff = 4.0;","float spotEffect = 0.0;","if ( rho >= phi ) {","spotEffect = 1.0;","} else if ( rho <= theta ) {","spotEffect = 0.0;","} else { ","spotEffect = pow( ( rho - theta ) / ( phi - theta ), falloff );","}","attenuation *= spotEffect;","float dotLNUnclamped = dot( normal, lightVector );","float dotLN = max( dotLNUnclamped, 0.0 );","#ifdef WRAP_AROUND","#ifdef WRAP_AROUND_SKIN","vec3 spotDiffuseWeight = PSSFitFunction( dot( vNormal, lightVector ), curvature );","#else","float spotDiffuseWeightFull = dotLN;","float spotDiffuseWeightHalf = max( 0.25 * dotLNUnclamped + 0.25, 0.0 );","vec3 spotDiffuseWeight = mix( vec3( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#endif","#else","float spotDiffuseWeight = dotLN;","#endif","spotDiffuseWeight *= attenuation;","vec3 diffuseTerm = spotDiffuseWeight * ( diffuse.rgb * spotLightColor[ i ] );","vec3 spotHalfVector = normalize( lightVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotLH = max( dot( lightVector, spotHalfVector ), 0.0 );","vec3 fresnel = specularColor + ( 1.0 - specularColor ) * pow( 1.0 - dotLH, 5.0 );","#if defined( BRDF_BLINN_PHONG )","vec3 specularTerm = attenuation * specularNormalization * BlinnPhong_Specular( shininess, dotLN, spotDotNormalHalf, eyeVector, normal ) * ( fresnel * dotLN ) * spotLightColor[ i ];","#elif defined( BRDF_GGX )","vec3 specularTerm = attenuation * GGX_Specular( roughness, normal, spotHalfVector, eyeVector, lightVector ) * ( fresnel * dotLN ) * spotLightColor[ i ];","#endif","#else","float spotSpecularWeight = max( pow( spotDotNormalHalf, shininess ), 0.0 );","vec3 specularTerm = attenuation * ( spotSpecularWeight * dotLN ) * ( specularColor * spotLightColor[ i ] );","#endif","#ifdef USE_SHADOWMAP","int shadowIndex = int( spotLightPars[ i ].w );","if ( ( i + SPOT_INDEX_OFFSET ) == shadowIndex ) {","diffuseTerm  *= occlusion[ i ];","specularTerm *= occlusion[ i ];","}","#endif","#ifdef PHYSICALLY_BASED_SHADING","spotDiffuse  += ( 1.0 - fresnel ) * diffuseTerm;","#else","spotDiffuse  += diffuseTerm;","#endif","spotSpecular += specularTerm;","globalLightFactor += spotLightColor[ i ] * attenuation;","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec3 lightDirection = directionalLightDirectionVS[ i ];","vec3 lightVector = normalize( lightDirection );","float dotLNUnclamped = dot( normal, lightVector );","float dotLN = max( dotLNUnclamped, 0.0 );","#ifdef WRAP_AROUND","#ifdef WRAP_AROUND_SKIN","vec3 dirDiffuseWeight = PSSFitFunction( dot( vNormal, lightVector ), curvature );","#else","float dirDiffuseWeightFull = dotLN;","float dirDiffuseWeightHalf = max( 0.25 * dotLNUnclamped + 0.25, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#endif","#else","float dirDiffuseWeight = dotLN;","#endif","vec3 diffuseTerm = diffuse.rgb * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( lightVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotLH = max( dot( lightVector, dirHalfVector ), 0.0 );","vec3 fresnel = specularColor + ( 1.0 - specularColor ) * pow( 1.0 - dotLH, 5.0 );","#if defined( BRDF_BLINN_PHONG )","vec3 specularTerm = specularNormalization * BlinnPhong_Specular( shininess, dotLN, dirDotNormalHalf, eyeVector, normal ) * ( fresnel * dotLN ) * directionalLightColor[ i ];","#elif defined( BRDF_GGX )","vec3 specularTerm = GGX_Specular( roughness, normal, dirHalfVector, eyeVector, lightVector ) * ( fresnel * dotLN ) * directionalLightColor[ i ];","#endif","#else","float dirSpecularWeight = max( pow( dirDotNormalHalf, shininess ), 0.0 );","vec3 specularTerm = ( dirSpecularWeight * dotLN ) * ( specularColor * directionalLightColor[ i ] );","#endif","#ifdef USE_SHADOWMAP","int shadowIndex = directionalLightPars[ i ];","if ( ( i + DIR_INDEX_OFFSET ) == shadowIndex ) {","diffuseTerm  *= occlusion[ i ];","specularTerm *= occlusion[ i ];","}","#endif","#ifdef PHYSICALLY_BASED_SHADING","dirDiffuse  += ( 1.0 - fresnel ) * diffuseTerm;","#else","dirDiffuse  += diffuseTerm;","#endif","dirSpecular += specularTerm;","globalLightFactor += directionalLightColor[ i ];","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec3 lightDirection = hemisphereLightDirectionVS[ i ];","vec3 lightVector = normalize( lightDirection.xyz );","vec3 halfVector = normalize( lightVector + eyeVector );","vec3 fresnelHemi = EnvironmentBRDF( gloss, dot( eyeVector, halfVector ), specularColor );","float dotProductHemi = dot( normal, lightVector );","float hemiDiffuseWeight = clamp( 0.5 * dotProductHemi + 0.5, 0.0, 1.0 );","vec3 diffuseHemi = ( 1.0 - fresnelHemi ) * mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","vec3 R = reflect( -eyeVector, normal );","R = normalize( R );","float hemiSpecularWeight = clamp( dot( R, lightVector ) * 0.5 + 0.5, 0.0, 1.0 );","vec3 specularHemi = fresnelHemi * mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiSpecularWeight );","hemiDiffuse += diffuse.rgb * diffuseHemi;","hemiSpecular += specularHemi;","globalLightFactor += hemisphereLightSkyColor[ i ];","}","#endif","#if MAX_AREA_LIGHTS > 0","vec3 areaDiffuse  = vec3( 0.0 );","vec3 areaSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_AREA_LIGHTS; i ++ ) {","float w = areaLightPars[ i ].x;","float h = areaLightPars[ i ].y;","vec3 proj = projectOnPlane( vertexPosition, areaLightPosition[ i ], areaLightNormal[ i ] );","vec3 dir = proj - areaLightPosition[ i ];","vec2 diagonal = vec2( dot( dir, areaLightRight[ i ] ), dot( dir, areaLightUp[ i ] ) );","vec2 nearest2D = vec2( clamp( diagonal.x, -w, w ), clamp( diagonal.y, -h, h ) );","vec3 nearestPointInside = areaLightPosition[ i ] + ( areaLightRight[ i ] * nearest2D.x + areaLightUp[ i ] * nearest2D.y );","vec3 lightDir = normalize( nearestPointInside - vertexPosition );","float NdotL = max( dot( areaLightNormal[ i ], -lightDir ), 0.0 );","float NdotL2 = max( dot( normal, lightDir ), 0.0 );","float dotLN = sqrt( NdotL * NdotL2 );","vec3 areaDiffuseWeight = vec3( dotLN );","#ifdef WRAP_AROUND","if ( NdotL > 0.0 ) {","#ifdef WRAP_AROUND_SKIN","areaDiffuseWeight = PSSFitFunction( sqrt( NdotL * dot( vNormal, lightDir ) ), curvature );","#else","float dotLNHalf = max( 0.25 * dotLN + 0.25, 0.0 );","areaDiffuseWeight = mix( areaDiffuseWeight, vec3( dotLNHalf ), wrapRGB );","#endif","}","#endif","float dist = distance( vertexPosition, nearestPointInside );","float attenuation = calculateAttenuation( dist, areaLightAttenuation[ i ].x, areaLightAttenuation[ i ].y, areaLightAttenuation[ i ].z );","areaDiffuseWeight *= attenuation;","vec3 areaDiffuseTerm = areaDiffuseWeight * ( diffuse.rgb * areaLightColor[ i ] );","#ifdef AREA_TEXTURE","if ( areaLightPars[ i ].z > 0.0 ) {","float d = distance( vertexPosition, nearestPointInside );","vec2 co = ( diagonal.xy + vec2( w, h ) ) / ( 2.0 * vec2( w, h ) );","co.y = 1.0 - co.y;","vec3 ve = vertexPosition - areaLightPosition[ i ];","vec4 diff = vec4( 0.0 );","if ( dot( ve, areaLightNormal[ i ] ) < 0.0 ) {","diff = vec4( 0.0 );","} else {","float lod = max( pow( d, 0.1 ), 0.0 ) * 5.0;","vec4 t00 = texture2D( areaLightTexture[ i ], co, lod );","vec4 t01 = texture2D( areaLightTexture[ i ], co, lod + 1.0 );","diff = mix( t00, t01, 0.5 );","}","areaDiffuseTerm *= diff.xyz;","}","#endif","vec3 areaSpecularTerm = vec3( 0.0 );","vec3 fresnel = vec3( 0.0 );","vec3 R = reflect( eyeVector, normal );","vec3 E = linePlaneIntersect( vertexPosition, R, areaLightPosition[ i ], areaLightNormal[ i ] );","float specAngle = dot( R, areaLightNormal[ i ] );","if ( dot( vertexPosition - areaLightPosition[ i ], areaLightNormal[ i ] ) >= 0.0 && specAngle > 0.0 ) {","vec3 dirSpec = E - areaLightPosition[ i ];","vec2 dirSpec2D = vec2( dot( dirSpec, areaLightRight[ i ] ), dot( dirSpec, areaLightUp[ i ] ) );","vec2 nearestSpec2D = vec2( clamp( dirSpec2D.x, -w, w ), clamp( dirSpec2D.y, -h, h ) );","vec3 nearestPointInsideSpec = areaLightPosition[ i ] + ( areaLightRight[ i ] * nearestSpec2D.x + areaLightUp[ i ] * nearestSpec2D.y );","vec3 lightDirSpec = normalize( nearestPointInsideSpec - vertexPosition );","vec3 halfVectorSpec = normalize( lightDirSpec + eyeVector );","float dotNormalHalf = max( dot( normal, halfVectorSpec ), 0.0 );","float dotLH = max( dot( lightDirSpec, halfVectorSpec ), 0.0 );","fresnel = specularColor + ( 1.0 - specularColor ) * pow( 1.0 - dotLH, 5.0 );","#if defined( BRDF_BLINN_PHONG )","areaSpecularTerm = specularNormalization * BlinnPhong_Specular( shininess, dotLN, dotNormalHalf, eyeVector, normal ) * ( fresnel * areaDiffuseWeight ) * specAngle * areaLightColor[ i ];","#elif defined( BRDF_GGX )","areaSpecularTerm = GGX_Specular( roughness, normal, halfVectorSpec, eyeVector, lightDirSpec ) * ( fresnel * areaDiffuseWeight ) * specAngle * areaLightColor[ i ];","#endif","#ifdef AREA_TEXTURE","if ( areaLightPars[ i ].z > 0.0 ) {","float areaHard = 16.0;","float areaGloss = 16.0;","vec3 specPlane = areaLightPosition[ i ] + ( areaLightRight[ i ] * dirSpec2D.x + areaLightUp[ i ] * dirSpec2D.y );","float dist = max( distance( vertexPosition, specPlane ), 0.0 );","float d = ( ( 1.0 / areaHard ) / 2.0 ) * ( dist / areaGloss );","w = max( w, 0.0 );","h = max( h, 0.0 );","vec2 co = dirSpec2D / ( d + 1.0 );","co /= 2.0 * vec2( w, h );","co = co + vec2( 0.5 );","co.y = 1.0 - co.y;","float lod = ( 2.0 / areaHard * max( dist, 0.0 ) );","vec4 t00 = texture2D( areaLightTexture[ i ], co, lod );","vec4 t01 = texture2D( areaLightTexture[ i ], co, lod + 1.0 );","vec4 spec = mix( t00, t01, 0.5 );","areaSpecularTerm *= spec.xyz;","}","#endif","}","#ifdef USE_SHADOWMAP","int shadowIndex = int( areaLightPars[ i ].w );","if ( ( i + AREA_INDEX_OFFSET ) == shadowIndex ) {","areaDiffuseTerm  *= occlusion[ i ];","areaSpecularTerm *= occlusion[ i ];","}","#endif","areaDiffuse  += ( 1.0 - fresnel * specAngle ) * areaDiffuseTerm;","areaSpecular += areaSpecularTerm;","globalLightFactor += areaLightColor[ i ] * attenuation;","}","#endif","#if MAX_IMAGE_LIGHTS > 0","vec3 imageDiffuse  = vec3( 0.0 );","vec3 imageSpecular = vec3( 0.0 );","vec3 reflectVS = reflect( -eyeVector, normal );","vec4 reflectWS = viewInverseMatrix * vec4( reflectVS, 0.0 );","vec3 fresnelEnv = EnvironmentBRDF( gloss, dot( eyeVector, normal ), specularColor );","for( int i = 0; i < MAX_IMAGE_LIGHTS; i ++ ) {","float maxMipSpecular = imageLightPars[ i ].x;","float lightIntensity = imageLightPars[ i ].y;","float lightLocal 	  = imageLightPars[ i ].z;","float localFade = 1.0;","if ( lightLocal > 0.0 ) {","vec3 lightPositionWS = imageLightPositionWS[ i ];","vec3 lightSize = imageLightSize[ i ];","vec3 BoxMin = lightPositionWS - lightSize;","vec3 BoxMax = lightPositionWS + lightSize;","vec3 FirstPlaneIntersect = ( BoxMax - vertexPositionWS.xyz ) / reflectWS.xyz;","vec3 SecondPlaneIntersect = ( BoxMin - vertexPositionWS.xyz ) / reflectWS.xyz;","vec3 FurthestPlane = max( FirstPlaneIntersect, SecondPlaneIntersect );","float Distance = min( min( FurthestPlane.x, FurthestPlane.y ), FurthestPlane.z );","vec3 IntersectPositionWS = vertexPositionWS.xyz + reflectWS.xyz * Distance;","reflectWS.xyz = IntersectPositionWS - lightPositionWS;","vec3 lightVectorWS = abs( lightPositionWS.xyz - vertexPositionWS.xyz );","if ( lightVectorWS.x > lightSize.x || lightVectorWS.y > lightSize.y || lightVectorWS.z > lightSize.z ) {","localFade = 0.0;","} else {","vec3 normLength = lightVectorWS / lightSize;","float maxLength = max( normLength.x, max( normLength.y, normLength.z ) );","localFade = max( 1.0 - maxLength, 0.0 );","}","}","vec3 cubeCoord = vec3( reflectWS.x, reflectWS.y, reflectWS.z );","const float mipUnit = 255.0 / 16.0;","float mipLevelMinification = mipUnit * textureCube( imageLightTextureMip[ i ], cubeCoord ).a;","float mipLevelMagnification = mipUnit * textureCube( imageLightTextureMip[ i ], cubeCoord, maxMipSpecular - 1.0 ).a;","float mipLevel;","if ( mipLevelMinification == 0.0 ) {","mipLevel = mipLevelMagnification - ( maxMipSpecular - 1.0 );","} else {","mipLevel = mipLevelMinification;","}","float maxMipDownscale = ( maxMipSpecular - 2.0 );","float mipBias = max( ( maxMipDownscale * ( 1.0 - gloss ) ) - mipLevel, 0.0 );","vec3 cubeColorSpecular = textureCube( imageLightTextureSpecular[ i ], cubeCoord, mipBias ).xyz;","#ifdef GAMMA_INPUT","cubeColorSpecular *= cubeColorSpecular;","#endif","vec4 normalWS = viewInverseMatrix * vec4( normal, 0.0 );","vec3 cubeColorDiffuse = textureCube( imageLightTextureDiffuse[ i ], vec3( normalWS.x, normalWS.y, normalWS.z ) ).xyz;","#ifdef GAMMA_INPUT","cubeColorDiffuse *= cubeColorDiffuse;","#endif","imageSpecular += localFade * lightIntensity * cubeColorSpecular * fresnelEnv;","imageDiffuse += localFade * lightIntensity * cubeColorDiffuse * ( 1.0 - fresnelEnv ) * diffuse.rgb;","globalLightFactor += cubeColorDiffuse[ i ] * lightIntensity;","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse * lightMapIntensity;","totalSpecular += hemiSpecular * lightMapIntensity;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPHERE_LIGHTS > 0","totalDiffuse += sphereDiffuse;","totalSpecular += sphereSpecular;","#endif","#if MAX_TUBE_LIGHTS > 0","totalDiffuse += tubeDiffuse;","totalSpecular += tubeSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#if MAX_AREA_LIGHTS > 0","totalDiffuse += areaDiffuse;","totalSpecular += areaSpecular;","#endif","#if MAX_IMAGE_LIGHTS > 0","totalDiffuse += imageDiffuse * lightMapIntensity;","totalSpecular += imageSpecular * lightMapIntensity;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse ) + totalSpecular;","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","gl_FragColor.rgb *= vColor;","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef BONE_TEXTURE","uniform sampler2D boneTexture;","mat4 getBoneMatrix( const in float i ) {","float j = i * 4.0;","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );","vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );","vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );","vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );","mat4 bone = mat4( v1, v2, v3, v4 );","return bone;","}","#else","uniform mat4 boneGlobalMatrices[ MAX_BONES ];","mat4 getBoneMatrix( const in float i ) {","mat4 bone = boneGlobalMatrices[ int(i) ];","return bone;","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","uniform float morphTargetInfluences[ 4 ];","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","#if MAX_MORPHTARGETS > 1","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","#if MAX_MORPHTARGETS > 2","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","#if MAX_MORPHTARGETS > 3","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#endif","#endif","#endif","morphed += position;","#endif"].join("\n"),default_vertex:["vec4 mvPosition;","#ifdef USE_SKINNING","mvPosition = modelViewMatrix * skinned;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( morphed, 1.0 );","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","#if MAX_MORPHNORMALS > 1","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","#if MAX_MORPHNORMALS > 2","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","#if MAX_MORPHNORMALS > 3","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","#endif","#endif","#endif","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#ifdef USE_SKINNING","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )","objectNormal = morphedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","vec3 transformedNormal = normalMatrix * objectNormal;"].join("\n"),shadowmap_pars_fragment:["#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec4 shadowMapPars[ MAX_SHADOWS ];","varying vec4 vShadowCoord[ MAX_SHADOWS ];","#ifdef DEPTH_TEXTURES","float unpackDepth( const in vec4 depth ) {","return depth.x;","}","#else","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","#endif","#endif"].join("\n"),shadowmap_fragment:["#ifdef USE_SHADOWMAP","float occlusion[ MAX_SHADOWS ];","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[4];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","frustumColors[3] = vec3( 1.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","float combinedOcclusion = 1.0;","#endif","float shadowDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","occlusion[ i ] = 1.0;","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","float shadowDarkness = shadowMapPars[ i ].z;","float shadowBias = shadowMapPars[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","inFrustumCount += int( inFrustum );","bvec3 frustumTestVec = bvec3( inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );","#else","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias;","#if defined( SHADOWMAP_TYPE_PCF )","float shadowValue = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapPars[ i ].x;","float yPixelOffset = 1.0 / shadowMapPars[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","shadowValue += shadowDelta * float( shadowCoord.z > shadowDepth );","occlusion[ i ] = 1.0 - shadowDarkness * shadowValue;","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadowDepth;","float shadowValue = 0.0;","float xPixelOffset = 1.0 / shadowMapPars[ i ].x;","float yPixelOffset = 1.0 / shadowMapPars[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","shadowKernel[0][0] = float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","shadowKernel[0][1] = float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","shadowKernel[0][2] = float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","shadowKernel[1][0] = float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","shadowKernel[1][1] = float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","shadowKernel[1][2] = float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","shadowKernel[2][0] = float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","shadowKernel[2][1] = float( shadowCoord.z > shadowDepth );","shadowDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","shadowKernel[2][2] = float( shadowCoord.z > shadowDepth );","shadowKernel *= 0.25;","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapPars[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadowValue = dot( shadowValues, vec4( 1.0 ) );","occlusion[ i ] = 1.0 - shadowDarkness * shadowValue;","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if ( fDepth < shadowCoord.z )","occlusion[ i ] = 1.0 - shadowDarkness;","#endif","#ifdef SHADOWMAP_CASCADE","combinedOcclusion *= occlusion[ i ];","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef SHADOWMAP_CASCADE","occlusion[ DIR_INDEX_OFFSET ] = combinedOcclusion;","#endif","#endif"].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif"].join("\n"),alphatest_fragment:["#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),particle_pars_vertex:["#ifdef PARTICLE","uniform float particleSize;","uniform float screenWidth;","#endif"].join("\n"),particle_vertex:["#ifdef PARTICLE","#ifdef USE_PARTICLE_SIZEATTENUATION","vec4 projectedCorner = projectionMatrix * vec4( 0.5 * particleSize, 0.5 * particleSize, mvPosition.z, mvPosition.w );","gl_PointSize = screenWidth * projectedCorner.x / projectedCorner.w;","#else","gl_PointSize = particleSize;","#endif","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n"),tonemapping_pars_fragment:["#ifdef TONEMAPPING","uniform float brightness;","#ifdef TONEMAP_UNCHARTED","const float A = 0.15;","const float B = 0.50;","const float C = 0.10;","const float D = 0.20;","const float E = 0.02;","const float F = 0.30;","const float W = 11.2;","vec3 Uncharted2Tonemap( vec3 x ) {","return ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","}","#endif","#endif"].join("\n"),tonemapping_fragment:["#ifdef TONEMAPPING","vec3 inColor = gl_FragColor.xyz;","inColor *= brightness;","vec3 outColor;","#if defined( TONEMAP_SIMPLE )","outColor = sqrt( inColor );","#elif defined( TONEMAP_LINEAR )","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD )","inColor = inColor / ( 1.0 + inColor );","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD_LUMA )","float luma = dot( inColor, vec3( 0.2126, 0.7152, 0.0722 ) );","float toneMappedLuma = luma / ( 1.0 + luma );","inColor *= toneMappedLuma / luma;","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD_WHITE )","const float white = 2.0;","float luma = dot( inColor, vec3( 0.2126, 0.7152, 0.0722 ) );","float toneMappedLuma = luma * ( 1.0 + luma / ( white * white ) ) / ( 1.0 + luma );","inColor *= toneMappedLuma / luma;","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_FILMIC )","vec3 x = max( vec3( 0.0 ), inColor - 0.004 );","outColor = ( x * ( 6.2 * x + 0.5 ) ) / ( x * ( 6.2 * x + 1.7 ) + 0.06 );","#elif defined( TONEMAP_UNCHARTED )","float ExposureBias = 2.0;","vec3 curr = Uncharted2Tonemap( ExposureBias * inColor );","vec3 whiteScale = vec3( 1.0 ) / Uncharted2Tonemap( vec3( W ) );","vec3 color = curr * whiteScale;","outColor = pow( color, vec3( 1.0 / 2.2 ) );","#else","outColor = inColor;","#endif","gl_FragColor.xyz = outColor;","#endif"].join("\n")},THREE.UniformsLib={common:{map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:null},brightness:{type:"f",value:1}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:25e-5,shared:!0},fogNearFar:{type:"v2",value:new THREE.Vector2(1,2e3),shared:!0},fogColor:{type:"c",value:new THREE.Color(16777215),shared:!0}},heightFog:{fogHeight:{type:"f",value:-15,shared:!0},fogVisibilityDistance:{type:"f",value:50,shared:!0},fogFadeSpeed:{type:"f",value:.15,shared:!0},fogShallowDepthColor:{type:"c",value:(new THREE.Color).setRGB(.0078,.5176,.7),shared:!0},fogDeepDepthColor:{type:"c",value:(new THREE.Color).setRGB(.0039,.00196,.145),shared:!0},fogRgbExtinctionDistance:{type:"v3",value:new THREE.Vector3(7,30,40),shared:!0}},lights:{directionalLightDirectionVS:{type:"fv3",value:[],shared:!0},directionalLightColor:{type:"fv3",value:[],shared:!0},directionalLightPars:{type:"iv1",value:[],shared:!0},hemisphereLightDirectionVS:{type:"fv3",value:[],shared:!0},hemisphereLightSkyColor:{type:"fv3",value:[],shared:!0},hemisphereLightGroundColor:{type:"fv3",value:[],shared:!0},pointLightColor:{type:"fv3",value:[],shared:!0},pointLightPositionVS:{type:"fv3",value:[],shared:!0},pointLightDistance:{type:"fv1",value:[],shared:!0},sphereLightColor:{type:"fv3",value:[],shared:!0},sphereLightPositionVS:{type:"fv3",value:[],shared:!0},sphereLightPars:{type:"fv2",value:[],shared:!0},tubeLightColor:{type:"fv3",value:[],shared:!0},tubeLightPosition0VS:{type:"fv3",value:[],shared:!0},tubeLightPosition1VS:{type:"fv3",value:[],shared:!0},tubeLightPars:{type:"fv2",value:[],shared:!0},spotLightColor:{type:"fv3",value:[],shared:!0},spotLightPositionVS:{type:"fv3",value:[],shared:!0},spotLightDirectionVS:{type:"fv3",value:[],shared:!0},spotLightPars:{type:"fv4",value:[],shared:!0},areaLightColor:{type:"fv3",value:[],shared:!0},areaLightPosition:{type:"fv3",value:[],shared:!0},areaLightNormal:{type:"fv3",value:[],shared:!0},areaLightRight:{type:"fv3",value:[],shared:!0},areaLightUp:{type:"fv3",value:[],shared:!0},areaLightPars:{type:"fv4",value:[],shared:!0},areaLightAttenuation:{type:"fv3",value:[],shared:!0},areaLightTexture:{type:"tv",value:[],shared:!0},imageLightTextureDiffuse:{type:"tv",value:[],shared:!0},imageLightTextureSpecular:{type:"tv",value:[],shared:!0},imageLightTextureMip:{type:"tv",value:[],shared:!0},imageLightPars:{type:"fv3",value:[],shared:!0},imageLightPositionWS:{type:"fv3",value:[],shared:!0},imageLightSize:{type:"fv3",value:[],shared:!0}},particle:{particleSize:{type:"f",value:1},screenWidth:{type:"f",value:1920}},dynamicParticle:{time:{type:"f",value:0},timeRange:{type:"f",value:1.25},timeOffset:{type:"f",value:0},numFrames:{type:"f",value:1},frameDuration:{type:"f",value:1},tDepth:{type:"t",value:null,shared:!0},viewSize:{type:"v2",value:new THREE.Vector2(800,600),shared:!0}},shadowmap:{shadowMap:{type:"tv",value:[],shared:!0},shadowMapPars:{type:"v4v",value:[],shared:!0},shadowMatrix:{type:"m4v",value:[],shared:!0}}},THREE.ShaderLib={emissive:{uniforms:THREE.UniformsUtils.merge([{diffuse:{type:"v4",value:new THREE.Vector4(.9,.9,.9,1)}},THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.particle]),vertexShader:[THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.particle_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.particle_vertex,"}"].join("\n"),fragmentShader:["uniform vec4 diffuse;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.tonemapping_pars_fragment,"void main() {","gl_FragColor = diffuse;","#if !defined( PARTICLE ) && ( defined( USE_MAP ) || defined( USE_LIGHTMAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined ( USE_NORMALGLOSSMAP ) || defined ( USE_GLOSSMAP ) || defined( USE_SPECULARMAP ) )","vec2 uvCoord = vUv;","#endif",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,"gl_FragColor.xyz *= lightMapIntensity;",THREE.ShaderChunk.fog_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.tonemapping_fragment,"}"].join("\n")},phong:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.bump,THREE.UniformsLib.normalmap,THREE.UniformsLib.fog,THREE.UniformsLib.heightFog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{diffuse:{type:"v4",value:new THREE.Vector4(.9,.9,.9,1)},specular:{type:"v4",value:new THREE.Vector4(.1,.1,.1,30)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)},glossMap:{type:"t",value:null},specularMap:{type:"t",value:null},parallaxScale:{type:"f",value:1}}]),vertexShader:["varying vec3 vViewPosition;","varying vec3 vNormal;",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec4 diffuse;","uniform vec4 specular;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.height_fog_pars_fragment,THREE.ShaderChunk.area_lights_utils,THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.bumpmap_pars_fragment,THREE.ShaderChunk.normalmap_pars_fragment,THREE.ShaderChunk.parallax_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,THREE.ShaderChunk.glossmap_pars_fragment,THREE.ShaderChunk.tonemapping_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), diffuse.a );","#if !defined( PARTICLE ) && ( defined( USE_MAP ) || defined( USE_LIGHTMAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined ( USE_NORMALGLOSSMAP ) || defined ( USE_GLOSSMAP ) || defined( USE_SPECULARMAP ) )","vec2 uvCoord = vUv;","#endif","vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );",THREE.ShaderChunk.parallax_fragment,THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.height_fog_fragment,THREE.ShaderChunk.fog_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.tonemapping_fragment,"}"].join("\n")},dynamicParticle:{uniforms:THREE.UniformsUtils.merge([{diffuse:{type:"v4",value:new THREE.Vector4(.9,.9,.9,1)}},THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.particle,THREE.UniformsLib.dynamicParticle]),vertexShader:[THREE.ShaderChunk.particle_pars_vertex,"uniform float time;","uniform float timeRange;","uniform float timeOffset;","#ifdef OFFSCREEN_PARTICLES","varying vec4 clipPos;","#endif","attribute vec4 velocitySpinStart;","attribute vec4 accelerationSpinSpeed;","attribute vec4 startSizeEndSizeStartTimeLifeTime;","varying vec4 vSpinLifeTime;","void main() {","float startSize = startSizeEndSizeStartTimeLifeTime.x;","float endSize = startSizeEndSizeStartTimeLifeTime.y;","float startTime = startSizeEndSizeStartTimeLifeTime.z;","float lifeTime = startSizeEndSizeStartTimeLifeTime.w;","vec3 velocity = velocitySpinStart.xyz;","float spinStart = velocitySpinStart.w;","vec3 acceleration = accelerationSpinSpeed.xyz;","float spinSpeed = accelerationSpinSpeed.w;","float localTime = mod( ( time - timeOffset - startTime ), timeRange );","float percentLife = localTime / lifeTime;","vec3 newPosition = position + velocity * localTime + acceleration * localTime * localTime;","vec4 mvPosition = modelViewMatrix * vec4( newPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","float currentSize = 0.5 * particleSize * mix( startSize, endSize, percentLife );","currentSize *= step( 0.0, percentLife );","currentSize *= step( -1.0, -percentLife );","if ( currentSize == 0.0 ) gl_Position = vec4( -100000000.0 );","#ifdef OFFSCREEN_PARTICLES","clipPos = gl_Position;","#endif","vec4 projectedCorner = projectionMatrix * vec4( currentSize, currentSize, mvPosition.z, mvPosition.w );","gl_PointSize = screenWidth * projectedCorner.x / projectedCorner.w;","percentLife *= step( 0.0, percentLife );","percentLife *= step( -1.0, -percentLife );","vSpinLifeTime = vec4( spinStart, spinSpeed, percentLife, localTime );","}"].join("\n"),fragmentShader:[THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.tonemapping_pars_fragment,"uniform sampler2D map;","uniform vec4 diffuse;","uniform float time;","uniform float numFrames;","uniform float frameDuration;","#ifdef OFFSCREEN_PARTICLES","uniform sampler2D tDepth;","uniform vec2 viewSize;","varying vec4 clipPos;","#ifdef RGBA_DEPTH","float unpackDepth( vec4 rgba ) {","return dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) );","}","#endif","#endif","varying vec4 vSpinLifeTime;","void main() {","#ifdef OFFSCREEN_PARTICLES","vec2 screenCoord = gl_FragCoord.xy / viewSize;","#if defined( RGBA_DEPTH )","float sceneDepth = unpackDepth( texture2D( tDepth, screenCoord ) );","#elif defined( FLOAT_DEPTH )","float sceneDepth = texture2D( tDepth, screenCoord ).w;","#elif defined( TEXTURE_DEPTH )","float sceneDepth = texture2D( tDepth, screenCoord ).x * 2.0 - 1.0;","#endif","float myDepth = clipPos.z / clipPos.w;","if ( myDepth > sceneDepth ) discard;","#endif","float spinStart = vSpinLifeTime.x;","float spinSpeed = vSpinLifeTime.y;","float percentLife = vSpinLifeTime.z;","float localTime = vSpinLifeTime.w;","const float frameStart = 0.0;","vec2 texCoord = vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) - 0.5;","float s = sin( spinStart + spinSpeed * time );","float c = cos( spinStart + spinSpeed * time );","vec2 rotatedCoord1 = vec2( texCoord.x * c + texCoord.y * s, -texCoord.x * s + texCoord.y * c ) + 0.5;","rotatedCoord1 = clamp( rotatedCoord1, 0.0, 1.0 );","vec2 rotatedCoord2 = rotatedCoord1;","float frame1 = mod( floor( localTime / frameDuration + frameStart ), numFrames );","float uOffset1 = frame1 / numFrames;","rotatedCoord1.x = uOffset1 + ( rotatedCoord1.x ) * ( 1.0 / numFrames );","vec4 pixel1 = texture2D( map, rotatedCoord1 );","pixel1.xyz *= pixel1.xyz;","#ifdef INTERPOLATE_PARTICLE_FRAMES","float frame2 = mod( floor( localTime / frameDuration + frameStart + 1.0 ), numFrames );","float uOffset2 = frame2 / numFrames;","float frameTime = fract( localTime / frameDuration + frameStart );","rotatedCoord2.x = uOffset2 + ( rotatedCoord2.x ) * ( 1.0 / numFrames );","vec4 pixel2 = texture2D( map, rotatedCoord2 );","pixel2.xyz *= pixel2.xyz;","pixel1 = mix( pixel1, pixel2, frameTime );","#endif","if ( pixel1.a < 0.001 ) discard;","gl_FragColor = pixel1 * diffuse;",THREE.ShaderChunk.fog_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.tonemapping_fragment,"}"].join("\n")},depthRGBA:{uniforms:{slopeScale:{type:"f",value:2,shared:!0},slopeBias:{type:"f",value:0,shared:!0},slopeMax:{type:"f",value:.001,shared:!0}},vertexShader:[THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,"void main() {",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:["#if !defined( DEPTH_TEXTURES )","#ifdef SLOPE_DEPTH_BIAS","#extension GL_OES_standard_derivatives : enable\n","uniform float slopeScale;","uniform float slopeBias;","uniform float slopeMax;","#endif","vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = fract( depth * bit_shift );","res -= res.xxyz * bit_mask;","return res;","}","#endif","void main() {","#ifndef DEPTH_TEXTURES","float depth = gl_FragCoord.z;","#ifdef SLOPE_DEPTH_BIAS","float dx = dFdx( depth );","float dy = dFdy( depth );","float m = max( abs(dx), abs(dy) );","m = min( m, slopeMax );","depth += m * slopeScale + slopeBias;","#endif","gl_FragColor = pack_depth( depth );","#endif","}"].join("\n")}},THREE.DeferredUniformsLib={gbuffers:{samplerColor:{type:"t",value:null,shared:!0},samplerNormalDepth:{type:"t",value:null,shared:!0},samplerDiffuseRGB:{type:"t",value:null,shared:!0},samplerSpecularRGB:{type:"t",value:null,shared:!0},samplerWrapRGB:{type:"t",value:null,shared:!0},samplerNormal:{type:"t",value:null,shared:!0},samplerDepth:{type:"t",value:null,shared:!0},viewSize:{type:"v2",value:new THREE.Vector2(800,600),shared:!0}},multiShadowMaps:{samplerShadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2",value:new THREE.Vector2(512,512)},shadowDarkness:{type:"f",value:.5},shadowBias:{type:"f",value:0},matShadow:{type:"m4v",value:[]}}},THREE.DeferredShaderChunk={gbuffersUniforms:["#ifdef USE_MRT","uniform sampler2D samplerDiffuseRGB;","uniform sampler2D samplerSpecularRGB;","uniform sampler2D samplerWrapRGB;","uniform sampler2D samplerNormal;","uniform sampler2D samplerDepth;","#else","uniform sampler2D samplerColor;","uniform sampler2D samplerNormalDepth;","#endif","uniform vec2 viewSize;"].join("\n"),multiShadowMapsUniforms:["#ifdef USE_SHADOWMAP","uniform mat4 matShadow[ SHADOWMAP_COUNT ];","uniform sampler2D samplerShadowMap[ SHADOWMAP_COUNT ];","uniform float shadowBias;","uniform float shadowDarkness;","uniform vec2 shadowMapSize;","#endif"].join("\n"),packFloat:["const float unit = 255.0/256.0;","float vec3_to_float( vec3 data ) {","highp float compressed = dot( floor( data * 255.0 + 0.5 ), vec3( 1.0, 256.0, 65536.0 ) );","return compressed;","}","float vec21_to_float( float dataHi, float dataLo ) {","highp float compressed = floor( dataHi ) + unit * dataLo;","return compressed;","}","vec3 packWrapAroundShininess( float wrapAround, float shininess ) {","vec3 tmp;","tmp.r = wrapAround + 0.5;","tmp.b = fract( shininess / 256.0 );","tmp.g = floor( shininess / 256.0 ) / 256.0;","return tmp;","}","vec4 packDepth( const in float depth ) {","vec4 enc = vec4( 1.0, 255.0, 65025.0, 160581375.0 ) * depth;","enc = fract( enc );","enc -= enc.yzww * vec4( 1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0 );","return enc;","}"].join("\n"),unpackFloat:["const float unitInverse = 256.0/255.0;","vec3 float_to_vec3( float data ) {","vec3 uncompressed;","uncompressed.z = data / 65536.0;","uncompressed.y = 256.0 * fract( uncompressed.z );","uncompressed.x = 256.0 * fract( uncompressed.y );","return floor( uncompressed ) / 255.0;","}","vec2 float_to_vec21( float data ) {","vec2 uncompressed;","uncompressed.x = floor( data );","uncompressed.y = fract( data ) * unitInverse;","return uncompressed;","}","float unpackDepth( const in vec4 rgba ) {","return clamp( dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) ), 0.0, 1.0 );","}"].join("\n"),computeVertexPositionVS:["vec2 texCoord = gl_FragCoord.xy / viewSize;","#ifdef USE_MRT","#ifdef TEXTURE_DEPTH","vec4 texDepth = texture2D( samplerDepth, texCoord );","float z = texDepth.x * 2.0 - 1.0;","#else","vec4 packedDepth = texture2D( samplerDepth, texCoord );","float z = unpackDepth( packedDepth );","#endif","#else","vec4 normalDepth = texture2D( samplerNormalDepth, texCoord );","float z = normalDepth.w;","#endif","if ( z <= 0.0 || z >= 1.0 ) discard;","vec2 xy = texCoord * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, z, 1.0 );","vec4 vertexPositionVS = matProjInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["#ifdef USE_MRT","vec4 normalTex = texture2D( samplerNormal, texCoord );","vec3 normal = normalTex.xyz * 2.0 - 1.0;","#else","vec3 normal = normalDepth.xyz * 2.0 - 1.0;","#endif","normal = normalize( normal );"].join("\n"),unpackColorMap:["#ifdef USE_MRT","vec4 albedoShininessLo = texture2D( samplerDiffuseRGB, texCoord );","vec3 albedo = albedoShininessLo.rgb * albedoShininessLo.rgb;","vec4 specularColorShininessHi = texture2D( samplerSpecularRGB, texCoord );","vec3 specularColor = specularColorShininessHi.rgb * specularColorShininessHi.rgb;","float shininess = specularColorShininessHi.a * 256.0 * 256.0 + albedoShininessLo.a * 256.0;","vec4 wrapRGBWrapAround = texture2D( samplerWrapRGB, texCoord );","vec3 wrapRGB = wrapRGBWrapAround.rgb;","float wrapAround = sign( wrapRGBWrapAround.a - 0.5 );","float lightMapIntensity = normalTex.a;","#else","vec4 colorMap = texture2D( samplerColor, texCoord );","vec3 albedo = float_to_vec3( abs( colorMap.x ) );","albedo *= albedo;","vec3 specularColor = float_to_vec3( abs( colorMap.y ) );","specularColor *= specularColor;","vec3 wrapRGB = float_to_vec3( abs( colorMap.w ) );","vec2 shininessLightmap = float_to_vec21( abs( colorMap.z ) );","float shininess = shininessLightmap.x;","float lightMapIntensity = shininessLightmap.y;","float wrapAround = sign( colorMap.z );","#endif"].join("\n"),computeDiffuse:["float dotLNUnclamped = dot( lightVector, normal );","float dotLN = max( dotLNUnclamped, 0.0 );","vec3 diffuse = vec3( dotLN );","if ( wrapAround < 0.0 ) {","float dotLNHalf = max( 0.25 * dotLNUnclamped + 0.25, 0.0 );","diffuse = mix( diffuse, vec3( dotLNHalf ), wrapRGB );","}"].join("\n"),geometryFactor:["float SmithGeometryFactor1( vec3 H, vec3 V, vec3 N, float shininess ) {","float dotVN = dot( V, N );","float dotVH = dot( V, H );","if ( ( dotVH / dotVN ) <= 0.0 ) return 0.0;","float f = acos( dotVN );","float a = sqrt( 0.5 * shininess + 1.0 ) / tan( f );","float G = 1.0;","if ( a < 1.6 )","G = ( 3.535 * a + 2.181 * a * a ) / ( 1.0 + 2.276 * a + 2.577 * a * a );","return G;","}","float SmithGeometryFactor2( float dotLN, vec3 V, vec3 N, float shininess ) {","float dotNV = max( dot( N, V ), 0.0 );","float a = 1.0 / ( sqrt( 0.7854 * shininess + 1.571 ) );","return 1.0 / ( ( dotLN * ( 1.0 - a ) + a ) * ( dotNV * ( 1.0 - a ) + a ) );","}","float KelemenGeometryFactor( float dotLH ) {","return 1.0 / ( dotLH * dotLH );","}","float GGX_SchlickGeometryFactor_V1( in float k, in float dotNX ) {","return dotNX / ( dotNX * ( 1.0 - k ) + k );","}","float GGX_SchlickGeometryFactor_V2( in float k, in float dotNX ) {","return 1.0 / ( dotNX + sqrt( k + ( 1.0 - k ) * dotNX * dotNX ) );","}"].join("\n"),environmentBRDF:["vec3 EnvironmentBRDF( float gloss, float dotNV, vec3 rf0 ) {","vec4 t = vec4( 1.0 / 0.96, 0.475, ( 0.0275 - 0.25 * 0.04 ) / 0.96, 0.25 );","t *= vec4( gloss );","t += vec4( 0.0, 0.0, ( 0.015 - 0.75 * 0.04 ) / 0.96, 0.75 );","float a0 = t.x * min( t.y, exp2( -9.28 * dotNV ) ) + t.z;","float a1 = t.w;","return clamp( a0 + rf0 * ( a1 - a0 ), 0.0, 1.0 );","}"].join("\n"),specularBRDF:["float saturate( float x ) {","return clamp( x, 0.0, 1.0 );","}","float GGX_Specular( in float m, in vec3 n, in vec3 h, in vec3 v, in vec3 l ) {","float nDotH = saturate( dot( n, h ) );","float nDotL = saturate( dot( n, l ) );","float nDotV = saturate( dot( n, v ) );","float nDotH2 = nDotH * nDotH;","float m2 = pow( m, 4.0 );","float d = m2 / ( pow( nDotH * nDotH * ( m2 - 1.0 ) + 1.0, 2.0 ) );","float v1i = GGX_SchlickGeometryFactor_V2( m2, nDotL );","float v1o = GGX_SchlickGeometryFactor_V2( m2, nDotV );","float vis = v1i * v1o;","return d * vis;","}","float BlinnPhong_Specular( in float shininess, in float dotLN, in float dotNormalHalf, in vec3 eyeVector, in vec3 normal ) {","float specularNormalization = shininess * 0.125 + 0.25;","float geo = SmithGeometryFactor2( dotLN, eyeVector, normal, shininess );","return ( specularNormalization * geo ) * max( pow( dotNormalHalf, shininess ), 0.0 );","}"].join("\n"),computeSpecular:["vec3 eyeVector = normalize( -vertexPositionVS.xyz );","vec3 halfVector = normalize( lightVector + eyeVector );","float dotNormalHalf = max( dot( normal, halfVector ), 0.0 );","float dotLightHalf = max( dot( lightVector, halfVector ), 0.0 );","vec3 fresnel = specularColor + ( 1.0 - specularColor ) * pow( 1.0 - dotLightHalf, 5.0 );","fresnel *= float( dot( specularColor, vec3( 1.0 ) ) > 0.0 );","#if defined( BRDF_BLINN_PHONG )","vec3 specular = BlinnPhong_Specular( shininess, dotLN, dotNormalHalf, eyeVector, normal ) * ( fresnel * dotLN );","#elif defined( BRDF_GGX )","float roughness = saturate( sqrt( 8.0 / ( shininess + 7.0 ) ) );","vec3 specular = GGX_Specular( roughness, normal, halfVector, eyeVector, lightVector ) * ( fresnel * dotLN );","#else","vec3 specular = specularColor * max( pow( dotNormalHalf, shininess ), 0.0 ) * dotLN;","#endif"].join("\n"),combine:["vec3 light = lightIntensity * lightColor;","gl_FragColor = vec4( light * ( albedo * diffuse + specular ), attenuation );"].join("\n"),directionalOcclusion:["#ifdef OCCLUSION_ENABLED","uniform mat4 matProj;","float checkOcclusion( in vec3 pointVS ) {","vec4 pointCS = matProj * vec4( pointVS, 1.0 );","pointCS.xyz /= pointCS.w;","vec2 pointUV = pointCS.xy * 0.5 + 0.5;","#ifdef USE_MRT","#ifdef TEXTURE_DEPTH","vec4 depthSample = texture2D( samplerDepth, pointUV );","float sampleZ = depthSample.x * 2.0 - 1.0;","#else","vec4 depthSample = texture2D( samplerDepth, pointUV );","float sampleZ = unpackDepth( depthSample );","#endif","#else","vec4 normalDepthSample = texture2D( samplerNormalDepth, pointUV );","float sampleZ = normalDepthSample.w;","#endif","float occlusion = 1.0;","if ( pointCS.z > sampleZ ) occlusion = 0.0;","return occlusion;","}","vec2 rand( const in vec2 coord ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 25.9796, 156.466 ) );","vec2 noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","return noise;","}","#endif"].join("\n"),shadowMapPCF:["float sampleShadowPCF( sampler2D shadowMap, vec2 shadowMapSize, vec2 shadowCoord, float vertexDepth ) {","float shadowDepth;","float shadowValue = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx0, dy0 ) ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( 0.0, dy0 ) ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx1, dy0 ) ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx0, 0.0 ) ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx1, 0.0 ) ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx0, dy1 ) ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( 0.0, dy1 ) ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx1, dy1 ) ).x;","shadowValue += shadowDelta * float( vertexDepth > shadowDepth );","return shadowValue;","}"].join("\n"),shadowMapPCFSoft:["float sampleShadowPCFSoft( sampler2D shadowMap, vec2 shadowMapSize, vec2 shadowCoord, float vertexDepth ) {","float shadowDepth;","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx0, dy0 ) ).x;","shadowKernel[0][0] = float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx0, 0.0 ) ).x;","shadowKernel[0][1] = float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx0, dy1 ) ).x;","shadowKernel[0][2] = float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( 0.0, dy0 ) ).x;","shadowKernel[1][0] = float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord ).x;","shadowKernel[1][1] = float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( 0.0, dy1 ) ).x;","shadowKernel[1][2] = float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx1, dy0 ) ).x;","shadowKernel[2][0] = float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx1, 0.0 ) ).x;","shadowKernel[2][1] = float( vertexDepth > shadowDepth );","shadowDepth = texture2D( shadowMap, shadowCoord + vec2( dx1, dy1 ) ).x;","shadowKernel[2][2] = float( vertexDepth > shadowDepth );","shadowKernel *= 0.25;","vec2 fractionalCoord = 1.0 - fract( shadowCoord * shadowMapSize );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","float shadowValue = dot( shadowValues, vec4( 1.0 ) );","return shadowValue;","}"].join("\n"),normalsParsFragment:["#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","#extension GL_OES_standard_derivatives : enable\n","varying vec3 vViewPosition;","#endif",THREE.ShaderChunk.bumpmap_pars_fragment,THREE.ShaderChunk.normalmap_pars_fragment,"varying vec3 normalView;"].join("\n"),normalsFragment:["#if defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","normal = perturbNormal2Arb( -vViewPosition, normal, normalGloss.xyz, uvCoord );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd( uvCoord ) );","#endif","#ifdef DOUBLE_SIDED","float flipNormal = 2.0 * float( gl_FrontFacing ) - 1.0;","normal = flipNormal * normal;","#endif","normal = normal * 0.5 + 0.5;"].join("\n"),colorsFragment:["float shininess = specular.a;","float wrapAround = diffuse.a;","vec4 diffuseColor  = vec4( diffuse.rgb, 1.0 );","vec4 specularColor = vec4( specular.rgb, 1.0 );","#ifdef USE_MAP","#ifdef PARTICLE","vec2 texCoord = vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y );","#else","vec2 texCoord = uvCoord;","#endif","vec4 diffuseMapColor = texture2D( map, texCoord );","diffuseColor *= diffuseMapColor;","#endif","#ifdef ALPHATEST","if ( diffuseColor.a < ALPHATEST ) discard;","#endif","#ifdef USE_COLOR","diffuseColor.rgb *= vColor;","#endif",THREE.ShaderChunk.specularmap_fragment,"specularColor.rgb *= specularMapColor;","#ifdef USE_LIGHTMAP","float lightMapIntensity = texture2D( lightMap, uvCoord ).r;","#else","float lightMapIntensity = 1.0;","#endif","#if defined( USE_GLOSSMAP )","vec4 glossMapVal = texture2D( glossMap, uvCoord );","float gloss = exp2( 13.0 * glossMapVal.r + 1.0 );","#elif defined( USE_NORMALGLOSSMAP )","float gloss = exp2( 13.0 * normalGloss.a + 1.0 );","#else","float gloss = 1.0;","#endif","shininess = clamp( shininess * gloss, 0.0, 8192.0 );"].join("\n"),hemiTerm:["const float maxShininess = 8192.0;","float gloss = min( shininess / maxShininess, 1.0 );","vec3 fresnelHemi = EnvironmentBRDF( gloss, dot( eyeVector, halfVector ), specularColor );","float dotProductHemi = dot( normal, lightVectorHemi );","float hemiDiffuseWeight = clamp( 0.5 * dotProductHemi + 0.5, 0.0, 1.0 );","vec3 diffuseHemi = ( 1.0 - fresnelHemi ) * mix( lightColorGround, lightColorSky, hemiDiffuseWeight );","vec3 R = reflect( -eyeVector, normal );","R = normalize( R );","float hemiSpecularWeight = clamp( dot( R, lightVectorHemi ) * 0.5 + 0.5, 0.0, 1.0 );","vec3 specularHemi = fresnelHemi * mix( lightColorGround, lightColorSky, hemiSpecularWeight );","vec3 hemiTerm = lightIntensityHemi * ( albedo * diffuseHemi + specularHemi );","hemiTerm *= lightMapIntensity;","#ifdef USE_SSAO","float hemiOcclusion = texture2D( samplerSSAO, texCoord ).x;","hemiTerm *= hemiOcclusion * hemiOcclusion;","#endif"].join("\n")},THREE.DeferredShaderChunk.shadowPrep=["float sectorOcclusion = 1.0;","vec4 posLightCS = matShadow[ i ] * vertexPositionVS;","vec2 shadowCoord = ( posLightCS.xy / posLightCS.w ) * 0.5 + 0.5;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );"].join("\n"),THREE.DeferredShaderChunk.shadowCheck=["float vertexDepth = posLightCS.z / posLightCS.w;","#if defined( DEPTH_TEXTURES )","vertexDepth = vertexDepth * 0.5 + 0.5;","#endif","#if !defined( SLOPE_DEPTH_BIAS )","vertexDepth -= shadowBias;","#endif","#if defined( SHADOWMAP_TYPE_PCF )","float shadowValue = sampleShadowPCF( samplerShadowMap[ i ], shadowMapSize, shadowCoord, vertexDepth );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadowValue = sampleShadowPCFSoft( samplerShadowMap[ i ], shadowMapSize, shadowCoord, vertexDepth );","#else","float shadowDepth = texture2D( samplerShadowMap[ i ], shadowCoord ).x;","float shadowValue = float( vertexDepth > shadowDepth );","#endif","sectorOcclusion = 1.0 - shadowDarkness * shadowValue;","occlusion *= sectorOcclusion;"].join("\n"),THREE.DeferredShaderChunk.directionalShadows=["float occlusion = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[5];","frustumColors[0] = vec3( 1.0, 0.0, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.0 );","frustumColors[2] = vec3( 0.0, 0.0, 1.0 );","frustumColors[3] = vec3( 0.0, 0.5, 1.0 );","frustumColors[4] = vec3( 0.2, 0.5, 1.0 );","vec3 debugColor = vec3( 1.0 );","#endif","#ifdef OSX_HACK","bool found = false;","#endif","for ( int i = 0; i < SHADOWMAP_COUNT; i ++ ) {",THREE.DeferredShaderChunk.shadowPrep,"#ifdef OSX_HACK","if ( inFrustum && !found ) {","#else","if ( inFrustum ) {","#endif",THREE.DeferredShaderChunk.shadowCheck,"#ifdef SHADOWMAP_DEBUG","debugColor *= frustumColors[ i ];","#endif","#if SHADOWMAP_COUNT > 1","#ifdef OSX_HACK","found = true;","#else","break;","#endif","#endif","}","}","#endif"].join("\n"),THREE.DeferredShaders={combined:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.particle,{diffuse:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specular:{type:"v4",value:new THREE.Vector4(.1,.1,.1,30)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)},bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1},normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)},glossMap:{type:"t",value:null},specularMap:{type:"t",value:null},parallaxScale:{type:"f",value:1}}]),fragmentShader:["#extension GL_EXT_draw_buffers : require\n","uniform vec4 diffuse;","uniform vec4 specular;","uniform vec3 wrapRGB;","#ifndef TEXTURE_DEPTH","varying vec4 clipPos;","#endif",THREE.DeferredShaderChunk.normalsParsFragment,THREE.DeferredShaderChunk.packFloat,THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,THREE.ShaderChunk.glossmap_pars_fragment,THREE.ShaderChunk.parallax_pars_fragment,"void main() {","#if !defined( PARTICLE ) && ( defined( USE_MAP ) || defined( USE_LIGHTMAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined ( USE_NORMALGLOSSMAP ) || defined ( USE_GLOSSMAP ) || defined( USE_SPECULARMAP ) )","vec2 uvCoord = vUv;","#endif","vec3 normal = normalize( normalView );","#if defined( USE_BUMPMAP ) && defined( USE_PARALLAX )","vec3 viewPosition = normalize( vViewPosition );","#endif",THREE.ShaderChunk.parallax_fragment,"#if defined( USE_NORMALGLOSSMAP ) || defined( USE_NORMALMAP )","vec4 normalGloss = texture2D( normalMap, uvCoord );","#endif",THREE.DeferredShaderChunk.normalsFragment,THREE.DeferredShaderChunk.colorsFragment,"float shininessLo = fract( shininess / 256.0 );","float shininessHi = floor( shininess / 256.0 ) / 256.0;","gl_FragData[ 0 ] = vec4( diffuseColor.rgb, shininessLo );","gl_FragData[ 1 ] = vec4( specularColor.rgb, shininessHi );","gl_FragData[ 2 ] = vec4( wrapRGB.rgb, wrapAround + 0.5 );","gl_FragData[ 3 ] = vec4( normal.xyz, lightMapIntensity );","#ifndef TEXTURE_DEPTH","gl_FragData[ 4 ] = vec4( packDepth( clipPos.z / clipPos.w ) );","#endif","}"].join("\n"),vertexShader:[THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.particle_pars_vertex,"#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","varying vec3 vViewPosition;","#endif","varying vec3 normalView;","#ifndef TEXTURE_DEPTH","varying vec4 clipPos;","#endif","void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.particle_vertex,"normalView = normalize( normalMatrix * objectNormal );","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","vViewPosition = -mvPosition.xyz;","#endif","#ifdef USE_COLOR","vColor = color;","#endif","#ifndef TEXTURE_DEPTH","clipPos = gl_Position;","#endif","}"].join("\n")},color:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.particle,{diffuse:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specular:{type:"v4",value:new THREE.Vector4(.1,.1,.1,30)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)},glossMap:{type:"t",value:null},specularMap:{type:"t",value:null},normalMap:{type:"t",value:null},bumpMap:{type:"t",value:null},samplerNormalDepth:{type:"t",value:null,shared:!0},viewSize:{type:"v2",value:new THREE.Vector2(800,600),shared:!0},parallaxScale:{type:"f",value:1}}]),fragmentShader:["uniform vec4 diffuse;","uniform vec4 specular;","uniform vec3 wrapRGB;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,"#ifdef USE_NORMALGLOSSMAP","uniform sampler2D normalMap;","#endif","#if defined( USE_PARALLAX ) && defined( USE_BUMPMAP )","#extension GL_OES_standard_derivatives : enable\n","uniform sampler2D bumpMap;","varying vec3 normalView;","varying vec3 vViewPosition;","#endif",THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.glossmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,THREE.ShaderChunk.parallax_pars_fragment,THREE.DeferredShaderChunk.packFloat,"void main() {","#if !defined( PARTICLE ) && ( defined( USE_MAP ) || defined( USE_LIGHTMAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined ( USE_NORMALGLOSSMAP ) || defined ( USE_GLOSSMAP ) || defined( USE_SPECULARMAP ) )","vec2 uvCoord = vUv;","#endif","#if defined( USE_PARALLAX ) && defined( USE_BUMPMAP )","vec3 normal = normalize( normalView );","vec3 viewPosition = normalize( vViewPosition );","#endif",THREE.ShaderChunk.parallax_fragment,"#ifdef USE_NORMALGLOSSMAP","vec4 normalGloss = texture2D( normalMap, uvCoord );","#endif",THREE.DeferredShaderChunk.colorsFragment,"float compressedDiffuse = vec3_to_float( diffuseColor.rgb );","float compressedSpecular = vec3_to_float( specularColor.rgb );","float compressedWrapRGB = vec3_to_float( wrapRGB.rgb );","float wrapAroundShininessOcclusion = wrapAround * vec21_to_float( shininess, lightMapIntensity );","gl_FragColor = vec4( compressedDiffuse, compressedSpecular, wrapAroundShininessOcclusion, compressedWrapRGB );","}"].join("\n"),vertexShader:[THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.particle_pars_vertex,"#if defined( USE_PARALLAX ) && defined( USE_BUMPMAP )","varying vec3 normalView;","varying vec3 vViewPosition;","#endif","void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.particle_vertex,"#if defined( USE_PARALLAX ) && defined( USE_BUMPMAP )","normalView = normalize( normalMatrix * objectNormal );","vViewPosition = -mvPosition.xyz;","#endif","#ifdef USE_COLOR","vColor = color;","#endif","}"].join("\n")},normalDepth:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.particle,{alphaMap:{type:"t",value:null},bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1},normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},parallaxScale:{type:"f",value:1}}]),fragmentShader:["#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP ) || defined( ALPHATEST )","varying vec2 vUv;","#endif","#ifdef ALPHATEST","uniform sampler2D alphaMap;","#endif",THREE.DeferredShaderChunk.normalsParsFragment,THREE.ShaderChunk.parallax_pars_fragment,"varying vec4 clipPos;","void main() {","#if !defined( PARTICLE ) && ( defined( USE_MAP ) || defined( USE_LIGHTMAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined ( USE_NORMALGLOSSMAP ) || defined ( USE_GLOSSMAP ) || defined( USE_SPECULARMAP ) || defined( ALPHATEST ) )","vec2 uvCoord = vUv;","#endif","vec3 normal = normalize( normalView );","#if defined( USE_BUMPMAP ) && defined( USE_PARALLAX )","vec3 viewPosition = normalize( vViewPosition );","#endif",THREE.ShaderChunk.parallax_fragment,"#ifdef ALPHATEST","vec2 textureCoord;","#ifdef PARTICLE","textureCoord = vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y );","#else","textureCoord = uvCoord;","#endif","float alphaValue = texture2D( alphaMap, textureCoord ).a;","if ( alphaValue < ALPHATEST ) discard;","#endif","#if defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","vec4 normalGloss = texture2D( normalMap, uvCoord );","#endif",THREE.DeferredShaderChunk.normalsFragment,"gl_FragColor = vec4( normal, clipPos.z / clipPos.w );","}"].join("\n"),vertexShader:["varying vec3 normalView;","varying vec4 clipPos;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP ) || defined( ALPHATEST )","varying vec2 vUv;","uniform vec4 offsetRepeat;","#endif","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","varying vec3 vViewPosition;","#endif",THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.particle_pars_vertex,"void main() {",THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.particle_vertex,"normalView = normalize( normalMatrix * objectNormal );","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP ) || defined( ALPHATEST )","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","#endif","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_NORMALGLOSSMAP )","vViewPosition = -mvPosition.xyz;","#endif","clipPos = gl_Position;","}"].join("\n")},depth:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.particle,{slopeScale:{type:"f",value:2,shared:!0},slopeBias:{type:"f",value:0,shared:!0},slopeMax:{type:"f",value:.001,shared:!0},alphaMap:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)}}]),fragmentShader:["#ifdef ALPHATEST","uniform sampler2D alphaMap;","varying vec2 vUv;","#endif","#ifndef DEPTH_TEXTURES","#ifdef SLOPE_DEPTH_BIAS","#extension GL_OES_standard_derivatives : enable\n","uniform float slopeScale;","uniform float slopeBias;","uniform float slopeMax;","#endif","varying vec4 clipPos;","#endif","void main() {","#ifdef ALPHATEST","float alphaValue = texture2D( alphaMap, vUv ).a;","if ( alphaValue < ALPHATEST ) discard;","#endif","#ifndef DEPTH_TEXTURES","float depth = clipPos.z / clipPos.w;","#ifdef SLOPE_DEPTH_BIAS","float dx = dFdx( depth );","float dy = dFdy( depth );","float m = max( abs(dx), abs(dy) );","m = min( m, slopeMax );","gl_FragColor.x = depth + m * slopeScale + slopeBias;","#else","gl_FragColor.x = depth;","#endif","#endif","}"].join("\n"),vertexShader:["#ifdef ALPHATEST","varying vec2 vUv;","uniform vec4 offsetRepeat;","#endif","#ifndef DEPTH_TEXTURES","varying vec4 clipPos;","#endif",THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.particle_pars_vertex,"void main() {",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.particle_vertex,"#ifndef DEPTH_TEXTURES","clipPos = gl_Position;","#endif","#ifdef ALPHATEST","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","#endif","}"].join("\n")},pointLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,THREE.DeferredUniformsLib.multiShadowMaps,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightPositionVS:{type:"v3",value:new THREE.Vector3(0,0,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},lightDistance:{type:"f",value:1}}]),fragmentShader:["uniform float lightDistance;","uniform float lightIntensity;","uniform vec3 lightColor;","uniform vec3 lightPositionVS;","uniform mat4 matProjInverse;",THREE.DeferredShaderChunk.multiShadowMapsUniforms,THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.shadowMapPCF,THREE.DeferredShaderChunk.shadowMapPCFSoft,THREE.DeferredShaderChunk.geometryFactor,THREE.DeferredShaderChunk.specularBRDF,"void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,"vec3 lightVector = lightPositionVS - vertexPositionVS.xyz;","float distance = length( lightVector );","if ( distance > lightDistance ) discard;",THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"lightVector = normalize( lightVector );",THREE.DeferredShaderChunk.computeDiffuse,THREE.DeferredShaderChunk.computeSpecular,"diffuse -= diffuse * fresnel;","const float cutoff = 0.3;","float denom = distance / lightDistance + 1.0;","float attenuation = 1.0 / ( denom * denom );","attenuation = ( attenuation - cutoff ) / ( 1.0 - cutoff );","attenuation = max( attenuation, 0.0 );","attenuation *= attenuation;","float occlusion = 1.0;","#ifdef USE_SHADOWMAP","for ( int i = 0; i < SHADOWMAP_COUNT; i ++ ) {",THREE.DeferredShaderChunk.shadowPrep,"if ( inFrustum && posLightCS.z >= 0.0 ) {",THREE.DeferredShaderChunk.shadowCheck,"#ifndef OSX_HACK","break;","#endif","}","}","#endif","attenuation *= occlusion;",THREE.DeferredShaderChunk.combine,"}"].join("\n"),vertexShader:["void main() { ","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n")},sphereLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,THREE.DeferredUniformsLib.multiShadowMaps,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightPositionVS:{type:"v3",value:new THREE.Vector3(0,0,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},lightDistance:{type:"f",value:1},lightRadius:{type:"f",value:1}}]),fragmentShader:["uniform float lightRadius;","uniform float lightDistance;","uniform float lightIntensity;","uniform vec3 lightColor;","uniform vec3 lightPositionVS;","uniform mat4 matProjInverse;",THREE.DeferredShaderChunk.multiShadowMapsUniforms,THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.shadowMapPCF,THREE.DeferredShaderChunk.shadowMapPCFSoft,THREE.DeferredShaderChunk.geometryFactor,THREE.DeferredShaderChunk.specularBRDF,"void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,"vec3 lightVectorFull = lightPositionVS - vertexPositionVS.xyz;","float distance = length( lightVectorFull );","if ( distance > lightDistance ) discard;",THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"vec3 lightVector = normalize( lightVectorFull );",THREE.DeferredShaderChunk.computeDiffuse,"diffuse *= 0.3183;","vec3 eye = normalize( -vertexPositionVS.xyz );","vec3 reflectVS = reflect( eye, normal );","vec3 centerToRay = lightVectorFull - dot( lightVectorFull, reflectVS ) * reflectVS;","vec3 closestPoint = lightVectorFull - centerToRay * saturate( lightRadius / length( centerToRay ) );","lightVector = normalize( closestPoint );","dotLN = max( dot( lightVector, normal ), 0.0 );",THREE.DeferredShaderChunk.computeSpecular,"float alpha = roughness * roughness;","float alphaPrime = saturate( alpha + lightRadius / ( 3.0 * distance ) );","float sphereNormalization = alphaPrime * alphaPrime;","specular *= sphereNormalization;","diffuse -= diffuse * fresnel;","const float cutoff = 0.3;","float denom = distance / lightDistance + 1.0;","float attenuation = 1.0 / ( denom * denom );","attenuation = ( attenuation - cutoff ) / ( 1.0 - cutoff );","attenuation = max( attenuation, 0.0 );","attenuation *= attenuation;","float occlusion = 1.0;","#ifdef USE_SHADOWMAP","for ( int i = 0; i < SHADOWMAP_COUNT; i ++ ) {",THREE.DeferredShaderChunk.shadowPrep,"if ( inFrustum && posLightCS.z >= 0.0 ) {",THREE.DeferredShaderChunk.shadowCheck,"#ifndef OSX_HACK","break;","#endif","}","}","#endif","attenuation *= occlusion;",THREE.DeferredShaderChunk.combine,"}"].join("\n"),vertexShader:["void main() { ","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n")},tubeLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,{matProj:{type:"m4",value:new THREE.Matrix4,shared:!0},matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightPosition0VS:{type:"v3",value:new THREE.Vector3(0,-1,0)},lightPosition1VS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},lightDistance:{type:"f",value:1},lightRadius:{type:"f",value:1}}]),fragmentShader:["uniform float lightRadius;","uniform float lightDistance;","uniform float lightIntensity;","uniform vec3 lightColor;","uniform vec3 lightPosition0VS;","uniform vec3 lightPosition1VS;","uniform mat4 matProjInverse;",THREE.DeferredShaderChunk.multiShadowMapsUniforms,THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.geometryFactor,THREE.DeferredShaderChunk.specularBRDF,THREE.DeferredShaderChunk.directionalOcclusion,"void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"vec3 lightVector0 = lightPosition0VS - vertexPositionVS.xyz;","vec3 lightVector1 = lightPosition1VS - vertexPositionVS.xyz;","float length0 = length( lightVector0 );","float length1 = length( lightVector1 );","float a = 2.0 * saturate( dot( normal, lightVector0 ) / ( 2.0 * length0 ) + dot( normal, lightVector1 ) / ( 2.0 * length1 ) );","float b = length0 * length1 + dot( lightVector0, lightVector1 ) + 2.0;","float dotLN = a / b;","vec3 diffuse = vec3( dotLN ) * 0.3183;","vec3 eye = normalize( -vertexPositionVS.xyz );","vec3 reflectVS = reflect( eye, normal );","vec3 lightVectorD = lightVector1 - lightVector0;","float lengthD = length( lightVectorD );","float dotRD = dot( reflectVS, lightVectorD );","float ta = dot( reflectVS, lightVector0 ) * dotRD - dot( lightVector0, lightVectorD );","float tb = lengthD * lengthD - dotRD * dotRD;","float t = ta / tb;","vec3 closestPoint = lightVector0 + saturate( t ) * lightVectorD;","vec3 lightVectorClosest = closestPoint;","vec3 centerToRay = lightVectorClosest - dot( lightVectorClosest, reflectVS ) * reflectVS;","closestPoint = lightVectorClosest - centerToRay * saturate( lightRadius / length( centerToRay ) );","vec3 lightVector = normalize( closestPoint );",THREE.DeferredShaderChunk.computeSpecular,"float distance = length( closestPoint );","float alpha = roughness * roughness;","float alphaPrime = saturate( alpha + lightRadius / ( 3.0 * distance ) );","float normalization = alphaPrime * alphaPrime;","specular *= normalization;","diffuse -= diffuse * fresnel;","#ifdef OCCLUSION_ENABLED","const float occlusionScale = 0.9;","vec2 r = rand( texCoord ) + 0.1;","float occlusionDistanceC = occlusionScale * r.x;","float occlusionDistance0 = occlusionScale * r.y;","float occlusionDistance1 = occlusionScale * rand( texCoord + 0.01 ).y + 0.1;","float occlusionC = checkOcclusion( vertexPositionVS.xyz + occlusionDistanceC * lightVector );","float occlusion0 = checkOcclusion( vertexPositionVS.xyz + occlusionDistance0 * lightVector0 / length0 );","float occlusion1 = checkOcclusion( vertexPositionVS.xyz + occlusionDistance1 * lightVector1 / length1 );","float occlusion = ( 0.5 * occlusionC + 0.25 * occlusion0 + 0.25 * occlusion1 );","#else","float occlusion = 1.0;","#endif","const float cutoff = 0.3;","float denom = distance / lightDistance + 1.0;","float attenuation = 1.0 / ( denom * denom );","attenuation = ( attenuation - cutoff ) / ( 1.0 - cutoff );","attenuation = max( attenuation, 0.0 );","attenuation *= occlusion;",THREE.DeferredShaderChunk.combine,"}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},spotLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightPositionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightDirectionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},lightDistance:{type:"f",value:1},lightAngleCos:{type:"f",value:1},matShadow:{type:"m4",value:new THREE.Matrix4},samplerShadowMap:{type:"t",value:null},shadowMapSize:{type:"v2",value:new THREE.Vector2(512,512)},shadowDarkness:{type:"f",value:.5},shadowBias:{type:"f",value:0},matTexture:{type:"m4",value:new THREE.Matrix4},samplerTexture:{type:"t",value:null}}]),fragmentShader:["uniform vec3 lightPositionVS;","uniform vec3 lightDirectionVS;","uniform vec3 lightColor;","uniform float lightIntensity;","uniform float lightAngleCos;","uniform mat4 matProjInverse;","#ifdef USE_SHADOWMAP","uniform mat4 matShadow;","uniform sampler2D samplerShadowMap;","uniform float shadowBias;","uniform float shadowDarkness;","uniform vec2 shadowMapSize;","#endif","#ifdef SPOT_TEXTURE","uniform mat4 matTexture;","uniform sampler2D samplerTexture;","#endif",THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.shadowMapPCF,THREE.DeferredShaderChunk.shadowMapPCFSoft,THREE.DeferredShaderChunk.geometryFactor,THREE.DeferredShaderChunk.specularBRDF,"void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"vec3 lightVector = normalize( lightPositionVS.xyz - vertexPositionVS.xyz );","float rho = dot( lightDirectionVS, lightVector );","if ( rho <= lightAngleCos ) discard;","float theta = lightAngleCos + 0.0001;","float phi = lightAngleCos + 0.05;","const float falloff = 4.0;","float spot = 0.0;","if ( rho >= phi ) {","spot = 1.0;","} else if ( rho <= theta ) {","spot = 0.0;","} else { ","spot = pow( ( rho - theta ) / ( phi - theta ), falloff );","}",THREE.DeferredShaderChunk.computeDiffuse,THREE.DeferredShaderChunk.computeSpecular,"diffuse *= spot;","specular *= spot;","diffuse -= diffuse * fresnel;","#ifdef SPOT_TEXTURE","vec4 posTextureCS = matTexture * vertexPositionVS;","vec4 textureColor = texture2DProj( samplerTexture, posTextureCS );","textureColor.xyz *= textureColor.xyz;","diffuse *= textureColor.xyz;","specular *= textureColor.xyz;","#endif","float occlusion = 1.0;","#ifdef USE_SHADOWMAP","vec4 posLightCS = matShadow * vertexPositionVS;","vec2 shadowCoord = ( posLightCS.xy / posLightCS.w ) * 0.5 + 0.5;","float vertexDepth = posLightCS.z / posLightCS.w;","#if defined( DEPTH_TEXTURES )","vertexDepth = vertexDepth * 0.5 + 0.5;","#endif","#if !defined( SLOPE_DEPTH_BIAS )","vertexDepth -= shadowBias;","#endif","#if defined( SHADOWMAP_TYPE_PCF )","float shadowValue = sampleShadowPCF( samplerShadowMap, shadowMapSize, shadowCoord, vertexDepth );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadowValue = sampleShadowPCFSoft( samplerShadowMap, shadowMapSize, shadowCoord, vertexDepth );","#else","float shadowDepth = texture2D( samplerShadowMap, shadowCoord ).x;","float shadowValue = float( vertexDepth > shadowDepth );","#endif","occlusion = 1.0 - shadowDarkness * shadowValue;","#endif","float attenuation = occlusion;",THREE.DeferredShaderChunk.combine,"}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},directionalLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,THREE.DeferredUniformsLib.multiShadowMaps,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightDirectionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1}}]),fragmentShader:["uniform float lightIntensity;","uniform vec3 lightColor;","uniform vec3 lightDirectionVS;","uniform mat4 matProjInverse;",THREE.DeferredShaderChunk.multiShadowMapsUniforms,THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.shadowMapPCF,THREE.DeferredShaderChunk.shadowMapPCFSoft,THREE.DeferredShaderChunk.geometryFactor,THREE.DeferredShaderChunk.specularBRDF,"void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"vec3 lightVector = lightDirectionVS;",THREE.DeferredShaderChunk.computeDiffuse,THREE.DeferredShaderChunk.computeSpecular,THREE.DeferredShaderChunk.directionalShadows,"diffuse -= diffuse * fresnel;","float attenuation = occlusion;",THREE.DeferredShaderChunk.combine,"#ifdef SHADOWMAP_DEBUG","gl_FragColor.xyz *= debugColor;","#endif","}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},hemisphereLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightDirectionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColorSky:{type:"c",value:new THREE.Color(0)},lightColorGround:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},samplerSSAO:{type:"t",value:null}}]),fragmentShader:["uniform float lightIntensity;","uniform vec3 lightColorSky;","uniform vec3 lightColorGround;","uniform vec3 lightDirectionVS;","uniform mat4 matProjInverse;","#ifdef USE_SSAO","uniform sampler2D samplerSSAO;","#endif",THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.environmentBRDF,"void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"vec3 lightVectorHemi = lightDirectionVS;","float lightIntensityHemi = lightIntensity;","vec3 eyeVector = normalize( -vertexPositionVS.xyz );","vec3 halfVector = normalize( lightVectorHemi + eyeVector );",THREE.DeferredShaderChunk.hemiTerm,"gl_FragColor = vec4( hemiTerm, 1.0 );","}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},dayLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,THREE.DeferredUniformsLib.multiShadowMaps,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightDirectionVSSun:{type:"v3",value:new THREE.Vector3(0,1,0)},lightDirectionVSHemi:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColorSun:{type:"c",value:new THREE.Color(0)},lightColorSky:{type:"c",value:new THREE.Color(0)},lightColorGround:{type:"c",value:new THREE.Color(0)},lightIntensitySun:{type:"f",value:1},lightIntensityHemi:{type:"f",value:1},samplerSSAO:{type:"t",value:null}}]),fragmentShader:["uniform float lightIntensitySun;","uniform float lightIntensityHemi;","uniform vec3 lightColorSun;","uniform vec3 lightColorSky;","uniform vec3 lightColorGround;","uniform vec3 lightDirectionVSSun;","uniform vec3 lightDirectionVSHemi;","uniform mat4 matProjInverse;","#ifdef USE_SSAO","uniform sampler2D samplerSSAO;","#endif",THREE.DeferredShaderChunk.multiShadowMapsUniforms,THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.shadowMapPCF,THREE.DeferredShaderChunk.shadowMapPCFSoft,THREE.DeferredShaderChunk.geometryFactor,THREE.DeferredShaderChunk.specularBRDF,THREE.DeferredShaderChunk.environmentBRDF,"void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"vec3 lightVector = lightDirectionVSSun;",THREE.DeferredShaderChunk.computeDiffuse,THREE.DeferredShaderChunk.computeSpecular,THREE.DeferredShaderChunk.directionalShadows,"diffuse -= diffuse * fresnel;","vec3 directionalTerm = ( occlusion * lightIntensitySun ) * lightColorSun * ( albedo * diffuse + specular );","vec3 lightVectorHemi = lightDirectionVSHemi;",THREE.DeferredShaderChunk.hemiTerm,"gl_FragColor = vec4( directionalTerm + hemiTerm, 1.0 );","#ifdef SHADOWMAP_DEBUG","gl_FragColor.xyz *= debugColor;","#endif","}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},dayLightCube:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,THREE.DeferredUniformsLib.multiShadowMaps,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightDirectionVSSun:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColorSun:{type:"c",value:new THREE.Color(0)},lightIntensitySun:{type:"f",value:1},lightIntensityAmbient:{type:"f",value:1},matViewInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},samplerSpecular:{type:"t",value:null},samplerDiffuse:{type:"t",value:null},samplerSSAO:{type:"t",value:null},maxMipSpecular:{type:"f",value:7}}]),fragmentShader:["uniform float lightIntensitySun;","uniform float lightIntensityAmbient;","uniform vec3 lightColorSun;","uniform vec3 lightDirectionVSSun;","uniform mat4 matProjInverse;","uniform mat4 matViewInverse;","uniform samplerCube samplerSpecular;","uniform samplerCube samplerDiffuse;","#ifdef USE_SSAO","uniform sampler2D samplerSSAO;","#endif","#ifdef SPECULAR_MIP_FIX","#extension GL_OES_standard_derivatives : enable\n","#endif","uniform float maxMipSpecular;",THREE.DeferredShaderChunk.multiShadowMapsUniforms,THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.shadowMapPCF,THREE.DeferredShaderChunk.shadowMapPCFSoft,THREE.DeferredShaderChunk.geometryFactor,THREE.DeferredShaderChunk.specularBRDF,THREE.DeferredShaderChunk.environmentBRDF,"void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"vec3 lightVector = lightDirectionVSSun;",THREE.DeferredShaderChunk.computeDiffuse,THREE.DeferredShaderChunk.computeSpecular,THREE.DeferredShaderChunk.directionalShadows,"diffuse -= diffuse * fresnel;","vec3 directionalTerm = ( occlusion * lightIntensitySun ) * lightColorSun * ( albedo * diffuse + specular );","float gloss = shininess / 8192.0;","vec3 reflectVS = reflect( -eyeVector, normal );","vec4 reflectWS = matViewInverse * vec4( reflectVS, 0.0 );","vec3 cubeCoord = reflectWS.xyz;","const float mipUnit = 255.0 / 16.0;","#ifdef SPECULAR_MIP_FIX","float curvature = length( fwidth( cubeCoord.xyz ) );","float mipLevelMinification = mipUnit * textureCube( samplerSpecular, cubeCoord, -curvature ).a;","float mipLevelMagnification = mipUnit * textureCube( samplerSpecular, cubeCoord, maxMipSpecular - 1.0 - curvature ).a;","#else","const float curvature = 0.0;","float mipLevelMinification = mipUnit * textureCube( samplerSpecular, cubeCoord ).a;","float mipLevelMagnification = mipUnit * textureCube( samplerSpecular, cubeCoord, maxMipSpecular - 1.0 ).a;","#endif","float mipLevel;","if ( mipLevelMinification == 0.0 ) {","mipLevel = mipLevelMagnification - ( maxMipSpecular - 1.0 );","} else {","mipLevel = mipLevelMinification;","}","float maxMipDownscale = ( maxMipSpecular - 2.0 );","float mipBias = max( ( maxMipDownscale * ( 1.0 - gloss ) ) - mipLevel, 0.0 );","mipBias -= curvature;","vec3 cubeColorSpecular = textureCube( samplerSpecular, cubeCoord, mipBias ).xyz;","cubeColorSpecular *= cubeColorSpecular;","vec4 normalWS = matViewInverse * vec4( normal, 0.0 );","vec3 cubeColorDiffuse = textureCube( samplerDiffuse, normalWS.xyz ).xyz;","cubeColorDiffuse *= cubeColorDiffuse;","vec3 fresnelEnv = EnvironmentBRDF( gloss, dot( eyeVector, normal ), specularColor );","vec3 imageDiffuse = ( 1.0 - fresnelEnv ) * cubeColorDiffuse;","vec3 imageSpecular = fresnelEnv * cubeColorSpecular;","#ifdef USE_SSAO","float occlusionAmbient = texture2D( samplerSSAO, texCoord ).x;","#else","float occlusionAmbient = 1.0;","#endif","vec3 imageTerm = lightIntensityAmbient * ( albedo * imageDiffuse + imageSpecular ) * occlusionAmbient * occlusionAmbient * lightMapIntensity;","gl_FragColor = vec4( directionalTerm + imageTerm, 1.0 );","#ifdef SHADOWMAP_DEBUG","gl_FragColor.xyz *= debugColor;","#endif","}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},areaLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},lightPositionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightNormalVS:{type:"v3",value:new THREE.Vector3(0,-1,0)},lightRightVS:{type:"v3",value:new THREE.Vector3(1,0,0)},lightUpVS:{type:"v3",value:new THREE.Vector3(1,0,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},lightWidth:{type:"f",value:1},lightHeight:{type:"f",value:1},constantAttenuation:{type:"f",value:1.5},linearAttenuation:{type:"f",value:.5},quadraticAttenuation:{type:"f",value:.1},samplerTexture:{type:"t",value:null},matShadow:{type:"m4",value:new THREE.Matrix4},samplerShadowMap:{type:"t",value:null},shadowMapSize:{type:"v2",value:new THREE.Vector2(512,512)},shadowDarkness:{type:"f",value:.5},shadowBias:{type:"f",value:0}}]),fragmentShader:["uniform vec3 lightPositionVS;","uniform vec3 lightNormalVS;","uniform vec3 lightRightVS;","uniform vec3 lightUpVS;","#ifdef AREA_TEXTURE","uniform sampler2D samplerTexture;","#endif","uniform float lightWidth;","uniform float lightHeight;","uniform float constantAttenuation;","uniform float linearAttenuation;","uniform float quadraticAttenuation;","uniform float lightIntensity;","uniform vec3 lightColor;","uniform mat4 matProjInverse;","#ifdef USE_SHADOWMAP","uniform mat4 matShadow;","uniform sampler2D samplerShadowMap;","uniform float shadowBias;","uniform float shadowDarkness;","uniform vec2 shadowMapSize;","#endif",THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.shadowMapPCF,THREE.DeferredShaderChunk.shadowMapPCFSoft,THREE.DeferredShaderChunk.geometryFactor,THREE.DeferredShaderChunk.specularBRDF,"vec3 projectOnPlane( vec3 point, vec3 planeCenter, vec3 planeNorm ) {","return point - dot( point - planeCenter, planeNorm ) * planeNorm;","}","bool sideOfPlane( vec3 point, vec3 planeCenter, vec3 planeNorm ) {","return ( dot( point - planeCenter, planeNorm ) >= 0.0 );","}","vec3 linePlaneIntersect( vec3 lp, vec3 lv, vec3 pc, vec3 pn ) {","return lp + lv * ( dot( pn, pc - lp ) / dot( pn, lv ) );","}","float calculateAttenuation( float dist ) {","return ( 1.0 / ( constantAttenuation + linearAttenuation * dist + quadraticAttenuation * dist * dist ) );","}","void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"float w = lightWidth;","float h = lightHeight;","vec3 proj = projectOnPlane( vertexPositionVS.xyz, lightPositionVS, lightNormalVS );","vec3 dir = proj - lightPositionVS;","vec2 diagonal = vec2( dot( dir, lightRightVS ), dot( dir, lightUpVS ) );","vec2 nearest2D = vec2( clamp( diagonal.x, -w, w ), clamp( diagonal.y, -h, h ) );","vec3 nearestPointInside = lightPositionVS + ( lightRightVS * nearest2D.x + lightUpVS * nearest2D.y );","vec3 lightDir = normalize( nearestPointInside - vertexPositionVS.xyz );","float NdotL = max( dot( lightNormalVS, -lightDir ), 0.0 );","float NdotL2 = max( dot( normal, lightDir ), 0.0 );","float dotLN = sqrt( NdotL * NdotL2 );","vec3 diffuse = vec3( dotLN );","if ( wrapAround < 0.0 && NdotL > 0.0 ) {","float dotLNHalf = max( 0.25 * dotLN + 0.25, 0.0 );","diffuse = mix( diffuse, vec3( dotLNHalf ), wrapRGB );","}","#ifdef AREA_TEXTURE","float d = distance( vertexPositionVS.xyz, nearestPointInside );","vec2 co = ( diagonal.xy + vec2( w, h ) ) / ( 2.0 * vec2( w, h ) );","co.y = 1.0 - co.y;","vec3 ve = vertexPositionVS.xyz - lightPositionVS;","vec4 diff = vec4( 0.0 );","if ( dot( ve, lightNormalVS ) < 0.0 ) {","diff = vec4( 0.0 );","} else {","float lod = max( pow( d, 0.1 ), 0.0 ) * 5.0;","vec4 t00 = texture2D( samplerTexture, co, lod );","vec4 t01 = texture2D( samplerTexture, co, lod + 1.0 );","diff = mix( t00, t01, 0.5 );","}","diffuse *= diff.xyz;","#endif","vec3 fresnel = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec3 eyeVector = normalize( -vertexPositionVS.xyz );","vec3 R = reflect( eyeVector, normal );","vec3 E = linePlaneIntersect( vertexPositionVS.xyz, R, lightPositionVS, lightNormalVS );","float specAngle = dot( R, lightNormalVS );","if ( dot( vertexPositionVS.xyz - lightPositionVS, lightNormalVS )>=0.0 && specAngle > 0.0 ) {","vec3 dirSpec = E - lightPositionVS;","vec2 dirSpec2D = vec2( dot( dirSpec, lightRightVS ), dot( dirSpec, lightUpVS ) );","vec2 nearestSpec2D = vec2( clamp( dirSpec2D.x, -w, w ), clamp( dirSpec2D.y, -h, h ) );","vec3 nearestPointInsideSpec = lightPositionVS + ( lightRightVS * nearestSpec2D.x + lightUpVS * nearestSpec2D.y );","vec3 lightDirSpec = normalize( nearestPointInsideSpec - vertexPositionVS.xyz );","vec3 halfVectorSpec = normalize( lightDirSpec + eyeVector );","float dotNormalHalf = max( dot( normal, halfVectorSpec ), 0.0 );","float dotLH = max( dot( lightDirSpec, halfVectorSpec ), 0.0 );","float dotLN = max( dot( lightDirSpec, normal ), 0.0 );","fresnel = specularColor + ( 1.0 - specularColor ) * pow( 1.0 - dotLH, 5.0 );","#if defined( BRDF_BLINN_PHONG )","specular = BlinnPhong_Specular( shininess, dotLN, dotNormalHalf, eyeVector, normal ) * ( fresnel * diffuse ) * specAngle;","#elif defined( BRDF_GGX )","float roughness = saturate( sqrt( 8.0 / ( shininess + 7.0 ) ) );","specular = GGX_Specular( roughness, normal, halfVectorSpec, eyeVector, lightDirSpec ) * ( fresnel * diffuse ) * specAngle;","#else","specular = specularColor * max( pow( dotNormalHalf, shininess ), 0.0 ) * diffuse * specAngle;","#endif","#ifdef AREA_TEXTURE","const float hard = 16.0;","const float gloss = 16.0;","vec3 specPlane = lightPositionVS + ( lightRightVS * dirSpec2D.x + lightUpVS * dirSpec2D.y );","float dist = max( distance( vertexPositionVS.xyz, specPlane ), 0.0 );","float d = ( ( 1.0 / hard ) / 2.0 ) * ( dist / gloss );","w = max( w, 0.0 );","h = max( h, 0.0 );","vec2 co = dirSpec2D / ( d + 1.0 );","co /= 2.0 * vec2( w, h );","co = co + vec2( 0.5 );","co.y = 1.0 - co.y;","float lod = ( 2.0 / hard * max( dist, 0.0 ) );","vec4 t00 = texture2D( samplerTexture, co, lod );","vec4 t01 = texture2D( samplerTexture, co, lod + 1.0 );","vec4 spec = mix( t00, t01, 0.5 );","specular *= spec.xyz;","#endif","}","diffuse -= diffuse * fresnel * specAngle;","float occlusion = 1.0;","#ifdef USE_SHADOWMAP","vec4 posLightCS = matShadow * vertexPositionVS;","vec2 shadowCoord = ( posLightCS.xy / posLightCS.w ) * 0.5 + 0.5;","float vertexDepth = posLightCS.z / posLightCS.w;","#if defined( DEPTH_TEXTURES )","vertexDepth = vertexDepth * 0.5 + 0.5;","#endif","#if !defined( SLOPE_DEPTH_BIAS )","vertexDepth -= shadowBias;","#endif","#if defined( SHADOWMAP_TYPE_PCF )","float shadowValue = sampleShadowPCF( samplerShadowMap, shadowMapSize, shadowCoord, vertexDepth );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadowValue = sampleShadowPCFSoft( samplerShadowMap, shadowMapSize, shadowCoord, vertexDepth );","#else","float shadowDepth = texture2D( samplerShadowMap, shadowCoord ).x;","float shadowValue = float( vertexDepth > shadowDepth );","#endif","occlusion = 1.0 - shadowDarkness * shadowValue;","#endif","float dist = distance( vertexPositionVS.xyz, nearestPointInside );","float attenuation = calculateAttenuation( dist ) * occlusion;",THREE.DeferredShaderChunk.combine,"}"].join("\n"),vertexShader:["void main() {","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},imageLight:{uniforms:THREE.UniformsUtils.merge([THREE.DeferredUniformsLib.gbuffers,{matProjInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},matViewInverse:{type:"m4",value:new THREE.Matrix4,shared:!0},samplerSpecular:{type:"t",value:null},samplerDiffuse:{type:"t",value:null},samplerMip:{type:"t",value:null},samplerSSAO:{type:"t",value:null},maxMipSpecular:{type:"f",value:7},lightIntensity:{type:"f",value:1},lightPositionWS:{type:"v3",value:new THREE.Vector3(0,0,0)},lightSize:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),fragmentShader:["uniform mat4 matProjInverse;","uniform mat4 matViewInverse;","uniform samplerCube samplerSpecular;","uniform samplerCube samplerDiffuse;","uniform samplerCube samplerMip;","#ifdef USE_SSAO","uniform sampler2D samplerSSAO;","#endif","uniform float maxMipSpecular;","uniform float lightIntensity;","#ifdef LIGHT_LOCAL","uniform vec3 lightPositionWS;","uniform vec3 lightSize;","#endif","#ifdef SPECULAR_MIP_FIX","#extension GL_OES_standard_derivatives : enable\n","#endif",THREE.DeferredShaderChunk.gbuffersUniforms,THREE.DeferredShaderChunk.unpackFloat,THREE.DeferredShaderChunk.environmentBRDF,"float maxLength( vec3 v ) {","return max( v.x, max( v.y, v.z ) );","}","void main() {",THREE.DeferredShaderChunk.computeVertexPositionVS,"#ifdef LIGHT_LOCAL","vec4 vertexPositionWS = matViewInverse * vertexPositionVS;","vec3 lightVectorWS = abs( lightPositionWS.xyz - vertexPositionWS.xyz );","if ( lightVectorWS.x > lightSize.x || lightVectorWS.y > lightSize.y || lightVectorWS.z > lightSize.z ) discard;","float localFade = max( 1.0 - maxLength( lightVectorWS / lightSize ), 0.0 );","#else","float localFade = 1.0;","#endif",THREE.DeferredShaderChunk.computeNormal,THREE.DeferredShaderChunk.unpackColorMap,"vec3 eyeVector = normalize( -vertexPositionVS.xyz );","vec3 reflectVS = reflect( -eyeVector, normal );","vec4 reflectWS = matViewInverse * vec4( reflectVS, 0.0 );","#ifdef LIGHT_LOCAL","vec3 BoxMin = lightPositionWS - lightSize;","vec3 BoxMax = lightPositionWS + lightSize;","vec3 FirstPlaneIntersect  = ( BoxMax - vertexPositionWS.xyz ) / reflectWS.xyz;","vec3 SecondPlaneIntersect = ( BoxMin - vertexPositionWS.xyz ) / reflectWS.xyz;","vec3 FurthestPlane = max( FirstPlaneIntersect, SecondPlaneIntersect );","float Distance = min( min( FurthestPlane.x, FurthestPlane.y ), FurthestPlane.z );","vec3 IntersectPositionWS = vertexPositionWS.xyz + reflectWS.xyz * Distance;","reflectWS.xyz = IntersectPositionWS - lightPositionWS;","#endif","vec3 cubeCoord = vec3( reflectWS.x, reflectWS.y, reflectWS.z );","float gloss = shininess / 8192.0;","const float mipUnit = 255.0 / 16.0;","#ifdef SPECULAR_MIP_FIX","float curvature = length( fwidth( cubeCoord.xyz ) );","float mipLevelMinification = mipUnit * textureCube( samplerMip, cubeCoord, -curvature ).a;","float mipLevelMagnification = mipUnit * textureCube( samplerMip, cubeCoord, maxMipSpecular - 1.0 - curvature ).a;","#else","const float curvature = 0.0;","float mipLevelMinification = mipUnit * textureCube( samplerMip, cubeCoord ).a;","float mipLevelMagnification = mipUnit * textureCube( samplerMip, cubeCoord, maxMipSpecular - 1.0 ).a;","#endif","float mipLevel;","if ( mipLevelMinification == 0.0 ) {","mipLevel = mipLevelMagnification - ( maxMipSpecular - 1.0 );","} else {","mipLevel = mipLevelMinification;","}","float maxMipDownscale = ( maxMipSpecular - 2.0 );","float mipBias = max( ( maxMipDownscale * ( 1.0 - gloss ) ) - mipLevel, 0.0 );","mipBias -= curvature;","vec3 cubeColorSpecular = textureCube( samplerSpecular, cubeCoord, mipBias ).xyz;","#ifndef CUBE_SPECULAR_LINEAR","cubeColorSpecular *= cubeColorSpecular;","#endif","vec4 normalWS = matViewInverse * vec4( normal, 0.0 );","vec3 cubeColorDiffuse = textureCube( samplerDiffuse, vec3( normalWS.x, normalWS.y, normalWS.z ) ).xyz;","#ifndef CUBE_DIFFUSE_LINEAR","cubeColorDiffuse *= cubeColorDiffuse;","#endif","vec3 fresnelEnv = EnvironmentBRDF( gloss, dot( eyeVector, normal ), specularColor );","vec3 diffuse = ( 1.0 - fresnelEnv ) * cubeColorDiffuse;","vec3 specular = fresnelEnv * cubeColorSpecular;","#ifdef USE_SSAO","float occlusion = texture2D( samplerSSAO, texCoord ).x;","#else","float occlusion = 1.0;","#endif","gl_FragColor = vec4( lightIntensity * ( albedo * diffuse + specular ), occlusion * occlusion * lightMapIntensity * localFade );","}"].join("\n"),vertexShader:["void main() { ","#ifdef LIGHT_LOCAL","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","#else","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","#endif","}"].join("\n")},composite:{uniforms:{samplerLight:{type:"t",value:null},samplerBloom:{type:"t",value:null},samplerDepth:{type:"t",value:null},samplerParticles:{type:"t",value:null},samplerBlur:{type:"t",value:null},samplerBlurAmount:{type:"t",value:null},brightness:{type:"f",value:1},bloomStrength:{type:"f",value:1},fogColor:{type:"c",value:new THREE.Color(0)},fogStrength:{type:"f",value:.1},fogStart:{type:"f",value:100},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:1e3}},fragmentShader:["varying vec2 texCoord;","uniform sampler2D samplerLight;","uniform float brightness;","#ifdef FOG_ENABLED","uniform sampler2D samplerDepth;","uniform vec3 fogColor;","uniform float fogStrength;","uniform float fogStart;","uniform float cameraNear;","uniform float cameraFar;","#endif","#ifdef BLOOM_ENABLED","uniform sampler2D samplerBloom;","uniform float bloomStrength;","#endif","#ifdef OFFSCREEN_PARTICLES","uniform sampler2D samplerParticles;","#endif","#ifdef FANCY_DOF","uniform sampler2D samplerBlur;","uniform sampler2D samplerBlurAmount;","#endif","#ifdef TONEMAP_UNCHARTED","const float A = 0.15;","const float B = 0.50;","const float C = 0.10;","const float D = 0.20;","const float E = 0.02;","const float F = 0.30;","const float W = 11.2;","vec3 Uncharted2Tonemap( vec3 x ) {","return ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","}","#endif",THREE.DeferredShaderChunk.unpackFloat,"void main() {","vec3 inColor = texture2D( samplerLight, texCoord ).xyz;","#ifdef FANCY_DOF","float bias = texture2D( samplerBlurAmount, texCoord ).a;","vec3 blur = texture2D( samplerBlur, texCoord ).rgb;","if ( bias > 0.1 ) inColor = blur;","#endif","#ifdef OFFSCREEN_PARTICLES","vec3 particleColor = texture2D( samplerParticles, texCoord ).xyz;","inColor += particleColor;","#endif","inColor *= brightness;","vec3 outColor;","#if defined( TONEMAP_SIMPLE )","outColor = sqrt( inColor );","#elif defined( TONEMAP_LINEAR )","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD )","inColor = inColor / ( 1.0 + inColor );","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD_LUMA )","float luma = dot( inColor, vec3( 0.2126, 0.7152, 0.0722 ) );","float toneMappedLuma = luma / ( 1.0 + luma );","inColor *= toneMappedLuma / luma;","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD_WHITE )","const float white = 2.0;","float luma = dot( inColor, vec3( 0.2126, 0.7152, 0.0722 ) );","float toneMappedLuma = luma * ( 1.0 + luma / ( white * white ) ) / ( 1.0 + luma );","inColor *= toneMappedLuma / luma;","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_FILMIC )","vec3 x = max( vec3( 0.0 ), inColor - 0.004 );","outColor = ( x * ( 6.2 * x + 0.5 ) ) / ( x * ( 6.2 * x + 1.7 ) + 0.06 );","#elif defined( TONEMAP_UNCHARTED )","float ExposureBias = 2.0;","vec3 curr = Uncharted2Tonemap( ExposureBias * inColor );","vec3 whiteScale = vec3( 1.0 ) / Uncharted2Tonemap( vec3( W ) );","vec3 color = curr * whiteScale;","outColor = pow( color, vec3( 1.0 / 2.2 ) );","#else","outColor = inColor;","#endif","#ifdef BLOOM_ENABLED","vec3 bloomColor = texture2D( samplerBloom, texCoord ).xyz;","outColor += bloomStrength * bloomColor;","#endif","#ifdef FOG_ENABLED","#if defined( RGBA_DEPTH )","vec4 packedDepth = texture2D( samplerDepth, texCoord );","float depth = unpackDepth( packedDepth );","#elif defined( FLOAT_DEPTH )","float depth = texture2D( samplerDepth, texCoord ).w;","#elif defined( TEXTURE_DEPTH )","float depth = texture2D( samplerDepth, texCoord ).x * 2.0 - 1.0;","#endif","float linearDepth = -cameraFar * cameraNear / ( depth * ( cameraFar - cameraNear ) - cameraFar );","float fogFactor = linearDepth / ( cameraFar - cameraNear );","fogFactor *= smoothstep( 0.0, fogStart, linearDepth );","fogFactor = clamp( fogFactor, 0.0, fogStrength );","outColor = mix( outColor, fogColor, fogFactor );","#endif","gl_FragColor = vec4( outColor, 1.0 );","}"].join("\n"),vertexShader:["varying vec2 texCoord;","void main() {","vec4 pos = vec4( sign( position.xy ), 0.0, 1.0 );","texCoord = pos.xy * 0.5 + 0.5;","gl_Position = pos;","}"].join("\n")}},THREE.ConvolutionShader={defines:{KERNEL_SIZE_FLOAT:"25.0",KERNEL_SIZE_INT:"25"},uniforms:{tDiffuse:{type:"t",value:null},uImageIncrement:{type:"v2",value:new THREE.Vector2(.001953125,0)},cKernel:{type:"fv1",value:[]}},vertexShader:["uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vUv = uv - ( ( KERNEL_SIZE_FLOAT - 1.0 ) / 2.0 ) * uImageIncrement;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cKernel[ KERNEL_SIZE_INT ];","uniform sampler2D tDiffuse;","uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vec2 imageCoord = vUv;","vec4 sum = vec4( 0.0, 0.0, 0.0, 0.0 );","for( int i = 0; i < KERNEL_SIZE_INT; i ++ ) {","sum += texture2D( tDiffuse, imageCoord ) * cKernel[ i ];","imageCoord += uImageIncrement;","}","gl_FragColor = sum;","}"].join("\n"),buildKernel:function(e){function t(e,t){return Math.exp(-(e*e)/(2*t*t))
}var a,r,i,o,n=25,s=2*Math.ceil(3*e)+1;for(s>n&&(s=n),o=.5*(s-1),r=new Array(s),i=0,a=0;s>a;++a)r[a]=t(a-o,e),i+=r[a];for(a=0;s>a;++a)r[a]/=i;return r}},THREE.CopyShader={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","float opacity  = rgbaM.w;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec3 rgbA = 0.5 * (","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz +","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz );","vec3 rgbB = rgbA * 0.5 + 0.25 * (","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * -0.5 ).xyz +","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * 0.5 ).xyz );","float lumaB = dot( rgbB, luma );","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = vec4( rgbA, opacity );","} else {","gl_FragColor = vec4( rgbB, opacity );","}","}"].join("\n")},THREE.SSAOShader={uniforms:{tDepth:{type:"t",value:null},size:{type:"v2",value:new THREE.Vector2(512,512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},onlyAO:{type:"i",value:0},aoClamp:{type:"f",value:.3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","uniform vec2 size;","uniform float aoClamp;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","float width = size.x;","float height = size.y;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","#ifndef SAMPLES","#define SAMPLES 8","#endif","#ifndef RADIUS","#define RADIUS 15.0","#endif","const int samples = SAMPLES;","const float radius = RADIUS;","#define USE_NOISE 1","const float noiseAmount = 0.0002;","const float diffAreaSq = 0.16;","const float gDisplace = 0.4;","#ifdef RGBA_DEPTH","float unpackDepth( vec4 rgba ) {","return clamp( dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) ), 0.0, 1.0 );","}","#endif","vec2 rand( const in vec2 coord ) {","#ifdef USE_NOISE","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 25.9796, 156.466 ) );","vec2 noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","#else","float ff = fract( 1.0 - coord.s * ( width / 2.0 ) );","float gg = fract( coord.t * ( height / 2.0 ) );","vec2 noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","#endif","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","float readDepth( const in vec2 coord ) {","#if defined( RGBA_DEPTH )","vec4 packedDepth = texture2D( tDepth, coord );","float depth = unpackDepth( packedDepth );","#elif defined( FLOAT_DEPTH )","float depth = texture2D( tDepth, coord ).w;","#elif defined( TEXTURE_DEPTH )","float depth = texture2D( tDepth, coord ).x * 2.0 - 1.0;","#endif","return cameraCoef / ( cameraFarPlusNear - depth * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float gareaSq = 4.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","gareaSq = diffAreaSq;","} else {","far = 1;","}","float dd = diff - gDisplace;","return pow( EULER, -2.0 * dd * dd / gareaSq );","}","float calcAO( const in float depth, const in float dw, const in float dh ) {","float dd = radius - depth * radius;","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + dd * vv;","vec2 coord2 = vUv - dd * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / width )  / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / height ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float pw = 0.0;","float ph = 0.0;","float ao = 0.0;","float dz = 1.0 / float( samples );","float z = 1.0 - dz / 2.0;","float l = 0.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","pw = cos( l ) * r;","ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","gl_FragColor = vec4( vec3( 1.0 - ao ), 1.0 );","}"].join("\n")},THREE.SSAOHorizontalBlurShader={uniforms:{tDiffuse:{type:"t",value:null},h:{type:"f",value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","vec4 h1 = texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) );","vec4 h2 = texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) );","vec4 h0 = texture2D( tDiffuse, vec2( vUv.x, vUv.y ) );","vec4 m = ( h1 - h2 ) * 0.5;","float d = abs( h0.x - m.x );","if ( d > 0.15 ) {","sum = min( h1, h2 );","} else {","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;","sum += h1 * 0.1531;","sum += h0 * 0.1633;","sum += h2 * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;","}","gl_FragColor = sum;","}"].join("\n")},THREE.SSAOVerticalBlurShader={uniforms:{tDiffuse:{type:"t",value:null},v:{type:"f",value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","vec4 v1 = texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) );","vec4 v2 = texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) );","vec4 v0 = texture2D( tDiffuse, vec2( vUv.x, vUv.y ) );","vec4 m = ( v1 - v2 ) * 0.5;","float d = abs( v0.x - m.x );","if ( d > 0.15 ) {","sum = min( v1, v2 );","} else {","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;","sum += v1 * 0.1531;","sum += v0 * 0.1633;","sum += v2 * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;","}","gl_FragColor = sum;","}"].join("\n")},THREE.SSAOBilateralHorizontalBlurShader={uniforms:{tDiffuse:{type:"t",value:null},tDepth:{type:"t",value:null},tNormal:{type:"t",value:null},h:{type:"f",value:1/512},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","float linearizeDepth( float d ) {","return cameraCoef / ( cameraFarPlusNear - d * cameraFarMinusNear );","}","float computeWeight( vec4 a, vec4 b ) {","vec3 na = a.xyz * 2.0 - 1.0;","vec3 nb = b.xyz * 2.0 - 1.0;","float dotab = max( dot( na, nb ), 0.0 );","float wn = pow( dotab, 32.0 );","float za = linearizeDepth( a.w );","float zb = linearizeDepth( b.w );","float zz = 10.0 * abs( za - zb );","float wz = 1.0 / ( 1.0 + zz );","return wn * wz;","}","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","uniform float h;","#if defined( RGBA_DEPTH )","float unpackDepth( vec4 rgba ) {","return clamp( dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) ), 0.0, 1.0 );","}","uniform sampler2D tNormal;","#elif defined( TEXTURE_DEPTH )","uniform sampler2D tNormal;","#endif","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","vec2 c1 = vec2( vUv.x - 1.0 * h, vUv.y );","vec2 c2 = vec2( vUv.x + 1.0 * h, vUv.y );","vec2 c3 = vec2( vUv.x - 2.0 * h, vUv.y );","vec2 c4 = vec2( vUv.x + 2.0 * h, vUv.y );","#if defined( RGBA_DEPTH )","vec4 normalDepth0 = texture2D( tNormal, vUv );","vec4 normalDepth1 = texture2D( tNormal, c1 );","vec4 normalDepth2 = texture2D( tNormal, c2 );","vec4 normalDepth3 = texture2D( tNormal, c3 );","vec4 normalDepth4 = texture2D( tNormal, c4 );","normalDepth0.w = unpackDepth( texture2D( tDepth, vUv ) );","normalDepth1.w = unpackDepth( texture2D( tDepth, c1 ) );","normalDepth2.w = unpackDepth( texture2D( tDepth, c2 ) );","normalDepth3.w = unpackDepth( texture2D( tDepth, c3 ) );","normalDepth4.w = unpackDepth( texture2D( tDepth, c4 ) );","#elif defined( FLOAT_DEPTH )","vec4 normalDepth0 = texture2D( tDepth, vUv );","vec4 normalDepth1 = texture2D( tDepth, c1 );","vec4 normalDepth2 = texture2D( tDepth, c2 );","vec4 normalDepth3 = texture2D( tDepth, c3 );","vec4 normalDepth4 = texture2D( tDepth, c4 );","#elif defined( TEXTURE_DEPTH )","vec4 normalDepth0 = texture2D( tNormal, vUv );","vec4 normalDepth1 = texture2D( tNormal, c1 );","vec4 normalDepth2 = texture2D( tNormal, c2 );","vec4 normalDepth3 = texture2D( tNormal, c3 );","vec4 normalDepth4 = texture2D( tNormal, c4 );","normalDepth0.w = texture2D( tDepth, vUv ).x * 2.0 - 1.0;","normalDepth1.w = texture2D( tDepth, c1 ).x * 2.0 - 1.0;","normalDepth2.w = texture2D( tDepth, c2 ).x * 2.0 - 1.0;","normalDepth3.w = texture2D( tDepth, c3 ).x * 2.0 - 1.0;","normalDepth4.w = texture2D( tDepth, c4 ).x * 2.0 - 1.0;","#endif","float w0 = 0.1633;","float w1 = computeWeight( normalDepth0, normalDepth1 ) * 0.1531;","float w2 = computeWeight( normalDepth0, normalDepth2 ) * 0.1531;","float w3 = computeWeight( normalDepth0, normalDepth3 ) * 0.12245;","float w4 = computeWeight( normalDepth0, normalDepth4 ) * 0.12245;","float ws = w0 + w1 + w2 + w3 + w4;","vec4 h0 = texture2D( tDiffuse, vUv );","vec4 h1 = texture2D( tDiffuse, c1 );","vec4 h2 = texture2D( tDiffuse, c2 );","vec4 h3 = texture2D( tDiffuse, c3 );","vec4 h4 = texture2D( tDiffuse, c4 );","sum += h3 * w3;","sum += h1 * w1;","sum += h0 * w0;","sum += h2 * w2;","sum += h4 * w4;","sum /= ws;","gl_FragColor = sum;","}"].join("\n")},THREE.SSAOBilateralVerticalBlurShader={uniforms:{tDiffuse:{type:"t",value:null},tDepth:{type:"t",value:null},tNormal:{type:"t",value:null},v:{type:"f",value:1/512},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","float linearizeDepth( float d ) {","return cameraCoef / ( cameraFarPlusNear - d * cameraFarMinusNear );","}","float computeWeight( vec4 a, vec4 b ) {","vec3 na = a.xyz * 2.0 - 1.0;","vec3 nb = b.xyz * 2.0 - 1.0;","float dotab = max( dot( na, nb ), 0.0 );","float wn = pow( dotab, 32.0 );","float za = linearizeDepth( a.w );","float zb = linearizeDepth( b.w );","float zz = 10.0 * abs( za - zb );","float wz = 1.0 / ( 1.0 + zz );","return wn * wz;","}","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","uniform float v;","#if defined( RGBA_DEPTH )","float unpackDepth( vec4 rgba ) {","return clamp( dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) ), 0.0, 1.0 );","}","uniform sampler2D tNormal;","#elif defined( TEXTURE_DEPTH )","uniform sampler2D tNormal;","#endif","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","vec2 c1 = vec2( vUv.x, vUv.y - 1.0 * v );","vec2 c2 = vec2( vUv.x, vUv.y + 1.0 * v );","#if defined( RGBA_DEPTH )","vec4 normalDepth0 = texture2D( tNormal, vUv );","vec4 normalDepth1 = texture2D( tNormal, c1 );","vec4 normalDepth2 = texture2D( tNormal, c2 );","normalDepth0.w = unpackDepth( texture2D( tDepth, vUv ) );","normalDepth1.w = unpackDepth( texture2D( tDepth, c1 ) );","normalDepth2.w = unpackDepth( texture2D( tDepth, c2 ) );","#elif defined( FLOAT_DEPTH )","vec4 normalDepth0 = texture2D( tDepth, vUv );","vec4 normalDepth1 = texture2D( tDepth, c1 );","vec4 normalDepth2 = texture2D( tDepth, c2 );","#elif defined( TEXTURE_DEPTH )","vec4 normalDepth0 = texture2D( tNormal, vUv );","vec4 normalDepth1 = texture2D( tNormal, c1 );","vec4 normalDepth2 = texture2D( tNormal, c2 );","normalDepth0.w = texture2D( tDepth, vUv ).x * 2.0 - 1.0;","normalDepth1.w = texture2D( tDepth, c1 ).x * 2.0 - 1.0;","normalDepth2.w = texture2D( tDepth, c2 ).x * 2.0 - 1.0;","#endif","float w0 = 0.1633;","float w1 = computeWeight( normalDepth0, normalDepth1 ) * 0.1531;","float w2 = computeWeight( normalDepth0, normalDepth2 ) * 0.1531;","float ws = w0 + w1 + w2;","vec4 h0 = texture2D( tDiffuse, vUv );","vec4 h1 = texture2D( tDiffuse, c1 );","vec4 h2 = texture2D( tDiffuse, c2 );","sum += h1 * w1;","sum += h0 * w0;","sum += h2 * w2;","sum /= ws;","gl_FragColor = sum;","}"].join("\n")},THREE.BloomHorizontalBlurShader={uniforms:{tDiffuse:{type:"t",value:null},h:{type:"f",value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","varying vec2 vUv;","void main() {","vec3 sum = vec3( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ).xyz * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ).xyz * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ).xyz * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ).xyz * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ).xyz * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ).xyz * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ).xyz * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ).xyz * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ).xyz * 0.051;","gl_FragColor.xyz = sum;","gl_FragColor.w = 1.0;","}"].join("\n")},THREE.BloomVerticalBlurShader={uniforms:{tDiffuse:{type:"t",value:null},v:{type:"f",value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","varying vec2 vUv;","void main() {","vec3 sum = vec3( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ).xyz * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ).xyz * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ).xyz * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ).xyz * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ).xyz * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ).xyz * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ).xyz * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ).xyz * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ).xyz * 0.051;","gl_FragColor.xyz = sum;","gl_FragColor.w = 1.0;","}"].join("\n")},THREE.BloomFilterShader={uniforms:{tSource:{type:"t",value:null},threshold:{type:"f",value:1},brightness:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tSource;","uniform float threshold;","uniform float brightness;","varying vec2 vUv;","#ifdef TONEMAP_UNCHARTED","const float A = 0.15;","const float B = 0.50;","const float C = 0.10;","const float D = 0.20;","const float E = 0.02;","const float F = 0.30;","const float W = 11.2;","vec3 Uncharted2Tonemap( vec3 x ) {","return ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","}","#endif","void main() {","vec3 outColor = vec3( 0.0 );","const vec3 luma = vec3( 0.299, 0.587, 0.114 );","vec3 inColor = texture2D( tSource, vec2( vUv.x, vUv.y ) ).xyz;","float v = dot( inColor, luma );","if ( v > threshold ) {","inColor *= brightness;","#if defined( TONEMAP_SIMPLE )","outColor = sqrt( inColor );","#elif defined( TONEMAP_LINEAR )","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD )","inColor = inColor / ( 1.0 + inColor );","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD_LUMA )","float luma = dot( inColor, vec3( 0.2126, 0.7152, 0.0722 ) );","float toneMappedLuma = luma / ( 1.0 + luma );","inColor *= toneMappedLuma / luma;","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD_WHITE )","const float white = 2.0;","float luma = dot( inColor, vec3( 0.2126, 0.7152, 0.0722 ) );","float toneMappedLuma = luma * ( 1.0 + luma / ( white * white ) ) / ( 1.0 + luma );","inColor *= toneMappedLuma / luma;","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_FILMIC )","vec3 x = max( vec3( 0.0 ), inColor - 0.004 );","outColor = ( x * ( 6.2 * x + 0.5 ) ) / ( x * ( 6.2 * x + 1.7 ) + 0.06 );","#elif defined( TONEMAP_UNCHARTED )","float ExposureBias = 2.0;","vec3 curr = Uncharted2Tonemap( ExposureBias * inColor );","vec3 whiteScale = vec3( 1.0 ) / Uncharted2Tonemap( vec3( W ) );","vec3 color = curr * whiteScale;","outColor = pow( color, vec3( 1.0 / 2.2 ) );","#else","outColor = inColor;","#endif","}","gl_FragColor.xyz = outColor;","gl_FragColor.a = 1.0;","}"].join("\n")},THREE.IBLDiffuseConvolutionShader={uniforms:{tCube:{type:"t",value:null}},vertexShader:["varying vec3 vWorldNormal;","void main() {","vec4 worldNormal = modelMatrix * vec4( normal, 0.0 );","vWorldNormal = worldNormal.xyz;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","varying vec3 vWorldNormal;","const int zSamples = 30;","const int tSamples = 2 * zSamples;","const float zFract = 1.0 / float( zSamples );","const float tFract = 3.14159265 * zFract;","const float normFract = 4.0 * 3.14159265 / float( ( tSamples + 1 ) * ( tSamples ) );","void main() {","vec3 surfaceNormal = normalize( vWorldNormal );","vec3 total = vec3( 0.0 );","for ( int z = -zSamples; z <= zSamples; z ++ ) {","for ( int t = 0; t < tSamples; t ++ ) {","float fz = float( z ) * zFract;","float ft = float( t ) * tFract;","float r = sqrt( 1.0 - fz * fz );","float x = r * cos( ft );","float y = r * sin( ft );","vec3 sampleNormal = vec3( x, y, fz );","float dotProduct = max( dot( surfaceNormal, sampleNormal ), 0.0 );","vec4 pixel = textureCube( tCube, sampleNormal );","total += pixel.xyz * dotProduct;","}","}","gl_FragColor.xyz = total * normFract;","gl_FragColor.a = 1.0;","}"].join("\n")},THREE.IBLDiffuseProbeShader={uniforms:{tCube:{type:"t",value:null}},vertexShader:["varying vec3 vWorldNormal;","void main() {","vec4 worldNormal = modelMatrix * vec4( normal, 0.0 );","vWorldNormal = worldNormal.xyz;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","varying vec3 vWorldNormal;","void main() {","vec3 surfaceNormal = normalize( vWorldNormal );","gl_FragColor = textureCube( tCube, surfaceNormal );","gl_FragColor.xyz *= gl_FragColor.xyz;","gl_FragColor.a = 1.0;","}"].join("\n")},THREE.DOFBlurShader={uniforms:{tDiffuse:{type:"t",value:null},tBlurAmount:{type:"t",value:null},resolution:{type:"v2",value:new THREE.Vector2(1024,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tBlurAmount;","uniform vec2 resolution;","varying vec2 vUv;","#if defined( RGBA_DEPTH )","float unpackDepth( vec4 rgba ) {","return clamp( dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) ), 0.0, 1.0 );","}","#endif","#define DL 2.399963229728653","void main() {","float centerBias = texture2D( tBlurAmount, vUv ).a;","vec3 mixed = vec3( 0.0 );","const int samples = 16;","vec2 pixelRatio = 16.0 / resolution;","float dz = 1.0 / float( samples );","float z = 1.0 - dz / 2.0;","float l = 0.0;","float usedWeights = 0.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","float dx = cos( l );","float dy = sin( l );","vec4 sampleColor = texture2D( tBlurAmount, vUv + ( vec2( dx, dy ) * pixelRatio ) * ( centerBias * r ) );","mixed += z * sampleColor.rgb;","usedWeights += z * sampleColor.a;","z = z - dz;","l = l + DL;","}","mixed /= usedWeights;","if ( usedWeights == 0.0 ) mixed = texture2D( tDiffuse, vUv ).rgb;","gl_FragColor = vec4( mixed, 1.0 );","}"].join("\n")},THREE.DOFShaderChunk={computeBlurPars:["#ifdef DOF_PHYSICAL","uniform float lensCOC;","uniform float lensFstop;","uniform float lensFocalLength;","float computeBlurStrength( float pointDepth, float focalDepth ) {","float f = lensFocalLength; ","float d = focalDepth * 1000.0;","float o = pointDepth * 1000.0;","float a = ( o * f ) / ( o - f );","float b = ( d * f ) / ( d - f );","float c = ( d - f ) / ( d * lensFstop * lensCOC );","float blurStrength = abs( a - b ) * c;","blurStrength = clamp( blurStrength, 0.0, 1.0 );","return blurStrength;","}","#else","uniform float focusRampStart;","uniform float focusRampEnd;","uniform float maxBlur;","const float maxBias = 8.0;","float computeBlurBias( float pointDepth, float focalDepth ) {","float blurFactor = abs( focalDepth - pointDepth );","blurFactor *= smoothstep( focusRampStart, focusRampEnd, blurFactor );","float blurBias = maxBlur * blurFactor;","blurBias = min( blurBias, maxBias );","return blurBias;","}","#endif"].join("\n")},THREE.DOFBlurAmountShader={defines:{DOF_PHYSICAL:!0},uniforms:{tDepth:{type:"t",value:null},tDistance:{type:"t",value:null},tDiffuse:{type:"t",value:null},autoFocus:{type:"i",value:1},autoFocusPoint:{type:"v2",value:new THREE.Vector2(.5,.5)},focusDistance:{type:"f",value:5},focusRampStart:{type:"f",value:2},focusRampEnd:{type:"f",value:8},maxBlur:{type:"f",value:1},lensCOC:{type:"f",value:.03},lensFstop:{type:"f",value:4},lensFocalLength:{type:"f",value:50},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:1e3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:[THREE.DOFShaderChunk.computeBlurPars,"uniform bool autoFocus;","uniform vec2 autoFocusPoint;","uniform float focusDistance;","uniform float cameraNear;","uniform float cameraFar;","uniform sampler2D tDepth;","uniform sampler2D tDistance;","uniform sampler2D tDiffuse;","varying vec2 vUv;","#if defined( RGBA_DEPTH )","float unpackDepth( vec4 rgba ) {","return clamp( dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) ), 0.0, 1.0 );","}","#endif","void main() {","#if defined( RGBA_DEPTH )","vec4 packedDepth = texture2D( tDepth, vUv );","float depth = unpackDepth( packedDepth );","#elif defined( FLOAT_DEPTH )","float depth = texture2D( tDepth, vUv ).w;","#elif defined( TEXTURE_DEPTH )","float depth = texture2D( tDepth, vUv ).x * 2.0 - 1.0;","#endif","depth = -cameraFar * cameraNear / ( depth * ( cameraFar - cameraNear ) - cameraFar );","float zFocusDistance;","if ( autoFocus ) {","zFocusDistance = texture2D( tDistance, autoFocusPoint ).x;","} else {","zFocusDistance = focusDistance;","}","#ifdef DOF_PHYSICAL","float blurAmount = computeBlurStrength( depth, zFocusDistance );","#else","float blurAmount = computeBlurBias( depth, zFocusDistance );","#endif","vec3 color = texture2D( tDiffuse, vUv ).rgb;","gl_FragColor = vec4( color * blurAmount, blurAmount );","}"].join("\n")},THREE.DepthOfFieldShader={uniforms:{tDiffuse:{type:"t",value:null},tDepth:{type:"t",value:null},tBlur:{type:"t",value:null},tDistance:{type:"t",value:null},focusDistance:{type:"f",value:5},focusRampStart:{type:"f",value:2},focusRampEnd:{type:"f",value:8},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:1e3},maxBlur:{type:"f",value:1},blurSize:{type:"v2",value:new THREE.Vector2(1024,512)},autoFocus:{type:"i",value:1},autoFocusPoint:{type:"v2",value:new THREE.Vector2(.5,.5)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform bool autoFocus;","uniform vec2 autoFocusPoint;","uniform float focusDistance;","uniform float focusRampStart;","uniform float focusRampEnd;","uniform float cameraNear;","uniform float cameraFar;","uniform float maxBlur;","uniform vec2 blurSize;","uniform sampler2D tDiffuse;","uniform sampler2D tBlur;","uniform sampler2D tDepth;","uniform sampler2D tDistance;","varying vec2 vUv;","const float maxBias = 3.0;","#if defined( RGBA_DEPTH )","float unpackDepth( vec4 rgba ) {","return clamp( dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) ), 0.0, 1.0 );","}","#endif","void main() {","#if defined( RGBA_DEPTH )","vec4 packedDepth = texture2D( tDepth, vUv );","float depth = unpackDepth( packedDepth );","#elif defined( FLOAT_DEPTH )","float depth = texture2D( tDepth, vUv ).w;","#elif defined( TEXTURE_DEPTH )","float depth = texture2D( tDepth, vUv ).x * 2.0 - 1.0;","#endif","depth = -cameraFar * cameraNear / ( depth * ( cameraFar - cameraNear ) - cameraFar );","float zFocusDistance;","if ( autoFocus ) {","zFocusDistance = texture2D( tDistance, autoFocusPoint ).x;","} else {","zFocusDistance = focusDistance;","}","float blurFactor = abs( zFocusDistance - depth );","#ifdef DOF_DEBUG","vec4 debugColor = vec4( 1.0 );","if ( blurFactor < 0.1 ) {","debugColor = vec4( 1.0, 0.0, 0.0, 1.0 );","}","if ( autoFocus && any( lessThan( abs( vUv - autoFocusPoint ), 0.001 * vec2( 1.0, 2.0 ) ) ) ) {","debugColor *= vec4( 0.0, 0.0, 0.0, 1.0 );","}","#endif","blurFactor *= smoothstep( focusRampStart, focusRampEnd, blurFactor );","float bias = maxBlur * blurFactor;","bias = min( bias, maxBias );","float blurStep = 10.0 * maxBlur;","float dx = blurStep / blurSize.x;","float dy = blurStep / blurSize.y;","vec4 blur0 = texture2D( tBlur, vUv, bias );","vec4 blur1 = texture2D( tBlur, vUv + vec2( -dx, -dy ), bias );","vec4 blur2 = texture2D( tBlur, vUv + vec2(  dx,  dy ), bias );","vec4 blur3 = texture2D( tBlur, vUv + vec2( -dx,  dy ), bias  );","vec4 blur4 = texture2D( tBlur, vUv + vec2(  dx, -dy ), bias  );","vec4 blur = ( blur0 + blur1 + blur2 + blur3 + blur4 ) * 0.2;","vec4 sharp = texture2D( tDiffuse, vUv );","vec4 mixed = mix( sharp, blur, min( bias, 1.0 ) );","gl_FragColor = mixed;","gl_FragColor.a = 1.0;","#ifdef DOF_DEBUG","gl_FragColor *= debugColor;","#endif","}"].join("\n")},THREE.DistanceShader={uniforms:{tDepth:{type:"t",value:null},tDistance:{type:"t",value:null},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:1e3},persistence:{type:"f",value:.75},samplePoint:{type:"v2",value:new THREE.Vector2(.5,.5)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","uniform float persistence;","uniform vec2 samplePoint;","uniform sampler2D tDepth;","uniform sampler2D tDistance;","varying vec2 vUv;","#if defined( RGBA_DEPTH )","float unpackDepth( vec4 rgba ) {","return clamp( dot( rgba, vec4( 1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0 ) ), 0.0, 1.0 );","}","#endif","void main() {","#if defined( RGBA_DEPTH )","vec4 packedDepth = texture2D( tDepth, samplePoint );","float depth = unpackDepth( packedDepth );","#elif defined( FLOAT_DEPTH )","float depth = texture2D( tDepth, samplePoint ).w;","#elif defined( TEXTURE_DEPTH )","float depth = texture2D( tDepth, samplePoint ).x * 2.0 - 1.0;","#endif","depth = -cameraFar * cameraNear / ( depth * ( cameraFar - cameraNear ) - cameraFar );","float oldDepth = texture2D( tDistance, samplePoint ).x;","depth = mix( depth, oldDepth, persistence );","gl_FragColor = vec4( depth );","gl_FragColor.a = 1.0;","}"].join("\n")},THREE.ChromaticAberrationShader={uniforms:{tDiffuse:{type:"t",value:null},amount:{type:"f",value:.005},angle:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 offset = amount * ( length( vUv - 0.5 ) + 0.01 ) * vec2( cos( angle ), sin( angle ) );","vec4 cr = texture2D( tDiffuse, vUv + offset );","vec4 cga = texture2D( tDiffuse, vUv );","vec4 cb = texture2D( tDiffuse, vUv - offset );","gl_FragColor = vec4( cr.r, cga.g, cb.b, cga.a );","}"].join("\n")},THREE.ForwardRenderer=function(e){function t(){for(var e=0,t=ha.length;t>e;e++){var a=ha[e];!na[a]&&la[a]&&(yt.enableVertexAttribArray(a),void 0===na[a]&&sa.push(a),na[a]=!0)}for(var e=0,t=sa.length;t>e;e++){var a=sa[e];na[a]&&!la[a]&&(yt.disableVertexAttribArray(a),na[a]=!1)}}function a(e){la[e]||(la[e]=!0,ha.push(e))}function r(){for(var e=0,t=ha.length;t>e;e++){var a=ha[e];la[a]=!1}ha.length=0}function i(e,t){return e.z!==t.z?t.z-e.z:t.id-e.id}function o(e,t){return t[0]-e[0]}function n(e,t,a){if(e.length)for(var r=0,i=e.length;i>r;r++)Ut=null,Ot=null,Wt=-1,Kt=-1,Yt=-1,zt=-1,Ht=-1,Bt=-1,It=-1,xa=!0,e[r].render(t,a,ia,oa),Ut=null,Ot=null,Wt=-1,Kt=-1,Yt=-1,zt=-1,Ht=-1,Bt=-1,It=-1,xa=!0}function s(e,t,a,r,i,o,n,s){var l,h,d,u;t?(h=e.length-1,d=-1,u=-1):(h=0,d=e.length,u=1);for(var c,f=h;f!==d;f+=u)l=e[f],l.render&&(c=l[a],c&&c.visible!==!1&&c.enabled!==!1&&(s&&Et.setBlending(c.blending,c.blendEquation,c.blendSrc,c.blendDst),Et.setDepthTest(c.depthTest),Et.setDepthWrite(c.depthWrite),Et.setPolygonOffset(c.polygonOffset,c.polygonOffsetFactor,c.polygonOffsetUnits),Et.setMaterialFaces(c),Et.setProgram(r,i,o,n,c,l.object,l.geometry),Et.renderGeometry(c,l.geometry,l.object)))
}function l(e,t,a,r,i,o,n){for(var s,l,h,d=0,u=e.length;u>d;d++)s=e[d],l=s.object,s.render&&(h=s[t],h&&h.visible!==!1&&h.enabled!==!1&&(n&&Et.setBlending(h.blending,h.blendEquation,h.blendSrc,h.blendDst),Et.setDepthTest(h.depthTest),Et.setDepthWrite(h.depthWrite),Et.setPolygonOffset(h.polygonOffset,h.polygonOffsetFactor,h.polygonOffsetUnits),Et.setProgram(a,r,i,o,h,l,null),Et.renderImmediateObject(a,r,i,h,l)))}function h(e){var t=e.object,a=e.index,r=t.materials[a];r&&(r.transparent?(e.transparent=r,e.opaque=null):(e.opaque=r,e.transparent=null))}function d(e){var t=e.object,a=e.index,r=t.materials[a];r&&(r.transparent?(e.transparent=r,e.opaque=null):(e.opaque=r,e.transparent=null))}function u(e,t){var a;if(!e.__webglInit&&(e.__webglInit=!0,e._modelViewMatrix=new THREE.Matrix4,e._normalMatrix=new THREE.Matrix3,e instanceof THREE.Mesh||e instanceof THREE.Particles))for(var r=0,i=e.geometries.length;i>r;r++)a=e.geometries[r],Ya(a);if(!e.__webglActive){if(e instanceof THREE.Mesh||e instanceof THREE.Particles)for(var r=0,i=e.geometries.length;i>r;r++)a=e.geometries[r],c(t.__webglObjects,a,e,r);else(e instanceof THREE.ImmediateRenderObject||e.immediateRenderCallback)&&f(t.__webglObjectsImmediate,e);e.__webglActive=!0}}function c(e,t,a,r){e.push({render:!1,index:r,geometry:t,object:a,opaque:null,transparent:null,z:0,id:0})}function f(e,t){e.push({render:!1,index:0,object:t,opaque:null,transparent:null,z:0,id:0})}function p(e){var t=e.geometries;if(e instanceof THREE.Mesh||e instanceof THREE.Particles)for(var a=0,r=t.length;r>a;a++)Qa(t[a])}function m(e,t){e instanceof THREE.Mesh||e instanceof THREE.Particles?v(t.__webglObjects,e):(e instanceof THREE.ImmediateRenderObject||e.immediateRenderCallback)&&v(t.__webglObjectsImmediate,e),e.__webglActive=!1}function v(e,t){for(var a=e.length-1;a>=0;a--)e[a].object===t&&e.splice(a,1)}function g(e,t){e.uniforms=THREE.UniformsUtils.clone(t.uniforms),e.vertexShader=t.vertexShader,e.fragmentShader=t.fragmentShader}function S(e,t){var a=t.color;if(Et.gammaInput?e.diffuse.value.setRGBAGamma(a,t.opacity):e.diffuse.value.setRGBA(a,t.opacity),t instanceof THREE.EmissiveMaterial||t instanceof THREE.DynamicParticleMaterial){var r=e.diffuse.value.data,i=t.intensity;r[0]*=i,r[1]*=i,r[2]*=i}e.map.value=t.map,e.lightMap.value=t.lightMap;var o;if(t.map?o=t.map:t.specularMap?o=t.specularMap:t.glossMap?o=t.glossMap:t.normalGlossMap?o=t.normalGlossMap:t.normalMap?o=t.normalMap:t.bumpMap&&(o=t.bumpMap),void 0!==o){var n=o.offset,s=o.repeat;e.offsetRepeat.value.set(n.data[0],n.data[1],s.data[0],s.data[1])}e.brightness.value=Et.brightness}function x(e,t){e.particleSize.value=t.particleSize,e.screenWidth.value=ia,t instanceof THREE.DynamicParticleMaterial&&(e.time.value=t.time,e.timeRange.value=t.timeRange,e.timeOffset.value=t.timeOffset,e.numFrames.value=t.numFrames,e.frameDuration.value=t.frameDuration)}function y(e,t){e.fogColor.value=t.color,t instanceof THREE.Fog?e.fogNearFar.value.set(t.near,t.far):t instanceof THREE.FogExp2&&(e.fogDensity.value=t.density)}function G(e,t){e.fogHeight.value=t.height,e.fogVisibilityDistance.value=t.visibilityDistance,e.fogFadeSpeed.value=t.fadeSpeed,e.fogShallowDepthColor.value=t.shallowDepthColor,e.fogDeepDepthColor.value=t.deepDepthColor,e.fogRgbExtinctionDistance.value=t.rgbExtinctionDistance}function M(e,t){var a=t.specular;Et.gammaInput?e.specular.value.setRGBAGamma(a,t.shininess):e.specular.value.setRGBA(a,t.shininess),t.specularMap&&(e.specularMap.value=t.specularMap),t.glossMap&&(e.glossMap.value=t.glossMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),(t.normalMap||t.normalGlossMap)&&(e.normalMap.value=t.normalGlossMap?t.normalGlossMap:t.normalMap,e.normalScale.value.copy(t.normalScale)),t.wrapAround&&(e.wrapRGB.value=t.wrapRGB),t.parallax&&(e.parallaxScale.value=t.parallaxScale)}function w(e,t){e.directionalLightColor.value=t.directional.colors,e.directionalLightDirectionVS.value=t.directional.positions,e.directionalLightPars.value=t.directional.pars,e.pointLightColor.value=t.point.colors,e.pointLightPositionVS.value=t.point.positions,e.pointLightDistance.value=t.point.distances,e.sphereLightColor.value=t.sphere.colors,e.sphereLightPositionVS.value=t.sphere.positions,e.sphereLightPars.value=t.sphere.pars,e.tubeLightColor.value=t.tube.colors,e.tubeLightPosition0VS.value=t.tube.positions0,e.tubeLightPosition1VS.value=t.tube.positions1,e.tubeLightPars.value=t.tube.pars,e.spotLightColor.value=t.spot.colors,e.spotLightPositionVS.value=t.spot.positions,e.spotLightDirectionVS.value=t.spot.directions,e.spotLightPars.value=t.spot.pars,e.hemisphereLightSkyColor.value=t.hemi.skyColors,e.hemisphereLightGroundColor.value=t.hemi.groundColors,e.hemisphereLightDirectionVS.value=t.hemi.positions,e.areaLightColor.value=t.area.colors,e.areaLightPosition.value=t.area.positions,e.areaLightNormal.value=t.area.normals,e.areaLightRight.value=t.area.rights,e.areaLightUp.value=t.area.ups,e.areaLightPars.value=t.area.pars,e.areaLightAttenuation.value=t.area.attenuations,e.areaLightTexture.value=t.area.textures,e.imageLightTextureDiffuse.value=t.image.texturesDiffuse,e.imageLightTextureSpecular.value=t.image.texturesSpecular,e.imageLightTextureMip.value=t.image.texturesMip,e.imageLightPars.value=t.image.pars,e.imageLightPositionWS.value=t.image.positions,e.imageLightSize.value=t.image.sizes}function X(e,t,a,r,i){e.useDepthTexture&&Pa&&Et.shadowMapUseDepthTextures&&(e=e.depthTexture),r.shadowMap.value[i]=e,r.shadowMatrix.value[i]=t;var o=Math.sqrt(a.shadowDarkness),n=a.properties.shadowMapPars;n.setZ(o),n.setW(a.shadowBias),r.shadowMapPars.value[i]=n}function D(e,t){for(var a=0,r=0,i=t.length;i>r;r++){var o=t[r];if(o.castShadow&&(o instanceof THREE.SpotLight||o instanceof THREE.AreaLight||(o instanceof THREE.DirectionalLight||o instanceof THREE.DayLight||o instanceof THREE.DayLightCube)&&!o.shadowCascade)){var n=o.properties,s=n.shadowMap,l=n.shadowMatrixForward;if(s instanceof Array)for(var h=0,d=s.length;d>h;h++)X(s[h],l[h],o,e,a),a++;else X(s,l,o,e,a),a++}}}function C(e,t){e.modelViewMatrix&&yt.uniformMatrix4fv(e.modelViewMatrix,!1,t._modelViewMatrix.elements),e.normalMatrix&&yt.uniformMatrix3fv(e.normalMatrix,!1,t._normalMatrix.elements),e.modelMatrix&&yt.uniformMatrix4fv(e.modelMatrix,!1,t.matrixWorld.elements)}function _(){var e=kt;return e>=Ga&&console.warn("XG:ForwardRenderer: trying to use "+(e+1)+" texture units while this GPU supports only "+Ga),kt+=1,e}function b(e){for(var t,a,r,i,o,n,s,l,h,d,u=0,c=e.length;c>u;u++)if(t=e[u],a=t[0],o=t[1],i=a.type,r=a.value,"i"===i)yt.uniform1i(o,r);else if("f"===i)yt.uniform1f(o,r);else if("v2"===i)yt.uniform2fv(o,r.data);else if("v3"===i)yt.uniform3fv(o,r.data);else if("v4"===i)yt.uniform4fv(o,r.data);else if("c"===i)yt.uniform3f(o,r.r,r.g,r.b);else if("iv1"===i)yt.uniform1iv(o,r);else if("iv2"===i)yt.uniform2iv(o,r);else if("iv3"===i)yt.uniform3iv(o,r);else if("fv1"===i)yt.uniform1fv(o,r);else if("fv2"===i)yt.uniform2fv(o,r);else if("fv3"===i)yt.uniform3fv(o,r);else if("fv4"===i)yt.uniform4fv(o,r);else if("v2v"===i){for(void 0===a._array&&(a._array=new Float32Array(2*r.length)),l=0,h=r.length;h>l;l++)d=2*l,a._array.set(r[l].data,d);yt.uniform2fv(o,a._array)}else if("v3v"===i){for(void 0===a._array&&(a._array=new Float32Array(3*r.length)),l=0,h=r.length;h>l;l++)d=3*l,a._array.set(r[l].data,d);yt.uniform3fv(o,a._array)}else if("v4v"===i){for(void 0===a._array&&(a._array=new Float32Array(4*r.length)),l=0,h=r.length;h>l;l++)d=4*l,a._array.set(r[l].data,d);yt.uniform4fv(o,a._array)}else if("m4"===i)yt.uniformMatrix4fv(o,!1,r.elements);else if("m4v"===i){for(void 0===a._array&&(a._array=new Float32Array(16*r.length)),l=0,h=r.length;h>l;l++)r[l].flattenToArrayOffset(a._array,16*l);yt.uniformMatrix4fv(o,!1,a._array)}else if("t"===i){if(n=r,s=_(),yt.uniform1i(o,s),!n)continue;n.image instanceof Array&&6===n.image.length?V(n,s):n instanceof THREE.RenderTargetCube?z(n,s):Et.setTexture(n,s)}else if("tv"===i){for(void 0===a._array&&(a._array=[]),l=0,h=a.value.length;h>l;l++)a._array[l]=_();for(yt.uniform1iv(o,a._array),l=0,h=a.value.length;h>l;l++)n=a.value[l],s=a._array[l],n&&(n.image instanceof Array&&6===n.image.length?V(n,s):n instanceof THREE.RenderTargetCube?z(n,s):Et.setTexture(n,s))}}function A(e,t){e._modelViewMatrix.multiply(t.matrixWorldInverse,e.matrixWorld),e._normalMatrix.getNormalMatrix(e._modelViewMatrix)}function T(e,t,a,r){e[t]=a.r*a.r*r,e[t+1]=a.g*a.g*r,e[t+2]=a.b*a.b*r}function P(e,t,a,r){e[t]=a.r*r,e[t+1]=a.g*r,e[t+2]=a.b*r}function L(e,t){var a,r,i,o,n,s,l,h,d,u,c=ya,f=c.directional.colors,p=c.directional.positions,m=c.directional.pars,v=c.point.colors,g=c.point.positions,S=c.point.distances,x=c.sphere.colors,y=c.sphere.positions,G=c.sphere.pars,M=c.tube.colors,w=c.tube.positions0,X=c.tube.positions1,D=c.tube.pars,C=c.spot.colors,_=c.spot.positions,b=c.spot.directions,A=c.spot.pars,L=c.hemi.skyColors,E=c.hemi.groundColors,F=c.hemi.positions,R=c.area.colors,U=c.area.positions,N=c.area.normals,I=c.area.rights,B=c.area.ups,O=c.area.pars,k=c.area.attenuations,V=c.area.textures,z=c.image.pars,H=c.image.texturesDiffuse,W=c.image.texturesSpecular,j=c.image.texturesMip,q=c.image.positions,Z=c.image.sizes,K=0,Y=0,Q=0,J=0,$=0,et=0,tt=0,at=0,rt=0,it=0,ot=0,nt=0,st=0,lt=0,ht=0,dt=0,ut=0,ct=0,ft=0,pt=0,mt=0,vt=0,gt=0,St=0,xt=999999,yt=0,Gt=[],Mt=[],wt=[],Xt=t.matrixWorldInverse;for(a=0,r=e.length;r>a;a++)if(i=e[a],i.onlyShadow)i instanceof THREE.DirectionalLight||i instanceof THREE.DayLight||i instanceof THREE.DayLightCube?i.castShadow&&Gt.push(i):i instanceof THREE.SpotLight?i.castShadow&&Mt.push(i):i instanceof THREE.AreaLight&&i.castShadow&&wt.push(i);else{if(o=i.color,l=i.intensity,d=i.distance,u=i.matrixWorld,i instanceof THREE.DirectionalLight){if(rt+=1,!i.visible)continue;if(ma.copy(u.getPosition()),ma.subSelf(i.target.matrixWorld.getPosition()),ma.normalize(),Xt.rotateAxis(ma),0===ma.data[0]&&0===ma.data[1]&&0===ma.data[2])continue;ut=3*K,p[ut]=ma.data[0],p[ut+1]=ma.data[1],p[ut+2]=ma.data[2],m[K]=i.castShadow?yt:xt,Et.gammaInput?T(f,ut,o,l*l):P(f,ut,o,l),i.castShadow&&Gt.push(i),K+=1}else if(i instanceof THREE.PointLight){if(it+=1,!i.visible)continue;ct=3*Y,Et.gammaInput?T(v,ct,o,l*l):P(v,ct,o,l),pa.copy(u.getPosition()),Xt.multiplyVector3(pa),g[ct]=pa.data[0],g[ct+1]=pa.data[1],g[ct+2]=pa.data[2],S[Y]=d,Y+=1}else if(i instanceof THREE.SphereLight){if(ot+=1,!i.visible)continue;ft=3*Q,Et.gammaInput?T(x,ft,o,l*l):P(x,ft,o,l),pa.copy(u.getPosition()),Xt.multiplyVector3(pa),y[ft]=pa.data[0],y[ft+1]=pa.data[1],y[ft+2]=pa.data[2],ft=2*Q,G[ft]=d,G[ft+1]=i.radius,Q+=1}else if(i instanceof THREE.TubeLight){if(nt+=1,!i.visible)continue;pt=3*J,Et.gammaInput?T(M,pt,o,l*l):P(M,pt,o,l),pa.copy(i.endPoint0.matrixWorld.getPosition()),Xt.multiplyVector3(pa),w[pt]=pa.data[0],w[pt+1]=pa.data[1],w[pt+2]=pa.data[2],pa.copy(i.endPoint1.matrixWorld.getPosition()),Xt.multiplyVector3(pa),X[pt]=pa.data[0],X[pt+1]=pa.data[1],X[pt+2]=pa.data[2],pt=2*J,D[pt]=d,D[pt+1]=i.radius,J+=1}else if(i instanceof THREE.SpotLight){if(st+=1,!i.visible)continue;mt=3*$,Et.gammaInput?T(C,mt,o,l*l):P(C,mt,o,l),pa.copy(u.getPosition()),Xt.multiplyVector3(pa),_[mt]=pa.data[0],_[mt+1]=pa.data[1],_[mt+2]=pa.data[2],ma.copy(u.getPosition()),ma.subSelf(i.target.matrixWorld.getPosition()),ma.normalize(),Xt.rotateAxis(ma),b[mt]=ma.data[0],b[mt+1]=ma.data[1],b[mt+2]=ma.data[2],mt=4*$,A[mt]=Math.cos(.5*i.angle),A[mt+1]=i.exponent,A[mt+2]=d,A[mt+3]=i.castShadow?yt:xt,i.castShadow&&Mt.push(i),$+=1}else if(i instanceof THREE.HemisphereLight){if(lt+=1,!i.visible)continue;if(ma.copy(u.getPosition()),ma.normalize(),Xt.rotateAxis(ma),0===ma.data[0]&&0===ma.data[1]&&0===ma.data[2])continue;vt=3*et,F[vt]=ma.data[0],F[vt+1]=ma.data[1],F[vt+2]=ma.data[2],n=i.color,s=i.groundColor,Et.gammaInput?(h=l*l,T(L,vt,n,h),T(E,vt,s,h)):(P(L,vt,n,l),P(E,vt,s,l)),et+=1}else if(i instanceof THREE.AreaLight){if(ht+=1,!i.visible)continue;gt=3*tt,Et.gammaInput?T(R,gt,o,l*l):P(R,gt,o,l),pa.copy(u.getPosition()),Xt.multiplyVector3(pa),U[gt]=pa.data[0],U[gt+1]=pa.data[1],U[gt+2]=pa.data[2],va.copy(i.normal),u.rotateAxis(va),Xt.rotateAxis(va),N[gt]=va.data[0],N[gt+1]=va.data[1],N[gt+2]=va.data[2],ga.copy(i.right),u.rotateAxis(ga),Xt.rotateAxis(ga),I[gt]=ga.data[0],I[gt+1]=ga.data[1],I[gt+2]=ga.data[2],Sa.cross(ga,va),Sa.normalize(),B[gt]=Sa.data[0],B[gt+1]=Sa.data[1],B[gt+2]=Sa.data[2],V[tt]=i.texture,k[gt]=i.constantAttenuation,k[gt+1]=i.linearAttenuation,k[gt+2]=i.quadraticAttenuation,gt=4*tt,O[gt]=i.width,O[gt+1]=i.height,O[gt+2]=i.texture?1:0,O[gt+3]=i.castShadow?yt:xt,i.castShadow&&wt.push(i),tt+=1}else if(i instanceof THREE.ImageLight){if(dt+=1,!i.visible)continue;St=3*at,H[at]=i.textureDiffuse,W[at]=i.textureSpecular,j[at]=i.textureMip,i.textureDiffuse instanceof THREE.RenderTargetCube&&(l/=Et.brightness),h=Et.gammaInput?l*l:l,z[St]=i.textureSpecular.mipmapCount,z[St+1]=h,z[St+2]=i.local?1:0;var Dt=i.size.data;Z[St]=Dt[0],Z[St+1]=Dt[1],Z[St+2]=Dt[2],pa.copy(u.getPosition()),q[St]=pa.data[0],q[St+1]=pa.data[1],q[St+2]=pa.data[2],at+=1}else if(i instanceof THREE.DayLight){if(lt+=1,rt+=1,!i.visible)continue;if(ma.copy(i.hemiPosition),ma.normalize(),Xt.rotateAxis(ma),0===ma.data[0]&&0===ma.data[1]&&0===ma.data[2])continue;if(vt=3*et,F[vt]=ma.data[0],F[vt+1]=ma.data[1],F[vt+2]=ma.data[2],n=i.color,s=i.groundColor,l=i.hemiIntensity,Et.gammaInput?(h=l*l,T(L,vt,n,h),T(E,vt,s,h)):(P(L,vt,n,l),P(E,vt,s,l)),et+=1,ma.copy(u.getPosition()),ma.subSelf(i.target.matrixWorld.getPosition()),ma.normalize(),Xt.rotateAxis(ma),0===ma.data[0]&&0===ma.data[1]&&0===ma.data[2])continue;ut=3*K,p[ut]=ma.data[0],p[ut+1]=ma.data[1],p[ut+2]=ma.data[2],m[K]=i.castShadow?yt:xt,l=i.sunIntensity,Et.gammaInput?T(f,ut,o,l*l):P(f,ut,o,l),i.castShadow&&Gt.push(i),K+=1}else if(i instanceof THREE.DayLightCube){if(dt+=1,rt+=1,!i.visible)continue;St=3*at,H[at]=i.textureDiffuse,W[at]=i.textureSpecular,j[at]=i.textureMip;var Ct=i.ambientIntensity;if(h=Et.gammaInput?Ct*Ct:Ct,z[St]=i.textureSpecular.mipmapCount,z[St+1]=h,z[St+2]=i.local?1:0,Z[St]=0,Z[St+1]=0,Z[St+2]=0,pa.copy(u.getPosition()),q[St]=pa.data[0],q[St+1]=pa.data[1],q[St+2]=pa.data[2],at+=1,ma.copy(u.getPosition()),ma.subSelf(i.target.matrixWorld.getPosition()),ma.normalize(),Xt.rotateAxis(ma),0===ma.data[0]&&0===ma.data[1]&&0===ma.data[2])continue;ut=3*K,p[ut]=ma.data[0],p[ut+1]=ma.data[1],p[ut+2]=ma.data[2],m[K]=i.castShadow?yt:xt,Et.gammaInput?T(f,ut,o,l*l):P(f,ut,o,l),i.castShadow&&Gt.push(i),K+=1}i.castShadow&&(yt+=1)}var _t=c.shadowCasters;_t.length=0;var bt,At,Tt;for(bt=0,At=Gt.length;At>bt;bt++)Tt=Gt[bt],_t.push(Tt);for(bt=0,At=Mt.length;At>bt;bt++)Tt=Mt[bt],_t.push(Tt);for(bt=0,At=wt.length;At>bt;bt++)Tt=wt[bt],_t.push(Tt);for(a=3*K,r=Math.max(f.length,3*rt);r>a;a++)f[a]=0;for(a=3*Y,r=Math.max(v.length,3*it);r>a;a++)v[a]=0;for(a=3*Q,r=Math.max(x.length,3*ot);r>a;a++)x[a]=0;for(a=3*J,r=Math.max(M.length,3*nt);r>a;a++)M[a]=0;for(a=3*$,r=Math.max(C.length,3*st);r>a;a++)C[a]=0;for(a=3*et,r=Math.max(L.length,3*lt);r>a;a++)L[a]=0;for(a=3*et,r=Math.max(E.length,3*lt);r>a;a++)E[a]=0;for(a=3*tt,r=Math.max(R.length,3*ht);r>a;a++)R[a]=0;c.directional.length=K,c.point.length=Y,c.sphere.length=Q,c.tube.length=J,c.spot.length=$,c.hemi.length=et,c.area.length=tt,c.image.length=at}function E(e){var t,a,r=[];for(var i in e)t=e[i],t!==!1&&(a="#define "+i+" "+t,r.push(a));return r.join("\n")}function F(e,t,a,r,i,o,n){var s=[];e?s.push(e):(s.push(t),s.push(a));var l;for(l in r)s.push(l),s.push(r[l]);for(l in n)s.push(l),s.push(n[l]);for(var h=s.join(),d=0,u=Ft.length;u>d;d++){var c=Ft[d];if(c.code===h)return c.usedTimes++,c.program}var f="SHADOWMAP_TYPE_BASIC";n.shadowMapType===THREE.PCFShadowMap?f="SHADOWMAP_TYPE_PCF":n.shadowMapType===THREE.PCFSoftShadowMap&&(f="SHADOWMAP_TYPE_PCF_SOFT");var p;switch(xt){case THREE.SimpleOperator:p="TONEMAP_SIMPLE";break;case THREE.LinearOperator:p="TONEMAP_LINEAR";break;case THREE.ReinhardOperator:p="TONEMAP_REINHARD";break;case THREE.FilmicOperator:p="TONEMAP_FILMIC";break;case THREE.UnchartedOperator:p="TONEMAP_UNCHARTED";break;case THREE.LumaReinhardOperator:p="TONEMAP_REINHARD_LUMA";break;case THREE.WhitePreservingReinhardOperator:p="TONEMAP_REINHARD_WHITE"}var m;switch(Et.specularBRDF){case THREE.SimpleBRDF:m="BRDF_SIMPLE";break;case THREE.BlinnPhongBRDF:m="BRDF_BLINN_PHONG";break;case THREE.GGXBRDF:m="BRDF_GGX"}var v=E(r),g=yt.createProgram(),S=["precision "+ht+" float;","precision "+ht+" int;",v,Et.gammaInput?"#define GAMMA_INPUT":"",Et.gammaOutput?"#define GAMMA_OUTPUT":"",Et.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",xt?"#define TONEMAPPING":"",p?"#define "+p:"","#define "+m,"#define MAX_DIR_LIGHTS "+n.maxDirLights,"#define MAX_POINT_LIGHTS "+n.maxPointLights,"#define MAX_SPHERE_LIGHTS "+n.maxSphereLights,"#define MAX_TUBE_LIGHTS "+n.maxTubeLights,"#define MAX_SPOT_LIGHTS "+n.maxSpotLights,"#define MAX_HEMI_LIGHTS "+n.maxHemiLights,"#define MAX_AREA_LIGHTS "+n.maxAreaLights,"#define MAX_IMAGE_LIGHTS "+n.maxImageLights,n.areaTextures?"#define AREA_TEXTURE":"",Pa&&Et.shadowMapUseDepthTextures?"#define DEPTH_TEXTURES":"","#define MAX_SHADOWS "+n.maxShadows,n.alphaTest?"#define ALPHATEST "+n.alphaTest:"",n.map?"#define USE_MAP":"",n.lightMap?"#define USE_LIGHTMAP":"",Ra&&n.bumpMap?"#define USE_BUMPMAP":"",Ra&&n.normalMap?"#define USE_NORMALMAP":"",Ra&&n.normalGlossMap?"#define USE_NORMALGLOSSMAP":"",n.glossMap?"#define USE_GLOSSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.vertexColors?"#define USE_COLOR":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+f:"",n.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",n.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","#define DIR_INDEX_OFFSET "+n.dirIndexOffset,"#define SPOT_INDEX_OFFSET "+n.spotIndexOffset,"#define AREA_INDEX_OFFSET "+n.areaIndexOffset,n.isParticle?"#define PARTICLE":"",n.sizeAttenuation?"#define USE_PARTICLE_SIZEATTENUATION":"",n.interpolateParticleFrames?"#define INTERPOLATE_PARTICLE_FRAMES":"",n.wrapAround?"#define WRAP_AROUND":"",Ra&&n.wrapAroundSkin?"#define WRAP_AROUND_SKIN":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.osxHack?"#define OSX_HACK":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",""].join("\n"),x=[Da?"#define VERTEX_TEXTURES":"","#define MAX_BONES "+n.maxBones,n.skinning?"#define USE_SKINNING":"",n.useVertexTexture?"#define BONE_TEXTURE":"",n.boneTextureWidth?"#define N_BONE_PIXEL_X "+n.boneTextureWidth.toFixed(1):"",n.boneTextureHeight?"#define N_BONE_PIXEL_Y "+n.boneTextureHeight.toFixed(1):"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals?"#define USE_MORPHNORMALS":"","#define MAX_MORPHTARGETS "+n.maxMorphTargets,"#define MAX_MORPHNORMALS "+n.maxMorphNormals,"uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat3 normalMatrix;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","attribute vec2 uv2;","#ifdef USE_COLOR","attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n"),y=[Ra&&(n.bumpMap||n.normalMap||n.normalGlossMap||n.wrapAroundSkin)?"#extension GL_OES_standard_derivatives : enable":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp?"#define FOG_EXP2":"",n.metal?"#define METAL":"",n.parallax?"#define USE_PARALLAX":"",n.parallax&&n.parallaxRefineSteps>0?"#define PARALLAX_REFINE_STEPS "+n.parallaxRefineSteps.toFixed(0):"",""].join("\n"),G=I("fragment",S+y+t),M=I("vertex",S+x+a);yt.attachShader(g,M),yt.attachShader(g,G),yt.linkProgram(g),yt.getProgramParameter(g,yt.LINK_STATUS)||console.error("Could not initialise shader\nINFO_LOG: "+yt.getProgramInfoLog(g)+"\nVALIDATE_STATUS: "+yt.getProgramParameter(g,yt.VALIDATE_STATUS)+"\nGL_ERROR: "+yt.getError()),yt.deleteShader(G),yt.deleteShader(M),g.uniforms={},g.attributes={};var w;w=[];for(l in i)w.push(l);R(g,w),w=[];for(l in o)w.push(l);return U(g,w),g.id=Rt++,Ft.push({program:g,code:h,usedTimes:1}),Et.info.memory.programs=Ft.length,g}function R(e,t){var a,r,i;for(a=0,r=t.length;r>a;a++)i=t[a],e.uniforms[i]=yt.getUniformLocation(e,i)}function U(e,t){var a,r,i;for(a=0,r=t.length;r>a;a++)i=t[a],e.attributes[i]=yt.getAttribLocation(e,i)}function N(e){for(var t,a,r=0,i=0,o={};r>=0&&(r=e.indexOf("ERROR: 0:",r),!(0>r));)r+=9,i=e.indexOf(":",r),i>r&&(t=parseInt(e.substring(r,i),10),r=i+1,i=e.indexOf("\n",r),a=i>r?e.substring(r,i):e.substring(r),void 0===o[t]?o[t]=a:o[t]+=", "+a);return o}function I(e,t){var a;if("fragment"===e?a=yt.createShader(yt.FRAGMENT_SHADER):"vertex"===e&&(a=yt.createShader(yt.VERTEX_SHADER)),yt.shaderSource(a,t),yt.compileShader(a),!yt.getShaderParameter(a,yt.COMPILE_STATUS)){var r=yt.getShaderInfoLog(a),i=N(r);return console.error(e.toUpperCase()+" SHADER COMPILATION ERRORS:\n\n"+r),ir(t,i),null}return a}function B(e){return 0===(e&e-1)}function O(e,t,a){a?(yt.texParameteri(e,yt.TEXTURE_WRAP_S,t.wrapS),yt.texParameteri(e,yt.TEXTURE_WRAP_T,t.wrapT),yt.texParameteri(e,yt.TEXTURE_MAG_FILTER,t.magFilter),yt.texParameteri(e,yt.TEXTURE_MIN_FILTER,t.minFilter)):(yt.texParameteri(e,yt.TEXTURE_WRAP_S,yt.CLAMP_TO_EDGE),yt.texParameteri(e,yt.TEXTURE_WRAP_T,yt.CLAMP_TO_EDGE),yt.texParameteri(e,yt.TEXTURE_MAG_FILTER,$(t.magFilter)),yt.texParameteri(e,yt.TEXTURE_MIN_FILTER,$(t.minFilter))),Ct&&t.type!==THREE.FloatType&&(t.anisotropy>1||t.__oldAnisotropy)&&(yt.texParameterf(e,Ct.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,Xa)),t.__oldAnisotropy=t.anisotropy)}function k(e,t){if(e.width<=t&&e.height<=t)return e;var a=Math.max(e.width,e.height),r=Math.floor(e.width*t/a),i=Math.floor(e.height*t/a),o=document.createElement("canvas");o.width=r,o.height=i;var n=o.getContext("2d");return n.drawImage(e,0,0,e.width,e.height,0,0,r,i),o}function V(e,t){if(6===e.image.length)if(e.needsUpdate){e.image.__webglTextureCube||(e.image.__webglTextureCube=yt.createTexture(),Et.info.memory.textures++),yt.activeTexture(yt.TEXTURE0+t),yt.bindTexture(yt.TEXTURE_CUBE_MAP,e.image.__webglTextureCube),da[t]=e.id,yt.pixelStorei(yt.UNPACK_FLIP_Y_WEBGL,e.flipY),yt.pixelStorei(yt.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),yt.pixelStorei(yt.UNPACK_ALIGNMENT,e.unpackAlignment);for(var a=e instanceof THREE.CompressedTexture,r=[],i=0;6>i;i++)r[i]=Et.autoScaleCubemaps&&!a?k(e.image[i],wa):e.image[i];var o=r[0],n=B(o.width)&&B(o.height),s=e.format,l=e.type;O(yt.TEXTURE_CUBE_MAP,e,n);for(var i=0;6>i;i++){var h=r[i].mipmaps;if(h&&h.length>0)for(var d=0,u=h.length;u>d;d++){var c=h[d];yt.pixelStorei(yt.UNPACK_ALIGNMENT,c.unpackAlignment),s===THREE.RGBAFormat||s===THREE.RGBFormat?yt.texImage2D(yt.TEXTURE_CUBE_MAP_POSITIVE_X+i,d,s,c.width,c.height,0,s,l,c.data):yt.compressedTexImage2D(yt.TEXTURE_CUBE_MAP_POSITIVE_X+i,d,s,c.width,c.height,0,c.data)}else yt.texImage2D(yt.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,s,s,l,r[i])}e.generateMipmaps&&n&&(yt.generateMipmap(yt.TEXTURE_CUBE_MAP),e.mipmapCount=Math.log(Math.max(o.width,o.height))/Math.LN2),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()}else da[t]!==e.id&&(yt.activeTexture(yt.TEXTURE0+t),yt.bindTexture(yt.TEXTURE_CUBE_MAP,e.image.__webglTextureCube),da[t]=e.id)}function z(e,t){da[t]!==e.id&&(yt.activeTexture(yt.TEXTURE0+t),yt.bindTexture(yt.TEXTURE_CUBE_MAP,e.__webglTexture),da[t]=e.id)}function H(e,t,a,r,i){yt.bindFramebuffer(yt.FRAMEBUFFER,e),i&&yt.framebufferTexture2D(yt.FRAMEBUFFER,yt.COLOR_ATTACHMENT0,a,t.__webglTexture,0),r&&yt.framebufferTexture2D(yt.FRAMEBUFFER,yt.DEPTH_ATTACHMENT,a,t.depthTexture.__webglTexture,0)}function W(e,t){yt.bindRenderbuffer(yt.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(yt.renderbufferStorage(yt.RENDERBUFFER,yt.DEPTH_COMPONENT16,t.width,t.height),yt.framebufferRenderbuffer(yt.FRAMEBUFFER,yt.DEPTH_ATTACHMENT,yt.RENDERBUFFER,e)):!t.depthBuffer&&t.stencilBuffer?(yt.renderbufferStorage(yt.RENDERBUFFER,yt.STENCIL_INDEX8,t.width,t.height),yt.framebufferRenderbuffer(yt.FRAMEBUFFER,yt.STENCIL_ATTACHMENT,yt.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer&&(yt.renderbufferStorage(yt.RENDERBUFFER,yt.DEPTH_STENCIL,t.width,t.height),yt.framebufferRenderbuffer(yt.FRAMEBUFFER,yt.DEPTH_STENCIL_ATTACHMENT,yt.RENDERBUFFER,e))}function j(e){if(!La)return void console.error("THREE.ForwardRenderer: can't create RenderTargetArray");var t=e.colorTexture.length;e.__webglFramebuffer=yt.createFramebuffer(),e.__attachments=[],yt.bindFramebuffer(yt.FRAMEBUFFER,e.__webglFramebuffer);for(var a=0;t>a;a++)e.__attachments.push(yt.COLOR_ATTACHMENT0+a);Tt.drawBuffersEXT?Tt.drawBuffersEXT(e.__attachments):Tt.drawBuffersWEBGL(e.__attachments),e.__webglTexture=[];for(var a=0;t>a;a++){var r=e.colorTexture[a];r.__webglTexture=yt.createTexture(),Et.info.memory.textures++}e.depthTexture?(e.depthTexture.__webglTexture=yt.createTexture(),Et.info.memory.textures++):e.__webglRenderbuffer=yt.createRenderbuffer()}function q(e){var t=B(e.width)&&B(e.height),a=e.colorTexture.length;yt.bindFramebuffer(yt.FRAMEBUFFER,e.__webglFramebuffer);for(var r=0;a>r;r++){var i=e.__attachments[r],o=e.colorTexture[r],n=o.format,s=o.type;yt.bindTexture(yt.TEXTURE_2D,o.__webglTexture),O(yt.TEXTURE_2D,o,t),yt.texImage2D(yt.TEXTURE_2D,0,n,e.width,e.height,0,n,s,null),yt.framebufferTexture2D(yt.FRAMEBUFFER,i,yt.TEXTURE_2D,o.__webglTexture,0),o.needsUpdate=!1}e.depthTexture?(yt.bindTexture(yt.TEXTURE_2D,e.depthTexture.__webglTexture),O(yt.TEXTURE_2D,e.depthTexture,t),yt.texImage2D(yt.TEXTURE_2D,0,yt.DEPTH_COMPONENT,e.width,e.height,0,yt.DEPTH_COMPONENT,e.depthTexture.depthTextureType,null),yt.framebufferTexture2D(yt.FRAMEBUFFER,yt.DEPTH_ATTACHMENT,yt.TEXTURE_2D,e.depthTexture.__webglTexture,0),e.depthTexture.needsUpdate=!1):W(e.__webglRenderbuffer,e)}function Z(e){e.__webglFramebuffer=[],e.__webglRenderbuffer=[],e.__webglTexture=yt.createTexture();for(var t=0;6>t;t++)e.__webglFramebuffer[t]=yt.createFramebuffer(),e.__webglRenderbuffer[t]=yt.createRenderbuffer();Et.info.memory.textures++}function K(e){var t=B(e.width)&&B(e.height),a=e.format,r=e.type;yt.activeTexture(yt.TEXTURE0),yt.bindTexture(yt.TEXTURE_CUBE_MAP,e.__webglTexture),O(yt.TEXTURE_CUBE_MAP,e,t);for(var i=0;6>i;i++)yt.texImage2D(yt.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,a,e.width,e.height,0,a,r,null),H(e.__webglFramebuffer[i],e,yt.TEXTURE_CUBE_MAP_POSITIVE_X+i,!1,!0),W(e.__webglRenderbuffer[i],e);t&&(e.generateMipmaps||e.minFilter!==THREE.NearestFilter&&e.minFilter!==THREE.LinearFilter)&&yt.generateMipmap(yt.TEXTURE_CUBE_MAP),t&&(e.mipmapCount=Math.log(Math.max(e.width,e.height))/Math.LN2)}function Y(e){var t=e.useColorTexture,a=e.useDepthTexture&&Pa;e.__webglFramebuffer=yt.createFramebuffer(),t&&(e.__webglTexture=yt.createTexture(),Et.info.memory.textures++),e.shareDepthFrom||(a?(e.depthTexture={__webglTexture:yt.createTexture(),id:THREE.TextureIdCount++},Et.info.memory.textures++):e.__webglRenderbuffer=yt.createRenderbuffer())}function Q(e){var t=e.useColorTexture,a=e.useDepthTexture&&Pa,r=B(e.width)&&B(e.height),i=e.format,o=e.type;t&&(yt.activeTexture(yt.TEXTURE0),yt.bindTexture(yt.TEXTURE_2D,e.__webglTexture),O(yt.TEXTURE_2D,e,r),yt.texImage2D(yt.TEXTURE_2D,0,i,e.width,e.height,0,i,o,null),r&&e.generateMipmaps&&yt.generateMipmap(yt.TEXTURE_2D)),a&&(e.shareDepthFrom?e.depthTexture=e.shareDepthFrom.depthTexture:(yt.bindTexture(yt.TEXTURE_2D,e.depthTexture.__webglTexture),O(yt.TEXTURE_2D,e,r),yt.texImage2D(yt.TEXTURE_2D,0,yt.DEPTH_COMPONENT,e.width,e.height,0,yt.DEPTH_COMPONENT,e.depthTextureType,null))),H(e.__webglFramebuffer,e,yt.TEXTURE_2D,a,t),a||(e.shareDepthFrom&&e.shareDepthFrom.depthTexture?(e.depthTexture=e.shareDepthFrom.depthTexture,yt.framebufferTexture2D(yt.FRAMEBUFFER,yt.DEPTH_ATTACHMENT,yt.TEXTURE_2D,e.depthTexture.__webglTexture,0)):e.shareDepthFrom?(e.__webglRenderbuffer=e.shareDepthFrom.__webglRenderbuffer,e.depthBuffer&&!e.stencilBuffer?yt.framebufferRenderbuffer(yt.FRAMEBUFFER,yt.DEPTH_ATTACHMENT,yt.RENDERBUFFER,e.__webglRenderbuffer):e.depthBuffer&&e.stencilBuffer&&yt.framebufferRenderbuffer(yt.FRAMEBUFFER,yt.DEPTH_STENCIL_ATTACHMENT,yt.RENDERBUFFER,e.__webglRenderbuffer)):W(e.__webglRenderbuffer,e))}function J(e){if(yt.activeTexture(yt.TEXTURE0),e instanceof THREE.RenderTargetCube)yt.bindTexture(yt.TEXTURE_CUBE_MAP,e.__webglTexture),yt.generateMipmap(yt.TEXTURE_CUBE_MAP),yt.bindTexture(yt.TEXTURE_CUBE_MAP,null);else if(e instanceof THREE.RenderTargetArray){for(var t=0,a=e.colorTexture.length;a>t;t++)yt.bindTexture(yt.TEXTURE_2D,e.colorTexture[t].__webglTexture),yt.generateMipmap(yt.TEXTURE_2D);yt.bindTexture(yt.TEXTURE_2D,null)}else yt.bindTexture(yt.TEXTURE_2D,e.__webglTexture),yt.generateMipmap(yt.TEXTURE_2D),yt.bindTexture(yt.TEXTURE_2D,null);da[0]=-1}function $(e){return e===THREE.NearestFilter||e===THREE.NearestMipMapNearestFilter||e===THREE.NearestMipMapLinearFilter?yt.NEAREST:yt.LINEAR}function et(e){if(Ca&&e&&e.useVertexTexture)return 1024;var t=yt.getParameter(yt.MAX_VERTEX_UNIFORM_VECTORS),a=Math.floor((t-20)/4),r=a;return void 0!==e&&e instanceof THREE.SkinnedMesh&&(r=Math.min(e.bones.length,r),r<e.bones.length&&console.warn("THREE.ForwardRenderer: too many bones - "+e.bones.length+", this GPU supports just "+r+" (try OpenGL instead of ANGLE)")),r}function tt(e){var t,a,r,i,o,n,s,l,h,d,u,c,f;a=r=i=o=n=s=l=h=d=0,u=c=f=0;for(var p=0,m=e.length;m>p;p++)t=e[p],t.onlyShadow||(t instanceof THREE.DirectionalLight&&(a++,t.castShadow&&u++),t instanceof THREE.SpotLight&&(n++,t.castShadow&&c++),t instanceof THREE.AreaLight&&(l++,t.texture&&h++,t.castShadow&&f++),t instanceof THREE.DayLight&&(a++,s++,t.castShadow&&u++),t instanceof THREE.DayLightCube&&(a++,d++,t.castShadow&&u++),t instanceof THREE.PointLight&&r++,t instanceof THREE.SphereLight&&i++,t instanceof THREE.TubeLight&&o++,t instanceof THREE.HemisphereLight&&s++,t instanceof THREE.ImageLight&&d++);var v=0,g=v+u,S=g+c,x={directional:a,point:r,sphere:i,tube:o,spot:n,hemi:s,area:l,areaTextures:h,image:d,dirIndexOffset:v,spotIndexOffset:g,areaIndexOffset:S};return x}function at(e){var t,a,r,i=0;for(t=0,a=e.length;a>t;t++)r=e[t],r.castShadow&&(r instanceof THREE.SpotLight&&i++,r instanceof THREE.AreaLight&&i++,(r instanceof THREE.DirectionalLight||r instanceof THREE.DayLight||r instanceof THREE.DayLightCube)&&!r.shadowCascade&&i++);return i}function rt(e,t){var a=yt.createFramebuffer(),r=yt.createTexture();yt.activeTexture(yt.TEXTURE0),yt.bindTexture(yt.TEXTURE_2D,r),yt.texImage2D(yt.TEXTURE_2D,0,e,2,2,0,e,t,null),yt.bindFramebuffer(yt.FRAMEBUFFER,a),yt.framebufferTexture2D(yt.FRAMEBUFFER,yt.COLOR_ATTACHMENT0,yt.TEXTURE_2D,r,0);var i=yt.checkFramebufferStatus(yt.FRAMEBUFFER);return yt.bindFramebuffer(yt.FRAMEBUFFER,null),yt.bindTexture(yt.TEXTURE_2D,null),da[0]=-1,i===yt.FRAMEBUFFER_COMPLETE}function it(){var e=yt.createFramebuffer(),t=yt.createTexture();yt.activeTexture(yt.TEXTURE0),yt.bindTexture(yt.TEXTURE_2D,t),yt.texImage2D(yt.TEXTURE_2D,0,yt.DEPTH_COMPONENT,2,2,0,yt.DEPTH_COMPONENT,THREE.UnsignedIntType,null),yt.bindFramebuffer(yt.FRAMEBUFFER,e),yt.framebufferTexture2D(yt.FRAMEBUFFER,yt.DEPTH_ATTACHMENT,yt.TEXTURE_2D,t,0);var a=yt.checkFramebufferStatus(yt.FRAMEBUFFER);return yt.bindFramebuffer(yt.FRAMEBUFFER,null),yt.bindTexture(yt.TEXTURE_2D,null),da[0]=-1,a===yt.FRAMEBUFFER_COMPLETE}function ot(){try{var e={alpha:dt,premultipliedAlpha:ut,antialias:ct,stencil:ft,depth:pt,preserveDrawingBuffer:mt};if(!(yt=lt.getContext("experimental-webgl",e)))throw"Error creating WebGL context."}catch(t){console.error(t)}Gt=yt.getExtension("OES_texture_float"),Mt=yt.getExtension("OES_texture_half_float"),wt=yt.getExtension("OES_texture_float_linear"),Xt=yt.getExtension("OES_texture_half_float_linear"),Dt=yt.getExtension("OES_standard_derivatives"),bt=yt.getExtension("OES_element_index_uint"),Ct=yt.getExtension("EXT_texture_filter_anisotropic")||yt.getExtension("MOZ_EXT_texture_filter_anisotropic")||yt.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),_t=yt.getExtension("WEBGL_compressed_texture_s3tc")||yt.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||yt.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),At=yt.getExtension("WEBGL_depth_texture")||yt.getExtension("MOZ_WEBGL_depth_texture")||yt.getExtension("WEBKIT_WEBGL_depth_texture"),Tt=yt.getExtension("EXT_draw_buffers")||yt.getExtension("WEBGL_draw_buffers")||yt.getExtension("WEBKIT_EXT_draw_buffers")||yt.getExtension("MOZ_EXT_draw_buffers"),Pt=yt.getExtension("EXT_frag_depth"),Lt=yt.getExtension("WEBGL_debug_shaders"),Gt||console.log("XG: float textures not supported."),Mt||console.log("XG: half float textures not supported."),wt||console.log("XG: linear filtering for float textures not supported."),Xt||console.log("XG: linear filtering for half float textures not supported."),Dt||console.log("XG: standard derivatives not supported."),Ct||console.log("XG: anisotropic texture filtering not supported."),_t||console.log("XG: S3TC compressed textures not supported."),bt||console.log("XG: 32-bit unsigned integer indices not supported."),At||console.log("XG: depth texture not supported."),Tt||console.log("XG: multiple render targets not supported."),Pt||console.log("XG: fragment depth setting not supported.")
}function nt(){yt.clearColor(0,0,0,1),yt.clearDepth(1),yt.clearStencil(0),yt.enable(yt.DEPTH_TEST),yt.depthFunc(yt.LEQUAL),yt.frontFace(yt.CCW),yt.cullFace(yt.BACK),yt.enable(yt.CULL_FACE),yt.enable(yt.BLEND),yt.blendEquation(yt.FUNC_ADD),yt.blendFunc(yt.SRC_ALPHA,yt.ONE_MINUS_SRC_ALPHA),yt.disable(yt.STENCIL_TEST),yt.clearColor(vt.r,vt.g,vt.b,gt)}function st(){Et.shadowMapPlugin=new THREE.ShadowMapPlugin,Et.addPrePlugin(Et.shadowMapPlugin)}e=e||{};var lt=void 0!==e.canvas?e.canvas:document.createElement("canvas"),ht=void 0!==e.precision?e.precision:"highp",dt=void 0!==e.alpha?e.alpha:!1,ut=void 0!==e.premultipliedAlpha?e.premultipliedAlpha:!0,ct=void 0!==e.antialias?e.antialias:!1,ft=void 0!==e.stencil?e.stencil:!0,pt=void 0!==e.depth?e.depth:!0,mt=void 0!==e.preserveDrawingBuffer?e.preserveDrawingBuffer:!1,vt=new THREE.Color(void 0!==e.clearColor?e.clearColor:0),gt=void 0!==e.clearAlpha?e.clearAlpha:0,St=void 0!==e.scale?e.scale:1,xt=void 0!==e.tonemapping?e.tonemapping:THREE.SimpleOperator;this.brightness=void 0!==e.brightness?e.brightness:1,this.domElement=lt,this.context=null,this.devicePixelRatio=void 0!==e.devicePixelRatio?e.devicePixelRatio:void 0!==window.devicePixelRatio?window.devicePixelRatio:1,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.autoUpdateObjects=!0,this.autoUpdateScene=!0,this.autoUpdateView=!0,this.gammaInput=!0,this.gammaOutput=!1,this.physicallyBasedShading=!0,this.specularBRDF=THREE.GGXBRDF,this.shadowMapEnabled=!1,this.shadowMapAutoUpdate=!0,this.shadowMapType=THREE.PCFSoftShadowMap,this.shadowMapCullFace=THREE.CullFaceFront,this.shadowMapDebug=!1,this.shadowMapCascade=!1,this.shadowMapUseDepthTextures=!1,this.shadowMapDepthTextureType=THREE.UnsignedIntType,this.shadowMapSlopeDepthBias=!1,this.shadowMapSlopeScale=2,this.shadowMapSlopeBias=0,this.shadowMapSlopeMax=.001,this.maxMorphTargets=4,this.maxMorphNormals=4,this.autoScaleCubemaps=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var yt,Gt,Mt,wt,Xt,Dt,Ct,_t,bt,At,Tt,Pt,Lt,Et=this,Ft=[],Rt=0,Ut=null,Nt=null,It=-1,Bt=null,Ot=null,kt=0,Vt=0,zt=-1,Ht=-1,Wt=-1,jt=-1,qt=-1,Zt=-1,Kt=-1,Yt=-1,Qt=null,Jt=null,$t=null,ea=0,ta=0,aa=0,ra=0,ia=0,oa=0,na={},sa=[],la={},ha=[],da=[],ua=new THREE.Frustum,ca=new THREE.Matrix4,fa=new THREE.Vector3,pa=new THREE.Vector3,ma=new THREE.Vector3,va=new THREE.Vector3,ga=new THREE.Vector3,Sa=new THREE.Vector3,xa=!0,ya={directional:{length:0,colors:[],positions:[],pars:[]},point:{length:0,colors:[],positions:[],distances:[]},sphere:{length:0,colors:[],positions:[],pars:[]},tube:{length:0,colors:[],positions0:[],positions1:[],pars:[]},spot:{length:0,colors:[],positions:[],directions:[],pars:[]},area:{length:0,colors:[],positions:[],normals:[],rights:[],ups:[],attenuations:[],pars:[],textures:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]},image:{length:0,positions:[],sizes:[],texturesDiffuse:[],texturesSpecular:[],texturesMip:[],pars:[]},shadowCasters:[]};ot(),nt(),this.context=yt;{var Ga=yt.getParameter(yt.MAX_TEXTURE_IMAGE_UNITS),Ma=yt.getParameter(yt.MAX_VERTEX_TEXTURE_IMAGE_UNITS),wa=(yt.getParameter(yt.MAX_TEXTURE_SIZE),yt.getParameter(yt.MAX_CUBE_MAP_TEXTURE_SIZE)),Xa=Ct?yt.getParameter(Ct.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,Da=Ma>0,Ca=Da&&Gt,_a=!!Gt,ba=!!Mt,Aa=!!wt,Ta=!!Xt,Pa=!!At,La=!!Tt,Ea=!!Pt,Fa=!!bt,Ra=!!Dt;_t?yt.getParameter(yt.COMPRESSED_TEXTURE_FORMATS):[]}THREE.elementIndexUintAvailable=!!bt;{var Ua=yt.getShaderPrecisionFormat(yt.VERTEX_SHADER,yt.HIGH_FLOAT),Na=yt.getShaderPrecisionFormat(yt.VERTEX_SHADER,yt.MEDIUM_FLOAT),Ia=(yt.getShaderPrecisionFormat(yt.VERTEX_SHADER,yt.LOW_FLOAT),yt.getShaderPrecisionFormat(yt.FRAGMENT_SHADER,yt.HIGH_FLOAT)),Ba=yt.getShaderPrecisionFormat(yt.FRAGMENT_SHADER,yt.MEDIUM_FLOAT);yt.getShaderPrecisionFormat(yt.FRAGMENT_SHADER,yt.LOW_FLOAT),yt.getShaderPrecisionFormat(yt.VERTEX_SHADER,yt.HIGH_INT),yt.getShaderPrecisionFormat(yt.VERTEX_SHADER,yt.MEDIUM_INT),yt.getShaderPrecisionFormat(yt.VERTEX_SHADER,yt.LOW_INT),yt.getShaderPrecisionFormat(yt.FRAGMENT_SHADER,yt.HIGH_INT),yt.getShaderPrecisionFormat(yt.FRAGMENT_SHADER,yt.MEDIUM_INT),yt.getShaderPrecisionFormat(yt.FRAGMENT_SHADER,yt.LOW_INT)}console.log("XG: render target support autodetection START (please ignore following warnings)");var Oa=Gt&&rt(yt.RGB,yt.FLOAT),ka=Gt&&rt(yt.RGBA,yt.FLOAT),Va=Gt&&rt(yt.LUMINANCE,yt.FLOAT),za=Gt&&rt(yt.ALPHA,yt.FLOAT),Ha=Gt&&rt(yt.LUMINANCE_ALPHA,yt.FLOAT),Wa=Pa&&it();console.log("XG: render target support autodetection END");var ja=Ua.precision>0&&Ia.precision>0,qa=Na.precision>0&&Ba.precision>0;"highp"!==ht||ja||(qa?(ht="mediump",console.warn("THREE.ForwardRenderer: highp not supported, using mediump")):(ht="lowp",console.warn("THREE.ForwardRenderer: highp and mediump not supported, using lowp"))),"mediump"!==ht||qa||(ht="lowp",console.warn("THREE.ForwardRenderer: mediump not supported, using lowp"));var Za=!1;this.getContext=function(){return yt},this.supportsStandardDerivatives=function(){return Ra},this.supportsElementIndexUint=function(){return Fa},this.supportsFloatTextures=function(){return _a},this.supportsHalfFloatTextures=function(){return ba},this.supportsFloatTexturesLinear=function(){return Aa},this.supportsHalfFloatTexturesLinear=function(){return Ta},this.supportsVertexTextures=function(){return Da},this.supportsLuminanceFloatRenderTarget=function(){return Va},this.supportsAlphaFloatRenderTarget=function(){return za},this.supportsLuminanceAlphaFloatRenderTarget=function(){return Ha},this.supportsRGBFloatRenderTarget=function(){return Oa},this.supportsRGBAFloatRenderTarget=function(){return ka},this.supportsDepthOnlyRenderTarget=function(){return Wa},this.supportsDepthTextures=function(){return Pa},this.supportsDrawBuffers=function(){return La},this.supportsFragDepth=function(){return Ea},this.getMaxAnisotropy=function(){return Xa},this.getPrecision=function(){return ht},this.setSize=function(e,t){lt.width=e*this.devicePixelRatio,lt.height=t*this.devicePixelRatio,lt.style.width=e+"px",lt.style.height=t+"px",this.setViewport(0,0,lt.width,lt.height)},this.setScale=function(e){St=e},this.setViewport=function(e,t,a,r){ea=void 0!==e?e:0,ta=void 0!==t?t:0,aa=void 0!==a?a:lt.width,ra=void 0!==r?r:lt.height,yt.viewport(ea,ta,aa,ra)},this.setScissor=function(e,t,a,r){yt.scissor(e,t,a,r)},this.enableScissorTest=function(e){e?yt.enable(yt.SCISSOR_TEST):yt.disable(yt.SCISSOR_TEST)},this.setClearColorHex=function(e,t){vt.setHex(e),gt=t,xt&&vt.copyTonemapped(vt,xt,Et.brightness),yt.clearColor(vt.r,vt.g,vt.b,gt)},this.setClearColor=function(e,t){xt?vt.copyTonemapped(e,xt,Et.brightness):vt.copy(e),gt=t,yt.clearColor(vt.r,vt.g,vt.b,gt)},this.getClearColor=function(){return vt},this.getClearAlpha=function(){return gt},this.clear=function(e,t,a){var r=0;(void 0===e||e)&&(r|=yt.COLOR_BUFFER_BIT),(void 0===t||t)&&(r|=yt.DEPTH_BUFFER_BIT),(void 0===a||a)&&(r|=yt.STENCIL_BUFFER_BIT),yt.clear(r)},this.clearTarget=function(e,t,a,r){this.setRenderTarget(e),this.clear(t,a,r)},this.addPostPlugin=function(e){e.init(this),this.renderPluginsPost.push(e)},this.addPrePlugin=function(e){e.init(this),this.renderPluginsPre.push(e)},this.updateShadowMap=function(e,t){Ut=null,Wt=-1,Kt=-1,Yt=-1,Bt=-1,It=-1,xa=!0,zt=-1,Ht=-1,this.shadowMapPlugin.update(e,t)};var Ka=function(e){var t=e.program;if(void 0!==t){e.program=void 0;var a,r,i,o=!1;for(a=0,r=Ft.length;r>a;a++)if(i=Ft[a],i.program===t){i.usedTimes--,0===i.usedTimes&&(o=!0);break}if(o===!0){var n=[];for(a=0,r=Ft.length;r>a;a++)i=Ft[a],i.program!==t&&n.push(i);Ft=n,yt.deleteProgram(t),Et.info.memory.programs--}}},Ya=function(e){for(var t=0,a=e.attributesList.length;a>t;t++){var r=e.attributesList[t];r.buffer||(r.buffer=yt.createBuffer())}},Qa=function(e){for(var t,a,r=e.dynamic?yt.DYNAMIC_DRAW:yt.STATIC_DRAW,i=e.attributesList,o=0,n=i.length;n>o;o++)a=i[o],a.needsUpdate&&(t="index"===a.name?yt.ELEMENT_ARRAY_BUFFER:yt.ARRAY_BUFFER,yt.bindBuffer(t,a.buffer),yt.bufferData(t,a.array,r),a.needsUpdate=!1,e.dynamic||delete a.array)},Ja=function(e,t,r){for(var i,o,n,s,l,h=t.virtualAttributesList,d=0,u=h.length;u>d;d++)i=h[d],n=i.mapped,n&&(o=e[i.name],0>o||(s=n.buffer,l=n.itemSize,a(o),yt.bindBuffer(yt.ARRAY_BUFFER,s),yt.vertexAttribPointer(o,l,yt.FLOAT,!1,0,r*l*4)))},$a=function(e,t,a,r){for(var i,n=a.numSupportedMorphTargets,s=[],l=e.morphTargetInfluences,h=0,d=l.length;d>h;h++)i=l[h],i>0&&s.push([i,h]);s.length>n?(s.sort(o),s.length=n):0===s.length&&s.push([0,0]),e.__morphTargetInfluencesArray||(e.__morphTargetInfluencesArray=new Float32Array(Et.maxMorphTargets));for(var u,c,f=e.__morphTargetInfluencesArray,p=t.virtualAttributes,m=t.attributesList,v=t.morphTargets,g=0;n>g;)s[g]?(u=s[g][1],c=v[u].index,p["morphTarget"+g].mapped=m[c],p["morphNormal"+g].mapped=m[c+1],f[g]=l[u]):f[g]=0,g++;null!==r.uniforms.morphTargetInfluences&&yt.uniform1fv(r.uniforms.morphTargetInfluences,f)};this.renderImmediateGeometry=function(e,t,a){e.hasPositions&&!e.__webglVertexBuffer&&(e.__webglVertexBuffer=yt.createBuffer()),e.hasNormals&&!e.__webglNormalBuffer&&(e.__webglNormalBuffer=yt.createBuffer()),e.hasUvs&&!e.__webglUvBuffer&&(e.__webglUvBuffer=yt.createBuffer()),e.hasColors&&!e.__webglColorBuffer&&(e.__webglColorBuffer=yt.createBuffer());var r=t.attributes;e.hasPositions&&r.position>=0&&(yt.bindBuffer(yt.ARRAY_BUFFER,e.__webglVertexBuffer),yt.bufferData(yt.ARRAY_BUFFER,e.positionArray,yt.STREAM_DRAW),yt.enableVertexAttribArray(r.position),yt.vertexAttribPointer(r.position,3,yt.FLOAT,!1,0,0)),e.hasNormals&&r.normal>=0&&(yt.bindBuffer(yt.ARRAY_BUFFER,e.__webglNormalBuffer),yt.bufferData(yt.ARRAY_BUFFER,e.normalArray,yt.STREAM_DRAW),yt.enableVertexAttribArray(r.normal),yt.vertexAttribPointer(r.normal,3,yt.FLOAT,!1,0,0)),e.hasUvs&&r.uv>=0&&(a.map||a.lightMap||a.bumpMap||a.normalMap||a.normalGlossMap)&&(yt.bindBuffer(yt.ARRAY_BUFFER,e.__webglUvBuffer),yt.bufferData(yt.ARRAY_BUFFER,e.uvArray,yt.STREAM_DRAW),yt.enableVertexAttribArray(r.uv),yt.vertexAttribPointer(r.uv,2,yt.FLOAT,!1,0,0)),e.hasColors&&r.color>=0&&a.vertexColors&&(yt.bindBuffer(yt.ARRAY_BUFFER,e.__webglColorBuffer),yt.bufferData(yt.ARRAY_BUFFER,e.colorArray,yt.STREAM_DRAW),yt.enableVertexAttribArray(r.color),yt.vertexAttribPointer(r.color,3,yt.FLOAT,!1,0,0)),yt.drawArrays(yt.TRIANGLES,0,e.count),e.count=0},this.renderGeometry=function(e,i,o){var n=e.program,s=n.attributes,l=!1,h=16777215*i.id+n.id;h!==Bt&&(Bt=h,l=!0),l&&r(),o.morphTargetInfluences&&e.morphTargets&&$a(o,i,e,n);var d,u,c,f,p=i.attributesList;if(o instanceof THREE.Mesh){var m=i.attributes.index;if(m){var v=i.offsets;v.length>1&&(l=!0);for(var g=0,S=v.length;S>g;g++){var x=v[g];if(l){for(var y=x.index,G=0,M=p.length;M>G;G++)f=p[G],f.attached&&(c=f.name,"index"!==c&&(d=s[c],0>d||void 0===d||(u=f.itemSize,a(d),yt.bindBuffer(yt.ARRAY_BUFFER,f.buffer),yt.vertexAttribPointer(d,u,yt.FLOAT,!1,0,y*u*4))));yt.bindBuffer(yt.ELEMENT_ARRAY_BUFFER,m.buffer)}Ja(s,i,x.index),t(),yt.drawElements(yt.TRIANGLES,x.count,m.type,x.start*m.typeSize)}}else{if(l)for(var g=0,S=p.length;S>g;g++)f=p[g],f.attached&&(d=s[f.name],0>d||void 0===d||(a(d),yt.bindBuffer(yt.ARRAY_BUFFER,f.buffer),yt.vertexAttribPointer(d,f.itemSize,yt.FLOAT,!1,0,0)));Ja(s,i,0),t();var w=o instanceof THREE.TriangleStrip?yt.TRIANGLE_STRIP:yt.TRIANGLES,X=i.attributes.position;yt.drawArrays(w,0,X.numItems/3)}}else if(o instanceof THREE.Particles){if(l)for(var g=0,S=p.length;S>g;g++)f=p[g],f.attached&&(d=s[f.name],0>d||void 0===d||(a(d),yt.bindBuffer(yt.ARRAY_BUFFER,f.buffer),yt.vertexAttribPointer(d,f.itemSize,yt.FLOAT,!1,0,0)));t();var X=i.attributes.position;yt.drawArrays(yt.POINTS,0,X.numItems/3)}};var er=function(e,t){for(var a,r,o,n=0,s=0,l=e.length;l>s;s++)a=e[s],r=a.object,o=a.geometry,a.render=!1,a.id=r.id,r.visible&&r.enabled&&((r instanceof THREE.Mesh||r instanceof THREE.Particles)&&r.frustumCulled&&!ua.contains(r,o)||(A(r,t),d(a),a.render=!0,Et.sortObjects===!0&&(null!==r.renderDepth?a.z=r.renderDepth:(fa.copy(r.matrixWorld.getPosition()),ca.multiplyVector3(fa),a.z=fa.data[2])),n+=1));Et.sortObjects&&n>0&&e.sort(i)},tr=function(e,t){for(var a,r,i=0,o=e.length;o>i;i++)a=e[i],r=a.object,a.render=!1,r.visible&&r.enabled&&(ua.contains(r,r)||!r.frustumCulled)&&(A(r,t),h(a),a.render=!0)},ar=function(e){for(var t,a=0,r=e.length;r>a;a++)t=e[a],t.render&&d(t)},rr=function(e){for(var t,a=0,r=e.length;r>a;a++)t=e[a],t.render&&h(t)};this.renderCube=function(e,t,a){var r=a.generateMipmaps;a.generateMipmaps=!1,a.activeCubeFace=0,this.render(e,t.px,a),a.activeCubeFace=1,this.render(e,t.nx,a),a.activeCubeFace=2,this.render(e,t.py,a),a.activeCubeFace=3,this.render(e,t.ny,a),a.activeCubeFace=4,this.render(e,t.pz,a),a.generateMipmaps=r,a.activeCubeFace=5,this.render(e,t.nz,a)},this.render=function(e,t,a,r){if(t instanceof THREE.Camera==!1)return void console.error("THREE.ForwardRenderer.render: camera is not an instance of THREE.Camera.");var i=e.__lights,o=e.fog,h=e.heightFog;It=-1,xa=!0,da.length=0,this.autoUpdateScene&&e.updateMatrixWorld(),this.autoUpdateView&&(void 0===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),ca.multiply(t.projectionMatrix,t.matrixWorldInverse),ua.setFromMatrix(ca)),this.autoUpdateObjects&&this.initWebGLObjects(e),Za||(st(),Za=!0),n(this.renderPluginsPre,e,t),this.setRenderTarget(a),(this.autoClear||r)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),this.autoUpdateView?(er(e.__webglObjects,t),tr(e.__webglObjectsImmediate,t)):(ar(e.__webglObjects),rr(e.__webglObjectsImmediate)),this.setBlending(THREE.NoBlending),s(e.__webglObjects,!0,"opaque",t,i,o,h,!1),l(e.__webglObjectsImmediate,"opaque",t,i,o,h,!1),s(e.__webglObjects,!1,"transparent",t,i,o,h,!0),l(e.__webglObjectsImmediate,"transparent",t,i,o,h,!0),n(this.renderPluginsPost,e,t),a&&a.generateMipmaps&&a.minFilter!==THREE.NearestFilter&&a.minFilter!==THREE.LinearFilter&&J(a),this.setDepthTest(!0),this.setDepthWrite(!0)},this.renderImmediateObject=function(e,t){var a=e.program;Bt=-1,Et.setMaterialFaces(e),t.immediateRenderCallback?t.immediateRenderCallback(a,yt,ua):t.render(function(t){Et.renderImmediateGeometry(t,a,e)})},this.initWebGLObjects=function(e){for(e.__webglObjects||(e.__webglObjects=[],e.__webglObjectsImmediate=[]);e.__objectsAdded.length;)u(e.__objectsAdded[0],e),e.__objectsAdded.splice(0,1);for(;e.__objectsRemoved.length;)m(e.__objectsRemoved[0],e),e.__objectsRemoved.splice(0,1);for(var t=0,a=e.__webglObjects.length;a>t;t++)p(e.__webglObjects[t].object)},this.initMaterial=function(e,t,a,r,i){var o;e instanceof THREE.EmissiveMaterial?o="emissive":e instanceof THREE.PhongMaterial?o="phong":e instanceof THREE.DynamicParticleMaterial&&(o="dynamicParticle"),o&&g(e,THREE.ShaderLib[o]);var n,s,l=tt(t),h=at(t),d=et(r),u={map:!!e.map,lightMap:!!e.lightMap,bumpMap:!!e.bumpMap,normalMap:!!e.normalMap,normalGlossMap:!!e.normalGlossMap,glossMap:!!e.glossMap,specularMap:!!e.specularMap,vertexColors:e.vertexColors,fog:a,useFog:e.fog,fogExp:a instanceof THREE.FogExp2,isParticle:e.particle,sizeAttenuation:e.particle&&e.particleSizeAttenuation,interpolateParticleFrames:e.particle&&e.interpolateFrames&&e.numFrames>1,skinning:e.skinning,maxBones:d,useVertexTexture:Ca&&r&&r.useVertexTexture,boneTextureWidth:r&&r.boneTextureWidth,boneTextureHeight:r&&r.boneTextureHeight,morphTargets:e.morphTargets&&this.maxMorphTargets>0,morphNormals:e.morphNormals&&this.maxMorphNormals>0,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:l.directional,maxPointLights:l.point,maxSphereLights:l.sphere,maxTubeLights:l.tube,maxSpotLights:l.spot,maxHemiLights:l.hemi,maxAreaLights:l.area,areaTextures:l.areaTextures>0,maxImageLights:l.image,maxShadows:h,shadowMapEnabled:this.shadowMapEnabled&&r.receiveShadow&&h>0,shadowMapType:this.shadowMapType,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,areaIndexOffset:l.areaIndexOffset,spotIndexOffset:l.spotIndexOffset,dirIndexOffset:l.dirIndexOffset,alphaTest:e.alphaTest,metal:e.metal,parallax:e.parallax,parallaxRefineSteps:e.parallaxRefineSteps,wrapAround:e.wrapAround,wrapAroundSkin:e.wrapAroundSkin,doubleSided:e.side===THREE.DoubleSide,flipSided:e.side===THREE.BackSide,osxHack:navigator.platform.toLowerCase().indexOf("mac")>=0},c={position:!0,normal:!0,uv:!0,uv2:!0,tangent:!0,color:!0};for(n=0;n<this.maxMorphTargets;n++)c["morphTarget"+n]=!0;for(n=0;n<this.maxMorphNormals;n++)c["morphNormal"+n]=!0;if(i){for(s in i.attributes)c[s]=!0;for(s in i.virtualAttributes)c[s]=!0}var f={viewMatrix:!0,viewInverseMatrix:!0,modelViewMatrix:!0,projectionMatrix:!0,normalMatrix:!0,modelMatrix:!0,cameraPosition:!0,morphTargetInfluences:!0};u.useVertexTexture?f.boneTexture=!0:f.boneGlobalMatrices=!0;for(s in e.uniforms)f[s]=!0;e.program=F(o,e.fragmentShader,e.vertexShader,e.defines,f,c,u);var p=e.program.uniforms;e.uniformsListUnique=[],e.uniformsListShared=[];for(var m in e.uniforms){var v=p[m];if(v){var S=e.uniforms[m],x=[S,v];S.shared?e.uniformsListShared.push(x):e.uniformsListUnique.push(x)}}if(e.morphTargets){var y=e.program.attributes;for(e.numSupportedMorphTargets=0,n=0;n<this.maxMorphTargets;n++)y["morphTarget"+n]>=0&&e.numSupportedMorphTargets++}},this.setProgram=function(e,t,a,r,i,o,n){kt=0,i.needsUpdate&&(i.program&&Ka(i),Et.initMaterial(i,t,a,o,n),i.needsUpdate=!1);var s=!1,l=!1,h=i.program;h!==Ut&&(yt.useProgram(h),Ut=h,s=!0,l=!0),i.id!==It&&(It=i.id,s=!0);var d=h.uniforms,u=i.uniforms;if(i.skinning)if(Ca&&o.useVertexTexture){if(null!==d.boneTexture){var c=_();yt.uniform1i(d.boneTexture,c),Et.setTexture(o.boneTexture,c)}}else null!==d.boneGlobalMatrices&&yt.uniformMatrix4fv(d.boneGlobalMatrices,!1,o.boneMatrices);if(!l&&e===Ot||null===d.projectionMatrix||(yt.uniformMatrix4fv(d.projectionMatrix,!1,e.projectionMatrix.elements),e!==Ot&&(Ot=e)),l){if(a&&i.fog&&y(u,a),r&&i.defines&&i.defines.USE_HEIGHT_FOG&&G(u,r),i.lights&&(xa&&(L(t,e),xa=!1),w(u,ya)),o.receiveShadow&&!i._shadowPass&&u.shadowMatrix&&null!==d.shadowMatrix&&D(u,ya.shadowCasters),null!==d.viewMatrix&&yt.uniformMatrix4fv(d.viewMatrix,!1,e.matrixWorldInverse.elements),null!==d.viewInverseMatrix&&yt.uniformMatrix4fv(d.viewInverseMatrix,!1,e.matrixWorld.elements),null!==d.cameraPosition){var f=e.matrixWorld.getPosition();yt.uniform3fv(d.cameraPosition,f.data)}b(i.uniformsListShared),Vt=kt}else kt=Vt;return s&&(i.particle&&x(u,i),(i instanceof THREE.EmissiveMaterial||i instanceof THREE.PhongMaterial||i instanceof THREE.DynamicParticleMaterial)&&S(u,i),i instanceof THREE.PhongMaterial&&M(u,i),b(i.uniformsListUnique)),C(d,o),h},this.setFaceCulling=function(e,t){e===THREE.CullFaceNone?yt.disable(yt.CULL_FACE):(yt.frontFace(t===THREE.FrontFaceDirectionCW?yt.CW:yt.CCW),yt.cullFace(e===THREE.CullFaceBack?yt.BACK:e===THREE.CullFaceFront?yt.FRONT:yt.FRONT_AND_BACK),yt.enable(yt.CULL_FACE))},this.setMaterialFaces=function(e){var t=e.side===THREE.DoubleSide,a=e.side===THREE.BackSide;zt!==t&&(t?yt.disable(yt.CULL_FACE):yt.enable(yt.CULL_FACE),zt=t),Ht!==a&&(yt.frontFace(a?yt.CW:yt.CCW),Ht=a)},this.setDepthTest=function(e){Kt!==e&&(e?yt.enable(yt.DEPTH_TEST):yt.disable(yt.DEPTH_TEST),Kt=e)},this.setDepthWrite=function(e){Yt!==e&&(yt.depthMask(e),Yt=e)},this.setPolygonOffset=function(e,t,a){Qt!==e&&(e?yt.enable(yt.POLYGON_OFFSET_FILL):yt.disable(yt.POLYGON_OFFSET_FILL),Qt=e),!e||Jt===t&&$t===a||(yt.polygonOffset(t,a),Jt=t,$t=a)},this.setBlending=function(e,t,a,r){e!==Wt&&(e===THREE.NoBlending?yt.disable(yt.BLEND):e===THREE.AdditiveBlending?(yt.enable(yt.BLEND),yt.blendEquation(yt.FUNC_ADD),yt.blendFunc(yt.SRC_ALPHA,yt.ONE)):e===THREE.SubtractiveBlending?(yt.enable(yt.BLEND),yt.blendEquation(yt.FUNC_ADD),yt.blendFunc(yt.ZERO,yt.ONE_MINUS_SRC_COLOR)):e===THREE.MultiplyBlending?(yt.enable(yt.BLEND),yt.blendEquation(yt.FUNC_ADD),yt.blendFunc(yt.ZERO,yt.SRC_COLOR)):e===THREE.CustomBlending?yt.enable(yt.BLEND):(yt.enable(yt.BLEND),yt.blendEquationSeparate(yt.FUNC_ADD,yt.FUNC_ADD),yt.blendFuncSeparate(yt.SRC_ALPHA,yt.ONE_MINUS_SRC_ALPHA,yt.ONE,yt.ONE_MINUS_SRC_ALPHA)),Wt=e),e===THREE.CustomBlending?(t!==jt&&(yt.blendEquation(t),jt=t),(a!==qt||r!==Zt)&&(yt.blendFunc(a,r),qt=a,Zt=r)):(jt=null,qt=null,Zt=null)};var ir=function(e,t){for(var a=e.split("\n"),r=[],i=0,o=a.length;o>i;i++){var n=i+1,s=n+": "+a[i];t[n]?(r.length>0&&(console.log(r.join("\n")),r=[]),console.error("ERROR: "+t[n]+"\n"+s)):r.push(s)}console.log(r.join("\n"))};this.setTexture=function(e,t){if(e.needsUpdate&&e instanceof THREE.Texture){e.__webglInit||(e.__webglInit=!0,e.__webglTexture=yt.createTexture(),Et.info.memory.textures++),yt.activeTexture(yt.TEXTURE0+t),yt.bindTexture(yt.TEXTURE_2D,e.__webglTexture),da[t]=e.id,yt.pixelStorei(yt.UNPACK_FLIP_Y_WEBGL,e.flipY),yt.pixelStorei(yt.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),yt.pixelStorei(yt.UNPACK_ALIGNMENT,e.unpackAlignment);var a=e.image,r=B(a.width)&&B(a.height),i=e.format,o=e.type;O(yt.TEXTURE_2D,e,r);var n,s=e.mipmaps;if(e instanceof THREE.DataTexture)if(s.length>0&&r){for(var l=0,h=s.length;h>l;l++)n=s[l],yt.texImage2D(yt.TEXTURE_2D,l,i,n.width,n.height,0,i,o,n.data);e.generateMipmaps=!1}else yt.texImage2D(yt.TEXTURE_2D,0,i,a.width,a.height,0,i,o,a.data);else if(e instanceof THREE.CompressedTexture)for(var l=0,h=s.length;h>l;l++)n=s[l],yt.pixelStorei(yt.UNPACK_ALIGNMENT,n.unpackAlignment),i===THREE.RGBAFormat||i===THREE.RGBFormat?yt.texImage2D(yt.TEXTURE_2D,l,i,n.width,n.height,0,i,o,n.data):yt.compressedTexImage2D(yt.TEXTURE_2D,l,i,n.width,n.height,0,n.data);else if(s.length>0&&r){for(var l=0,h=s.length;h>l;l++)n=s[l],yt.texImage2D(yt.TEXTURE_2D,l,i,i,o,n);e.generateMipmaps=!1}else yt.texImage2D(yt.TEXTURE_2D,0,i,i,o,e.image);e.generateMipmaps&&r&&yt.generateMipmap(yt.TEXTURE_2D),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()}else da[t]!==e.id&&(yt.activeTexture(yt.TEXTURE0+t),yt.bindTexture(yt.TEXTURE_2D,e.__webglTexture),da[t]=e.id)},this.setRenderTarget=function(e){var t=e instanceof THREE.RenderTargetCube,a=e instanceof THREE.RenderTargetArray;e&&e.needsUpdate&&(void 0===e.__webglFramebuffer&&(void 0===e.depthBuffer&&(e.depthBuffer=!0),void 0===e.stencilBuffer&&(e.stencilBuffer=!0),a?j(e):t?Z(e):Y(e)),a?q(e):t?K(e):Q(e),t?yt.bindTexture(yt.TEXTURE_CUBE_MAP,null):yt.bindTexture(yt.TEXTURE_2D,null),da[0]=-1,yt.bindRenderbuffer(yt.RENDERBUFFER,null),yt.bindFramebuffer(yt.FRAMEBUFFER,null),e.needsUpdate=!1,e.onUpdate&&e.onUpdate());var r,i,o,n,s;e?(r=t?e.__webglFramebuffer[e.activeCubeFace]:e.__webglFramebuffer,i=e.width,o=e.height,n=0,s=0):(r=null,i=aa,o=ra,n=ea,s=ta),r!==Nt&&(yt.bindFramebuffer(yt.FRAMEBUFFER,r),yt.viewport(n,s,i,o),Nt=r),ia=i,oa=o},void 0!==e.width&&void 0!==e.height&&this.setSize(e.width,e.height)},THREE.DeferredRenderer=function(e){var t=this,a=void 0!==e.width?e.width:800,r=void 0!==e.height?e.height:600,i=void 0!==e.scale?e.scale:1,o=Math.floor(i*a),n=Math.floor(i*r),s=void 0!==e.tonemapping?e.tonemapping:THREE.SimpleOperator,l=void 0!==e.antialias?e.antialias:!1,h=void 0!==e.useMultipleRenderTargets?e.useMultipleRenderTargets:!1,d=void 0!==e.specularBRDF?e.specularBRDF:THREE.GGXBRDF;t.brightness=void 0!==e.brightness?e.brightness:1,this.renderer=e.renderer,void 0===this.renderer&&(this.renderer=new THREE.ForwardRenderer({alpha:!1,antialias:!1,depth:!1,stencil:!1,tonemapping:THREE.NoOperator,scale:i}),this.renderer.setSize(a,r),this.renderer.setClearColorHex(0,0),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!1,this.renderer.specularBRDF=d,this.renderer.autoClear=!1);var u=this.renderer.devicePixelRatio;o*=u,n*=u,this.domElement=this.renderer.domElement,this.shadowMapEnabled=!1,this.shadowMapType=THREE.PCFSoftShadowMap,this.shadowMapSlopeDepthBias=!1,this.shadowMapSlopeScale=2,this.shadowMapSlopeBias=0,this.shadowMapSlopeMax=.001,this.shadowMapProjectionBias=1e-5,this.shadowMapCullFace=THREE.CullFaceFront,this.shadowMapUseDepthTextures=!1,this.shadowMapDepthTextureType=THREE.UnsignedIntType,this.shadowMapCascadeUpdateThreshold=2,this.shadowMapCascadeUpdateModulo=2,this.shadowMapDebug=!1,this.particleScale=.5,this.offscreenParticles=!1,this.ssaoEnabled=!1,this.ssaoScale=.5,this.bloomEnabled=!1,this.bloomScale=.25,this.bloomStrength=1,this.bloomThreshold=1,this.dofEnabled=!1,this.dofFancy=!1,this.dofPhysical=!0,this.dofLensCOC=.03,this.dofLensFstop=4,this.dofLensFocalLength=50,this.dofDebug=!1,this.dofAutofocus=!1,this.dofAutofocusPoint=new THREE.Vector2(.5,.5),this.dofFocusDistance=1,this.dofFocusWidth=1,this.dofFocusRampWidth=2,this.dofMaxBlur=.2,this.fogEnabled=!1,this.fogColor=new THREE.Color(0),this.fogStrength=.1,this.fogStart=100,this.specularMipFix=!1,this.useDepthTexture=!1,h&&!this.renderer.supportsDrawBuffers()&&(console.warn("THREE.DeferredRenderer: can't use multiple render targets, falling back to multipass."),h=!1);var c,f,p,m,v,g,S,x,y,G,M,w,X,D,C,_,b,A,T,P,L,E,F,R,U,N,I,B,O,k,V,z=!1,H=this.renderer.context,W=new THREE.Projector,j=new THREE.Vector3,q=new THREE.Vector3,Z=new THREE.Color(0),K=new THREE.Color(16777215),Y=new THREE.Vector3(1,1,1),Q=THREE.DeferredShaders.combined,J=THREE.DeferredShaders.color,$=THREE.DeferredShaders.depth,et=THREE.DeferredShaders.normalDepth,tt=THREE.DeferredShaders.composite,at=[],rt=new THREE.Color,it=0,ot=[],nt=[],st=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(et.uniforms),vertexShader:et.vertexShader,fragmentShader:et.fragmentShader,blending:THREE.NoBlending}),lt=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone($.uniforms),vertexShader:$.vertexShader,fragmentShader:$.fragmentShader,blending:THREE.NoBlending}),ht={},dt={},ut={},ct={},ft=0,pt=function(e,a){var r=THREE.UniformsUtils.clone(Q.uniforms),i={USE_MAP:!!e.map,USE_LIGHTMAP:!!e.lightMap,USE_BUMPMAP:!!e.bumpMap,USE_NORMALMAP:!!e.normalMap,USE_NORMALGLOSSMAP:!!e.normalGlossMap,USE_GLOSSMAP:!!e.glossMap,USE_SPECULARMAP:!!e.specularMap,USE_PARALLAX:!!e.parallax,PARTICLE:e.particle,USE_PARTICLE_SIZEATTENUATION:e.particle&&e.particleSizeAttenuation,TEXTURE_DEPTH:t.useDepthTexture};e.parallax&&e.parallaxRefineSteps>0&&(i.PARALLAX_REFINE_STEPS=e.parallaxRefineSteps.toFixed(0).toString());var n=new THREE.ShaderMaterial({fragmentShader:Q.fragmentShader,vertexShader:Q.vertexShader,uniforms:r,defines:i,blending:THREE.NoBlending}),s=void 0!==e.color?e.color:K,l=void 0!==e.specular?e.specular:Z,h=void 0!==e.wrapRGB?e.wrapRGB:Y,d=void 0!==e.shininess?e.shininess:1,u=void 0!==e.wrapAround?e.wrapAround?-1:1:1;if(r.diffuse.value.setRGBA(s,u),r.specular.value.setRGBA(l,d),r.wrapRGB.value.copy(h),r.map.value=e.map,e.lightMap&&(r.lightMap.value=e.lightMap),e.bumpMap&&(r.bumpMap.value=e.bumpMap,r.bumpScale.value=e.bumpScale),(e.normalMap||e.normalGlossMap)&&(r.normalMap.value=e.normalGlossMap?e.normalGlossMap:e.normalMap,r.normalScale.value.copy(e.normalScale)),e.specularMap&&(r.specularMap.value=e.specularMap),e.glossMap&&(r.glossMap.value=e.glossMap),e.particle&&(r.particleSize.value=e.particleSize,r.screenWidth.value=o),e.particle&&e.particleSizeAttenuation&&ot.push({material:n}),e.parallax&&(r.parallaxScale.value=e.parallaxScale),n.vertexColors=e.vertexColors,n.morphTargets=e.morphTargets,n.morphNormals=e.morphNormals,n.skinning=e.skinning,n.alphaTest=e.alphaTest,n.side=e.side,n.visible=e.visible,void 0!==a){var c=a.offset,f=a.repeat;r.offsetRepeat.value.set(c.data[0],c.data[1],f.data[0],f.data[1])}return n},mt=function(e,t){var a=THREE.UniformsUtils.clone(J.uniforms),r={USE_MAP:!!e.map,USE_LIGHTMAP:!!e.lightMap,USE_SPECULARMAP:!!e.specularMap,USE_NORMALGLOSSMAP:!!e.normalGlossMap,USE_GLOSSMAP:!!e.glossMap,USE_BUMPMAP:!!e.bumpMap&&e.parallax,USE_PARALLAX:!!e.parallax,PARTICLE:e.particle,USE_PARTICLE_SIZEATTENUATION:e.particle&&e.particleSizeAttenuation};e.parallax&&e.parallaxRefineSteps>0&&(r.PARALLAX_REFINE_STEPS=e.parallaxRefineSteps.toFixed(0).toString());var i=new THREE.ShaderMaterial({fragmentShader:J.fragmentShader,vertexShader:J.vertexShader,uniforms:a,defines:r}),n=void 0!==e.color?e.color:K,s=void 0!==e.specular?e.specular:Z,l=void 0!==e.wrapRGB?e.wrapRGB:Y,h=void 0!==e.shininess?e.shininess:1,d=void 0!==e.wrapAround?e.wrapAround?-1:1:1;if(a.diffuse.value.setRGBA(n,d),a.specular.value.setRGBA(s,h),a.wrapRGB.value.copy(l),a.map.value=e.map,e.lightMap&&(a.lightMap.value=e.lightMap),e.specularMap&&(a.specularMap.value=e.specularMap),e.glossMap&&(a.glossMap.value=e.glossMap),e.normalGlossMap&&(a.normalMap.value=e.normalGlossMap),e.particle&&(a.particleSize.value=e.particleSize,a.screenWidth.value=o),e.particle&&e.particleSizeAttenuation&&ot.push({material:i}),e.parallax&&(a.parallaxScale.value=e.parallaxScale,a.bumpMap.value=e.bumpMap),i.vertexColors=e.vertexColors,i.morphTargets=e.morphTargets,i.morphNormals=e.morphNormals,i.skinning=e.skinning,i.alphaTest=e.alphaTest,i.side=e.side,i.visible=e.visible,void 0!==t){var u=t.offset,c=t.repeat;a.offsetRepeat.value.set(u.data[0],u.data[1],c.data[0],c.data[1])}return i},vt=function(e,t){var a={USE_BUMPMAP:!!e.bumpMap,USE_NORMALMAP:!!e.normalMap,USE_NORMALGLOSSMAP:!!e.normalGlossMap,USE_PARALLAX:!!e.parallax,PARTICLE:e.particle,USE_PARTICLE_SIZEATTENUATION:e.particle&&e.particleSizeAttenuation};if(e.parallax&&e.parallaxRefineSteps>0&&(a.PARALLAX_REFINE_STEPS=e.parallaxRefineSteps.toFixed(0).toString()),e.morphTargets||e.skinning||e.bumpMap||e.normalMap||e.alphaTest||e.particle){var r=THREE.UniformsUtils.clone(et.uniforms),i=new THREE.ShaderMaterial({uniforms:r,vertexShader:et.vertexShader,fragmentShader:et.fragmentShader,blending:THREE.NoBlending});if(i.morphTargets=e.morphTargets,i.morphNormals=e.morphNormals,i.skinning=e.skinning,e.bumpMap&&(r.bumpMap.value=e.bumpMap,r.bumpScale.value=e.bumpScale),(e.normalMap||e.normalGlossMap)&&(r.normalMap.value=e.normalGlossMap?e.normalGlossMap:e.normalMap,r.normalScale.value.copy(e.normalScale)),void 0!==t){var n=t.offset,s=t.repeat;r.offsetRepeat.value.set(n.data[0],n.data[1],s.data[0],s.data[1])}e.alphaTest&&e.map&&(r.alphaMap.value=e.map),e.particle&&(r.particleSize.value=e.particleSize,r.screenWidth.value=o,e.particleSizeAttenuation&&ot.push({material:i})),e.parallax&&(r.parallaxScale.value=e.parallaxScale)}else var i=st.clone();return i.defines=a,i.vertexColors=e.vertexColors,i.side=e.side,i.alphaTest=e.alphaTest,i.visible=e.visible,i},gt=function(e,a){var r={PARTICLE:e.particle,USE_PARTICLE_SIZEATTENUATION:e.particle&&e.particleSizeAttenuation,SLOPE_DEPTH_BIAS:t.shadowMapSlopeDepthBias,DEPTH_TEXTURES:t.shadowMapUseDepthTextures&&t.renderer.supportsDepthTextures()};if(e.morphTargets||e.skinning||e.alphaTest||e.particle){var i=THREE.UniformsUtils.clone($.uniforms),n=new THREE.ShaderMaterial({uniforms:i,vertexShader:$.vertexShader,fragmentShader:$.fragmentShader,blending:THREE.NoBlending});if(n.morphTargets=e.morphTargets,n.skinning=e.skinning,void 0!==a){var s=a.offset,l=a.repeat;i.offsetRepeat.value.set(s.data[0],s.data[1],l.data[0],l.data[1])}e.alphaTest&&e.map&&(i.alphaMap.value=e.map),e.particle&&(i.particleSize.value=e.particleSize,i.screenWidth.value=o,e.particleSizeAttenuation&&ot.push({material:n}))}else var n=lt.clone();return t.shadowMapSlopeDepthBias&&(n.uniforms.slopeScale.value=t.shadowMapSlopeScale,n.uniforms.slopeBias.value=t.shadowMapSlopeBias,n.uniforms.slopeMax.value=t.shadowMapSlopeMax),n.defines=r,n.vertexColors=e.vertexColors,n.alphaTest=e.alphaTest,n.visible=e.visible,n.side=t.shadowMapCullFace===THREE.CullFaceFront?THREE.BackSide:THREE.FrontSide,n},St=function(e){var t=e.properties,a=yt(e.materials);t.combinedMaterials=a.combinedMaterials,t.colorMaterials=a.colorMaterials,t.depthMaterials=a.depthMaterials,t.normalDepthMaterials=a.normalDepthMaterials,t.forwardMaterials=e.materials,t.deferredInitialized=!0,t.deferredNeedsUpdate=!1},xt=function(e){var t;return e.map?t=e.map:e.lightMap?t=e.lightMap:e.specularMap?t=e.specularMap:e.glossMap?t=e.glossMap:e.normalGlossMap?t=e.normalGlossMap:e.normalMap?t=e.normalMap:e.bumpMap&&(t=e.bumpMap),t},yt=function(e){for(var t={combinedMaterials:[],colorMaterials:[],depthMaterials:[],normalDepthMaterials:[]},a=0,r=e.length;r>a;a++){var i=e[a],o=xt(i);if(h){void 0===ht[i.id]&&(ht[i.id]=pt(i,o));var n=ht[i.id];t.combinedMaterials.push(n)}else{void 0===dt[i.id]&&(dt[i.id]=mt(i,o));var s=dt[i.id];t.colorMaterials.push(s),void 0===ut[i.id]&&(ut[i.id]=vt(i,o));var l=ut[i.id];t.normalDepthMaterials.push(l)}void 0===ct[i.id]&&(ct[i.id]=gt(i,o));var d=ct[i.id];
t.depthMaterials.push(d)}return t},Gt=function(e){for(var t,a,r,i=e.properties,o=i.forwardMaterials,n=i.combinedMaterials,s=i.colorMaterials,l=i.depthMaterials,d=i.normalDepthMaterials,u=0,c=o.length;c>u;u++){var f=o[u],p=f.visible,m=xt(f),v=l[u];if(v.visible=p,r=v.uniforms,h){var g=n[u];g.visible=p,t=g.uniforms}else{var S=s[u],x=d[u];S.visible=p,x.visible=p,t=S.uniforms,a=x.uniforms}if(t.map.value=f.map,f instanceof THREE.PhongMaterial){var y=f.wrapAround?-1:1,G=f.shininess,M=f.color,w=f.specular,X=f.wrapRGB;t.diffuse.value.setRGBA(M,y),t.specular.value.setRGBA(w,G),t.wrapRGB.value.copy(X)}if(m){var D=m.offset,C=m.repeat;t.offsetRepeat.value.set(D.data[0],D.data[1],C.data[0],C.data[1]),r.offsetRepeat.value.set(D.data[0],D.data[1],C.data[0],C.data[1]),h||a.offsetRepeat.value.set(D.data[0],D.data[1],C.data[0],C.data[1])}}i.deferredNeedsUpdate=!1},Mt=function(e){var a,r,i,o,n,s,l,h=e.__objects,d=e.__lights;for(a=0,r=h.length;r>a;a++)n=h[a],l=n.properties,n.materials&&(l.deferredInitialized?l.deferredNeedsUpdate&&Gt(n):St(n));for(a=0,r=d.length;r>a;a++)s=d[a],s.properties.deferredInitialized||(s instanceof THREE.PointLight?(i=new THREE.PointLightProxy(s,t),o=s.distance>0?B:I):s instanceof THREE.SphereLight?(i=new THREE.SphereLightProxy(s,t),o=s.distance>0?B:I):s instanceof THREE.TubeLight?(i=new THREE.TubeLightProxy(s,t),o=I):s instanceof THREE.SpotLight?(i=new THREE.SpotLightProxy(s,t),o=I):s instanceof THREE.DirectionalLight?(i=new THREE.DirectionalLightProxy(s,t),o=I):s instanceof THREE.HemisphereLight?(i=new THREE.HemisphereLightProxy(s,t),o=I):s instanceof THREE.DayLight?(i=new THREE.DayLightProxy(s,t),o=I):s instanceof THREE.DayLightCube?(i=new THREE.DayLightCubeProxy(s,t),o=I):s instanceof THREE.AreaLight?(i=new THREE.AreaLightProxy(s,t),o=I):s instanceof THREE.ImageLight&&(i=new THREE.ImageLightProxy(s,t),o=s.local?B:I),i&&(o.add(i),nt.push(i)),s.castShadow&&O.properties.shadowCasters.push(s),s.properties.deferredInitialized=!0)},wt=function(e,t){Ct(e,t,!0,!1)},Xt=function(e,t){Ct(e,t,!1,!0)},Dt=function(e,t){Ct(e,t,!0,!0)},Ct=function(e,a,r,i){for(var o=e.__objects,n=0,s=o.length;s>n;n++){var l=o[n];if(l.materials){var h=l.properties,d=h[a];if(d){l.materials=d;for(var u=!0,c=h.forwardMaterials,f=0,p=d.length;p>f;f++){var m=d[f],v=c[f].transparent,g=c[f].particle&&v;m.enabled=v?i:r,m.enabled=m.enabled&&(!g||!t.offscreenParticles),u=u&&!m.enabled}l.enabled=!u}}}},_t=function(e){for(var t,a=e.__objects,r=0,i=a.length;i>r;r++)if(t=a[r],t.materials)if(t instanceof THREE.Particles){var o=t.properties.forwardMaterials;t.materials=o,t.enabled=!0,bt(o)}else for(var n=0,s=t.materials.length;s>n;n++){var l=t.materials[n];l.enabled=!1}},bt=function(e){for(var a=0,r=e.length;r>a;a++){var i=e[a],s=i.uniforms;if(i.particle&&i.transparent){if(i.enabled=!0,!i.defines){var l=Pt();t.offscreenParticles&&(l.OFFSCREEN_PARTICLES=!0),i.defines=l}s&&(s.tDepth.value=h?c.renderTarget2.colorTexture[4]:p.renderTarget2,s.viewSize.value.set(o*t.particleScale,n*t.particleScale))}else i.enabled=!1}},At=function(e,a,r){for(var i=0,o=e.length;o>i;i++){var n=e[i],s=n.uniforms,l=a[i].transparent;n.enabled=!l,r?(n.polygonOffset=!0,n.polygonOffsetFactor=1.5,n.polygonOffsetUnits=10):(s.slopeScale.value=t.shadowMapSlopeScale,s.slopeBias.value=t.shadowMapSlopeBias,s.slopeMax.value=t.shadowMapSlopeMax),n.side=t.shadowMapCullFace===THREE.CullFaceFront?THREE.BackSide:t.shadowMapCullFace===THREE.CullFaceBack?THREE.FrontSide:THREE.DoubleSide}},Tt=function(e,t){for(var a,r=e.__objects,i=0,o=r.length;o>i;i++)if(a=r[i],a.materials)if(a.castShadow){var n=a.properties.depthMaterials;a.materials=n,At(n,a.properties.forwardMaterials,t)}else for(var s=0,l=a.materials.length;l>s;s++){var h=a.materials[s];h.enabled=!1}},Pt=function(){return h&&t.useDepthTexture?{TEXTURE_DEPTH:!0}:h&&!t.useDepthTexture?{RGBA_DEPTH:!0}:{FLOAT_DEPTH:!0}};this.setAntialias=function(e){l=e,Wt()},this.getAntialias=function(){return l},this.setDOF=function(e){this.dofEnabled=e,Wt();var a=A.material,r=a.defines;r.FANCY_DOF=t.dofFancy&&t.dofEnabled,a.needsUpdate=!0},this.setTonemapping=function(e){s=e,z&&jt()},this.addEffect=function(e,a){if(e.material&&e.uniforms&&(e.properties={},a&&(a.normalDepthUniform||a.colorUniform||a.depthUniform))){var r={material:e.material,normalDepth:a.normalDepthUniform,color:a.colorUniform,depth:a.depthUniform};ot.push(r),e.properties.normalDepthUniform=a.normalDepthUniform,e.properties.colorUniform=a.colorUniform,e.properties.depthUniform=a.depthUniform,(a.normalDepthUniform||a.depthUniform)&&(e.material.defines=Pt())}if(S){var i=t.dofFancy?-1:-2;S.insertPass(e,i)}else at.push(e)},this.setScale=function(e){if(i=e,this.renderer.setScale(i),o=Math.floor(i*a),n=Math.floor(i*r),o*=u,n*=u,z){m.setSize(o,n),S.setSize(o,n),g.setSize(o*t.particleScale,n*t.particleScale),x.setSize(o*t.ssaoScale,n*t.ssaoScale),y.setSize(o,n),G.setSize(o*t.bloomScale,n*t.bloomScale),h?c.setSize(o,n):(p.setSize(o,n),f.setSize(o,n));for(var s=0,l=ot.length;l>s;s++){var d=ot[s],v=d.material,M=v.uniforms;M.viewSize&&M.viewSize.value.set(o,n),M.screenWidth&&(M.screenWidth.value=o)}for(var s=0,l=nt.length;l>s;s++){var w=nt[s];w.resize(o,n)}T.renderToScreen?T.uniforms.resolution.value.set(1/(a*u),1/(r*u)):T.uniforms.resolution.value.set(1/o,1/n),L.resize(o,n),P.uniforms.size.value.set(o*t.ssaoScale,n*t.ssaoScale),E.uniforms.h.value=4/o,F.uniforms.v.value=2/n,R.uniforms.h.value=1/(o*t.bloomScale),U.uniforms.v.value=1/(n*t.bloomScale)}},this.setSize=function(e,t){a=e,r=t,this.renderer.setSize(a,r),this.setScale(i)},this.getCombinedTarget=function(){return c.renderTarget2},this.getColorTarget=function(){return f.renderTarget2},this.getNormalDepthTarget=function(){return p.renderTarget2},this.getSSAOTarget=function(){return y.renderTarget2},this.getUseMultipleRenderTargets=function(){return h};var Lt=function(e,t){e.position.copy(t.matrixWorld.getPosition()),t.target&&e.lookAt(t.target.matrixWorld.getPosition()),e.updateMatrixWorld(),e.matrixWorldInverse.getInverse(e.matrixWorld)},Et=function(e,t){e.near=t.shadowCameraNear,e.far=t.shadowCameraFar,t instanceof THREE.PointLight||t instanceof THREE.SphereLight?e.fov=90:t instanceof THREE.SpotLight||t instanceof THREE.AreaLight?e.fov=t.shadowCameraFov:(t instanceof THREE.DirectionalLight||t instanceof THREE.DayLight||t instanceof THREE.DayLightCube||t instanceof THREE.AreaLight)&&(e.left=t.shadowCameraLeft,e.right=t.shadowCameraRight,e.top=t.shadowCameraTop,e.bottom=t.shadowCameraBottom),e.updateProjectionMatrix()},Ft=function(e,t,a,r){e.near=t.shadowCameraNear,e.far=t.shadowCameraFar;var i=t.shadowCascadeNearZ[a],o=t.shadowCascadeFarZ[a],n=t.properties.pointsFrustum[a];n[0].setZ(i),n[1].setZ(i),n[2].setZ(i),n[3].setZ(i),n[4].setZ(o),n[5].setZ(o),n[6].setZ(o),n[7].setZ(o);var s=t.properties.pointsWorld[a];j.set(1/0,1/0,1/0),q.set(-1/0,-1/0,-1/0);for(var l=j.data,h=q.data,d=0;8>d;d++){var u=s[d],c=u.data;u.copy(n[d]),W.unprojectVector(u,r),e.matrixWorldInverse.multiplyVector3(u),c[0]<l[0]&&(l[0]=c[0]),c[0]>h[0]&&(h[0]=c[0]),c[1]<l[1]&&(l[1]=c[1]),c[1]>h[1]&&(h[1]=c[1]),c[2]<l[2]&&(l[2]=c[2]),c[2]>h[2]&&(h[2]=c[2])}e.left=l[0],e.right=h[0],e.top=h[1],e.bottom=l[1],e.updateProjectionMatrix()},Rt=function(e,a,r){var i=t.renderer,o=a.projectionMatrix.elements,n=o[10];o[10]*=1+t.shadowMapProjectionBias,i.render(e,a,r,!0),o[10]=n},Ut=function(e,a){var r=t.renderer;r.autoClearDepth=!0,r.autoClearStencil=!1,r.autoUpdateScene=!1;var i=t.shadowMapUseDepthTextures&&r.supportsDepthTextures();i?(r.autoClearColor=!1,H.colorMask(!1,!1,!1,!1)):(rt.copy(r.getClearColor()),it=r.getClearAlpha(),r.setClearColor(K,1)),Tt(e,i);for(var o=e.properties.shadowCasters,n=0,s=o.length;s>n;n++){var l=o[n];if(l instanceof THREE.SpotLight||l instanceof THREE.AreaLight){var h=l.properties.shadowMap,d=l.properties.shadowCamera;Lt(d,l),Et(d,l),Rt(e,d,h)}else if(l instanceof THREE.DirectionalLight||l instanceof THREE.DayLight||l instanceof THREE.DayLightCube){for(var u=0;u<l.properties.cascadeCount;u++)if(!(u>t.shadowMapCascadeUpdateThreshold&&ft%t.shadowMapCascadeUpdateModulo!==0)){var h=l.properties.shadowMap[u],d=l.properties.shadowCamera[u];Lt(d,l),l.shadowCascade?Ft(d,l,u,a):Et(d,l),Rt(e,d,h)}}else if(l instanceof THREE.PointLight||l instanceof THREE.SphereLight)for(var u=0;6>u;u++){var h=l.properties.shadowMap[u],d=l.properties.shadowCamera[u];Lt(d,l),Et(d,l),Rt(e,d,h)}}i?(r.autoClearColor=!0,H.colorMask(!0,!0,!0,!0)):r.setClearColor(rt,it)},Nt=function(e){e.projectionMatrixInverse.getInverse(e.projectionMatrix);for(var t=0,a=B.children.length;a>t;t++){var r=B.children[t];r.update(e)}for(var t=0,a=I.children.length;a>t;t++){var r=I.children[t];r.update(e)}},It=function(){var e=t.renderer,a=e.shadowMapUseDepthTextures;e.shadowMapEnabled=t.shadowMapEnabled,e.shadowMapAutoUpdate=!1,e.shadowMapUseDepthTextures=!0,H.depthFunc(H.LEQUAL),v.render(),e.shadowMapUseDepthTextures=a},Bt=function(e,a){V.enabled=!1;var r=e.properties.mirrors;if(void 0!==r){var i=r.length;if(0!==i){var s=t.renderer;s.autoClearDepth=!0,H.depthFunc(H.LEQUAL),Dt(e,"forwardMaterials");var l=s.shadowMapUseDepthTextures;s.shadowMapEnabled=t.shadowMapEnabled,s.shadowMapAutoUpdate=!1,s.shadowMapUseDepthTextures=!0;for(var d=h?c.renderTarget2.colorTexture[4]:p.renderTarget2,u=0;i>u;u++){var f=r[u],m=f.material.uniforms,v=f.material.defines;m.refractionSampler.value=k,m.refractionDepthSampler.value=d,m.matProjInverse.value=a.projectionMatrixInverse,m.matViewInverse.value=a.matrixWorld,m.viewSize.value.set(o,n),v.USE_MRT=h,f.render(e,a)}V.enabled=!0,s.autoClearDepth=!1,s.shadowMapUseDepthTextures=l}}},Ot=function(e){_t(e),g.render()},kt=function(){var e=t.renderer;e.autoClearDepth=!0,H.depthFunc(H.LEQUAL),c.render()},Vt=function(){var e=t.renderer;e.autoClearDepth=!0,H.depthFunc(H.LEQUAL),p.render()},zt=function(){var e=t.renderer;e.autoClearDepth=!0,e.autoUpdateView=!1,f.render()},Ht=function(e,a){var r=t.renderer;r.autoUpdateView=!0,t.shadowMapEnabled&&Ut(e,a),t.ssaoEnabled&&(P.uniforms.cameraNear.value=a.near,P.uniforms.cameraFar.value=a.far,E.uniforms.cameraNear.value=a.near,E.uniforms.cameraFar.value=a.far,F.uniforms.cameraNear.value=a.near,F.uniforms.cameraFar.value=a.far,x.render(),y.render()),r.autoClearDepth=!1,r.autoUpdateScene=!0,r.autoUpdateObjects=!0,Nt(a),H.depthFunc(H.GEQUAL),m.render()};this.prepareForwardPass=function(e){e.properties.deferredInitialized&&Dt(e,"forwardMaterials")},this.renderCube=function(e,t,a){e.properties.deferredInitialized&&wt(e,"forwardMaterials"),this.renderer.autoClear=!0,this.renderer.renderCube(e,t,a),this.renderer.autoClear=!1},this.render=function(e,a){if(!z){Zt();for(var r=t.dofFancy?-1:-2,i=0,o=at.length;o>i;i++){var n=at[i],s=n.properties;if(s){var l,d,u,m=s.normalDepthUniform,v=s.colorUniform,g=s.depthUniform;if(h){var x=c.renderTarget2;u=t.useDepthTexture?x.depthTexture:x.colorTexture[4],d=x.colorTexture[0]}else l=p.renderTarget2,d=f.renderTarget2,u=p.renderTarget2;m&&(n.uniforms[m].value=l),v&&(n.uniforms[v].value=d),g&&(n.uniforms[g].value=u)}S.insertPass(n,r)}z=!0}var y=t.renderer,T=e.properties;if(T.deferredInitialized||(T.lightSceneGeometry=new THREE.Scene,T.lightSceneFullscreen=new THREE.Scene,T.shadowCasters=[],T.deferredInitialized=!0),B=T.lightSceneGeometry,I=T.lightSceneFullscreen,O=e,h?(M.camera=a,M.scene=e):(w.camera=a,w.scene=e,X.camera=a,X.scene=e),C.camera=a,C.scene=B,D.camera=THREE.EffectComposer.camera,D.scene=I,_.camera=a,_.scene=e,b.camera=a,b.scene=e,y.autoUpdateObjects=!1,y.initWebGLObjects(e),y.initWebGLObjects(THREE.EffectComposer.scene),Mt(e),y.autoUpdateScene=!1,e.updateMatrixWorld(),D.clear=!0,h?(M.clear=!0,wt(e,"combinedMaterials"),kt(e,a),Ht(e,a),M.clear=!1):(w.clear=!0,X.clear=!0,wt(e,"normalDepthMaterials"),Vt(e,a),wt(e,"colorMaterials"),zt(e,a),Ht(e,a),w.clear=!1,X.clear=!1),D.clear=!1,Bt(e,a),y.autoUpdateScene=!1,y.autoUpdateObjects=!1,Xt(e,"forwardMaterials"),It(e,a),t.offscreenParticles&&Ot(e,a),t.bloomEnabled&&(N.uniforms.threshold.value=t.bloomThreshold,N.uniforms.brightness.value=t.brightness,G.render()),y.autoUpdateObjects=!0,y.autoUpdateScene=!0,y.autoClearDepth=!0,H.depthFunc(H.LEQUAL),t.bloomEnabled){var P=A.uniforms;P.bloomStrength.value=t.bloomStrength,P.brightness.value=t.brightness}if(t.dofEnabled&&(L.cameraNear=a.near,L.cameraFar=a.far,L.autoFocus=t.dofAutofocus,L.autoFocusPoint=t.dofAutofocusPoint,L.focusDistance=t.dofFocusDistance,L.focusRampStart=t.dofFocusWidth,L.focusRampEnd=t.dofFocusWidth+t.dofFocusRampWidth,L.maxBlur=t.dofMaxBlur,t.dofFancy&&t.dofPhysical&&(L.lensCOC=t.dofLensCOC,L.lensFstop=t.dofLensFstop,L.lensFocalLength=t.dofLensFocalLength)),t.fogEnabled){var E=A.uniforms;E.fogColor.value.copy(t.fogColor),E.fogStrength.value=t.fogStrength,E.fogStart.value=t.fogStart,E.cameraNear.value=a.near,E.cameraFar.value=a.far}A.uniforms.brightness.value=t.brightness,S.render(.1),ft+=1};var Wt=function(){l&&t.dofEnabled?(T.enabled=!0,L.enabled=!0,t.dofFancy?(L.renderToScreen=!1,A.renderToScreen=!1,T.renderToScreen=!0):(A.renderToScreen=!1,T.renderToScreen=!1,L.renderToScreen=!0)):l&&!t.dofEnabled?(T.enabled=!0,L.enabled=!1,L.renderToScreen=!1,A.renderToScreen=!1,T.renderToScreen=!0):!l&&t.dofEnabled?(T.enabled=!1,L.enabled=!0,t.dofFancy?(L.renderToScreen=!1,A.renderToScreen=!0,T.renderToScreen=!1):(A.renderToScreen=!1,T.renderToScreen=!1,L.renderToScreen=!0)):(T.enabled=!1,L.enabled=!1,A.renderToScreen=!0,T.renderToScreen=!1,L.renderToScreen=!1),T.renderToScreen?T.uniforms.resolution.value.set(1/(a*u),1/(r*u)):T.uniforms.resolution.value.set(1/o,1/n)},jt=function(){var e=A.material,t=e.defines;switch(t.TONEMAP_SIMPLE=!1,t.TONEMAP_LINEAR=!1,t.TONEMAP_REINHARD=!1,t.TONEMAP_FILMIC=!1,t.TONEMAP_UNCHARTED=!1,t.TONEMAP_REINHARD_LUMA=!1,t.TONEMAP_REINHARD_WHITE=!1,s){case THREE.SimpleOperator:t.TONEMAP_SIMPLE=!0;break;case THREE.LinearOperator:t.TONEMAP_LINEAR=!0;break;case THREE.ReinhardOperator:t.TONEMAP_REINHARD=!0;break;case THREE.FilmicOperator:t.TONEMAP_FILMIC=!0;break;case THREE.UnchartedOperator:t.TONEMAP_UNCHARTED=!0;break;case THREE.LumaReinhardOperator:t.TONEMAP_REINHARD_LUMA=!0;break;case THREE.WhitePreservingReinhardOperator:t.TONEMAP_REINHARD_WHITE=!0}e.needsUpdate=!0,N.material.needsUpdate=!0},qt=function(e){var t={hasFloatsNearest:e.supportsFloatTextures(),hasFloatsLinear:e.supportsFloatTexturesLinear(),hasHalfFloatsNearest:e.supportsHalfFloatTextures(),hasHalfFloatsLinear:e.supportsHalfFloatTexturesLinear()};return t},Zt=function(){var e,a={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.FloatType},r={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.FloatType},i={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.HalfFloatType},l={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.HalfFloatType},d={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBFormat,type:THREE.UnsignedByteType},u=qt(t.renderer);if(u.hasHalfFloatsLinear?e=i:u.hasHalfFloatsNearest?e=l:u.hasFloatsLinear?e=a:u.hasFloatsNearest?e=r:console.error("THREE.DeferredRenderer: missing float or half float render targets support"),h){var I=t.useDepthTexture?4:5,B={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,type:THREE.UnsignedByteType,format:THREE.RGBAFormat,stencilBuffer:!1},O=new THREE.RenderTargetArray(o,n,I,t.useDepthTexture,B);O.generateMipmaps=!1,M=new THREE.RenderPass,M.clear=!0,M.clearColor=K,M.clearAlpha=1,c=new THREE.EffectComposer(t.renderer,O),c.addPass(M);var z=c.renderTarget2,H=z.colorTexture[3],W=t.useDepthTexture?z.depthTexture:z.colorTexture[4]}else{var j=new THREE.RenderTarget(o,n,r);j.generateMipmaps=!1;var q=new THREE.RenderTarget(o,n,r);q.generateMipmaps=!1,X=new THREE.RenderPass,X.clear=!0,X.clearColor=K,X.clearAlpha=1,p=new THREE.EffectComposer(t.renderer,q),p.addPass(X),w=new THREE.RenderPass,w.clear=!0,f=new THREE.EffectComposer(t.renderer,j),f.addPass(w),f.renderTarget2.shareDepthFrom=p.renderTarget2}var Z=new THREE.RenderTarget(o*t.ssaoScale,n*t.ssaoScale,d),Y=new THREE.RenderTarget(o,n,d);Z.generateMipmaps=!1,Y.generateMipmaps=!1,Z.depthBuffer=!1,Z.stencilBuffer=!1,Y.depthBuffer=!1,Y.stencilBuffer=!1,P=new THREE.ShaderPass(THREE.SSAOShader),P.clear=!1,P.uniforms.size.value.set(o*t.ssaoScale,n*t.ssaoScale),P.uniforms.aoClamp.value=1.5,E=new THREE.ShaderPass(THREE.SSAOBilateralHorizontalBlurShader),F=new THREE.ShaderPass(THREE.SSAOBilateralVerticalBlurShader),E.uniforms.h.value=4/o,F.uniforms.v.value=2/n,P.material.blending=THREE.NoBlending,P.material.depthTest=!1,P.material.depthWrite=!1,E.material.blending=THREE.NoBlending,E.material.depthTest=!1,E.material.depthWrite=!1,F.material.blending=THREE.NoBlending,F.material.depthTest=!1,F.material.depthWrite=!1,h?(P.uniforms.tDepth.value=W,E.uniforms.tDepth.value=W,F.uniforms.tDepth.value=W,E.uniforms.tNormal.value=H,F.uniforms.tNormal.value=H):(P.uniforms.tDepth.value=p.renderTarget2,E.uniforms.tDepth.value=p.renderTarget2,F.uniforms.tDepth.value=p.renderTarget2);var Q=Pt();P.material.defines=Q,E.material.defines=Q,F.material.defines=Q,x=new THREE.EffectComposer(t.renderer,Z),x.addPass(P),E.textureID="dummy",E.uniforms.tDiffuse.value=x.renderTarget1,y=new THREE.EffectComposer(t.renderer,Y),y.addPass(E),y.addPass(F);var J=new THREE.RenderTarget(o,n,e),$=new THREE.RenderTarget(o,n,d);J.generateMipmaps=!1,$.generateMipmaps=!1,$.depthBuffer=!1,$.stencilBuffer=!1,D=new THREE.RenderPass,D.clear=!0,C=new THREE.RenderPass,C.clear=!1,k=new THREE.RenderTarget(o,n,d),V=new THREE.SavePass(k),V.material.depthTest=!1,V.enabled=!1,m=new THREE.EffectComposer(t.renderer,J),m.addPass(D),m.addPass(C),m.addPass(V),m.renderTarget2.shareDepthFrom=h?c.renderTarget2:p.renderTarget2,_=new THREE.RenderPass,_.clear=!1,v=new THREE.EffectComposer(t.renderer,J),v.addPass(_),v.renderTarget1=m.renderTarget1,v.renderTarget2=m.renderTarget2,v.renderTarget2.shareDepthFrom=h?c.renderTarget2:p.renderTarget2;var et=new THREE.RenderTarget(o*t.particleScale,n*t.particleScale,e);b=new THREE.RenderPass,b.clear=!0,g=new THREE.EffectComposer(t.renderer,et),g.addPass(b);var at=new THREE.RenderTarget(o*t.bloomScale,n*t.bloomScale,d);at.generateMipmaps=!1,at.depthBuffer=!1,at.stencilBuffer=!1,R=new THREE.ShaderPass(THREE.BloomHorizontalBlurShader),U=new THREE.ShaderPass(THREE.BloomVerticalBlurShader),N=new THREE.ShaderPass(THREE.BloomFilterShader),N.uniforms.tSource.value=m.renderTarget2,N.uniforms.threshold.value=t.bloomThreshold,N.uniforms.brightness.value=t.brightness,R.uniforms.h.value=1/(o*t.bloomScale),U.uniforms.v.value=1/(n*t.bloomScale),R.material.blending=THREE.NoBlending,R.material.depthTest=!1,R.material.depthWrite=!1,U.material.blending=THREE.NoBlending,U.material.depthTest=!1,U.material.depthWrite=!1,N.material.blending=THREE.NoBlending,N.material.depthTest=!1,N.material.depthWrite=!1,G=new THREE.EffectComposer(t.renderer,at),G.addPass(N),G.addPass(R),G.addPass(U),A=new THREE.ShaderPass(tt),A.uniforms.brightness.value=t.brightness,A.uniforms.samplerLight.value=m.renderTarget2,A.uniforms.samplerBloom.value=G.renderTarget1,A.uniforms.bloomStrength.value=t.bloomStrength,A.uniforms.samplerParticles.value=g.renderTarget2;var rt=Pt();switch(t.fogEnabled&&(rt.FOG_ENABLED=!0,A.uniforms.samplerDepth.value=h?W:p.renderTarget2,ot.push({material:A.material,depth:"samplerDepth"})),A.material.blending=THREE.NoBlending,A.material.depthTest=!1,A.material.depthWrite=!1,A.clear=!0,s){case THREE.SimpleOperator:rt.TONEMAP_SIMPLE=!0;break;case THREE.LinearOperator:rt.TONEMAP_LINEAR=!0;break;case THREE.ReinhardOperator:rt.TONEMAP_REINHARD=!0;break;case THREE.FilmicOperator:rt.TONEMAP_FILMIC=!0;break;case THREE.UnchartedOperator:rt.TONEMAP_UNCHARTED=!0;break;case THREE.LumaReinhardOperator:rt.TONEMAP_REINHARD_LUMA=!0;break;case THREE.WhitePreservingReinhardOperator:rt.TONEMAP_REINHARD_WHITE=!0}if(rt.BLOOM_ENABLED=t.bloomEnabled,rt.OFFSCREEN_PARTICLES=t.offscreenParticles,rt.FANCY_DOF=t.dofFancy&&t.dofEnabled,A.material.defines=rt,N.material.defines=rt,T=new THREE.ShaderPass(THREE.FXAAShader),T.material.blending=THREE.NoBlending,T.material.depthTest=!1,T.material.depthWrite=!1,t.dofFancy){var it=.75;L=new THREE.FancyDepthOfFieldPass(o,n,it,u)}else L=new THREE.DepthOfFieldPass(1024,512);L.materialDOF.defines=Pt(),t.dofDebug&&(L.materialDOF.defines.DOF_DEBUG=1),t.dofPhysical&&(L.materialDOF.defines.DOF_PHYSICAL=1),L.depthInput=h?W:p.renderTarget2,L.colorInput=m.renderTarget2,L.autoFocus=t.dofAutofocus,L.autoFocusPoint=t.dofAutofocusPoint,L.focusDistance=t.dofFocusDistance,L.focusRampStart=t.dofFocusWidth,L.focusRampEnd=t.dofFocusWidth+t.dofFocusRampWidth,L.maxBlur=t.dofMaxBlur,t.dofFancy&&t.dofPhysical&&(L.lensCOC=t.dofLensCOC,L.lensFstop=t.dofLensFstop,L.lensFocalLength=t.dofLensFocalLength),t.dofFancy?(A.uniforms.samplerBlur.value=L.renderTargetBlur,A.uniforms.samplerBlurAmount.value=L.renderTargetBlurAmount,S=new THREE.EffectComposer(t.renderer,$),S.addPass(L),S.addPass(A),S.addPass(T)):(S=new THREE.EffectComposer(t.renderer,$),S.addPass(A),S.addPass(T),S.addPass(L)),Wt()}},THREE.ShadowMapPlugin=function(){function e(e,t){var a=new THREE.DirectionalLight;a.isVirtual=!0,a.onlyShadow=!0,a.castShadow=!0,a.shadowCameraNear=e.shadowCameraNear,a.shadowCameraFar=e.shadowCameraFar,a.shadowCameraLeft=e.shadowCameraLeft,a.shadowCameraRight=e.shadowCameraRight,a.shadowCameraBottom=e.shadowCameraBottom,a.shadowCameraTop=e.shadowCameraTop,a.shadowCameraVisible=e.shadowCameraVisible,a.shadowDarkness=e.shadowDarkness,a.shadowBias=e.shadowCascadeBias[t],a.shadowMapWidth=e.shadowCascadeWidth[t],a.shadowMapHeight=e.shadowCascadeHeight[t],a.properties.pointsWorld=[],a.properties.pointsFrustum=[];for(var r=a.properties.pointsWorld,i=a.properties.pointsFrustum,o=0;8>o;o++)r[o]=new THREE.Vector3,i[o]=new THREE.Vector3;var n=e.shadowCascadeNearZ[t],s=e.shadowCascadeFarZ[t];return i[0].set(-1,-1,n),i[1].set(1,-1,n),i[2].set(-1,1,n),i[3].set(1,1,n),i[4].set(-1,-1,s),i[5].set(1,-1,s),i[6].set(-1,1,s),i[7].set(1,1,s),a}function t(e,t){var a=e.shadowCascadeArray[t];a.position.copy(e.position),a.target.position.copy(e.target.position),a.lookAt(a.target.position),a.shadowCameraVisible=e.shadowCameraVisible,a.shadowDarkness=e.shadowDarkness,a.shadowBias=e.shadowCascadeBias[t];var r=e.shadowCascadeNearZ[t],i=e.shadowCascadeFarZ[t],o=a.properties.pointsFrustum;o[0].setZ(r),o[1].setZ(r),o[2].setZ(r),o[3].setZ(r),o[4].setZ(i),o[5].setZ(i),o[6].setZ(i),o[7].setZ(i)}function a(e,t){var a=t.properties,r=a.shadowCamera,i=a.pointsFrustum,o=a.pointsWorld;c.set(1/0,1/0,1/0),f.set(-1/0,-1/0,-1/0);for(var n=c.data,s=f.data,l=THREE.ShadowMapPlugin.__projector,h=0;8>h;h++){var d=o[h],u=d.data;d.copy(i[h]),l.unprojectVector(d,e),r.matrixWorldInverse.multiplyVector3(d),u[0]<n[0]&&(n[0]=u[0]),u[0]>s[0]&&(s[0]=u[0]),u[1]<n[1]&&(n[1]=u[1]),u[1]>s[1]&&(s[1]=u[1]),u[2]<n[2]&&(n[2]=u[2]),u[2]>s[2]&&(s[2]=u[2])}r.left=n[0],r.right=s[0],r.top=s[1],r.bottom=n[1],r.updateProjectionMatrix()}var r,i,o,n,s,l,h,d=new THREE.Frustum,u=new THREE.Matrix4,c=new THREE.Vector3,f=new THREE.Vector3,p={};this.init=function(e){r=e.context,i=e;var t=THREE.ShaderLib.depthRGBA;h=THREE.UniformsUtils.clone(t.uniforms),h.slopeScale.value=i.shadowMapSlopeScale,h.slopeBias.value=i.shadowMapSlopeBias,h.slopeMax.value=i.shadowMapSlopeMax;var a={SLOPE_DEPTH_BIAS:i.shadowMapSlopeDepthBias&&i.supportsStandardDerivatives()};o=new THREE.ShaderMaterial({fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,uniforms:h,defines:a}),n=new THREE.ShaderMaterial({fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,uniforms:h,defines:a,morphTargets:!0}),s=new THREE.ShaderMaterial({fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,uniforms:h,defines:a,skinning:!0}),l=new THREE.ShaderMaterial({fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,uniforms:h,defines:a,morphTargets:!0,skinning:!0}),o._shadowPass=!0,n._shadowPass=!0,s._shadowPass=!0,l._shadowPass=!0},this.render=function(e,t){i.shadowMapEnabled&&i.shadowMapAutoUpdate&&this.update(e,t)},this.update=function(c,f){var m,v,g,S,x,y,G,M,w,X,D,C,_,b,A,T=[],P=0,L=null,E=null,F=i.supportsDepthTextures()&&i.shadowMapUseDepthTextures;r.clearColor(1,1,1,1),r.disable(r.BLEND);var R;for(R=i.shadowMapCullFace===THREE.CullFaceFront?THREE.BackSide:i.shadowMapCullFace===THREE.CullFaceBack?THREE.FrontSide:THREE.DoubleSide,i.setDepthTest(!0),F&&r.colorMask(!1,!1,!1,!1),m=0,v=c.__lights.length;v>m;m++)if(_=c.__lights[m],_.castShadow)if((_ instanceof THREE.DirectionalLight||_ instanceof THREE.DayLight||_ instanceof THREE.DayLightCube)&&_.shadowCascade)for(x=0;x<_.shadowCascadeCount;x++){var U;if(_.shadowCascadeArray[x])U=_.shadowCascadeArray[x];else{U=e(_,x),U.originalCamera=f;var N=new THREE.Gyroscope;N.position=_.shadowCascadeOffset,N.add(U),N.add(U.target),f.add(N),_.shadowCascadeArray[x]=U,console.log("Created virtualLight",U)}t(_,x),T[P]=U,P++}else T[P]=_,P++;for(i.shadowMapSlopeDepthBias&&(F?i.setPolygonOffset(!0,1.5,10):(h.slopeScale.value=i.shadowMapSlopeScale,h.slopeBias.value=i.shadowMapSlopeBias,h.slopeMax.value=i.shadowMapSlopeMax)),m=0,v=T.length;v>m;m++){if(_=T[m],b=_.properties,!b.shadowMap){var I=i.shadowMapType===THREE.PCFSoftShadowMap?THREE.NearestFilter:THREE.LinearFilter,B=F?THREE.RGBFormat:THREE.RGBAFormat,O=i.shadowMapDepthTextureType,k={minFilter:I,magFilter:I,format:B,stencilBuffer:!1,useDepthTexture:F,depthTextureType:O};b.shadowMap=new THREE.RenderTarget(_.shadowMapWidth,_.shadowMapHeight,k),b.shadowMap.generateMipmaps=!1,b.shadowMapPars=new THREE.Vector4(_.shadowMapWidth,_.shadowMapHeight,_.shadowDarkness,_.shadowBias),b.shadowMatrixForward=new THREE.Matrix4}if(!b.shadowCamera){if(_ instanceof THREE.SpotLight)M=new THREE.PerspectiveCamera(_.shadowCameraFov,_.shadowMapWidth/_.shadowMapHeight,_.shadowCameraNear,_.shadowCameraFar);else if(_ instanceof THREE.DirectionalLight||_ instanceof THREE.DayLight||_ instanceof THREE.DayLightCube)M=new THREE.OrthographicCamera(_.shadowCameraLeft,_.shadowCameraRight,_.shadowCameraTop,_.shadowCameraBottom,_.shadowCameraNear,_.shadowCameraFar);else{if(!(_ instanceof THREE.AreaLight)){console.error("XG:ShadowMapPlugin: Unsupported light type for shadow");continue}M=_.shadowCameraOrtho?new THREE.OrthographicCamera(_.shadowCameraLeft,_.shadowCameraRight,_.shadowCameraTop,_.shadowCameraBottom,_.shadowCameraNear,_.shadowCameraFar):new THREE.PerspectiveCamera(_.shadowCameraFov,_.shadowMapWidth/_.shadowMapHeight,_.shadowCameraNear,_.shadowCameraFar)}b.shadowCamera=M,c.add(M),i.autoUpdateScene&&c.updateMatrixWorld()}for(y=b.shadowMap,M=b.shadowCamera,G=b.shadowMatrixForward,M.position.copy(_.matrixWorld.getPosition()),M.lookAt(_.target.matrixWorld.getPosition()),M.updateMatrixWorld(),M.matrixWorldInverse.getInverse(M.matrixWorld),_.isVirtual&&U.originalCamera==f&&a(f,_),_.cameraHelper&&(_.cameraHelper.visible=_.shadowCameraVisible),_.shadowCameraVisible&&_.cameraHelper.update(),G.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),G.multiplySelf(M.projectionMatrix),G.multiplySelf(M.matrixWorldInverse),u.multiply(M.projectionMatrix,M.matrixWorldInverse),d.setFromMatrix(u),i.setRenderTarget(y),i.clear(),A=c.__webglObjects,g=0,S=A.length;S>g;g++)D=A[g],C=D.object,w=D.geometry,D.render=!1,C.visible&&C.castShadow&&((C instanceof THREE.Mesh||C instanceof THREE.Particles)&&C.frustumCulled&&!d.contains(C,w)||(C._modelViewMatrix.multiply(M.matrixWorldInverse,C.matrixWorld),D.render=!0));var V,z,H;for(g=0,S=A.length;S>g;g++)if(D=A[g],D.render){if(C=D.object,w=D.geometry,V=D.opaque,!V||!V.visible)continue;z=w.morphTargets.length>0&&V.morphTargets,H=C instanceof THREE.SkinnedMesh&&V.skinning,C.customDepthMaterial?X=C.customDepthMaterial:H?void 0===p[V.id]?(X=z?l:s,p[V.id]=X.clone(),p[V.id]._shadowPass=!0):X=p[V.id]:X=z?n:o,X.side=R,i.setMaterialFaces(X),i.setProgram(M,c.__lights,L,E,X,C,w),i.renderGeometry(X,w,C)}for(A=c.__webglObjectsImmediate,g=0,S=A.length;S>g;g++)D=A[g],C=D.object,C.visible&&C.castShadow&&(d.contains(C,C)||!C.frustumCulled)&&(C._modelViewMatrix.multiply(M.matrixWorldInverse,C.matrixWorld),i.renderImmediateObject(M,c.__lights,L,o,C))}var W=i.getClearColor(),j=i.getClearAlpha();r.clearColor(W.r,W.g,W.b,j),r.enable(r.BLEND),F&&r.colorMask(!0,!0,!0,!0)}},THREE.ShadowMapPlugin.__projector=new THREE.Projector,THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var a=window.innerWidth||1,r=window.innerHeight||1,i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1};t=new THREE.RenderTarget(a,r,i)}this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},THREE.EffectComposer.prototype={swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2;var t,a,r=!1,i=this.passes.length;for(a=0;i>a;a++)if(t=this.passes[a],t.enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,r),t.needsSwap){if(r){var o=this.renderer.context;o.stencilFunc(o.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),o.stencilFunc(o.EQUAL,1,4294967295)}this.swapBuffers()}t instanceof THREE.MaskPass?r=!0:t instanceof THREE.ClearMaskPass&&(r=!1)}},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t)}},THREE.EffectComposer.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),THREE.EffectComposer.quad=new THREE.Mesh(new THREE.PlaneGeometry(2,2),null),THREE.EffectComposer.scene=new THREE.Scene,THREE.EffectComposer.scene.add(THREE.EffectComposer.quad),THREE.TexturePass=function(e,t){var a=THREE.CopyShader;this.uniforms=THREE.UniformsUtils.clone(a.uniforms),this.uniforms.opacity.value=void 0!==t?t:1,this.uniforms.tDiffuse.value=e,this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader}),this.enabled=!0,this.needsSwap=!1},THREE.TexturePass.prototype={render:function(e,t,a){THREE.EffectComposer.quad.materials[0]=this.material,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,a)}},THREE.ShaderPass=function(e,t){this.textureID=void 0!==t?t:"tDiffuse",this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader}),this.renderToScreen=!1,this.enabled=!0,this.needsSwap=!0,this.clear=!1},THREE.ShaderPass.prototype={render:function(e,t,a){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=a),THREE.EffectComposer.quad.materials[0]=this.material,this.renderToScreen?e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera):e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,t,this.clear)}},THREE.SavePass=function(e){var t=THREE.CopyShader;this.textureID="tDiffuse",this.uniforms=THREE.UniformsUtils.clone(t.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.renderTarget=e,void 0===this.renderTarget&&(this.renderTargetParameters={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1},this.renderTarget=new THREE.RenderTarget(window.innerWidth,window.innerHeight,this.renderTargetParameters)),this.enabled=!0,this.needsSwap=!1,this.clear=!1},THREE.SavePass.prototype={render:function(e,t,a){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=a),THREE.EffectComposer.quad.materials[0]=this.material,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTarget,this.clear)}},THREE.RenderPass=function(e,t,a,r){this.scene=e,this.camera=t,this.clearColor=a,this.clearAlpha=void 0!==r?r:1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.enabled=!0,this.clear=!0,this.needsSwap=!1},THREE.RenderPass.prototype={render:function(e,t,a){this.clearColor&&(this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),e.render(this.scene,this.camera,a,this.clear),this.clearColor&&e.setClearColor(this.oldClearColor,this.oldClearAlpha)}},THREE.MaskPass=function(e,t){this.scene=e,this.camera=t,this.enabled=!0,this.clear=!0,this.needsSwap=!1,this.inverse=!1},THREE.MaskPass.prototype={render:function(e,t,a){var r=e.context;r.colorMask(!1,!1,!1,!1),r.depthMask(!1);var i,o;this.inverse?(i=0,o=1):(i=1,o=0),r.enable(r.STENCIL_TEST),r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,i,4294967295),r.clearStencil(o),e.render(this.scene,this.camera,a,this.clear),e.render(this.scene,this.camera,t,this.clear),r.colorMask(!0,!0,!0,!0),r.depthMask(!0),r.stencilFunc(r.EQUAL,1,4294967295),r.stencilOp(r.KEEP,r.KEEP,r.KEEP)
}},THREE.ClearMaskPass=function(){this.enabled=!0},THREE.ClearMaskPass.prototype={render:function(e){var t=e.context;t.disable(t.STENCIL_TEST)}},THREE.BloomPass=function(e,t,a,r){e=void 0!==e?e:1,t=void 0!==t?t:25,a=void 0!==a?a:4,r=void 0!==r?r:256;var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat};this.renderTargetX=new THREE.RenderTarget(r,r,i),this.renderTargetY=new THREE.RenderTarget(r,r,i);var o=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(o.uniforms),this.copyUniforms.opacity.value=e,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader,blending:THREE.AdditiveBlending,transparent:!0});var n=THREE.ConvolutionShader;this.convolutionUniforms=THREE.UniformsUtils.clone(n.uniforms),this.convolutionUniforms.uImageIncrement.value=THREE.BloomPass.blurx,this.convolutionUniforms.cKernel.value=THREE.ConvolutionShader.buildKernel(a),this.materialConvolution=new THREE.ShaderMaterial({uniforms:this.convolutionUniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,defines:{KERNEL_SIZE_FLOAT:t.toFixed(1),KERNEL_SIZE_INT:t.toFixed(0)}}),this.enabled=!0,this.needsSwap=!1,this.clear=!1},THREE.BloomPass.prototype={render:function(e,t,a,r,i){i&&e.context.disable(e.context.STENCIL_TEST),THREE.EffectComposer.quad.materials[0]=this.materialConvolution,this.convolutionUniforms.tDiffuse.value=a,this.convolutionUniforms.uImageIncrement.value=THREE.BloomPass.blurX,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetX,!0),this.convolutionUniforms.tDiffuse.value=this.renderTargetX,this.convolutionUniforms.uImageIncrement.value=THREE.BloomPass.blurY,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetY,!0),THREE.EffectComposer.quad.materials[0]=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetY,i&&e.context.enable(e.context.STENCIL_TEST),e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,a,this.clear)}},THREE.BloomPass.blurX=new THREE.Vector2(.001953125,0),THREE.BloomPass.blurY=new THREE.Vector2(0,.001953125),THREE.DepthOfFieldPass=function(e,t){e=void 0!==e?e:1024,t=void 0!==t?t:512;var a={minFilter:THREE.LinearMipMapLinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat},r={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat,type:THREE.FloatType};this.renderTargetBlur=new THREE.RenderTarget(e,t,a),this.renderTargetBlur.generateMipmaps=!0,this.renderTargetDistance1=new THREE.RenderTarget(2,2,r),this.renderTargetDistance1.generateMipmaps=!1,this.renderTargetDistance2=this.renderTargetDistance1.clone(),this.renderTargetDistanceRead=this.renderTargetDistance1,this.renderTargetDistanceWrite=this.renderTargetDistance2;var i=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(i.uniforms),this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1});var o=THREE.DistanceShader;this.distanceUniforms=THREE.UniformsUtils.clone(o.uniforms),this.materialDistance=new THREE.ShaderMaterial({uniforms:this.distanceUniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1});var n=THREE.DepthOfFieldShader;this.dofUniforms=THREE.UniformsUtils.clone(n.uniforms),this.materialDOF=new THREE.ShaderMaterial({uniforms:this.dofUniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1}),this.dofUniforms.tBlur.value=this.renderTargetBlur,this.dofUniforms.blurSize.value.set(e,t),this.depthInput=null,this.colorInput=null,this.cameraNear=null,this.cameraFar=null,this.autoFocus=null,this.autoFocusPoint=null,this.focusDistance=null,this.focusRampStart=null,this.focusRampEnd=null,this.maxBlur=null,this.enabled=!0,this.needsSwap=!0,this.clear=!1},THREE.DepthOfFieldPass.prototype={resize:function(){},render:function(e,t,a){var r=this.dofUniforms,i=this.copyUniforms,o=this.distanceUniforms,n=this.renderTargetDistanceRead;this.renderTargetDistanceRead=this.renderTargetDistanceWrite,this.renderTargetDistanceWrite=n,r.tDepth.value=this.depthInput,o.tDepth.value=this.depthInput,r.autoFocus.value=this.autoFocus,r.autoFocusPoint.value.copy(this.autoFocusPoint),r.focusDistance.value=this.focusDistance,r.focusRampStart.value=this.focusRampStart,r.focusRampEnd.value=this.focusRampEnd,r.maxBlur.value=this.maxBlur,o.cameraNear.value=this.cameraNear,o.cameraFar.value=this.cameraFar,o.samplePoint.value.copy(this.autoFocusPoint),i.tDiffuse.value=a,r.tDiffuse.value=a,r.tDistance.value=this.renderTargetDistanceRead,o.tDistance.value=this.renderTargetDistanceRead,this.materialDistance.defines=this.materialDOF.defines,THREE.EffectComposer.quad.materials[0]=this.materialCopy,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetBlur,!0),THREE.EffectComposer.quad.materials[0]=this.materialDOF,this.renderToScreen?e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera):e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,t,this.clear),THREE.EffectComposer.quad.materials[0]=this.materialDistance,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetDistanceWrite,!1)}},THREE.FancyDepthOfFieldPass=function(e,t,a,r){this.blurScale=void 0!==a?a:.75;var i,o,n,s=Math.floor(this.blurScale*e),l=Math.floor(this.blurScale*t),h={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBFormat,type:THREE.FloatType},d={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:THREE.RGBFormat,type:THREE.FloatType},u={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBFormat,type:THREE.HalfFloatType},c={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:THREE.RGBFormat,type:THREE.HalfFloatType},f={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBFormat,type:THREE.UnsignedByteType},p={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.FloatType},m={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.FloatType},v={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.HalfFloatType},g={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.HalfFloatType},S={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBAFormat,type:THREE.UnsignedByteType};r.hasHalfFloatsLinear?(i=u,n=c,o=v):r.hasHalfFloatsNearest?(i=c,n=c,o=g):r.hasFloatsLinear?(i=h,n=d,o=p):r.hasFloatsNearest?(i=d,n=d,o=m):(i=f,n=f,o=S),this.renderTargetBlurAmount=new THREE.RenderTarget(e,t,o),this.renderTargetBlurAmount.generateMipmaps=!1,this.renderTargetBlur=new THREE.RenderTarget(s,l,i),this.renderTargetBlur.generateMipmaps=!1,this.renderTargetDistance1=new THREE.RenderTarget(2,2,n),this.renderTargetDistance1.generateMipmaps=!1,this.renderTargetDistance2=this.renderTargetDistance1.clone(),this.renderTargetDistanceRead=this.renderTargetDistance1,this.renderTargetDistanceWrite=this.renderTargetDistance2;var x=THREE.DOFBlurAmountShader;this.blurAmountUniforms=THREE.UniformsUtils.clone(x.uniforms),this.materialBlurAmount=new THREE.ShaderMaterial({uniforms:this.blurAmountUniforms,vertexShader:x.vertexShader,fragmentShader:x.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1});var y=THREE.DistanceShader;this.distanceUniforms=THREE.UniformsUtils.clone(y.uniforms),this.materialDistance=new THREE.ShaderMaterial({uniforms:this.distanceUniforms,vertexShader:y.vertexShader,fragmentShader:y.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1});var G=THREE.DOFBlurShader;this.dofUniforms=THREE.UniformsUtils.clone(G.uniforms),this.materialDOF=new THREE.ShaderMaterial({uniforms:this.dofUniforms,vertexShader:G.vertexShader,fragmentShader:G.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1}),this.depthInput=null,this.colorInput=null,this.cameraNear=null,this.cameraFar=null,this.autoFocus=null,this.autoFocusPoint=null,this.focusDistance=null,this.focusRampStart=null,this.focusRampEnd=null,this.maxBlur=null,this.lensCOC=null,this.lensFstop=null,this.lensFocalLength=null,this.enabled=!0,this.needsSwap=!0,this.clear=!1},THREE.FancyDepthOfFieldPass.prototype={resize:function(e,t){var a=Math.floor(this.blurScale*e),r=Math.floor(this.blurScale*t);this.renderTargetBlurAmount.setSize(e,t),this.renderTargetBlur.setSize(a,r)},render:function(e){var t=this.dofUniforms,a=this.blurAmountUniforms,r=(this.blurCompositeUniforms,this.distanceUniforms),i=this.renderTargetDistanceRead;this.renderTargetDistanceRead=this.renderTargetDistanceWrite,this.renderTargetDistanceWrite=i,a.tDepth.value=this.depthInput,r.tDepth.value=this.depthInput,t.tDiffuse.value=this.colorInput,t.resolution.value.set(this.colorInput.width,this.colorInput.height),a.tDiffuse.value=this.colorInput,a.cameraNear.value=this.cameraNear,a.cameraFar.value=this.cameraFar,a.autoFocus.value=this.autoFocus,a.autoFocusPoint.value.copy(this.autoFocusPoint),a.focusDistance.value=this.focusDistance,a.focusRampStart.value=this.focusRampStart,a.focusRampEnd.value=this.focusRampEnd,a.maxBlur.value=this.maxBlur,a.lensCOC.value=this.lensCOC,a.lensFstop.value=this.lensFstop,a.lensFocalLength.value=this.lensFocalLength,r.cameraNear.value=this.cameraNear,r.cameraFar.value=this.cameraFar,r.samplePoint.value.copy(this.autoFocusPoint),t.tBlurAmount.value=this.renderTargetBlurAmount,a.tDistance.value=this.renderTargetDistanceRead,r.tDistance.value=this.renderTargetDistanceRead,this.materialBlurAmount.defines=this.materialDOF.defines,this.materialDistance.defines=this.materialDOF.defines,THREE.EffectComposer.quad.materials[0]=this.materialBlurAmount,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetBlurAmount,!0),THREE.EffectComposer.quad.materials[0]=this.materialDOF,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetBlur,!0),THREE.EffectComposer.quad.materials[0]=this.materialDistance,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetDistanceWrite,!1)}},THREE.PhysicsSimulation=function(e){var t=this,a=void 0!==e.useTransferables?e.useTransferables:!1,r=void 0!==e.workerUrl?e.workerUrl:"js/ammo/ammo.worker.js";this.currentFrame=0,this.currentFPS=0,this.allFPS=0,this.callbackIdle=null,this.callbackInitialized=null;var i,o=6,n=7,s=new Float32Array(0),l=[],h=[],d=[],u=[],c=[],f=function(e){for(var t=0,a=e.length;a>t;t++)for(var r=e[t].wheels,i=0,o=r.length;o>i;i++){var n=r[i],s=h.length;h.push(n.mesh),n.mesh=s}},p=function(e,t){for(var a=(e.length-t)/n,r=l.length,i=Math.min(a,r),o=0;i>o;o++){var s=l[o],h=s.position.data,d=s.quaternion.data;e[t]=h[0],e[t+1]=h[1],e[t+2]=h[2],e[t+3]=d[0],e[t+4]=d[1],e[t+5]=d[2],e[t+6]=d[3],t+=n}},m=function(e,t,a){var r=l.length,i=Math.min(a,r);a!==r&&console.warn("Number of physics bodies = ",a," while number of rendering bodies = ",r);for(var o=0;i>o;o++){var s=l[o],h=s.position.data,d=s.quaternion.data;h[0]=e[t],h[1]=e[t+1],h[2]=e[t+2],d[0]=e[t+3],d[1]=e[t+4],d[2]=e[t+5],d[3]=e[t+6],t+=n}return t},v=function(e,t,a){var r=h.length,i=Math.min(a,r);a!==r&&console.warn("Number of physics wheels = ",a," while number of rendering wheels = ",r);for(var o=0;i>o;o++){var s=h[o],l=s.position.data,d=s.quaternion.data;l[0]=e[t],l[1]=e[t+1],l[2]=e[t+2],d[0]=e[t+3],d[1]=e[t+4],d[2]=e[t+5],d[3]=e[t+6],t+=n}return t},g=function(e,t,a){var r=c.length,i=Math.min(a,r);a!==r&&console.warn("Number of physics vehicles = ",a," while number of local vehicles = ",r);for(var o=0;i>o;o++){var n=c[o],s=e[t];n.speed=s,t+=1}return t},S=function(e){var r,n=!1;a&&(e instanceof Float32Array?(r=e.buffer,0===e.length&&r.byteLength>0&&(e=new Float32Array(r))):e instanceof ArrayBuffer&&(r=e,e=new Float32Array(r),n=!0));var s=0,l=e[0];if(l>=t.currentFrame){t.currentFrame=l,t.currentFPS=e[1],t.allFPS=e[2];var h=e[3],d=e[4],u=e[5];s+=o,s=m(e,s,h),s=v(e,s,u),s=g(e,s,d)}else console.warn("Physics simulation frames received out of order");a&&(n?i.postMessage(e,[e.buffer]):i.postMessage(e.buffer,[e.buffer]))},x=function(e){var a=e.data;if(a instanceof Float32Array||a instanceof ArrayBuffer&&a.byteLength>1)S(a);else{var r=a;"simulationIdle"===r.type?t.callbackIdle&&t.callbackIdle():"simulationInitialized"===r.type?t.callbackInitialized&&t.callbackInitialized():"debug"===r.type&&console.log(r.content)}};this.loadPhysicsVehicle=function(e){var t,a,r,i,o,n=e.chassisUrl,s=e.wheelUrl,l=e.scale,h=e.position,d=e.chassisOffset,u=e.chassisShape,c=e.chassisPhysicsProperties,f=e.vehiclePhysicsProperties,p=e.wheels,m=e.callback,v=e.debugPhysicsShapes,g=[],S=0,x=function(){if(S+=1,2===S){var e=[t];e=e.concat(g),f.wheels=[];for(var n=0,s=p.length;s>n;n++){var h=p[n],d={mesh:g[n],isFrontWheel:h.isFrontWheel,wheelRadius:h.wheelRadius,suspensionRestLength:h.suspensionRestLength,connectionPoint:h.connectionPoint,wheelDirection:h.wheelDirection,wheelAxle:h.wheelAxle,tuning:h.tuning};f.wheels.push(d)}t.properties.physics=c;var v={chassisGeometries:a,wheelGeometries:r,chassisMaterials:i,wheelMaterials:o,parts:e,chassisShape:u,vehiclePhysicsProperties:f,scale:l};m(v)}},y=new THREE.UTF8Loader;y.load(n,function(e,r){if(a=e,i=r,THREE.GeometryUtils.center(e),d){var o=new THREE.Matrix4,n=new THREE.Vector3(d[0],d[1],d[2]);o.makeTranslation(n);for(var s=0;s<e.length;s++){var c=e[s];c.applyMatrix(o)}}if(t=new THREE.Mesh(e,r),t.scale.multiplyScalar(l),t.position.set(h[0],h[1],h[2]),t.useQuaternion=!0,t.castShadow=!0,t.receiveShadow=!0,t.visible=!1,v)for(var f=[16711680,16755200,16711935,65280,16776960],p=new THREE.Vector3(1,1,1).multiplyScalar(1/l),m=new THREE.Vector3,g=new THREE.Matrix4,S=new THREE.Matrix4,s=0,y=u.children.length;y>s;s++){var G=new THREE.EmissiveMaterial({color:f[s%f.length],transparent:!0,opacity:.8}),M=u.children[s],w=M.position;m.set(w[0],w[1],w[2]),S.makeScale(p),g.makeTranslation(m);var X=new THREE.BoxGeometry(2*M.sx,2*M.sy,2*M.sz);X.applyMatrix(g),X.applyMatrix(S),X.computeBoundingSphere(),e.push(X),r.push(G)}x()}),y.load(s,function(e,t){r=e,o=t,THREE.GeometryUtils.center(e);for(var a=0,i=p.length;i>a;a++){var n=p[a],s=new THREE.Mesh(e,t);s.castShadow=!0,s.receiveShadow=!0,s.visible=!1;var d;n.mirrored?(s.rotation.y=Math.PI,d=new THREE.Node,d.add(s)):d=s,d.useQuaternion=!0,d.scale.multiplyScalar(l),d.position.set(h[0],h[1],h[2]),g.push(d)}x()})},this.applyEngineForce=function(e,t,a){if(i){var r={type:"applyEngineForce",force:e,vehicleId:t,wheelId:a};i.postMessage(r)}},this.setSteering=function(e,t,a){if(i){var r={type:"setSteering",steering:e,vehicleId:t,wheelId:a};i.postMessage(r)}},this.setBrake=function(e,t,a){if(i){var r={type:"setBrake",brake:e,vehicleId:t,wheelId:a};i.postMessage(r)}},this.setGravity=function(e,t,a){if(i){var r={type:"setGravity",value:[e,t,a]};i.postMessage(r)}},this.resetTransforms=function(){if(i){var e=l.length,t=e*n;s.length<t&&(s=new Float32Array(t)),p(s,0);var a={type:"resetTransforms",nObjects:e,transforms:s};i.postMessage(a)}},this.startPhysics=function(e){l=e.objects,d=e.shapes,void 0!==e.constraints&&(u=e.constraints),void 0!==e.vehicles&&(c=e.vehicles,f(e.vehicles));for(var t=[],a=0,o=l.length;o>a;a++){var h=l[a],m=h.properties.physics,v=a,g=m.shapeId,S=void 0!==m.mass?m.mass:1,y=void 0!==m.linearSleepThreshold?m.linearSleepThreshold:.8,G=void 0!==m.angularSleepThreshold?m.angularSleepThreshold:1,M={bodyId:v,shapeId:g,mass:S,linearSleepThreshold:y,angularSleepThreshold:G};t.push(M)}var w=l.length,X=w*n;s.length<X&&(s=new Float32Array(X)),p(s,0),i=new Worker(r),i.onmessage=x;var D=void 0!==e.gravity?e.gravity:[0,-9.81,0],C=void 0!==e.floorEnabled?e.floorEnabled:!0,_={type:"init",nObjects:w,transforms:s,objectsData:t,shapesData:d,constraintsData:u,vehiclesData:c,floorEnabled:C,floorSize:.5*e.floorSize,floorHeight:e.floorHeight,gravity:D};i.postMessage(_)}};var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,supportsTransferables:function(){var e=!1;try{var t=new ArrayBuffer(1),a=window.URL||window.webkitURL,r=new Blob([""],{type:"application/x-javascript"}),i=a.createObjectURL(r),o=new Worker(i);o.postMessage(t,[t]),e=0===t.byteLength}catch(n){console.log(n)}return e},getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,a,r;e=e||{},t=void 0!==e.parent?e.parent:document.body,a=void 0!==e.id?e.id:"oldie",r=Detector.getWebGLErrorMessage(),r.id=a,t.appendChild(r)}};!function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(t){var a=Date.now(),r=Math.max(0,16-(a-e)),i=window.setTimeout(function(){t(a+r)},r);return e=a+r,i}),window.cancelAnimationFrame=window.cancelAnimationFrame||function(e){window.clearTimeout(e)}}(),self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}},self.Int32Array=self.Int32Array||Array,self.Float32Array=self.Float32Array||Array,String.prototype.startsWith=String.prototype.startsWith||function(e){return this.slice(0,e.length)===e},String.prototype.endsWith=String.prototype.endsWith||function(e){var t=String(e),a=this.lastIndexOf(t);return(a>-1&&a)===this.length-t.length},String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},function(e,t,a,r,i,o){function n(e){var t,a=e.length,i=this,o=0,n=i.i=i.j=0,s=i.S=[];for(a||(e=[a++]);r>o;)s[o]=o++;for(o=0;r>o;o++)s[o]=s[n=p&n+e[o%a]+(t=s[o])],s[n]=t;(i.g=function(e){for(var t,a=0,o=i.i,n=i.j,s=i.S;e--;)t=s[o=p&o+1],a=a*r+s[p&(s[o]=s[n=p&n+t])+(s[n]=t)];return i.i=o,i.j=n,a})(r)}function s(e,t){var a,r=[],i=(typeof e)[0];if(t&&"o"==i)for(a in e)try{r.push(s(e[a],t-1))}catch(o){}return r.length?r:"s"==i?e:e+"\x00"}function l(e,t){for(var a,r=e+"",i=0;i<r.length;)t[p&i]=p&(a^=19*t[p&i])+r.charCodeAt(i++);return d(t)}function h(a){try{return e.crypto.getRandomValues(a=new Uint8Array(r)),d(a)}catch(i){return[+new Date,e,e.navigator.plugins,e.screen,d(t)]}}function d(e){return String.fromCharCode.apply(0,e)}var u=a.pow(r,i),c=a.pow(2,o),f=2*c,p=r-1;a.seedrandom=function(e,o){var p=[],m=l(s(o?[e,d(t)]:0 in arguments?e:h(),3),p),v=new n(p);return l(d(v.S),t),a.srandom=function(){for(var e=v.g(i),t=u,a=0;c>e;)e=(e+a)*r,t*=r,a=v.g(1);for(;e>=f;)e/=2,t/=2,a>>>=1;return(e+a)/t},m},l(a.random(),t)}(this,[],Math,256,6,52);
// footer

THREE.BUILD_NUMBER = 383;
THREE.BUILD_DATE = '2014-02-05';

console.log( 'XG [version ' + THREE.VERSION + " | build " + THREE.BUILD_NUMBER + " | " + THREE.BUILD_DATE + "]" );
